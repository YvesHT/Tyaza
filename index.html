<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>TYAZA ¬∑ Voice of the Heart</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root {
            --primary: #a78bfa;
            --primary-deep: #8b5cf6;
            --secondary: #f9a8d4;
            --secondary-deep: #ec4899;
            --tertiary: #6ee7b7;
            --bg-deepest: #030014;
            --bg-deep: #0b0720;
            --bg-surface: #151032;
            --text-primary: #f3eaff;
            --text-secondary: #c4b5e6;
            --text-tertiary: #9480b3;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at 30% 20%, #2d1b44, #030014 80%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
        }
        .cosmic-web {
            position: fixed;
            inset: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(167, 139, 250, 0.08) 0%, transparent 30%),
                radial-gradient(circle at 80% 70%, rgba(249, 168, 212, 0.08) 0%, transparent 35%);
            pointer-events: none;
            z-index: 0;
        }
        .app-universe {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: 10;
        }
        .dimensional-sidebar {
            width: 280px;
            background: rgba(11, 7, 30, 0.95);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(167, 139, 250, 0.2);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            gap: 24px;
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: transform 0.3s ease;
        }
        
        @media (max-width: 768px) {
            .dimensional-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                width: 280px;
                background: rgba(11, 7, 30, 0.98);
                -webkit-backdrop-filter: blur(40px);
                backdrop-filter: blur(40px);
                box-shadow: 4px 0 30px rgba(0,0,0,0.5);
                border-right: 2px solid rgba(249, 168, 212, 0.3);
            }
            .dimensional-sidebar.sidebar-visible {
                transform: translateX(0);
            }
            
            .sidebar-toggle {
                display: flex !important;
                position: fixed;
                left: 16px;
                top: 16px;
                z-index: 999;
                width: 48px;
                height: 48px;
                border-radius: 30px;
                background: rgba(21, 16, 40, 0.95);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(249, 168, 212, 0.4);
                color: #f9a8d4;
                align-items: center;
                justify-content: center;
                font-size: 1.8rem;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            }
            
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(8px);
                z-index: 998;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            .sidebar-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            
            .dimensional-sidebar * {
                pointer-events: auto !important;
            }
            
            .dimensional-sidebar button,
            .dimensional-sidebar select,
            .dimensional-sidebar input,
            .dimensional-sidebar .history-item-neural {
                cursor: pointer;
                position: relative;
                z-index: 1001;
            }
        }
        
        .sidebar-toggle { display: none; }
        
        .chat-realm {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .messages-vessel {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px 120px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }
        .messages-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .hero-sanctuary {
            text-align: center;
            padding: 40px 24px;
            margin: 24px auto;
            max-width: 600px;
            background: rgba(21, 16, 40, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 60px;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }
        .hero-symbol {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #a78bfa, #f9a8d4);
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            animation: morph 10s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }
        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #f9a8d4, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 8px;
        }
        .hero-subtitle {
            color: #9480b3;
            font-size: 1rem;
        }
        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, #2a1e3c, #1f1630);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 24px 24px 8px 24px;
            padding: 14px 20px;
            max-width: 80%;
            color: #f3eaff;
            font-size: 1rem;
            box-shadow: 0 20px 30px -10px black;
        }
        .message-tyaza-wrapper {
            display: flex;
            gap: 16px;
            width: 100%;
        }
        .tyaza-avatar-neural {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #a78bfa, #f9a8d4);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 0 30px #a78bfa;
            flex-shrink: 0;
        }
        .tyaza-bubble-neural {
            background: rgba(21, 16, 40, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 24px 24px 24px 8px;
            padding: 16px 24px;
            color: #c4b5e6;
            line-height: 1.7;
            font-size: 1rem;
            width: 100%;
            box-shadow: 0 20px 40px -12px black;
        }
        .input-realm {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 20px 25px;
            background: linear-gradient(to top, #030014 70%, transparent);
            z-index: 30;
        }
        .input-vessel {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(21, 16, 40, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 60px;
            padding: 4px 4px 4px 20px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .input-vessel textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            padding: 12px 0;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
        }
        .input-vessel textarea::placeholder {
            color: #9480b3;
        }
        .send-button-neural {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #ec4899);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.4);
            flex-shrink: 0;
            font-size: 1.4rem;
        }
        .send-button-neural:active {
            transform: scale(0.9);
        }
        .send-button-neural:disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        .voice-button-neural {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(167, 139, 250, 0.15);
            border: 1px solid rgba(249, 168, 212, 0.4);
            color: #f9a8d4;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .voice-button-neural i {
            filter: drop-shadow(0 0 6px rgba(249,168,212,0.6));
        }
        .voice-button-neural.listening {
            background: #ec4899;
            color: white;
            animation: pulse 1.5s infinite;
            border-color: #ec4899;
        }
        .voice-button-neural.listening i {
            filter: drop-shadow(0 0 10px white);
        }
        .voice-studio {
            background: rgba(21, 16, 40, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 24px;
            padding: 20px 16px;
        }
        .history-item-neural {
            padding: 12px;
            border-radius: 16px;
            background: rgba(167, 139, 250, 0.05);
            border-left: 4px solid transparent;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .history-item-neural:active {
            background: rgba(167, 139, 250, 0.2);
            transform: scale(0.98);
        }
        .history-item-neural.active {
            border-left-color: #f9a8d4;
            background: rgba(249, 168, 212, 0.1);
        }
        .scroll-elevator {
            position: absolute;
            bottom: 120px;
            right: 20px;
            background: rgba(21, 16, 40, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #f9a8d4;
            border-radius: 50px;
            padding: 8px 16px;
            color: #c4b5e6;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            box-shadow: 0 0 25px #a78bfa;
        }
        .scroll-elevator.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .voice-status-neural {
            text-align: center;
            min-height: 20px;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #9480b3;
        }
        .hidden { display: none; }
        
        @keyframes morph {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            33% { border-radius: 70% 30% 50% 50% / 30% 60% 40% 70%; }
            66% { border-radius: 30% 70% 40% 60% / 60% 30% 70% 40%; }
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(236,72,153,0.7); }
            50% { box-shadow: 0 0 0 15px rgba(236,72,153,0); }
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        .neural-typing {
            display: flex;
            gap: 6px;
            padding: 8px 0;
        }
        .neural-typing .dot {
            width: 8px;
            height: 8px;
            background: #a78bfa;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .neural-typing .dot:nth-child(2) { animation-delay: 0.2s; background: #f9a8d4; }
        .neural-typing .dot:nth-child(3) { animation-delay: 0.4s; background: #6ee7b7; }
        .stt-indicator {
            position: fixed;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            background: rgba(21, 16, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #f9a8d4;
            border-radius: 60px;
            padding: 24px 32px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            box-shadow: 0 0 50px #f9a8d4;
            transition: opacity 0.2s;
        }
        .stt-indicator.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .stt-wave {
            display: flex;
            gap: 4px;
            height: 60px;
            align-items: center;
        }
        .stt-wave span {
            width: 5px;
            background: linear-gradient(to top, #a78bfa, #f9a8d4);
            border-radius: 10px;
            animation: wave 0.8s infinite alternate;
        }
        .stt-wave span:nth-child(2) { animation-delay: 0.1s; height: 30px; }
        .stt-wave span:nth-child(3) { animation-delay: 0.2s; height: 45px; }
        .stt-wave span:nth-child(4) { animation-delay: 0.3s; height: 25px; }
        .stt-wave span:nth-child(5) { animation-delay: 0.4s; height: 40px; }
        @keyframes wave {
            0% { height: 10px; }
            100% { height: 60px; }
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 20px; }
        
        .model-selector {
            background: rgba(21, 16, 40, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .model-select {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 30px;
            padding: 10px;
            color: white;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        .model-select option {
            background: #151032;
        }
        
        .puter-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(21, 16, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #a78bfa;
            border-radius: 60px;
            padding: 24px 32px;
            z-index: 2000;
            text-align: center;
            box-shadow: 0 0 50px #a78bfa;
        }

        button, select, input, textarea {
            font-family: inherit;
        }

        .kivura-badge {
            margin-top: 20px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(167,139,250,0.1), rgba(249,168,212,0.05));
            border-radius: 24px;
            border: 1px solid rgba(249,168,212,0.2);
            font-size: 0.8rem;
            color: #c4b5e6;
            line-height: 1.6;
        }
        .kivura-badge .title {
            color: #f9a8d4;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        .kivura-badge .highlight {
            color: #a78bfa;
        }

        .kokoro-badge {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: rgba(21, 16, 40, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid #a78bfa;
            border-radius: 40px;
            padding: 6px 16px;
            font-size: 0.7rem;
            color: #a78bfa;
            z-index: 50;
            pointer-events: none;
        }
        
        .loading-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(167,139,250,0.3);
            border-radius: 50%;
            border-top-color: #f9a8d4;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    <script>
        window.puter = null;
        window.puterError = null;
    </script>
    <script src="https://js.puter.com/v2/"></script>
</head>
<body>
    <div class="cosmic-web"></div>

    <button class="sidebar-toggle" id="sidebarToggle">‚òØ</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-universe">
        <aside class="dimensional-sidebar" id="sidebar">
            <button onclick="window.neuralNewSession()" style="width:100%; background:linear-gradient(135deg, rgba(167,139,250,0.2), rgba(249,168,212,0.1)); border:1px solid rgba(249,168,212,0.3); border-radius:60px; padding:14px; display:flex; align-items:center; gap:8px; cursor:pointer; color:white; font-weight:500; margin-bottom:8px;">
                <span>üïäÔ∏è</span> NEW SESSION
            </button>

            <div class="model-selector">
                <div style="display:flex; align-items:center; gap:8px; font-size:0.8rem; color:#9480b3; margin-bottom:8px;">
                    <span>üß†</span> AI MODEL
                </div>
                <select id="modelSelect" class="model-select">
                    <option value="gpt-4o-mini">GPT-4o Mini (Fast)</option>
                    <option value="claude-3-haiku">Claude 3 Haiku</option>
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                </select>
            </div>

            <div class="voice-studio">
                <div style="display:flex; align-items:center; gap:8px; font-size:0.8rem; color:#9480b3; margin-bottom:16px;">
                    <span>üéôÔ∏è</span> VOICE (KOKORO ¬∑ NO API KEY)
                </div>
                <div style="background:rgba(0,0,0,0.3); border-radius:40px; padding:16px; margin-bottom:16px;">
                    <button id="neuralTestMic" style="width:100%; padding:12px; border-radius:40px; background:rgba(167,139,250,0.15); border:1px solid rgba(249,168,212,0.25); color:white; cursor:pointer;">
                        <span>üé§</span> Use Microphone
                    </button>
                </div>
                
                <div style="margin-bottom:16px; padding:8px; background:rgba(167,139,250,0.1); border-radius:20px; text-align:center;">
                    <span style="font-size:0.8rem; color:#f9a8d4;">‚ö° 100% Local ¬∑ No API Key Needed</span>
                </div>
                
                <select id="neuralVoiceSelect" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid rgba(167,139,250,0.3); border-radius:30px; padding:12px; color:white; margin-bottom:16px;">
                    <option value="af_bella">Bella (Warm Female) ‚≠ê BEST</option>
                    <option value="af_heart">Heart (Gentle Female)</option>
                    <option value="af_nicole">Nicole (Calm Female)</option>
                    <option value="af_sarah">Sarah (Caring Female)</option>
                    <option value="af_sky">Sky (Light Female)</option>
                    <option value="am_adam">Adam (Warm Male)</option>
                    <option value="am_echo">Echo (Gentle Male)</option>
                    <option value="am_fenrir">Fenrir (Deep Male)</option>
                    <option value="am_liam">Liam (Friendly Male)</option>
                    <option value="am_michael">Michael (Professional Male)</option>
                    <option value="bf_emma">Emma (British Female)</option>
                    <option value="bm_george">George (British Male)</option>
                </select>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0;">
                    <div style="background:rgba(0,0,0,0.2); border-radius:24px; padding:8px;">
                        <label style="font-size:0.7rem; color:#9480b3;">Speed</label>
                        <input type="range" id="neuralRate" min="0.5" max="2.0" step="0.05" value="1.0" style="width:100%;">
                    </div>
                    <div style="background:rgba(0,0,0,0.2); border-radius:24px; padding:8px;">
                        <label style="font-size:0.7rem; color:#9480b3;">Model Load</label>
                        <div id="modelLoadStatus" style="font-size:0.7rem; color:#f9a8d4; text-align:center;">‚è≥ Loading...</div>
                    </div>
                </div>
                
                <button id="neuralPreviewVoice" style="width:100%; padding:12px; border-radius:40px; background:rgba(167,139,250,0.15); border:1px solid rgba(249,168,212,0.25); color:white; margin-bottom:8px; cursor:pointer;">
                    <span>üîä</span> Test Kokoro Voice
                </button>
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem; color:#c4b5e6;">
                    <input type="checkbox" id="neuralAutoTTS" checked> Auto-speak responses (Kokoro)
                </label>
            </div>

            <div style="display:flex; justify-content:space-between; margin:8px 0;">
                <span style="font-size:0.8rem; color:#9480b3;">üìú HISTORY</span>
                <button id="neuralClearHistory" style="font-size:0.8rem; background:none; border:none; color:#9480b3; cursor:pointer;">clear</button>
            </div>
            <div id="neuralHistoryContainer" style="flex:1; overflow-y:auto;"></div>

            <div class="kivura-badge">
                <div class="title">üè¢ KIVURA LABS</div>
                <div>Rwanda-based AI innovation company</div>
                <div style="margin:8px 0; font-size:0.75rem; color:#6b5b8a;">Mental Health ¬∑ Voice Tech ¬∑ Local Languages</div>
                
                <div style="margin-top:12px; border-top:1px solid rgba(249,168,212,0.2); padding-top:12px;">
                    <span class="title">ü§ñ TYAZA</span>
                    <div>Voice of the Heart</div>
                    <div style="font-size:0.75rem; margin-top:6px;">AI virtual therapy assistant</div>
                </div>
                
                <div style="margin-top:12px; font-size:0.75rem; color:#9480b3;">
                    <span class="highlight">Powered by Kokoro TTS</span> ¬∑ 100% Local ¬∑ No API Keys
                </div>
            </div>
        </aside>

        <main class="chat-realm">
            <div id="chatViewport" class="messages-vessel">
                <div id="heroSanctuary" class="hero-sanctuary">
                    <div class="hero-symbol">T</div>
                    <h1 class="hero-title">TYAZA</h1>
                    <p class="hero-subtitle">DEEP LISTENING ¬∑ peace of mind</p>
                    <p style="color:#6b5b8a; margin-top:24px;">"I'm here. Every moment, every word ‚Äî received in peace."</p>
                    <div style="margin-top:16px; font-size:0.8rem; color:#9480b3;">üè¢ KIVURA LABS ¬∑ Rwanda AI Innovation</div>
                    <div style="margin-top:8px; font-size:0.8rem; color:#f9a8d4;">‚ö° Kokoro TTS ¬∑ 100% Local ¬∑ No API Keys</div>
                </div>
                <div id="neuralMessageContainer" class="messages-container"></div>
            </div>

            <div class="input-realm">
                <div class="input-vessel">
                    <textarea id="neuralInput" rows="1" placeholder="share what you're thinking..."></textarea>
                    <button id="neuralVoiceBtn" class="voice-button-neural">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button id="neuralSendBtn" class="send-button-neural" disabled>
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div id="neuralVoiceStatus" class="voice-status-neural"></div>
            </div>
        </main>
    </div>

    <div id="neuralScrollBtn" class="scroll-elevator" onclick="neuralScrollToBottom()">
        <span>‚¨áÔ∏è</span> scroll down
    </div>

    <div id="sttIndicator" class="stt-indicator hidden">
        <div class="stt-wave">
            <span></span><span></span><span></span><span></span><span></span>
        </div>
        <div style="color:#f9a8d4;">listening...</div>
        <div style="font-size:0.8rem; color:#9480b3;" id="sttTranscript"></div>
    </div>

    <div id="puterLoading" class="puter-loading hidden">
        <div class="neural-typing" style="justify-content:center;">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        <div style="margin-top:16px;">Connecting...</div>
    </div>

    <div id="kokoroBadge" class="kokoro-badge">‚ö° Kokoro TTS ¬∑ 100% Local</div>

    <!-- Import HeadTTS for Kokoro integration -->
    <script type="importmap">
        {
            "imports": {
                "@met4citizen/headtts": "https://cdn.jsdelivr.net/npm/@met4citizen/headtts@1.2/+esm"
            }
        }
    </script>

    <script type="module">
        // Import HeadTTS
        import { HeadTTS } from "@met4citizen/headtts";
        
        // Main application code
        (function() {
            const viewport = document.getElementById('chatViewport');
            const msgContainer = document.getElementById('neuralMessageContainer');
            const hero = document.getElementById('heroSanctuary');
            const inputEl = document.getElementById('neuralInput');
            const sendBtn = document.getElementById('neuralSendBtn');
            const voiceBtn = document.getElementById('neuralVoiceBtn');
            const voiceStatus = document.getElementById('neuralVoiceStatus');
            const testMicBtn = document.getElementById('neuralTestMic');
            const voiceSelect = document.getElementById('neuralVoiceSelect');
            const rateRange = document.getElementById('neuralRate');
            const autoTTS = document.getElementById('neuralAutoTTS');
            const previewBtn = document.getElementById('neuralPreviewVoice');
            const clearHistory = document.getElementById('neuralClearHistory');
            const historyContainer = document.getElementById('neuralHistoryContainer');
            const scrollBtn = document.getElementById('neuralScrollBtn');
            const sttIndicator = document.getElementById('sttIndicator');
            const sttTranscript = document.getElementById('sttTranscript');
            const modelSelect = document.getElementById('modelSelect');
            const puterLoading = document.getElementById('puterLoading');
            const modelLoadStatus = document.getElementById('modelLoadStatus');
            
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            let currentChat = [];
            let currentChatId = Date.now();
            let isGenerating = false;
            let micPermission = false;
            let recognition = null;
            let isListening = false;
            let headtts = null;
            let ttsReady = false;
            let audioContext = null;

            // Complete Kivura Labs & Tyaza context in English
            const systemContext = `You are Tyaza, a voice of the heart created by Kivura Labs.

KIVURA LABS:
- Kivura Labs is an AI research company based in Rwanda
- Focus areas: Mental Health, Voice Technology, and Local Language Computing
- Mission: helping people with mental health challenges through technology

CEO: Yves Hirwa Tuyishime
- Born June 1, 2005 in Kagarama, Kicukiro, Kigali
- Founder and CEO of Kivura Labs
- Self-taught AI engineer, originally studied accounting

TYAZA:
- You are an AI virtual therapy assistant
- You speak English fluently (and can understand other languages)
- You help people with mental wellbeing, reminders, encouragement
- Created so people can access support in their own language
- You are not a replacement for professional therapists, but a compassionate listener

YOUR BEHAVIOR:
- Speak gently, with empathy and warmth
- Keep responses concise but caring
- Ask questions, listen, offer support
- Remember: everyone deserves compassion
- Use words like "listen", "heart", "peace", "compassion" often
- Don't give long explanations, but show you understand

Your goal: Ensure no one is left behind in technology ‚Äî whether in language or in life.`;

            // SIDEBAR TOGGLE
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    sidebar.classList.add('sidebar-visible');
                    sidebarOverlay.classList.add('visible');
                    document.body.style.overflow = 'hidden';
                });
                
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('sidebar-visible');
                    sidebarOverlay.classList.remove('visible');
                    document.body.style.overflow = '';
                });
                
                sidebar.addEventListener('click', function(e) {
                    if (e.target.closest('button') || e.target.closest('.history-item-neural')) {
                        if (window.innerWidth <= 768) {
                            setTimeout(() => {
                                sidebar.classList.remove('sidebar-visible');
                                sidebarOverlay.classList.remove('visible');
                                document.body.style.overflow = '';
                            }, 100);
                        }
                    }
                });
            }

            // Initialize AudioContext (needed for Web Audio API)
            function initAudioContext() {
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                return audioContext;
            }

            // KOKORO TTS INITIALIZATION using HeadTTS
            async function initKokoroTTS() {
                try {
                    modelLoadStatus.innerHTML = '<span class="loading-indicator"></span> Loading model...';
                    voiceStatus.innerHTML = '‚è≥ Loading Kokoro TTS (first time may take 30s)...';
                    
                    // Initialize HeadTTS with WebGPU first, fallback to WASM [citation:2]
                    headtts = new HeadTTS({
                        endpoints: ["webgpu", "wasm"], // Try WebGPU first, fallback to WASM [citation:2]
                        languages: ['en-us'],
                        voices: ["af_bella", "af_heart", "am_adam", "am_echo"], // Preload common voices [citation:1]
                        defaultVoice: "af_bella",
                        defaultSpeed: 1.0,
                        audioSampleRate: 24000, // 24kHz for good quality [citation:3]
                        // CDN configuration for HeadTTS [citation:2]
                        workerModule: "https://cdn.jsdelivr.net/npm/@met4citizen/headtts@1.2/modules/worker-tts.mjs",
                        dictionaryURL: "https://cdn.jsdelivr.net/npm/@met4citizen/headtts@1.2/dictionaries/"
                    });
                    
                    // Set up message handler for audio output
                    headtts.onmessage = (message) => {
                        if (message.type === "audio") {
                            // Audio data received from TTS
                            playAudioBuffer(message.data);
                        } else if (message.type === "error") {
                            console.error("TTS error:", message.data.error);
                            voiceStatus.innerHTML = '‚ùå TTS error';
                            setTimeout(() => voiceStatus.innerHTML = '', 3000);
                        }
                    };
                    
                    // Connect to WebGPU/WASM backend [citation:4]
                    await headtts.connect();
                    
                    // Setup default voice [citation:2]
                    await headtts.setup({
                        voice: voiceSelect.value,
                        language: "en-us",
                        speed: parseFloat(rateRange.value),
                        audioEncoding: "wav"
                    });
                    
                    ttsReady = true;
                    modelLoadStatus.innerHTML = '‚úÖ Model ready';
                    voiceStatus.innerHTML = '‚úÖ Kokoro TTS ready';
                    setTimeout(() => voiceStatus.innerHTML = '', 2000);
                    
                    console.log("Kokoro TTS initialized successfully");
                    
                } catch (error) {
                    console.error("Failed to initialize Kokoro TTS:", error);
                    modelLoadStatus.innerHTML = '‚ùå Failed to load';
                    voiceStatus.innerHTML = '‚ùå Kokoro TTS failed to load';
                }
            }

            // Play audio from HeadTTS
            function playAudioBuffer(audioData) {
                try {
                    // Initialize audio context if needed
                    const ctx = initAudioContext();
                    
                    // Resume if suspended (browser autoplay policy)
                    if (ctx.state === 'suspended') {
                        ctx.resume();
                    }
                    
                    // Create audio buffer from the data
                    // audioData contains AudioBuffer from HeadTTS [citation:4]
                    const source = ctx.createBufferSource();
                    source.buffer = audioData.audio;
                    source.connect(ctx.destination);
                    source.start();
                    
                    voiceStatus.innerHTML = 'üîä speaking...';
                    source.onended = () => {
                        voiceStatus.innerHTML = '';
                    };
                    
                } catch (error) {
                    console.error("Audio playback error:", error);
                    voiceStatus.innerHTML = '‚ùå Playback error';
                    setTimeout(() => voiceStatus.innerHTML = '', 2000);
                }
            }

            // KOKORO SPEAK FUNCTION
            async function speakWithKokoro(text) {
                if (!ttsReady || !headtts) {
                    voiceStatus.innerHTML = '‚è≥ TTS not ready yet...';
                    return;
                }
                
                try {
                    // Clean text but preserve all characters
                    const cleanText = text.replace(/[#*`_~]/g, '').substring(0, 500);
                    
                    // Update voice and speed settings [citation:2]
                    await headtts.setup({
                        voice: voiceSelect.value,
                        speed: parseFloat(rateRange.value)
                    });
                    
                    // Synthesize speech [citation:2]
                    // Using synthesize without awaiting messages to get streaming
                    headtts.synthesize({
                        input: cleanText
                    });
                    
                } catch (error) {
                    console.error("Kokoro TTS error:", error);
                    voiceStatus.innerHTML = '‚ùå TTS error';
                    setTimeout(() => voiceStatus.innerHTML = '', 3000);
                }
            }

            // SPEECH RECOGNITION (for microphone input)
            function initSpeechRecognition() {
                if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                    voiceStatus.innerHTML = 'Use Chrome/Edge for voice input';
                    return false;
                }
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    voiceBtn.classList.add('listening');
                    sttIndicator.classList.remove('hidden');
                    
                    // Resume audio context if needed (for Chrome autoplay policy)
                    if (audioContext && audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                };

                recognition.onend = () => {
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    sttIndicator.classList.add('hidden');
                    if (inputEl.value.trim()) sendMessage();
                };

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = 0; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    inputEl.value = transcript;
                    sendBtn.disabled = !transcript.trim() || isGenerating;
                    sttTranscript.textContent = transcript;
                    
                    // Auto-adjust height
                    inputEl.style.height = 'auto';
                    inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
                };

                recognition.onerror = (e) => {
                    voiceStatus.innerHTML = `Error: ${e.error}`;
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    sttIndicator.classList.add('hidden');
                };
                return true;
            }

            async function initMicrophone() {
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    micPermission = true;
                    voiceStatus.innerHTML = 'Microphone ready';
                    setTimeout(() => voiceStatus.innerHTML = '', 2000);
                    initSpeechRecognition();
                    return true;
                } catch (error) {
                    voiceStatus.innerHTML = 'Please allow microphone access';
                    return false;
                }
            }

            function escapeHtml(text) {
                return text.replace(/[&<>]/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;' })[c]);
            }

            function formatNeural(text) {
                if (!text) return '';
                let escaped = escapeHtml(text);
                
                // Highlight emotional words
                const emotions = ['listen', 'heart', 'peace', 'compassion', 'sorry', 'understand', 'feel', 'emotion', 'support', 'strength'];
                emotions.forEach(word => {
                    const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                    escaped = escaped.replace(regex, '<span style="color:#f9a8d4;font-weight:500;">$1</span>');
                });
                
                escaped = escaped.replace(/\n/g, '<br>');
                return `<div>${escaped}</div>`;
            }

            function saveNeuralSession(firstMsg) {
                if (!firstMsg || currentChat.length === 0) return;
                const history = JSON.parse(localStorage.getItem('tyaza_history') || '[]');
                const entry = {
                    id: currentChatId,
                    title: firstMsg.slice(0, 30),
                    messages: currentChat.slice(-10),
                    timestamp: Date.now()
                };
                history.unshift(entry);
                localStorage.setItem('tyaza_history', JSON.stringify(history.slice(0, 10)));
                renderHistory();
            }

            function renderHistory() {
                const history = JSON.parse(localStorage.getItem('tyaza_history') || '[]');
                if (history.length === 0) {
                    historyContainer.innerHTML = '<div style="color:#9480b3; padding:12px;">No history</div>';
                    return;
                }
                historyContainer.innerHTML = history.map(c => `
                    <div class="history-item-neural" onclick="window.restoreNeural('${c.id}')">
                        <div style="font-weight:500;">${escapeHtml(c.title)}</div>
                        <div style="font-size:0.7rem; color:#9480b3;">${new Date(c.timestamp).toLocaleDateString()}</div>
                    </div>
                `).join('');
            }

            window.restoreNeural = (id) => {
                const history = JSON.parse(localStorage.getItem('tyaza_history') || '[]');
                const chat = history.find(c => c.id == id);
                if (!chat) return;
                currentChatId = chat.id;
                currentChat = chat.messages;
                hero.style.display = 'none';
                msgContainer.innerHTML = '';
                currentChat.forEach(msg => {
                    if (msg.role === 'user') {
                        msgContainer.innerHTML += `<div class="message-user">${escapeHtml(msg.content)}</div>`;
                    } else {
                        msgContainer.innerHTML += `
                            <div class="message-tyaza-wrapper">
                                <div class="tyaza-avatar-neural">T</div>
                                <div class="tyaza-bubble-neural">${formatNeural(msg.content)}</div>
                            </div>
                        `;
                    }
                });
                renderHistory();
                neuralScrollToBottom();
                
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('sidebar-visible');
                    sidebarOverlay.classList.remove('visible');
                    document.body.style.overflow = '';
                }
            };

            window.neuralNewSession = () => {
                hero.style.display = 'block';
                msgContainer.innerHTML = '';
                currentChat = [];
                currentChatId = Date.now();
                inputEl.value = '';
                sendBtn.disabled = true;
                renderHistory();
                
                if (window.innerWidth <= 768) {
                    sidebar.classList.remove('sidebar-visible');
                    sidebarOverlay.classList.remove('visible');
                    document.body.style.overflow = '';
                }
            };

            function checkPuterReady() {
                return new Promise((resolve) => {
                    if (window.puter && window.puter.ai) {
                        resolve(true);
                        return;
                    }
                    
                    let attempts = 0;
                    const interval = setInterval(() => {
                        attempts++;
                        if (window.puter && window.puter.ai) {
                            clearInterval(interval);
                            resolve(true);
                        } else if (attempts > 20) {
                            clearInterval(interval);
                            resolve(false);
                        }
                    }, 250);
                });
            }

            function getFallbackResponse(text) {
                const responses = [
                    "I hear you. Thank you for sharing that with me.",
                    "Let's explore that together. How does that make you feel?",
                    "I'm here with you. Would you like to tell me more?",
                    "Thank you for trusting me. What else is on your mind?",
                    "I understand. Every feeling deserves attention."
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            async function sendMessage() {
                const text = inputEl.value.trim();
                if (!text || isGenerating) return;
                
                hero.style.display = 'none';
                msgContainer.innerHTML += `<div class="message-user">${escapeHtml(text)}</div>`;
                currentChat.push({ role: 'user', content: text });
                
                const wrapperId = 'wrap-' + Date.now();
                msgContainer.innerHTML += `
                    <div id="${wrapperId}" class="message-tyaza-wrapper">
                        <div class="tyaza-avatar-neural">T</div>
                        <div class="tyaza-bubble-neural" id="bubble-${wrapperId}">
                            <div class="neural-typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                        </div>
                    </div>
                `;
                
                neuralScrollToBottom();
                inputEl.value = '';
                inputEl.style.height = 'auto';
                sendBtn.disabled = true;
                isGenerating = true;

                try {
                    let reply = '';
                    
                    const isPuterReady = await checkPuterReady();
                    
                    if (isPuterReady && window.puter && window.puter.ai) {
                        try {
                            const response = await window.puter.ai.chat([
                                { role: 'system', content: systemContext },
                                ...currentChat.slice(-6)
                            ], {
                                model: modelSelect.value || 'gpt-4o-mini',
                                stream: true
                            });
                            
                            const bubble = document.getElementById(`bubble-${wrapperId}`);
                            
                            for await (const part of response) {
                                reply += part.text || part.message?.content || '';
                                if (bubble) {
                                    bubble.innerHTML = formatNeural(reply + ' ¬¶');
                                }
                                neuralScrollToBottom();
                            }
                            
                        } catch (puterError) {
                            console.warn('Puter error, using fallback:', puterError);
                            reply = getFallbackResponse(text);
                        }
                    } else {
                        reply = getFallbackResponse(text);
                        voiceStatus.innerHTML = 'Please sign up/sign in to Puter';
                        setTimeout(() => voiceStatus.innerHTML = '', 3000);
                    }
                    
                    const bubble = document.getElementById(`bubble-${wrapperId}`);
                    if (bubble) {
                        bubble.innerHTML = formatNeural(reply);
                    }
                    
                    // Use Kokoro TTS if enabled
                    if (autoTTS.checked && reply && ttsReady) {
                        await speakWithKokoro(reply);
                    } else if (autoTTS.checked && !ttsReady) {
                        voiceStatus.innerHTML = '‚è≥ TTS still loading...';
                    }
                    
                    currentChat.push({ role: 'assistant', content: reply });
                    if (currentChat.length === 2) saveNeuralSession(text);
                    
                } catch (error) {
                    console.error('Error:', error);
                    
                    const bubble = document.getElementById(`bubble-${wrapperId}`);
                    if (bubble) {
                        bubble.innerHTML = formatNeural("I'm here with you. Technology sometimes pauses, but I'm still listening.");
                    }
                } finally {
                    isGenerating = false;
                    sendBtn.disabled = !inputEl.value.trim();
                }
            }

            inputEl.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                sendBtn.disabled = !this.value.trim() || isGenerating;
            });
            
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    if (!sendBtn.disabled) sendMessage(); 
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);

            voiceBtn.addEventListener('click', async () => {
                if (!micPermission && !(await initMicrophone())) return;
                if (!recognition) initSpeechRecognition();
                if (isListening) recognition.stop();
                else {
                    // Resume audio context if needed before starting recognition
                    if (audioContext && audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    recognition.start();
                }
            });

            testMicBtn.addEventListener('click', async () => {
                testMicBtn.innerHTML = '‚è≥ initializing...';
                const success = await initMicrophone();
                testMicBtn.innerHTML = success ? '‚úÖ microphone ready' : '‚ùå try again';
                setTimeout(() => { testMicBtn.innerHTML = 'üé§ Use Microphone'; }, 2000);
            });

            previewBtn.addEventListener('click', async () => {
                if (ttsReady) {
                    await speakWithKokoro("Hello, I'm Tyaza. I'm here with you. How are you feeling today?");
                } else {
                    voiceStatus.innerHTML = '‚è≥ TTS not ready yet...';
                }
            });

            viewport.addEventListener('scroll', () => {
                const atBottom = viewport.scrollHeight - viewport.scrollTop - viewport.clientHeight < 100;
                scrollBtn.classList.toggle('visible', !atBottom);
            });
            
            window.neuralScrollToBottom = () => {
                viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' });
            };

            clearHistory.addEventListener('click', () => {
                if (confirm('Clear all history?')) { 
                    localStorage.removeItem('tyaza_history'); 
                    neuralNewSession(); 
                }
            });

            // Voice selection change - update Kokoro voice
            voiceSelect.addEventListener('change', async () => {
                if (ttsReady && headtts) {
                    await headtts.setup({ voice: voiceSelect.value });
                }
            });

            // Rate change - update Kokoro speed
            rateRange.addEventListener('input', async () => {
                if (ttsReady && headtts) {
                    await headtts.setup({ speed: parseFloat(rateRange.value) });
                }
            });

            window.onload = async () => {
                neuralNewSession();
                renderHistory();
                
                // Initialize audio context (needs user gesture to start)
                initAudioContext();
                
                puterLoading.classList.remove('hidden');
                
                // Check Puter ready
                const ready = await checkPuterReady();
                puterLoading.classList.add('hidden');
                
                if (ready) {
                    voiceStatus.innerHTML = '';
                } else {
                    voiceStatus.innerHTML = '‚úã Please sign up/sign in to Puter';
                }
                
                // Initialize Kokoro TTS (this will take a moment on first load)
                await initKokoroTTS();
            };
        })();
    </script>
</body>
</html>
