<!DOCTYPE html>
<html lang="rw" data-theme="dark">
<head>
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="TYAZA - Umuvugizi w'Umutima | AI Virtual Therapy Assistant in Kinyarwanda by Kivura Labs">
    <meta name="theme-color" content="#0a0612">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>TYAZA Â· Umuvugizi w'Umutima</title>
    
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/json,{"name":"TYAZA","short_name":"TYA","start_url":".","display":"standalone","background_color":"#0f172a","theme_color":"#667eea"}'>
    
    <style>
        /* ================================================================
           TYAZA - PROFESSIONAL GRADE CSS FRAMEWORK
           Built with love by Kivura Labs
           ================================================================ */

        /* ----------------------------------------------------------------
           CSS CUSTOM PROPERTIES - DESIGN TOKENS
           ---------------------------------------------------------------- */
        :root {
            /* Color Tokens - Dark Theme (Default) */
            --color-primary-50: #f5f3ff;
            --color-primary-100: #ede9fe;
            --color-primary-200: #ddd6fe;
            --color-primary-300: #c4b5fd;
            --color-primary-400: #a78bfa;
            --color-primary-500: #8b5cf6;
            --color-primary-600: #7c3aed;
            --color-primary-700: #6d28d9;
            --color-primary-800: #5b21b6;
            --color-primary-900: #4c1d95;
            
            --color-secondary-50: #fdf2f8;
            --color-secondary-100: #fce7f3;
            --color-secondary-200: #fbcfe8;
            --color-secondary-300: #f9a8d4;
            --color-secondary-400: #f472b6;
            --color-secondary-500: #ec4899;
            --color-secondary-600: #db2777;
            --color-secondary-700: #be185d;
            --color-secondary-800: #9d174d;
            --color-secondary-900: #831843;
            
            --color-accent-50: #ecfdf5;
            --color-accent-100: #d1fae5;
            --color-accent-200: #a7f3d0;
            --color-accent-300: #6ee7b7;
            --color-accent-400: #34d399;
            --color-accent-500: #10b981;
            --color-accent-600: #059669;
            --color-accent-700: #047857;
            --color-accent-800: #065f46;
            --color-accent-900: #064e3b;
            
            --color-surface-950: #030014;
            --color-surface-900: #0a0612;
            --color-surface-800: #130d24;
            --color-surface-700: #1a1433;
            --color-surface-600: #231b42;
            --color-surface-500: #2d2352;
            --color-surface-400: #3d2f6d;
            --color-surface-300: #504185;
            --color-surface-200: #6b5a9e;
            --color-surface-100: #8b7ab8;
            --color-surface-50: #b8b0d0;
            
            --color-text-primary: #f8fafc;
            --color-text-secondary: #e2e8f0;
            --color-text-tertiary: #94a3b8;
            --color-text-muted: #64748b;
            --color-text-inverted: #0f172a;
            
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--color-primary-400), var(--color-secondary-400));
            --gradient-secondary: linear-gradient(135deg, var(--color-secondary-400), var(--color-accent-400));
            --gradient-cosmic: linear-gradient(135deg, var(--color-surface-900), var(--color-surface-800), var(--color-primary-900));
            --gradient-glow: radial-gradient(circle at center, var(--color-primary-500) 0%, transparent 70%);
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
            --shadow-glow-primary: 0 0 40px rgba(139, 92, 246, 0.3);
            --shadow-glow-secondary: 0 0 40px rgba(236, 72, 153, 0.3);
            --shadow-glow-accent: 0 0 40px rgba(110, 231, 183, 0.3);
            
            /* Border Radius */
            --radius-none: 0;
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;
            
            /* Spacing */
            --space-0: 0;
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;
            
            /* Typography */
            --font-sans: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-display: 'Space Grotesk', var(--font-sans);
            --font-serif: 'Crimson Pro', Georgia, serif;
            
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            --text-5xl: 3rem;
            
            --leading-tight: 1.25;
            --leading-normal: 1.5;
            --leading-relaxed: 1.75;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);
            --transition-spring: 600ms cubic-bezier(0.175, 0.885, 0.32, 1.275);
            
            /* Z-Index Scale */
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-fixed: 300;
            --z-modal-backdrop: 400;
            --z-modal: 500;
            --z-popover: 600;
            --z-tooltip: 700;
            --z-toast: 800;
            --z-loading: 900;
            
            /* Layout */
            --sidebar-width: 320px;
            --header-height: 64px;
            --input-height: 80px;
            --content-max-width: 900px;
        }

        /* Light Theme */
        [data-theme="light"] {
            --color-surface-950: #f8fafc;
            --color-surface-900: #f1f5f9;
            --color-surface-800: #e2e8f0;
            --color-surface-700: #cbd5e1;
            --color-surface-600: #94a3b8;
            --color-surface-500: #64748b;
            --color-surface-400: #475569;
            --color-surface-300: #334155;
            --color-surface-200: #1e293b;
            --color-surface-100: #0f172a;
            --color-surface-50: #020617;
            
            --color-text-primary: #0f172a;
            --color-text-secondary: #334155;
            --color-text-tertiary: #64748b;
            --color-text-muted: #94a3b8;
            --color-text-inverted: #f8fafc;
        }

        /* ----------------------------------------------------------------
           CSS RESET & BASE STYLES
           ---------------------------------------------------------------- */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-surface-950);
            color: var(--color-text-primary);
            line-height: var(--leading-normal);
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* ----------------------------------------------------------------
           UTILITY CLASSES - Display
           ---------------------------------------------------------------- */
        .d-none { display: none !important; }
        .d-block { display: block !important; }
        .d-flex { display: flex !important; }
        .d-inline-flex { display: inline-flex !important; }
        .d-grid { display: grid !important; }
        
        /* ----------------------------------------------------------------
           UTILITY CLASSES - Flexbox
           ---------------------------------------------------------------- */
        .flex-row { flex-direction: row; }
        .flex-col { flex-direction: column; }
        .flex-wrap { flex-wrap: wrap; }
        .flex-nowrap { flex-wrap: nowrap; }
        .flex-1 { flex: 1 1 0%; }
        .flex-auto { flex: 1 1 auto; }
        .flex-none { flex: none; }
        
        .items-start { align-items: flex-start; }
        .items-center { align-items: center; }
        .items-end { align-items: flex-end; }
        .items-stretch { align-items: stretch; }
        
        .justify-start { justify-content: flex-start; }
        .justify-center { justify-content: center; }
        .justify-end { justify-content: flex-end; }
        .justify-between { justify-content: space-between; }
        .justify-around { justify-content: space-around; }
        
        .gap-1 { gap: var(--space-1); }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .gap-5 { gap: var(--space-5); }
        .gap-6 { gap: var(--space-6); }
        .gap-8 { gap: var(--space-8); }

        /* ----------------------------------------------------------------
           UTILITY CLASSES - Spacing
           ---------------------------------------------------------------- */
        .m-0 { margin: 0; }
        .m-auto { margin: auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        
        .p-0 { padding: 0; }
        .p-1 { padding: var(--space-1); }
        .p-2 { padding: var(--space-2); }
        .p-3 { padding: var(--space-3); }
        .p-4 { padding: var(--space-4); }
        .p-5 { padding: var(--space-5); }
        .p-6 { padding: var(--space-6); }
        
        .px-2 { padding-left: var(--space-2); padding-right: var(--space-2); }
        .px-3 { padding-left: var(--space-3); padding-right: var(--space-3); }
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .px-6 { padding-left: var(--space-6); padding-right: var(--space-6); }
        
        .py-1 { padding-top: var(--space-1); padding-bottom: var(--space-1); }
        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-3 { padding-top: var(--space-3); padding-bottom: var(--space-3); }
        .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }

        /* ----------------------------------------------------------------
           UTILITY CLASSES - Typography
           ---------------------------------------------------------------- */
        .text-xs { font-size: var(--text-xs); }
        .text-sm { font-size: var(--text-sm); }
        .text-base { font-size: var(--text-base); }
        .text-lg { font-size: var(--text-lg); }
        .text-xl { font-size: var(--text-xl); }
        .text-2xl { font-size: var(--text-2xl); }
        .text-3xl { font-size: var(--text-3xl); }
        
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-tertiary { color: var(--color-text-tertiary); }
        .text-muted { color: var(--color-text-muted); }
        
        .leading-tight { line-height: var(--leading-tight); }
        .leading-normal { line-height: var(--leading-normal); }
        .leading-relaxed { line-height: var(--leading-relaxed); }

        /* ----------------------------------------------------------------
           UTILITY CLASSES - Sizing
           ---------------------------------------------------------------- */
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .min-h-screen { min-height: 100vh; }
        .h-screen { height: 100vh; }
        
        .max-w-md { max-width: 28rem; }
        .max-w-lg { max-width: 32rem; }
        .max-w-xl { max-width: 36rem; }
        .max-w-2xl { max-width: 42rem; }
        .max-w-3xl { max-width: 48rem; }
        .max-w-4xl { max-width: 56rem; }
        .max-w-full { max-width: 100%; }

        /* ----------------------------------------------------------------
           UTILITY CLASSES - Borders & Radius
           ---------------------------------------------------------------- */
        .rounded-none { border-radius: var(--radius-none); }
        .rounded-sm { border-radius: var(--radius-sm); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .rounded-2xl { border-radius: var(--radius-2xl); }
        .rounded-full { border-radius: var(--radius-full); }
        
        .border { border: 1px solid var(--color-surface-600); }
        .border-0 { border: none; }
        .border-t { border-top: 1px solid var(--color-surface-600); }
        .border-b { border-bottom: 1px solid var(--color-surface-600); }

        /* ----------------------------------------------------------------
           UTILITY CLASSES - Effects
           ---------------------------------------------------------------- */
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        .shadow-xl { box-shadow: var(--shadow-xl); }
        .shadow-glow-primary { box-shadow: var(--shadow-glow-primary); }
        .shadow-glow-secondary { box-shadow: var(--shadow-glow-secondary); }
        
        .opacity-0 { opacity: 0; }
        .opacity-50 { opacity: 0.5; }
        .opacity-75 { opacity: 0.75; }
        .opacity-100 { opacity: 1; }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-y-auto { overflow-y: auto; }
        .overflow-x-hidden { overflow-x: hidden; }
        
        .transition { transition: all var(--transition-base); }
        .transition-fast { transition: all var(--transition-fast); }
        .transition-slow { transition: all var(--transition-slow); }

        /* ----------------------------------------------------------------
           UTILITY CLASSES - Position
           ---------------------------------------------------------------- */
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .sticky { position: sticky; }
        
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        .top-0 { top: 0; }
        .right-0 { right: 0; }
        .bottom-0 { bottom: 0; }
        .left-0 { left: 0; }
        
        .z-10 { z-index: 10; }
        .z-20 { z-index: 20; }
        .z-50 { z-index: 50; }
        .z-100 { z-index: 100; }

        /* ----------------------------------------------------------------
           COMPONENT: BUTTONS
           ---------------------------------------------------------------- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 500;
            line-height: 1;
            text-decoration: none;
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            user-select: none;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--shadow-glow-primary);
        }

        .btn-primary:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--color-surface-700);
            border-color: var(--color-surface-500);
            color: var(--color-text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-surface-600);
            border-color: var(--color-primary-500);
        }

        .btn-ghost {
            background: transparent;
            color: var(--color-text-secondary);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-xs);
        }

        .btn-lg {
            padding: var(--space-4) var(--space-6);
            font-size: var(--text-base);
        }

        .btn-block {
            width: 100%;
        }

        /* ----------------------------------------------------------------
           COMPONENT: INPUTS
           ---------------------------------------------------------------- */
        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: inherit;
            font-size: var(--text-base);
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            transition: all var(--transition-fast);
        }

        .input::placeholder {
            color: var(--color-text-muted);
        }

        .input:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .input:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        textarea.input {
            resize: vertical;
            min-height: 100px;
            max-height: 300px;
            line-height: var(--leading-relaxed);
        }

        /* ----------------------------------------------------------------
           COMPONENT: SELECT
           ---------------------------------------------------------------- */
        .select {
            appearance: none;
            width: 100%;
            padding: var(--space-3) var(--space-4);
            padding-right: var(--space-10);
            font-family: inherit;
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-3) center;
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .select:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .select option {
            background: var(--color-surface-800);
            color: var(--color-text-primary);
        }

        /* ----------------------------------------------------------------
           COMPONENT: CHECKBOX & RADIO
           ---------------------------------------------------------------- */
        .checkbox, .radio {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-surface-800);
            border: 2px solid var(--color-surface-500);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .radio {
            border-radius: var(--radius-full);
        }

        .checkbox:checked, .radio:checked {
            background: var(--color-primary-500);
            border-color: var(--color-primary-500);
        }

        .checkbox:checked::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 6px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .radio:checked::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: white;
            border-radius: var(--radius-full);
            transform: translate(-50%, -50%);
        }

        /* ----------------------------------------------------------------
           COMPONENT: SLIDER
           ---------------------------------------------------------------- */
        .slider {
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: transform var(--transition-fast);
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-full);
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        /* ----------------------------------------------------------------
           COMPONENT: BADGE
           ---------------------------------------------------------------- */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            font-weight: 500;
            border-radius: var(--radius-full);
            background: var(--color-surface-700);
            color: var(--color-text-secondary);
        }

        .badge-primary {
            background: rgba(139, 92, 246, 0.2);
            color: var(--color-primary-300);
        }

        .badge-secondary {
            background: rgba(236, 72, 153, 0.2);
            color: var(--color-secondary-300);
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--color-warning);
        }

        .badge-error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--color-error);
        }

        /* ----------------------------------------------------------------
           COMPONENT: CARD
           ---------------------------------------------------------------- */
        .card {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
        }

        .card-elevated {
            box-shadow: var(--shadow-lg);
        }

        .card-glass {
            background: rgba(26, 20, 51, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        /* ----------------------------------------------------------------
           COMPONENT: MODAL
           ---------------------------------------------------------------- */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: var(--z-modal-backdrop);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }

        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-bounce);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
        }

        .modal-title {
            font-size: var(--text-xl);
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }

        /* ----------------------------------------------------------------
           COMPONENT: TOAST NOTIFICATIONS
           ---------------------------------------------------------------- */
        .toast-container {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            z-index: var(--z-toast);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-5);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            animation: toastSlideIn 0.3s ease-out;
            max-width: 350px;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast-success { border-left: 4px solid var(--color-success); }
        .toast-error { border-left: 4px solid var(--color-error); }
        .toast-warning { border-left: 4px solid var(--color-warning); }
        .toast-info { border-left: 4px solid var(--color-info); }

        /* ----------------------------------------------------------------
           COMPONENT: DROPDOWN
           ---------------------------------------------------------------- */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            min-width: 180px;
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--space-2);
            z-index: var(--z-dropdown);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
        }

        .dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(4px);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--color-text-secondary);
            text-decoration: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .dropdown-item:hover {
            background: var(--color-surface-600);
            color: var(--color-text-primary);
        }

        .dropdown-divider {
            height: 1px;
            background: var(--color-surface-500);
            margin: var(--space-2) 0;
        }

        /* ----------------------------------------------------------------
           COMPONENT: TABS
           ---------------------------------------------------------------- */
        .tabs {
            display: flex;
            gap: var(--space-1);
            background: var(--color-surface-800);
            padding: var(--space-1);
            border-radius: var(--radius-lg);
        }

        .tab {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-muted);
            background: transparent;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .tab:hover {
            color: var(--color-text-secondary);
        }

        .tab.active {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }

        /* ----------------------------------------------------------------
           COMPONENT: PROGRESS
           ---------------------------------------------------------------- */
        .progress {
            width: 100%;
            height: 8px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width var(--transition-slow);
        }

        /* ----------------------------------------------------------------
           COMPONENT: SKELETON LOADING
           ---------------------------------------------------------------- */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--color-surface-700) 25%,
                var(--color-surface-600) 50%,
                var(--color-surface-700) 75%
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-md);
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* ----------------------------------------------------------------
           COMPONENT: TOOLTIP
           ---------------------------------------------------------------- */
        .tooltip {
            position: relative;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface-600);
            color: var(--color-text-primary);
            font-size: var(--text-xs);
            white-space: nowrap;
            border-radius: var(--radius-md);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-fast);
            pointer-events: none;
            z-index: var(--z-tooltip);
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(-4px);
        }

        /* ----------------------------------------------------------------
           COMPONENT: SPINNER
           ---------------------------------------------------------------- */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--color-surface-600);
            border-top-color: var(--color-primary-500);
            border-radius: var(--radius-full);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner-sm { width: 16px; height: 16px; border-width: 2px; }
        .spinner-lg { width: 40px; height: 40px; border-width: 4px; }

        /* ----------------------------------------------------------------
           COMPONENT: AVATAR
           ---------------------------------------------------------------- */
        .avatar {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            font-weight: 600;
            color: white;
            background: var(--gradient-primary);
            overflow: hidden;
        }

        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-sm { width: 32px; height: 32px; font-size: var(--text-xs); }
        .avatar-md { width: 40px; height: 40px; font-size: var(--text-sm); }
        .avatar-lg { width: 56px; height: 56px; font-size: var(--text-lg); }
        .avatar-xl { width: 80px; height: 80px; font-size: var(--text-2xl); }

        /* ----------------------------------------------------------------
           COMPONENT: LIST GROUP
           ---------------------------------------------------------------- */
        .list-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            color: var(--color-text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .list-item:hover {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }

        .list-item.active {
            background: rgba(139, 92, 246, 0.15);
            color: var(--color-primary-300);
            border-left: 3px solid var(--color-primary-500);
        }

        /* ----------------------------------------------------------------
           COMPONENT: ALERT
           ---------------------------------------------------------------- */
        .alert {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border-left: 4px solid;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--color-info);
            color: var(--color-info);
        }

        .alert-success {
            background: rgba(34, 197, 94, 0.1);
            border-color: var(--color-success);
            color: var(--color-success);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--color-warning);
            color: var(--color-warning);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--color-error);
            color: var(--color-error);
        }

        /* ================================================================
           TYAZA APPLICATION SPECIFIC STYLES
           ================================================================ */

        /* Cosmic Background */
        .app-background {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
            background: var(--color-surface-950);
        }

        .app-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 60% 10%, rgba(110, 231, 183, 0.05) 0%, transparent 40%),
                radial-gradient(ellipse at 40% 90%, rgba(139, 92, 246, 0.08) 0%, transparent 45%);
            animation: cosmicDrift 40s ease-in-out infinite;
        }

        .app-background::after {
            content: '';
            position: absolute;
            inset: 0;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            opacity: 0.025;
            pointer-events: none;
        }

        .stars-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: var(--radius-full);
            animation: starTwinkle 3s ease-in-out infinite;
        }

        .star.large {
            width: 3px;
            height: 3px;
        }

        .star.medium {
            width: 2px;
            height: 2px;
        }

        @keyframes cosmicDrift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2%, 1%) rotate(0.5deg); }
            50% { transform: translate(-1%, 2%) rotate(-0.5deg); }
            75% { transform: translate(1%, -1%) rotate(0.3deg); }
        }

        @keyframes starTwinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.3); }
        }

        /* ================================================================
           MAIN APPLICATION LAYOUT
           ================================================================ */
        .app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: var(--z-fixed);
        }

        /* ----------------------------------------------------------------
           SIDEBAR
           ---------------------------------------------------------------- */
        .app-sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(10, 6, 18, 0.92);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-right: 1px solid rgba(139, 92, 246, 0.15);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: var(--z-fixed);
            transition: transform var(--transition-slow);
        }

        .sidebar-header {
            padding: var(--space-5);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-close {
            display: none;
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-surface-700);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }

        .sidebar-close:hover {
            background: var(--color-surface-600);
            color: var(--color-text-primary);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
        }

        .sidebar-brand img {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            object-fit: contain;
            opacity: 0.7;
            transition: opacity var(--transition-fast);
        }

        .sidebar-brand img:hover {
            opacity: 1;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow-glow-primary);
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        .logo-text {
            flex: 1;
        }

        .logo-title {
            font-family: var(--font-display);
            font-size: var(--text-xl);
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .logo-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 2px;
        }

        /* Sidebar Sections */
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .sidebar-section-title {
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0 var(--space-2);
        }

        /* New Chat Button */
        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            width: 100%;
            padding: var(--space-4);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-xl);
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(236, 72, 153, 0.15));
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-primary);
        }

        /* Settings Card */
        .settings-card {
            background: var(--color-surface-800);
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
        }

        /* Voice Controls */
        .voice-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }

        .voice-control-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .voice-control-label {
            display: flex;
            justify-content: space-between;
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
        }

        .voice-control-value {
            color: var(--color-primary-300);
            font-weight: 500;
        }

        /* History List */
        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            min-height: 150px;
        }

        .history-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: var(--space-3);
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
            max-height: 60px;
            overflow: hidden;
        }

        .history-item:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .history-item.active {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            border-left: 3px solid var(--color-secondary-400);
        }

        .history-title {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
        }

        .history-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        .history-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            color: var(--color-text-muted);
            text-align: center;
            gap: var(--space-2);
        }

        .history-empty i {
            font-size: 2rem;
            opacity: 0.5;
        }

        /* Info Card */
        .info-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
            line-height: 1.7;
        }

        .info-card-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-secondary-300);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .info-card-logo {
            width: 24px;
            height: 24px;
            margin-right: var(--space-2);
        }

        .info-card-divider {
            height: 1px;
            background: rgba(139, 92, 246, 0.1);
            margin: var(--space-3) 0;
        }

        .info-highlight {
            color: var(--color-primary-300);
            font-weight: 500;
        }

        .info-card-footer {
            font-size: 0.65rem;
            color: var(--color-text-muted);
            text-align: center;
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid rgba(139, 92, 246, 0.1);
        }

        /* ----------------------------------------------------------------
           MAIN CHAT AREA
           ---------------------------------------------------------------- */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            overflow: hidden;
        }

        /* Chat Header */
        .chat-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            background: rgba(10, 6, 18, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            z-index: var(--z-sticky);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .menu-toggle {
            display: none;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            overflow: hidden;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-info h1 {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--color-accent-400);
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            background: var(--color-accent-400);
            border-radius: var(--radius-full);
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Messages Container */
        .messages-wrapper {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }

        .messages-wrapper::-webkit-scrollbar {
            width: 6px;
        }

        .messages-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-wrapper::-webkit-scrollbar-thumb {
            background: var(--color-surface-500);
            border-radius: var(--radius-full);
        }

        .messages-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--color-surface-400);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-icon {
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary-400), var(--color-secondary-400), var(--color-accent-400));
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            font-size: 4rem;
            color: white;
            margin-bottom: var(--space-8);
            box-shadow: var(--shadow-glow-primary), var(--shadow-glow-secondary);
            animation: morphShape 10s ease-in-out infinite, iconFloat 6s ease-in-out infinite;
            overflow: hidden;
        }

        .welcome-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes morphShape {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            33% { border-radius: 70% 30% 50% 50% / 30% 60% 40% 70%; }
            66% { border-radius: 30% 70% 40% 60% / 60% 30% 70% 40%; }
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-12px) rotate(2deg); }
        }

        .welcome-title {
            font-family: var(--font-display);
            font-size: var(--text-5xl);
            font-weight: 800;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-primary-300), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
            letter-spacing: -0.03em;
        }

        .welcome-subtitle {
            font-family: var(--font-serif);
            font-size: var(--text-xl);
            font-style: italic;
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-6);
        }

        .welcome-quote {
            font-family: var(--font-serif);
            font-size: var(--text-lg);
            color: var(--color-text-tertiary);
            max-width: 500px;
            line-height: 1.9;
            padding: var(--space-5) var(--space-8);
            background: rgba(26, 20, 51, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-8);
        }

        .welcome-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
            max-width: 600px;
        }

        .suggestion-btn {
            padding: var(--space-3) var(--space-5);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-family: inherit;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .suggestion-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--color-primary-500);
            color: var(--color-text-primary);
            transform: translateY(-2px);
        }

        /* Message Styles */
        .message {
            display: flex;
            gap: var(--space-4);
            max-width: 85%;
            animation: messageSlideIn 0.4s ease-out;
        }

        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            font-weight: 600;
            font-size: var(--text-base);
            flex-shrink: 0;
            overflow: hidden;
        }

        .message.user .message-avatar {
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            color: var(--color-text-muted);
        }

        .message.assistant .message-avatar {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .message.user .message-content {
            align-items: flex-end;
        }

        .message-bubble {
            padding: var(--space-4) var(--space-5);
            line-height: 1.75;
            font-size: var(--text-base);
            word-wrap: break-word;
        }

        .message.user .message-bubble {
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-xl) var(--radius-xl) var(--radius-sm) var(--radius-xl);
            color: var(--color-text-primary);
        }

        .message.assistant .message-bubble {
            background: rgba(26, 20, 51, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl) var(--radius-xl) var(--radius-xl) var(--radius-sm);
            color: var(--color-text-secondary);
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: 0 var(--space-2);
        }

        .message-time {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        .message-actions {
            display: flex;
            gap: var(--space-1);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-md);
            color: var(--color-text-muted);
            font-size: var(--text-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .message-action:hover {
            background: var(--color-surface-600);
            color: var(--color-text-primary);
            transform: scale(1.1);
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .typing-avatar {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            color: white;
            font-weight: 600;
            overflow: hidden;
        }

        .typing-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .typing-bubble {
            display: flex;
            gap: 6px;
            padding: var(--space-4) var(--space-5);
            background: rgba(26, 20, 51, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: var(--radius-full);
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { background: var(--color-primary-400); }
        .typing-dot:nth-child(2) { background: var(--color-secondary-400); animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { background: var(--color-accent-400); animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* ----------------------------------------------------------------
           INPUT AREA
           ---------------------------------------------------------------- */
        .input-area {
            padding: var(--space-5) var(--space-6) var(--space-6);
            background: linear-gradient(to top, var(--color-surface-950) 50%, transparent);
            position: relative;
        }

        .input-container {
            max-width: var(--content-max-width);
            margin: 0 auto;
            background: rgba(26, 20, 51, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-2) var(--space-2) var(--space-2) var(--space-5);
            display: flex;
            align-items: flex-end;
            gap: var(--space-3);
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-fast);
        }

        .input-container:focus-within {
            border-color: var(--color-primary-500);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        .input-textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: var(--text-base);
            padding: var(--space-4) 0;
            resize: none;
            max-height: 150px;
            min-height: 24px;
            line-height: 1.6;
        }

        .input-textarea::placeholder {
            color: var(--color-text-muted);
        }

        .input-actions {
            display: flex;
            gap: var(--space-2);
            padding-bottom: var(--space-2);
        }

        .input-btn {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            border: none;
            font-size: 1.1rem;
        }

        .voice-btn {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(236, 72, 153, 0.3);
            color: var(--color-secondary-400);
        }

        .voice-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: var(--color-secondary-500);
            color: white;
            animation: micPulse 1.5s infinite;
            border-color: var(--color-secondary-500);
        }

        @keyframes micPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.5); }
            50% { box-shadow: 0 0 0 20px rgba(236, 72, 153, 0); }
        }

        .send-btn {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg), var(--shadow-glow-primary);
        }

        .send-btn:active:not(:disabled) {
            transform: scale(0.95);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .voice-status {
            text-align: center;
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            min-height: 24px;
            margin-top: var(--space-3);
            transition: color var(--transition-fast);
        }

        .voice-status.active {
            color: var(--color-secondary-400);
        }

        /* ----------------------------------------------------------------
           SCROLL TO BOTTOM BUTTON
           ---------------------------------------------------------------- */
        .scroll-bottom {
            position: absolute;
            bottom: 100px;
            right: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(26, 20, 51, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all var(--transition-slow);
            z-index: 40;
            box-shadow: var(--shadow-glow-secondary);
        }

        .scroll-bottom.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .scroll-bottom:hover {
            background: rgba(236, 72, 153, 0.2);
            color: var(--color-text-primary);
        }

        /* ----------------------------------------------------------------
           STT OVERLAY
           ---------------------------------------------------------------- */
        .stt-overlay {
            position: fixed;
            inset: 0;
            background: rgba(3, 0, 20, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-slow);
        }

        .stt-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .stt-modal {
            background: rgba(26, 20, 51, 0.98);
            border: 2px solid var(--color-secondary-500);
            border-radius: var(--radius-2xl);
            padding: var(--space-10);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-6);
            box-shadow: var(--shadow-glow-secondary), var(--shadow-xl);
            transform: scale(0.9);
            transition: transform var(--transition-bounce);
            max-width: 90vw;
        }

        .stt-overlay.active .stt-modal {
            transform: scale(1);
        }

        .stt-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 80px;
        }

        .stt-bar {
            width: 8px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            animation: sttWave 0.7s ease-in-out infinite alternate;
        }

        .stt-bar:nth-child(1) { height: 25px; animation-delay: 0s; }
        .stt-bar:nth-child(2) { height: 40px; animation-delay: 0.1s; }
        .stt-bar:nth-child(3) { height: 60px; animation-delay: 0.2s; }
        .stt-bar:nth-child(4) { height: 45px; animation-delay: 0.3s; }
        .stt-bar:nth-child(5) { height: 70px; animation-delay: 0.4s; }
        .stt-bar:nth-child(6) { height: 35px; animation-delay: 0.5s; }
        .stt-bar:nth-child(7) { height: 50px; animation-delay: 0.6s; }
        .stt-bar:nth-child(8) { height: 30px; animation-delay: 0.7s; }

        @keyframes sttWave {
            from { height: 15px; transform: scaleY(1); }
            to { height: 70px; transform: scaleY(1); }
        }

        .stt-text {
            font-size: var(--text-xl);
            color: var(--color-text-secondary);
            text-align: center;
            max-width: 400px;
            min-height: 30px;
        }

        .stt-hint {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }

        /* ----------------------------------------------------------------
           LOADING SCREEN
           ---------------------------------------------------------------- */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--color-surface-950);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-6);
            z-index: var(--z-loading);
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            font-size: 3rem;
            color: white;
            animation: logoFloat 3s ease-in-out infinite;
            box-shadow: var(--shadow-glow-primary);
            overflow: hidden;
        }

        .loading-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-surface-600);
            border-top-color: var(--color-primary-500);
            border-radius: var(--radius-full);
            animation: spin 0.8s linear infinite;
        }

        .loading-text {
            font-size: var(--text-base);
            color: var(--color-text-tertiary);
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            animation: loadingProgress 2s ease-in-out infinite;
        }

        @keyframes loadingProgress {
            0% { width: 0%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 0%; margin-left: 100%; }
        }

        /* ----------------------------------------------------------------
           SIDEBAR OVERLAY (MOBILE)
           ---------------------------------------------------------------- */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: calc(var(--z-fixed) - 1);
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-slow);
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* ================================================================
           ADVANCED FEATURES STYLES
           ================================================================ */

        /* Crisis Resources */
        .crisis-resources {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            max-height: 300px;
            overflow-y: auto;
            padding-right: var(--space-2);
        }
        
        .crisis-resource {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
        }
        
        .crisis-resource:hover {
            border-color: var(--color-error);
            transform: translateX(4px);
        }
        
        .crisis-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface-600);
            border-radius: var(--radius-md);
            font-size: 1.2rem;
        }
        
        .crisis-info {
            flex: 1;
        }
        
        .crisis-name {
            font-weight: 600;
            color: var(--color-text-primary);
            font-size: var(--text-sm);
        }
        
        .crisis-number {
            font-size: var(--text-lg);
            font-weight: 700;
            color: var(--color-error);
            line-height: 1.3;
        }
        
        .crisis-desc {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .crisis-call {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-error);
            color: white;
            border-radius: var(--radius-full);
            text-decoration: none;
            transition: all var(--transition-fast);
        }
        
        .crisis-call:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--color-error);
        }
        
        .crisis-floating-btn {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-error);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
            z-index: 100;
            transition: all var(--transition-fast);
            animation: crisisFloat 3s ease-in-out infinite;
        }
        
        .crisis-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6);
        }
        
        .crisis-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-full);
            background: var(--color-error);
            opacity: 0.6;
            animation: crisisPulse 2s ease-out infinite;
        }
        
        @keyframes crisisPulse {
            0% { transform: scale(1); opacity: 0.6; }
            70% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1.5); opacity: 0; }
        }
        
        @keyframes crisisFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Emotional Analytics */
        .analytics-dashboard {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-4);
            overflow: hidden;
        }
        
        .analytics-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface-700);
            cursor: pointer;
        }
        
        .analytics-header h3 {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-secondary);
        }
        
        .analytics-content {
            padding: var(--space-4);
            transition: all var(--transition-fast);
        }
        
        .analytics-content.collapsed {
            display: none;
        }
        
        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-2);
            margin-top: var(--space-3);
        }
        
        .stat-item {
            background: var(--color-surface-700);
            padding: var(--space-2);
            border-radius: var(--radius-md);
            text-align: center;
        }
        
        .stat-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }
        
        .stat-value {
            font-size: var(--text-lg);
            font-weight: 600;
            color: var(--color-primary-300);
        }
        
        .emotion-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            margin-right: var(--space-1);
        }

        /* Meditation Library */
        .meditation-library {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-xl);
            margin-top: var(--space-4);
            overflow: hidden;
        }
        
        .meditation-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--gradient-primary);
            cursor: pointer;
        }
        
        .meditation-header h3 {
            font-size: var(--text-sm);
            font-weight: 600;
            color: white;
        }
        
        .meditation-content {
            padding: var(--space-4);
            max-height: 400px;
            overflow-y: auto;
            transition: all var(--transition-fast);
        }
        
        .meditation-content.collapsed {
            display: none;
        }
        
        .meditation-filters {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }
        
        .meditation-grid {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }
        
        .meditation-card {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
        }
        
        .meditation-card:hover {
            border-color: var(--color-primary-500);
            transform: translateX(4px);
        }
        
        .meditation-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            font-size: 1.2rem;
            color: white;
        }
        
        .meditation-info {
            flex: 1;
        }
        
        .meditation-title {
            font-weight: 500;
            color: var(--color-text-primary);
            font-size: var(--text-sm);
            margin-bottom: 4px;
        }
        
        .meditation-meta {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
        }
        
        .meditation-duration {
            color: var(--color-text-muted);
        }
        
        .meditation-level {
            padding: 2px 8px;
            border-radius: var(--radius-full);
            text-transform: capitalize;
        }
        
        .meditation-level.beginner {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }
        
        .meditation-level.intermediate {
            background: rgba(245, 158, 11, 0.2);
            color: var(--color-warning);
        }
        
        .meditation-play {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border: none;
            border-radius: var(--radius-full);
            color: white;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .meditation-play:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glow-primary);
        }
        
        .meditation-player {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 300px;
            background: var(--color-surface-800);
            border: 1px solid var(--color-primary-500);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            z-index: 100;
            box-shadow: var(--shadow-glow-primary);
        }
        
        .meditation-timer {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: var(--color-primary-300);
            text-align: center;
            margin: var(--space-4) 0;
            font-family: monospace;
        }
        
        .meditation-instruction {
            text-align: center;
            padding: var(--space-4);
            background: var(--color-surface-700);
            border-radius: var(--radius-lg);
            margin: var(--space-4) 0;
            font-size: var(--text-lg);
            color: var(--color-text-primary);
            animation: fadeInOut 1s ease;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        
        .meditation-progress {
            width: 100%;
            height: 4px;
            background: var(--color-surface-600);
            border-radius: var(--radius-full);
            margin: var(--space-4) 0;
            overflow: hidden;
        }
        
        .meditation-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 1s linear;
        }
        
        .meditation-controls {
            display: flex;
            justify-content: center;
            gap: var(--space-3);
        }
        
        .meditation-control {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--color-surface-700);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .meditation-control:hover {
            background: var(--color-primary-500);
            color: white;
            transform: scale(1.1);
        }
        
        .meditation-control.pause {
            background: var(--gradient-primary);
            color: white;
        }
        
        .meditation-quick-btn {
            position: fixed;
            bottom: 180px;
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-glow-primary);
            z-index: 99;
            transition: all var(--transition-fast);
        }
        
        .meditation-quick-btn:hover {
            transform: scale(1.1) rotate(180deg);
        }

        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--color-warning);
            color: var(--color-surface-950);
            padding: var(--space-3);
            text-align: center;
            font-size: var(--text-sm);
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform var(--transition-slow);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }
        
        .offline-banner.show {
            transform: translateY(0);
        }
        
        .offline-banner i {
            font-size: var(--text-base);
        }
        
        .offline-indicator {
            width: 8px;
            height: 8px;
            background: var(--color-warning);
            border-radius: var(--radius-full);
            animation: offlinePulse 2s infinite;
        }
        
        @keyframes offlinePulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.5); }
        }

        /* Voice Visualizer */
        .voice-visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            display: block;
        }
        
        .voice-visualizer.active {
            box-shadow: 0 0 20px var(--color-secondary-400);
        }
        
        .visualizer-container {
            position: relative;
            width: 100%;
        }
        
        .visualizer-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: var(--color-text-muted);
            font-size: var(--text-xs);
            background: rgba(0,0,0,0.5);
            padding: 2px 8px;
            border-radius: var(--radius-full);
        }

        /* ----------------------------------------------------------------
           RESPONSIVE STYLES
           ---------------------------------------------------------------- */
        @media (max-width: 1024px) {
            :root {
                --sidebar-width: 280px;
            }
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 85vw;
                --header-height: 56px;
            }

            .app-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                box-shadow: var(--shadow-xl);
                background: rgba(10, 6, 18, 0.98);
                backdrop-filter: none;
                -webkit-backdrop-filter: none;
                z-index: var(--z-modal);
            }

            .app-sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: block;
            }

            .sidebar-close {
                display: flex !important;
            }

            .sidebar-header {
                gap: var(--space-2);
            }

            .menu-toggle {
                display: flex !important;
            }

            .welcome-title {
                font-size: var(--text-4xl);
            }

            .welcome-subtitle {
                font-size: var(--text-lg);
            }

            .welcome-icon {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }

            .message {
                max-width: 92%;
            }

            .messages-wrapper {
                padding: var(--space-4);
            }

            .input-area {
                padding: var(--space-4);
            }

            .input-container {
                border-radius: var(--radius-xl);
                padding: var(--space-1) var(--space-1) var(--space-1) var(--space-4);
            }

            .input-btn {
                width: 48px;
                height: 48px;
            }

            .scroll-bottom {
                right: var(--space-4);
                bottom: 90px;
            }

            .chat-header {
                padding: 0 var(--space-4);
            }

            .welcome-screen {
                padding: var(--space-6);
            }

            .crisis-floating-btn,
            .meditation-quick-btn {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }
            
            .crisis-floating-btn {
                bottom: 90px;
                left: 10px;
            }
            
            .meditation-quick-btn {
                bottom: 150px;
                left: 10px;
            }
        }

        @media (max-width: 480px) {
            .welcome-suggestions {
                flex-direction: column;
                align-items: center;
            }

            .suggestion-btn {
                width: 100%;
                max-width: 280px;
            }
        }

        /* ----------------------------------------------------------------
           ANIMATION UTILITIES
           ---------------------------------------------------------------- */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        .animate-slide-down { animation: slideDown 0.3s ease-out; }
        .animate-scale-in { animation: scaleIn 0.2s ease-out; }
        .animate-bounce { animation: bounce 1s infinite; }
        .animate-pulse { animation: pulse 2s infinite; }
        .animate-spin { animation: spin 1s linear infinite; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* Focus States */
        :focus-visible {
            outline: 2px solid var(--color-primary-500);
            outline-offset: 2px;
        }

        /* Selection */
        ::selection {
            background: var(--color-primary-500);
            color: white;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-surface-500);
            border-radius: var(--radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-surface-400);
        }

        /* Print Styles */
        @media print {
            .app-background,
            .sidebar,
            .chat-header,
            .input-area,
            .scroll-bottom,
            .stt-overlay,
            .loading-screen,
            .crisis-floating-btn,
            .meditation-quick-btn {
                display: none !important;
            }

            .chat-main {
                width: 100%;
                height: auto;
                overflow: visible;
            }

            .messages-wrapper {
                overflow: visible;
                padding: 0;
            }

            .message {
                max-width: 100%;
                margin-bottom: 20px;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* ================================================================
           NEW FEATURES: PERSONALIZATION & WELLBEING
           ================================================================ */

        /* User Profile Modal */
        .profile-modal-content {
            min-width: 400px;
            max-width: 500px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-full);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: 700;
        }

        .profile-name-input {
            flex: 1;
        }

        .profile-name-input label {
            display: block;
            font-size: var(--text-sm);
            color: var(--color-text-muted);
            margin-bottom: var(--space-1);
        }

        .profile-name-input input {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-lg);
            font-weight: 600;
        }

        .profile-section {
            margin-bottom: var(--space-5);
        }

        .profile-section-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .profile-goals {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .profile-goal-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface-700);
            border-radius: var(--radius-lg);
        }

        .profile-goal-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary-500);
        }

        .profile-goal-text {
            flex: 1;
            font-size: var(--text-sm);
        }

        .profile-goal-input {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            background: var(--color-surface-600);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: var(--text-sm);
        }

        .add-goal-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3);
            background: transparent;
            border: 2px dashed var(--color-surface-500);
            border-radius: var(--radius-lg);
            color: var(--color-text-muted);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .add-goal-btn:hover {
            border-color: var(--color-primary-500);
            color: var(--color-primary-400);
        }

        /* Mood Tracker */
        .mood-tracker {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .mood-scale {
            display: flex;
            justify-content: space-between;
            gap: var(--space-2);
        }

        .mood-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 2px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mood-btn:hover {
            border-color: var(--color-primary-400);
            transform: translateY(-2px);
        }

        .mood-btn.selected {
            border-color: var(--color-primary-500);
            background: rgba(139, 92, 246, 0.2);
        }

        .mood-emoji {
            font-size: 1.5rem;
        }

        .mood-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        .mood-notes {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .mood-history {
            margin-top: var(--space-4);
        }

        .mood-history-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-3);
        }

        .mood-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-1);
        }

        .mood-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            font-size: var(--text-xs);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .mood-day:hover {
            transform: scale(1.1);
        }

        .mood-day-label {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-align: center;
            padding: var(--space-2);
        }

        .mood-level-1 { background: rgba(239, 68, 68, 0.3); }
        .mood-level-2 { background: rgba(245, 158, 11, 0.3); }
        .mood-level-3 { background: rgba(234, 179, 8, 0.3); }
        .mood-level-4 { background: rgba(34, 197, 94, 0.3); }
        .mood-level-5 { background: rgba(16, 185, 129, 0.3); }

        /* Breathing Exercise */
        .breathing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-6);
            padding: var(--space-6);
        }

        .breathing-circle {
            width: 200px;
            height: 200px;
            border-radius: var(--radius-full);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-glow-primary);
            transition: transform 4s ease-in-out;
        }

        .breathing-circle.inhale {
            transform: scale(1.3);
            animation: breatheIn 4s ease-in-out;
        }

        .breathing-circle.hold {
            transform: scale(1.3);
        }

        .breathing-circle.exhale {
            transform: scale(1);
            animation: breatheOut 4s ease-in-out;
        }

        @keyframes breatheIn {
            0% { transform: scale(1); }
            100% { transform: scale(1.3); }
        }

        @keyframes breatheOut {
            0% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .breathing-text {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: white;
            text-align: center;
        }

        .breathing-instruction {
            font-size: var(--text-lg);
            color: var(--color-text-secondary);
            text-align: center;
        }

        .breathing-timer {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: var(--color-primary-300);
        }

        .breathing-patterns {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            justify-content: center;
        }

        .breathing-pattern-btn {
            padding: var(--space-2) var(--space-4);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .breathing-pattern-btn:hover,
        .breathing-pattern-btn.active {
            background: var(--color-primary-600);
            border-color: var(--color-primary-400);
            color: white;
        }

        /* Affirmations */
        .affirmation-card {
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-8);
            text-align: center;
            box-shadow: var(--shadow-glow-primary);
            position: relative;
            overflow: hidden;
        }

        .affirmation-card::before {
            content: '"';
            position: absolute;
            top: -20px;
            left: 20px;
            font-size: 150px;
            color: rgba(255, 255, 255, 0.1);
            font-family: serif;
        }

        .affirmation-text {
            font-size: var(--text-xl);
            font-weight: 600;
            color: white;
            line-height: var(--leading-relaxed);
            position: relative;
            z-index: 1;
        }

        .affirmation-author {
            margin-top: var(--space-4);
            font-size: var(--text-sm);
            color: rgba(255, 255, 255, 0.8);
        }

        .affirmation-actions {
            display: flex;
            justify-content: center;
            gap: var(--space-3);
            margin-top: var(--space-4);
        }

        .affirmation-nav {
            display: flex;
            justify-content: center;
            gap: var(--space-2);
            margin-top: var(--space-4);
        }

        .affirmation-nav-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .affirmation-nav-btn:hover {
            background: var(--color-surface-600);
            color: var(--color-text-primary);
        }

        /* Gratitude Journal */
        .gratitude-input {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .gratitude-item-input {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .gratitude-number {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            color: white;
            font-size: var(--text-sm);
            font-weight: 600;
        }

        .gratitude-text-input {
            flex: 1;
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-size: var(--text-base);
        }

        .gratitude-saved-list {
            margin-top: var(--space-6);
        }

        .gratitude-saved-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-3);
        }

        .gratitude-saved-item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface-700);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-2);
        }

        .gratitude-date {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        /* Progress Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: var(--space-4);
        }

        .dashboard-card {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
        }

        .dashboard-card-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .dashboard-stat {
            display: flex;
            align-items: baseline;
            gap: var(--space-2);
        }

        .dashboard-stat-value {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: var(--color-primary-300);
        }

        .dashboard-stat-label {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }

        .emotion-chart {
            display: flex;
            align-items: flex-end;
            gap: var(--space-1);
            height: 100px;
            padding: var(--space-2) 0;
        }

        .emotion-bar {
            flex: 1;
            background: var(--gradient-primary);
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            min-height: 10px;
            transition: height var(--transition-slow);
        }

        .streak-card {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .streak-icon {
            font-size: 3rem;
        }

        .streak-info {
            flex: 1;
        }

        .streak-count {
            font-size: var(--text-3xl);
            font-weight: 700;
            color: var(--color-warning);
        }

        .streak-label {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }

        /* Feature Tabs in Modal */
        .feature-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-surface-600);
            padding-bottom: var(--space-2);
        }

        .feature-tab {
            padding: var(--space-2) var(--space-4);
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            font-size: var(--text-sm);
            cursor: pointer;
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .feature-tab:hover {
            background: var(--color-surface-700);
            color: var(--color-text-secondary);
        }

        .feature-tab.active {
            background: var(--color-primary-600);
            color: white;
        }

        .feature-content {
            display: none;
        }

        .feature-content.active {
            display: block;
        }

        /* Header Wellbeing Button */
        .wellbeing-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            min-width: 44px;
            min-height: 44px;
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .wellbeing-btn:hover {
            background: var(--color-surface-600);
            border-color: var(--color-primary-400);
            color: var(--color-primary-300);
        }

        @media (max-width: 480px) {
            .wellbeing-btn {
                padding: var(--space-2);
                font-size: var(--text-xs);
                min-width: 40px;
                min-height: 40px;
            }
            .wellbeing-btn span {
                display: none;
            }
        }

        @media (min-width: 481px) and (max-width: 768px) {
            .wellbeing-btn {
                padding: var(--space-2) var(--space-3);
                font-size: var(--text-sm);
            }
        }

        /* Safety Check-in */
        .checkin-prompt {
            position: fixed;
            bottom: var(--space-6);
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface-800);
            border: 1px solid var(--color-primary-500);
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-glow-primary);
            z-index: 50;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .checkin-prompt-text {
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
        }

        .checkin-yes, .checkin-no {
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .checkin-yes {
            background: var(--color-success);
            color: white;
            border: none;
        }

        .checkin-no {
            background: transparent;
            color: var(--color-text-muted);
            border: 1px solid var(--color-surface-500);
        }

        .checkin-yes:hover {
            background: var(--color-primary-500);
        }

        .checkin-no:hover {
            border-color: var(--color-text-muted);
            color: var(--color-text-secondary);
        }
    </style>
</head>
<body>
    <!-- Application Root -->
    <div id="app">
        <!-- Cosmic Background -->
        <div class="app-background">
            <div class="stars-container" id="starsContainer"></div>
        </div>

        <!-- Sidebar Overlay (Mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Main Layout -->
        <div class="app-layout">
            <!-- Sidebar -->
            <aside class="app-sidebar" id="sidebar">
                <!-- Header -->
                <div class="sidebar-header">
                    <div class="logo-container">
                        <div class="logo-icon">
                            <img src="tyaza-logo.png" alt="TYAZA">
                        </div>
                        <div class="logo-text">
                            <div class="logo-title">TYAZA</div>
                            <div class="logo-subtitle">Umuvugizi w'Umutima</div>
                        </div>
                    </div>
                    <div class="sidebar-brand">
                        <img src="kivura-logo.png" alt="Kivura Labs" title="Powered by Kivura Labs">
                    </div>
                    <button class="sidebar-close" id="sidebarClose" aria-label="Funga">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="sidebar-content">
                    <!-- New Chat Button -->
                    <button class="new-chat-btn" id="newChatBtn">
                        <span>â¨</span> Ikiganiro Gishya
                    </button>

                    <!-- AI Model Selection (hidden from UI) -->
                    <div class="sidebar-section" style="display: none;">
                        <div class="sidebar-section-title">Ubugeni bw'Ikoranabuhanga</div>
                        <div class="settings-card">
                            <select class="select" id="modelSelect">
                                <option value="gpt-4o-mini">GPT-4o Mini Â· Byoroshye</option>
                                <option value="claude-3-haiku">Claude 3 Haiku Â· Bishya</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash Â· Flax</option>
                                <option value="gpt-4o">GPT-4o Â· Byisonga</option>
                            </select>
                        </div>
                    </div>

                    <!-- Voice Settings -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Amajwi & Mikorofoni</div>
                        <div class="settings-card">
                            <div class="settings-row" style="margin-bottom: var(--space-4);">
                                <button class="btn btn-secondary btn-block" id="micTestBtn">
                                    <span>ð¤</span> Genzura Mikorofoni
                                </button>
                            </div>
                            <div class="settings-row" style="margin-bottom: var(--space-4);">
                                <label class="settings-label">Ijwi</label>
                                <select class="select" id="voiceSelect">
                                    <option value="Google UK English Female">ijwi ry'umugore (UK)</option>
                                    <option value="Google UK English Male">ijwi ry'umugabo (UK)</option>
                                    <option value="Samantha">Samantha Â· ryorohe</option>
                                    <option value="Microsoft Zira">Microsoft Zira</option>
                                    <option value="Google US English">US English</option>
                                </select>
                            </div>
                            <div class="voice-controls">
                                <div class="voice-control-item">
                                    <div class="voice-control-label">
                                        <span>Umurenge</span>
                                        <span class="voice-control-value" id="rateValue">0.9</span>
                                    </div>
                                    <input type="range" class="slider" id="rateSlider" min="0.5" max="1.5" step="0.05" value="0.9">
                                </div>
                                <div class="voice-control-item">
                                    <div class="voice-control-label">
                                        <span>Ibarura</span>
                                        <span class="voice-control-value" id="pitchValue">1.0</span>
                                    </div>
                                    <input type="range" class="slider" id="pitchSlider" min="0.5" max="2" step="0.05" value="1.0">
                                </div>
                            </div>
                            <div class="settings-row" style="margin-top: var(--space-4);">
                                <button class="btn btn-secondary btn-block" id="previewBtn">
                                    <span>ð</span> Subira ijwi
                                </button>
                            </div>
                            <div class="settings-row" style="margin-top: var(--space-3);">
                                <label class="checkbox-label">
                                    <input type="checkbox" class="checkbox" id="autoTTS" checked>
                                    Soma igisubizo mu ijwi
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Settings -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Imyifatire</div>
                        <div class="settings-card">
                            <div class="settings-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" class="checkbox" id="soundEffects" checked>
                                    Imivugo y'umuziki
                                </label>
                            </div>
                            <div class="settings-row" style="margin-top: var(--space-3);">
                                <label class="checkbox-label">
                                    <input type="checkbox" class="checkbox" id="animations" checked>
                                    Ibinyuzwamo
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Encryption Settings -->
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">Umutekano</div>
                        <div class="settings-card">
                            <div class="settings-row">
                                <label class="checkbox-label">
                                    <input type="checkbox" class="checkbox" id="enableEncryption">
                                    <i class="fas fa-lock"></i> Encryption end-to-end
                                </label>
                                <div class="text-xs text-muted" style="margin-top: var(--space-2);">
                                    Ibice byawe byose bizakingwa
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat History -->
                    <div class="sidebar-section" style="flex: 1; min-height: 0;">
                        <div class="sidebar-section-title" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>ð Amateka</span>
                            <button class="btn btn-ghost btn-sm" id="clearHistory">Hanagura</button>
                        </div>
                        <div class="history-list" id="historyList">
                            <div class="history-empty">
                                <i>ð­</i>
                                <span>Nta mateka</span>
                            </div>
                        </div>
                    </div>

                    <!-- Info Card -->
                    <div class="info-card">
                        <div class="info-card-title" style="display: flex; align-items: center; gap: 8px;">
                            <img src="kivura-logo.png" alt="Kivura Labs" style="width: 24px; height: 24px; border-radius: 4px;"> KIVURA LABS
                        </div>
                        <div>
                            <span class="info-highlight">Intego:</span> AI ifasha mu 
                            by'umutekano mu mutwe
                        </div>
                        <div class="info-card-divider"></div>
                        <div class="info-card-title" style="font-size: var(--text-xs);">
                            ð¤ TYAZA v1.0
                        </div>
                        <div>Umuvugizi w'Umutima â AI therapy mu Kinyarwanda</div>
                        <div class="info-card-footer">
                            Â© 2026 Kivura Labs Â· Rwanda<br>
                            <span style="font-size: 10px; color: var(--color-text-muted);">Yves HIRWA TUYISHIME - CEO</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Chat Area -->
            <main class="chat-main">
                <!-- Header -->
                <header class="chat-header">
                    <div class="header-left">
                        <button class="btn btn-icon btn-ghost menu-toggle" id="menuToggle">
                            <i class="fas fa-bars"></i>
                        </button>
                        <div class="chat-title">
                            <div class="chat-avatar">
                                <img src="tyaza-logo.png" alt="TYAZA">
                            </div>
                            <div class="chat-info">
                                <h1>TYAZA</h1>
                                <div class="chat-status">
                                    <span class="status-indicator"></span>
                                    <span id="connectionStatus">Irereye</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <!-- Wellbeing Button -->
                        <button class="wellbeing-btn" id="wellbeingBtn">
                            <i class="fas fa-heart"></i>
                            <span>Umutima</span>
                        </button>
                        <!-- Export Dropdown -->
                        <div class="dropdown" id="exportDropdown">
                            <button class="btn btn-icon btn-ghost" id="exportTrigger">
                                <i class="fas fa-download"></i>
                            </button>
                            <div class="dropdown-menu">
                                <div class="dropdown-item" data-format="json">
                                    <i class="fas fa-code"></i> JSON
                                </div>
                                <div class="dropdown-item" data-format="txt">
                                    <i class="fas fa-file-alt"></i> Text
                                </div>
                                <div class="dropdown-item" data-format="html">
                                    <i class="fas fa-file-code"></i> HTML
                                </div>
                                <div class="dropdown-item" data-format="csv">
                                    <i class="fas fa-table"></i> CSV
                                </div>
                                <div class="dropdown-divider"></div>
                                <div class="dropdown-item" data-format="encrypted">
                                    <i class="fas fa-lock"></i> Encrypted
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-icon btn-ghost tooltip" data-tooltip="Injiza chat" id="importChat">
                            <i class="fas fa-upload"></i>
                        </button>
                        <button class="btn btn-icon btn-ghost tooltip" data-tooltip="Hanagura chat" id="clearChat">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </header>

                <!-- Messages -->
                <div class="messages-wrapper" id="messagesWrapper">
                    <!-- Welcome Screen -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-icon">
                            <img src="tyaza-logo.png" alt="TYAZA">
                        </div>
                        <h1 class="welcome-title">TYAZA</h1>
                        <p class="welcome-subtitle">igisubizo cy'umutima</p>
                        <div class="welcome-quote" id="welcomeQuote">
                            "Ndi hano kugira nkugire. Buri mwanya, buri jambo â<br>
                            byakiriwe mu mahoro n'igondero."
                        </div>
                        <div class="welcome-suggestions">
                            <button class="suggestion-btn" data-prompt="ndashaka kuvuga">ð¬ Ndashaka kuvuga</button>
                            <button class="suggestion-btn" data-prompt="mfite ibibazo">ð Mfite ibibazo</button>
                            <button class="suggestion-btn" data-prompt="ngomba inkunga">ð¤ Ngomba inkunga</button>
                            <button class="suggestion-btn" data-prompt="narushijeho">ð Narushijeho</button>
                        </div>
                    </div>
                </div>

                <!-- Scroll to Bottom -->
                <button class="scroll-bottom" id="scrollBottom">
                    <i class="fas fa-arrow-down"></i>
                    subira hasi
                </button>

                <!-- Input Area -->
                <div class="input-area">
                    <div class="input-container">
                        <textarea 
                            class="input-textarea" 
                            id="messageInput" 
                            placeholder="sangiza icyo utekereza..." 
                            rows="1"
                        ></textarea>
                        <div class="input-actions">
                            <button class="input-btn voice-btn tooltip" data-tooltip="Soma inyuguti" id="voiceInputBtn">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="input-btn send-btn tooltip" data-tooltip="Tuma ubutumwa" id="sendBtn" disabled>
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    <div class="voice-status" id="voiceStatus"></div>
                </div>
            </main>
        </div>

        <!-- STT Overlay -->
        <div class="stt-overlay" id="sttOverlay">
            <div class="stt-modal">
                <canvas class="voice-visualizer" id="voiceVisualizer" width="300" height="100"></canvas>
                <div class="stt-visualizer">
                    <span class="stt-bar"></span>
                    <span class="stt-bar"></span>
                    <span class="stt-bar"></span>
                    <span class="stt-bar"></span>
                    <span class="stt-bar"></span>
                    <span class="stt-bar"></span>
                    <span class="stt-bar"></span>
                    <span class="stt-bar"></span>
                </div>
                <div class="stt-text" id="sttText">ndakumva...</div>
                <div class="stt-hint">soma ugire icyo uhambaro</div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading-screen" id="loadingScreen">
            <div class="loading-logo">
                <img src="tyaza-logo.png" alt="TYAZA">
            </div>
            <div class="spinner"></div>
            <div class="loading-text">Ihuza kuri Tyaza...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar"></div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>

        <!-- Wellbeing Modal -->
        <div class="modal-backdrop" id="wellbeingModal">
            <div class="modal active profile-modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">ð Ubuzima bw'Umutima</h3>
                    <button class="modal-close" id="wellbeingClose">&times;</button>
                </div>

                <div class="feature-tabs">
                    <button class="feature-tab active" data-tab="profile">
                        <i class="fas fa-user"></i> Profile
                    </button>
                    <button class="feature-tab" data-tab="mood">
                        <i class="fas fa-smile"></i> Imimerere
                    </button>
                    <button class="feature-tab" data-tab="breathing">
                        <i class="fas fa-wind"></i> Impessaha
                    </button>
                    <button class="feature-tab" data-tab="affirmation">
                        <i class="fas fa-star"></i> Ibyiringitungo
                    </button>
                    <button class="feature-tab" data-tab="gratitude">
                        <i class="fas fa-heart"></i> Ibyishimo
                    </button>
                    <button class="feature-tab" data-tab="progress">
                        <i class="fas fa-chart-line"></i> Ibitekerezo
                    </button>
                </div>

                <!-- Profile Tab -->
                <div class="feature-content active" id="tab-profile">
                    <div class="profile-header">
                        <div class="profile-avatar-large" id="profileAvatar">J</div>
                        <div class="profile-name-input">
                            <label>Izina ryawe</label>
                            <input type="text" id="userNameInput" placeholder="Injira izina ryawe...">
                        </div>
                    </div>

                    <div class="profile-section">
                        <div class="profile-section-title">
                            <i class="fas fa-bullseye"></i> Ibite goals byawe
                        </div>
                        <div class="profile-goals" id="profileGoals">
                            <div class="profile-goal-item">
                                <input type="checkbox" checked disabled>
                                <span class="profile-goal-text">Kuvuga neza ku byanjye</span>
                            </div>
                            <div class="profile-goal-item">
                                <input type="checkbox" checked disabled>
                                <span class="profile-goal-text">Kwigira impuhwe</span>
                            </div>
                            <div class="profile-goal-item">
                                <input type="checkbox" checked disabled>
                                <span class="profile-goal-text">Kugira amahoro</span>
                            </div>
                        </div>
                        <button class="add-goal-btn" id="addGoalBtn">
                            <i class="fas fa-plus"></i> Ongeraho goal
                        </button>
                    </div>

                    <button class="btn btn-primary btn-block" id="saveProfileBtn">
                        <i class="fas fa-save"></i> Bika Profile
                    </button>
                </div>

                <!-- Mood Tab -->
                <div class="feature-content" id="tab-mood">
                    <div class="mood-tracker">
                        <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                            Ubu umerera gute? Hitamo ikomere yemerera:
                        </p>

                        <div class="mood-scale" id="moodScale">
                            <button class="mood-btn" data-mood="1">
                                <span class="mood-emoji">ð¢</span>
                                <span class="mood-label">Byacye</span>
                            </button>
                            <button class="mood-btn" data-mood="2">
                                <span class="mood-emoji">ð</span>
                                <span class="mood-label">Ntacyo</span>
                            </button>
                            <button class="mood-btn" data-mood="3">
                                <span class="mood-emoji">ð</span>
                                <span class="mood-label">Harinkomeye</span>
                            </button>
                            <button class="mood-btn" data-mood="4">
                                <span class="mood-emoji">ð</span>
                                <span class="mood-label">Ni meza</span>
                            </button>
                            <button class="mood-btn" data-mood="5">
                                <span class="mood-emoji">ð</span>
                                <span class="mood-label">Neza cyane</span>
                            </button>
                        </div>

                        <textarea class="mood-notes" id="moodNotes" placeholder="Andika icyo uhererwa... (ikinywereri)"></textarea>

                        <button class="btn btn-primary btn-block" id="saveMoodBtn">
                            <i class="fas fa-save"></i> Bika Imimerere
                        </button>

                        <div class="mood-history">
                            <div class="mood-history-title">Imimerere y'icyumweru</div>
                            <div class="mood-calendar" id="moodCalendar">
                                <!-- Generated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Breathing Tab -->
                <div class="feature-content" id="tab-breathing">
                    <div class="breathing-container">
                        <div class="breathing-patterns">
                            <button class="breathing-pattern-btn active" data-pattern="4-7-8">4-7-8</button>
                            <button class="breathing-pattern-btn" data-pattern="4-4-4">4-4-4</button>
                            <button class="breathing-pattern-btn" data-pattern="5-5-5">5-5-5</button>
                            <button class="breathing-pattern-btn" data-pattern="box">Box</button>
                        </div>

                        <div class="breathing-circle" id="breathingCircle">
                            <div class="breathing-text" id="breathingText">Bite</div>
                        </div>

                        <div class="breathing-timer" id="breathingTimer">0</div>

                        <div class="breathing-instruction" id="breathingInstruction">
                            Kanda "Banzerereze" wishakiye gutangira
                        </div>

                        <button class="btn btn-primary btn-lg" id="startBreathingBtn">
                            <i class="fas fa-play"></i> Banzerereze
                        </button>
                    </div>
                </div>

                <!-- Affirmation Tab -->
                <div class="feature-content" id="tab-affirmation">
                    <div class="affirmation-card" id="affirmationCard">
                        <div class="affirmation-text" id="affirmationText">
                            "Ndi uwizeye kugira nibura ibitego bimwe mu buzima"
                        </div>
                        <div class="affirmation-author" id="affirmationAuthor">
                            â TYAZA
                        </div>
                    </div>

                    <div class="affirmation-actions">
                        <button class="btn btn-secondary" id="speakAffirmationBtn">
                            <i class="fas fa-volume-up"></i> Soma
                        </button>
                        <button class="btn btn-secondary" id="shareAffirmationBtn">
                            <i class="fas fa-share"></i> Bagirane
                        </button>
                    </div>

                    <div class="affirmation-nav">
                        <button class="affirmation-nav-btn" id="prevAffirmation">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="affirmationIndex" style="display: flex; align-items: center; color: var(--color-text-muted);">1 / 10</span>
                        <button class="affirmation-nav-btn" id="nextAffirmation">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

                <!-- Gratitude Tab -->
                <div class="feature-content" id="tab-gratitude">
                    <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                        Hambere nibuka bimwe ushaka kugaragariza ikigira cy'umutima:
                    </p>

                    <div class="gratitude-input" id="gratitudeInput">
                        <div class="gratitude-item-input">
                            <div class="gratitude-number">1</div>
                            <input type="text" class="gratitude-text-input" id="gratitude1" placeholder="Icyo ushaka kugaragariza...">
                        </div>
                        <div class="gratitude-item-input">
                            <div class="gratitude-number">2</div>
                            <input type="text" class="gratitude-text-input" id="gratitude2" placeholder="Icyo ushaka kugaragariza...">
                        </div>
                        <div class="gratitude-item-input">
                            <div class="gratitude-number">3</div>
                            <input type="text" class="gratitude-text-input" id="gratitude3" placeholder="Icyo ushaka kugaragariza...">
                        </div>
                    </div>

                    <button class="btn btn-primary btn-block" id="saveGratitudeBtn" style="margin-top: var(--space-4);">
                        <i class="fas fa-save"></i> Bika Ibyishimo
                    </button>

                    <div class="gratitude-saved-list" id="gratitudeSavedList">
                        <!-- Generated by JS -->
                    </div>
                </div>

                <!-- Progress Tab -->
                <div class="feature-content" id="tab-progress">
                    <div class="dashboard-grid">
                        <div class="dashboard-card">
                            <div class="dashboard-card-title">
                                <i class="fas fa-fire"></i> Imitsindo
                            </div>
                            <div class="streak-card">
                                <div class="streak-icon">ð¥</div>
                                <div class="streak-info">
                                    <div class="streak-count" id="streakCount">0</div>
                                    <div class="streak-label">iminsi</div>
                                </div>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="dashboard-card-title">
                                <i class="fas fa-comments"></i> Ibibazo
                            </div>
                            <div class="dashboard-stat">
                                <span class="dashboard-stat-value" id="totalMessages">0</span>
                                <span class="dashboard-stat-label">byavuzwe</span>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="dashboard-card-title">
                                <i class="fas fa-smile"></i> Imimerere
                            </div>
                            <div class="dashboard-stat">
                                <span class="dashboard-stat-value" id="avgMood">-</span>
                                <span class="dashboard-stat-label">averaje</span>
                            </div>
                        </div>

                        <div class="dashboard-card">
                            <div class="dashboard-card-title">
                                <i class="fas fa-heart"></i> Ibyishimo
                            </div>
                            <div class="dashboard-stat">
                                <span class="dashboard-stat-value" id="gratitudeCount">0</span>
                                <span class="dashboard-stat-label">byabitswe</span>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card" style="margin-top: var(--space-4);">
                        <div class="dashboard-card-title">
                            <i class="fas fa-chart-area"></i> Imimerere y'icyumweru
                        </div>
                        <div class="emotion-chart" id="emotionChart">
                            <!-- Generated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden File Input for Import -->
        <input type="file" id="importFile" accept=".json,.txt,.tyaza,.html,.csv" style="display: none;">
    </div>

    <!-- Puter AI SDK -->
    <script>
        window.puter = null;
        window.puterError = null;
    </script>
    <script src="https://js.puter.com/v2/"></script>

    <!-- TYAZA Complete Application Script -->
    <script>
        /* ================================================================
           TYAZA v3.0 - COMPLETE INTEGRATED APPLICATION
           All Features: Crisis Resources, Emotional Analytics, 
           Encryption, Export/Import, Meditation Library, 
           Offline Storage, Voice Visualizer
           Built with love by Kivura Labs
           ================================================================ */

        (function() {
            'use strict';

            // ============================================================
            // UTILITY FUNCTIONS
            // ============================================================

            /**
             * Generate unique ID
             */
            function generateId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }

            /**
             * Escape HTML entities
             */
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            /**
             * Format date for display
             */
            function formatRelativeTime(timestamp) {
                const now = Date.now();
                const diff = now - timestamp;
                const minutes = Math.floor(diff / 60000);
                const hours = Math.floor(diff / 3600000);
                const days = Math.floor(diff / 86400000);

                if (minutes < 1) return 'none';
                if (minutes < 60) return `${minutes} min.`;
                if (hours < 24) return `${hours} hr.`;
                if (days < 7) return `${days} j.`;
                
                return new Date(timestamp).toLocaleDateString('rw-RW', {
                    day: 'numeric',
                    month: 'short'
                });
            }

            /**
             * Format message content
             */
            function formatMessageContent(text) {
                if (!text) return '';
                
                let formatted = escapeHtml(text);
                
                // Highlight emotional keywords
                const keywords = [
                    'umva', 'umutima', 'mahoro', 'impuhwe', 'mbabarwe', 
                    'wigitsa', 'ubwoba', 'agahinda', 'ibyishimo', 'ishinga',
                    'komeza', 'nkunda', 'jye', 'maze', 'byose', 'buri'
                ];
                
                keywords.forEach(word => {
                    const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                    formatted = formatted.replace(regex, '<span style="color:var(--color-secondary-400);font-weight:500;">$1</span>');
                });
                
                // Line breaks
                formatted = formatted.replace(/\n/g, '<br>');
                
                return formatted;
            }

            /**
             * Format time for messages
             */
            function formatMessageTime() {
                return new Date().toLocaleTimeString('rw-RW', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // ============================================================
            // EVENT BUS
            // ============================================================

            const EventBus = {
                events: {},

                on(event, callback) {
                    if (!this.events[event]) {
                        this.events[event] = [];
                    }
                    this.events[event].push(callback);
                    return () => this.off(event, callback);
                },

                off(event, callback) {
                    if (!this.events[event]) return;
                    this.events[event] = this.events[event].filter(cb => cb !== callback);
                },

                emit(event, data) {
                    if (!this.events[event]) return;
                    this.events[event].forEach(callback => {
                        try {
                            callback(data);
                        } catch (e) {
                            console.error(`Error in event handler for ${event}:`, e);
                        }
                    });
                }
            };

            // Make EventBus globally available
            window.EventBus = EventBus;

            // ============================================================
            // STATE MANAGEMENT
            // ============================================================

            const StateManager = {
                state: {
                    // Chat state
                    currentChat: [],
                    currentChatId: generateId(),
                    chatStarted: false,
                    
                    // UI state
                    isSidebarOpen: false,
                    isGenerating: false,
                    isListening: false,
                    puterReady: false,
                    isOnline: navigator.onLine,
                    
                    // Voice state
                    micPermission: false,
                    speechRecognition: null,
                    speechSynthesis: window.speechSynthesis,
                    availableVoices: [],
                    
                    // Settings
                    settings: {
                        model: 'gpt-4o-mini',
                        voice: 'Google UK English Female',
                        rate: 0.9,
                        pitch: 1.0,
                        autoTTS: true,
                        soundEffects: true,
                        animations: true,
                        enableEncryption: false
                    }
                },

                get(path) {
                    return path.split('.').reduce((obj, key) => obj?.[key], this.state);
                },

                set(path, value) {
                    const keys = path.split('.');
                    const lastKey = keys.pop();
                    const obj = keys.reduce((o, key) => {
                        if (!o[key]) o[key] = {};
                        return o[key];
                    }, this.state);
                    obj[lastKey] = value;
                    
                    // Emit state change
                    EventBus.emit('state:changed', { path, value });
                },

                update(updates) {
                    Object.keys(updates).forEach(key => {
                        this.set(key, updates[key]);
                    });
                },

                loadSettings() {
                    try {
                        const saved = localStorage.getItem('tyaza_settings_v3');
                        if (saved) {
                            const parsed = JSON.parse(saved);
                            this.state.settings = { ...this.state.settings, ...parsed };
                        }
                        // Load user data
                        const userData = localStorage.getItem('tyaza_userdata');
                        if (userData) this.state.userData = JSON.parse(userData);
                        const moodData = localStorage.getItem('tyaza_mooddata');
                        if (moodData) this.state.moodData = JSON.parse(moodData);
                        const gratitudeData = localStorage.getItem('tyaza_gratitude');
                        if (gratitudeData) this.state.gratitudeData = JSON.parse(gratitudeData);
                    } catch (e) {
                        console.warn('Failed to load settings:', e);
                    }
                },

                saveSettings() {
                    try {
                        localStorage.setItem('tyaza_settings_v3', JSON.stringify(this.state.settings));
                        if (this.state.userData) localStorage.setItem('tyaza_userdata', JSON.stringify(this.state.userData));
                        if (this.state.moodData) localStorage.setItem('tyaza_mooddata', JSON.stringify(this.state.moodData));
                        if (this.state.gratitudeData) localStorage.setItem('tyaza_gratitude', JSON.stringify(this.state.gratitudeData));
                    } catch (e) {
                        console.warn('Failed to save settings:', e);
                    }
                }
            };

            // ============================================================
            // TOAST NOTIFICATION SYSTEM
            // ============================================================

            const ToastService = {
                container: null,

                init() {
                    this.container = document.getElementById('toastContainer');
                },

                show(message, type = 'info', duration = 3000) {
                    if (!this.container) this.init();

                    const toast = document.createElement('div');
                    toast.className = `toast toast-${type}`;
                    toast.innerHTML = `
                        <i class="fas fa-${this.getIcon(type)}"></i>
                        <span>${escapeHtml(message)}</span>
                    `;

                    this.container.appendChild(toast);

                    setTimeout(() => {
                        toast.style.opacity = '0';
                        toast.style.transform = 'translateX(100%)';
                        setTimeout(() => toast.remove(), 300);
                    }, duration);
                },

                getIcon(type) {
                    const icons = {
                        success: 'check-circle',
                        error: 'exclamation-circle',
                        warning: 'exclamation-triangle',
                        info: 'info-circle'
                    };
                    return icons[type] || 'info-circle';
                },

                success(message) { this.show(message, 'success'); },
                error(message) { this.show(message, 'error'); },
                warning(message) { this.show(message, 'warning'); },
                info(message) { this.show(message, 'info'); }
            };

            // ============================================================
            // ENCRYPTION SERVICE
            // ============================================================

            const EncryptionService = {
                key: null,
                iv: null,
                
                async init() {
                    if (!window.crypto || !window.crypto.subtle) {
                        console.warn('Web Crypto API not supported');
                        return false;
                    }
                    
                    try {
                        // Generate or load encryption key
                        const savedKey = localStorage.getItem('tyaza_encryption_key');
                        if (savedKey) {
                            const keyData = JSON.parse(savedKey);
                            this.key = await crypto.subtle.importKey(
                                'jwk',
                                keyData,
                                { name: 'AES-GCM', length: 256 },
                                true,
                                ['encrypt', 'decrypt']
                            );
                        } else {
                            this.key = await crypto.subtle.generateKey(
                                { name: 'AES-GCM', length: 256 },
                                true,
                                ['encrypt', 'decrypt']
                            );
                            
                            const exported = await crypto.subtle.exportKey('jwk', this.key);
                            localStorage.setItem('tyaza_encryption_key', JSON.stringify(exported));
                        }
                        
                        // Generate random IV for each session
                        this.iv = crypto.getRandomValues(new Uint8Array(12));
                        return true;
                    } catch (e) {
                        console.error('Encryption init failed:', e);
                        return false;
                    }
                },
                
                async encrypt(text) {
                    if (!this.key) return text;
                    
                    try {
                        const encoder = new TextEncoder();
                        const data = encoder.encode(text);
                        
                        const encrypted = await crypto.subtle.encrypt(
                            {
                                name: 'AES-GCM',
                                iv: this.iv
                            },
                            this.key,
                            data
                        );
                        
                        // Combine IV and encrypted data
                        const combined = new Uint8Array(this.iv.length + encrypted.byteLength);
                        combined.set(this.iv, 0);
                        combined.set(new Uint8Array(encrypted), this.iv.length);
                        
                        return btoa(String.fromCharCode(...combined));
                    } catch (e) {
                        console.error('Encryption failed:', e);
                        return text;
                    }
                },
                
                async decrypt(encryptedText) {
                    if (!this.key) return encryptedText;
                    
                    try {
                        const combined = new Uint8Array(
                            atob(encryptedText).split('').map(c => c.charCodeAt(0))
                        );
                        
                        const iv = combined.slice(0, 12);
                        const data = combined.slice(12);
                        
                        const decrypted = await crypto.subtle.decrypt(
                            {
                                name: 'AES-GCM',
                                iv: iv
                            },
                            this.key,
                            data
                        );
                        
                        const decoder = new TextDecoder();
                        return decoder.decode(decrypted);
                    } catch (e) {
                        console.error('Decryption failed:', e);
                        return '[Encrypted - Cannot decrypt]';
                    }
                },
                
                async encryptChat(chat) {
                    const json = JSON.stringify(chat);
                    return await this.encrypt(json);
                },
                
                async decryptChat(encrypted) {
                    const json = await this.decrypt(encrypted);
                    try {
                        return JSON.parse(json);
                    } catch {
                        return null;
                    }
                },
                
                async encryptWithPassword(text, password) {
                    const encoder = new TextEncoder();
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    
                    // Derive key from password
                    const keyMaterial = await crypto.subtle.importKey(
                        'raw',
                        encoder.encode(password),
                        { name: 'PBKDF2' },
                        false,
                        ['deriveKey']
                    );
                    
                    const key = await crypto.subtle.deriveKey(
                        {
                            name: 'PBKDF2',
                            salt: salt,
                            iterations: 100000,
                            hash: 'SHA-256'
                        },
                        keyMaterial,
                        { name: 'AES-GCM', length: 256 },
                        false,
                        ['encrypt']
                    );
                    
                    const iv = crypto.getRandomValues(new Uint8Array(12));
                    const data = encoder.encode(text);
                    
                    const encrypted = await crypto.subtle.encrypt(
                        { name: 'AES-GCM', iv },
                        key,
                        data
                    );
                    
                    // Combine salt + iv + encrypted
                    const combined = new Uint8Array(salt.length + iv.length + encrypted.byteLength);
                    combined.set(salt, 0);
                    combined.set(iv, salt.length);
                    combined.set(new Uint8Array(encrypted), salt.length + iv.length);
                    
                    return btoa(String.fromCharCode(...combined));
                }
            };

            // ============================================================
            // OFFLINE STORAGE (IndexedDB)
            // ============================================================

            const OfflineDB = {
                db: null,
                dbName: 'TyazaDB',
                version: 1,
                
                async init() {
                    return new Promise((resolve, reject) => {
                        const request = indexedDB.open(this.dbName, this.version);
                        
                        request.onerror = () => reject(request.error);
                        request.onsuccess = () => {
                            this.db = request.result;
                            this.checkConnection();
                            resolve();
                        };
                        
                        request.onupgradeneeded = (event) => {
                            const db = event.target.result;
                            
                            // Conversations store
                            if (!db.objectStoreNames.contains('conversations')) {
                                const conversationStore = db.createObjectStore('conversations', { keyPath: 'id' });
                                conversationStore.createIndex('timestamp', 'timestamp', { unique: false });
                            }
                            
                            // Messages store
                            if (!db.objectStoreNames.contains('messages')) {
                                const messageStore = db.createObjectStore('messages', { keyPath: 'id', autoIncrement: true });
                                messageStore.createIndex('conversationId', 'conversationId', { unique: false });
                                messageStore.createIndex('timestamp', 'timestamp', { unique: false });
                            }
                            
                            // Offline queue store
                            if (!db.objectStoreNames.contains('offlineQueue')) {
                                const queueStore = db.createObjectStore('offlineQueue', { keyPath: 'id', autoIncrement: true });
                                queueStore.createIndex('timestamp', 'timestamp', { unique: false });
                            }
                            
                            // Settings store
                            if (!db.objectStoreNames.contains('settings')) {
                                db.createObjectStore('settings');
                            }
                            
                            // Media cache store
                            if (!db.objectStoreNames.contains('mediaCache')) {
                                const mediaStore = db.createObjectStore('mediaCache', { keyPath: 'url' });
                                mediaStore.createIndex('timestamp', 'timestamp', { unique: false });
                            }
                        };
                    });
                },
                
                async saveConversation(conversation) {
                    if (!this.db) return;
                    
                    const tx = this.db.transaction('conversations', 'readwrite');
                    const store = tx.objectStore('conversations');
                    
                    conversation.timestamp = Date.now();
                    conversation.synced = navigator.onLine;
                    
                    return new Promise((resolve, reject) => {
                        const request = store.put(conversation);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                },
                
                async saveMessage(message) {
                    if (!this.db) return;
                    
                    const tx = this.db.transaction('messages', 'readwrite');
                    const store = tx.objectStore('messages');
                    
                    message.timestamp = Date.now();
                    message.synced = navigator.onLine;
                    
                    return new Promise((resolve, reject) => {
                        const request = store.add(message);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                },
                
                async getAllConversations() {
                    if (!this.db) return [];
                    
                    const tx = this.db.transaction('conversations', 'readonly');
                    const store = tx.objectStore('conversations');
                    
                    return new Promise((resolve, reject) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                },
                
                async getConversationMessages(conversationId) {
                    if (!this.db) return [];
                    
                    const tx = this.db.transaction('messages', 'readonly');
                    const store = tx.objectStore('messages');
                    const index = store.index('conversationId');
                    
                    return new Promise((resolve, reject) => {
                        const request = index.getAll(conversationId);
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => reject(request.error);
                    });
                },
                
                async queueMessage(message) {
                    if (!this.db) return;
                    
                    const tx = this.db.transaction('offlineQueue', 'readwrite');
                    const store = tx.objectStore('offlineQueue');
                    
                    message.timestamp = Date.now();
                    message.status = 'pending';
                    
                    return new Promise((resolve, reject) => {
                        const request = store.add(message);
                        request.onsuccess = () => {
                            this.showOfflineNotification();
                            resolve(request.result);
                        };
                        request.onerror = () => reject(request.error);
                    });
                },
                
                async processQueue() {
                    if (!navigator.onLine || !this.db) return;
                    
                    const tx = this.db.transaction('offlineQueue', 'readwrite');
                    const store = tx.objectStore('offlineQueue');
                    
                    const messages = await new Promise((resolve) => {
                        const request = store.getAll();
                        request.onsuccess = () => resolve(request.result);
                    });
                    
                    for (const message of messages) {
                        try {
                            // Send message - will be handled by main app
                            EventBus.emit('offline:process', message);
                            
                            // Delete from queue
                            store.delete(message.id);
                            
                            ToastService.success('Ubutumwa bwoherejwe!');
                        } catch (e) {
                            console.error('Failed to send queued message:', e);
                        }
                    }
                },
                
                checkConnection() {
                    window.addEventListener('online', () => {
                        StateManager.set('isOnline', true);
                        this.processQueue();
                        ToastService.success('Mwongeye guhuza!', 'success');
                        document.getElementById('connectionStatus').textContent = 'Irereye';
                    });
                    
                    window.addEventListener('offline', () => {
                        StateManager.set('isOnline', false);
                        this.showOfflineNotification();
                        document.getElementById('connectionStatus').textContent = 'Ntahuzi';
                    });
                },
                
                showOfflineNotification() {
                    const offlineBanner = document.createElement('div');
                    offlineBanner.className = 'offline-banner';
                    offlineBanner.id = 'offlineBanner';
                    offlineBanner.innerHTML = `
                        <i class="fas fa-wifi-slash"></i>
                        Ntago uhuza - ubutumwa buzerekwa
                    `;
                    
                    if (!document.getElementById('offlineBanner')) {
                        document.body.appendChild(offlineBanner);
                        
                        setTimeout(() => {
                            offlineBanner.classList.add('show');
                        }, 100);
                        
                        window.addEventListener('online', () => {
                            offlineBanner.classList.remove('show');
                            setTimeout(() => {
                                if (offlineBanner.parentNode) {
                                    offlineBanner.remove();
                                }
                            }, 300);
                        }, { once: true });
                    }
                }
            };

            // ============================================================
            // STORAGE SERVICE (with encryption support)
            // ============================================================

            const StorageService = {
                async getHistory() {
                    try {
                        const enableEncryption = StateManager.get('settings.enableEncryption');
                        
                        if (enableEncryption) {
                            const encrypted = localStorage.getItem('tyaza_history_encrypted_v3');
                            if (encrypted) {
                                return await EncryptionService.decryptChat(encrypted) || [];
                            }
                            return [];
                        } else {
                            return JSON.parse(localStorage.getItem('tyaza_history_v3') || '[]');
                        }
                    } catch {
                        return [];
                    }
                },

                async saveToHistory(chat) {
                    const history = await this.getHistory();
                    
                    // Filter out invalid entries
                    const validHistory = history.filter(h => 
                        h && h.title && h.title.length > 0 && h.title.length < 50
                    );
                    
                    const existingIndex = validHistory.findIndex(c => c.id === chat.id);
                    
                    if (existingIndex >= 0) {
                        validHistory[existingIndex] = chat;
                    } else {
                        validHistory.unshift(chat);
                    }
                    
                    // Keep only last 20 chats
                    const trimmed = validHistory.slice(0, 20);
                    
                    const enableEncryption = StateManager.get('settings.enableEncryption');
                    
                    if (enableEncryption) {
                        const encrypted = await EncryptionService.encryptChat(trimmed);
                        localStorage.setItem('tyaza_history_encrypted_v3', encrypted);
                    } else {
                        localStorage.setItem('tyaza_history_v3', JSON.stringify(trimmed));
                    }
                    
                    return trimmed;
                },

                async clearHistory() {
                    localStorage.removeItem('tyaza_history_v3');
                    localStorage.removeItem('tyaza_history_encrypted_v3');
                }
            };

            // ============================================================
            // SPEECH SERVICES
            // ============================================================

            const SpeechService = {
                initRecognition() {
                    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                        return false;
                    }

                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    
                    recognition.continuous = false;
                    recognition.interimResults = true;
                    recognition.lang = 'rw-RW';

                    recognition.onstart = () => {
                        EventBus.emit('recognition:start');
                    };

                    recognition.onend = () => {
                        EventBus.emit('recognition:end');
                    };

                    recognition.onresult = (event) => {
                        let transcript = '';
                        for (let i = 0; i < event.results.length; i++) {
                            transcript += event.results[i][0].transcript;
                        }
                        EventBus.emit('recognition:result', transcript);
                    };

                    recognition.onerror = (event) => {
                        EventBus.emit('recognition:error', event.error);
                    };

                    StateManager.set('speechRecognition', recognition);
                    return true;
                },

                startRecognition() {
                    const recognition = StateManager.get('speechRecognition');
                    if (recognition) {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('Recognition start error:', e);
                        }
                    }
                },

                stopRecognition() {
                    const recognition = StateManager.get('speechRecognition');
                    if (recognition) {
                        try {
                            recognition.stop();
                        } catch (e) {
                            console.error('Recognition stop error:', e);
                        }
                    }
                },

                initSynthesis() {
                    const synth = StateManager.get('speechSynthesis');
                    if (synth) {
                        const loadVoices = () => {
                            StateManager.set('availableVoices', synth.getVoices());
                        };
                        
                        loadVoices();
                        if (synth.onvoiceschanged !== undefined) {
                            synth.onvoiceschanged = loadVoices;
                        }
                    }
                },

                speak(text) {
                    const synth = StateManager.get('speechSynthesis');
                    const settings = StateManager.get('settings');
                    
                    if (!synth || !settings.autoTTS) return;
                    
                    // Cancel any ongoing speech
                    synth.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text.substring(0, 1000));
                    
                    // Set voice
                    if (StateManager.get('availableVoices').length > 0) {
                        const voiceName = settings.voice;
                        const voice = StateManager.get('availableVoices').find(v => 
                            v.name.includes(voiceName.split(' ')[0])
                        ) || StateManager.get('availableVoices')[0];
                        
                        if (voice) utterance.voice = voice;
                    }
                    
                    // Set rate and pitch
                    utterance.rate = parseFloat(settings.rate);
                    utterance.pitch = parseFloat(settings.pitch);
                    
                    // Language
                    utterance.lang = 'rw-RW';
                    
                    synth.speak(utterance);
                }
            };

            // ============================================================
            // VOICE VISUALIZER
            // ============================================================

            const VoiceVisualizer = {
                canvas: null,
                ctx: null,
                audioContext: null,
                analyser: null,
                source: null,
                stream: null,
                animationFrame: null,
                isActive: false,
                
                init() {
                    this.canvas = document.getElementById('voiceVisualizer');
                    if (this.canvas) {
                        this.ctx = this.canvas.getContext('2d');
                    }
                },
                
                async start() {
                    if (this.isActive) return;
                    
                    try {
                        this.stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        this.analyser = this.audioContext.createAnalyser();
                        this.analyser.fftSize = 256;
                        
                        this.source = this.audioContext.createMediaStreamSource(this.stream);
                        this.source.connect(this.analyser);
                        
                        this.isActive = true;
                        if (this.canvas) {
                            this.canvas.classList.add('active');
                        }
                        this.draw();
                        
                    } catch (e) {
                        console.error('Failed to start visualizer:', e);
                    }
                },
                
                stop() {
                    this.isActive = false;
                    
                    if (this.animationFrame) {
                        cancelAnimationFrame(this.animationFrame);
                    }
                    
                    if (this.source) {
                        this.source.disconnect();
                    }
                    
                    if (this.stream) {
                        this.stream.getTracks().forEach(track => track.stop());
                    }
                    
                    if (this.audioContext) {
                        this.audioContext.close();
                    }
                    
                    if (this.canvas) {
                        this.canvas.classList.remove('active');
                    }
                    this.clearCanvas();
                },
                
                draw() {
                    if (!this.isActive || !this.analyser || !this.ctx || !this.canvas) return;
                    
                    const bufferLength = this.analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    const drawFrame = () => {
                        if (!this.isActive) return;
                        
                        this.animationFrame = requestAnimationFrame(drawFrame);
                        
                        this.analyser.getByteFrequencyData(dataArray);
                        
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        // Draw gradient background
                        const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
                        gradient.addColorStop(1, 'rgba(236, 72, 153, 0.2)');
                        this.ctx.fillStyle = gradient;
                        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        // Draw frequency bars
                        const barWidth = (this.canvas.width / bufferLength) * 2.5;
                        let x = 0;
                        
                        for (let i = 0; i < bufferLength; i++) {
                            const barHeight = (dataArray[i] / 255) * this.canvas.height;
                            
                            // Color based on frequency
                            const hue = 240 + (i / bufferLength) * 120;
                            this.ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`;
                            
                            this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth - 1, barHeight);
                            
                            x += barWidth;
                        }
                        
                        // Draw waveform overlay
                        this.ctx.beginPath();
                        this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
                        this.ctx.lineWidth = 2;
                        
                        const sliceWidth = this.canvas.width / bufferLength;
                        x = 0;
                        
                        for (let i = 0; i < bufferLength; i++) {
                            const v = dataArray[i] / 128.0;
                            const y = v * this.canvas.height / 2;
                            
                            if (i === 0) {
                                this.ctx.moveTo(x, y);
                            } else {
                                this.ctx.lineTo(x, y);
                            }
                            
                            x += sliceWidth;
                        }
                        
                        this.ctx.stroke();
                    };
                    
                    drawFrame();
                },
                
                clearCanvas() {
                    if (!this.ctx || !this.canvas) return;
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }
            };

            // ============================================================
            // PERSONALIZATION & WELLBEING FEATURES
            // ============================================================

            const WellbeingFeatures = {
                affirmations: [
                    "Ndi uwizeye kugira nibura ibitego bimwe mu buzima",
                    "Ndemerewe kuba mfite agaciro mu buzima",
                    "Nshobora guhindura ibintu binyuranye",
                    "Ndi uwizeye kwigira amahoro",
                    "Nshobora guhangana n'ibibazo byose",
                    "Ndi uwizeye kugira umutima utahawe",
                    "Nshobora kugira umushinga wuzuye",
                    "Ndi uwizeye mu buzima bwanjye",
                    "Nshobora gufata ibå³å® zuzwe",
                    "Ndi uwizeye kugira ibyiringitungo"
                ],

                currentAffirmationIndex: 0,
                isBreathing: false,
                breathingInterval: null,
                currentPattern: '4-7-8',
                patterns: {
                    '4-7-8': { inhale: 4, hold: 7, exhale: 8 },
                    '4-4-4': { inhale: 4, hold: 4, exhale: 4 },
                    '5-5-5': { inhale: 5, hold: 5, exhale: 5 },
                    'box': { inhale: 4, hold: 4, exhale: 4, holdAfter: 4 }
                },

                init() {
                    this.cacheElements();
                    this.bindEvents();
                    this.loadUserData();
                    this.renderMoodCalendar();
                    this.updateDashboard();
                    this.startSafetyCheckins();
                },

                cacheElements() {
                    this.elements = {
                        wellbeingBtn: document.getElementById('wellbeingBtn'),
                        wellbeingModal: document.getElementById('wellbeingModal'),
                        wellbeingClose: document.getElementById('wellbeingClose'),
                        profileAvatar: document.getElementById('profileAvatar'),
                        userNameInput: document.getElementById('userNameInput'),
                        profileGoals: document.getElementById('profileGoals'),
                        addGoalBtn: document.getElementById('addGoalBtn'),
                        saveProfileBtn: document.getElementById('saveProfileBtn'),
                        moodScale: document.getElementById('moodScale'),
                        moodNotes: document.getElementById('moodNotes'),
                        saveMoodBtn: document.getElementById('saveMoodBtn'),
                        moodCalendar: document.getElementById('moodCalendar'),
                        breathingCircle: document.getElementById('breathingCircle'),
                        breathingText: document.getElementById('breathingText'),
                        breathingTimer: document.getElementById('breathingTimer'),
                        breathingInstruction: document.getElementById('breathingInstruction'),
                        startBreathingBtn: document.getElementById('startBreathingBtn'),
                        affirmationCard: document.getElementById('affirmationCard'),
                        affirmationText: document.getElementById('affirmationText'),
                        affirmationAuthor: document.getElementById('affirmationAuthor'),
                        affirmationIndex: document.getElementById('affirmationIndex'),
                        prevAffirmation: document.getElementById('prevAffirmation'),
                        nextAffirmation: document.getElementById('nextAffirmation'),
                        speakAffirmationBtn: document.getElementById('speakAffirmationBtn'),
                        shareAffirmationBtn: document.getElementById('shareAffirmationBtn'),
                        gratitude1: document.getElementById('gratitude1'),
                        gratitude2: document.getElementById('gratitude2'),
                        gratitude3: document.getElementById('gratitude3'),
                        saveGratitudeBtn: document.getElementById('saveGratitudeBtn'),
                        gratitudeSavedList: document.getElementById('gratitudeSavedList'),
                        streakCount: document.getElementById('streakCount'),
                        totalMessages: document.getElementById('totalMessages'),
                        avgMood: document.getElementById('avgMood'),
                        gratitudeCount: document.getElementById('gratitudeCount'),
                        emotionChart: document.getElementById('emotionChart')
                    };
                },

                bindEvents() {
                    this.elements.wellbeingBtn?.addEventListener('click', () => this.openModal());
                    this.elements.wellbeingClose?.addEventListener('click', () => this.closeModal());
                    this.elements.wellbeingModal?.addEventListener('click', (e) => {
                        if (e.target === this.elements.wellbeingModal) this.closeModal();
                    });

                    document.querySelectorAll('.feature-tab').forEach(tab => {
                        tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                    });

                    this.elements.saveProfileBtn?.addEventListener('click', () => this.saveProfile());
                    this.elements.userNameInput?.addEventListener('input', (e) => {
                        const initial = e.target.value.charAt(0).toUpperCase() || 'J';
                        this.elements.profileAvatar.textContent = initial;
                    });
                    this.elements.addGoalBtn?.addEventListener('click', () => this.addGoal());

                    document.querySelectorAll('.mood-btn').forEach(btn => {
                        btn.addEventListener('click', () => this.selectMood(btn));
                    });
                    this.elements.saveMoodBtn?.addEventListener('click', () => this.saveMood());

                    document.querySelectorAll('.breathing-pattern-btn').forEach(btn => {
                        btn.addEventListener('click', () => this.selectPattern(btn));
                    });
                    this.elements.startBreathingBtn?.addEventListener('click', () => this.toggleBreathing());

                    this.elements.prevAffirmation?.addEventListener('click', () => this.prevAffirmation());
                    this.elements.nextAffirmation?.addEventListener('click', () => this.nextAffirmation());
                    this.elements.speakAffirmationBtn?.addEventListener('click', () => this.speakAffirmation());
                    this.elements.shareAffirmationBtn?.addEventListener('click', () => this.shareAffirmation());

                    this.elements.saveGratitudeBtn?.addEventListener('click', () => this.saveGratitude());
                },

                loadUserData() {
                    const userData = StateManager.get('userData') || {};
                    if (userData.name) {
                        this.elements.userNameInput.value = userData.name;
                        this.elements.profileAvatar.textContent = userData.name.charAt(0).toUpperCase();
                        // Update welcome quote with personalized greeting
                        const welcomeQuote = document.getElementById('welcomeQuote');
                        if (welcomeQuote) {
                            welcomeQuote.innerHTML = `"${userData.name}, ndi hano kugira nkugire. Buri mwanya, buri jambo â<br>byakiriwe mu mahoro n'igondero."`;
                        }
                    }
                    this.renderGratitudeList();
                },

                openModal() {
                    this.elements.wellbeingModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                },

                closeModal() {
                    this.elements.wellbeingModal.classList.remove('active');
                    document.body.style.overflow = '';
                    if (this.isBreathing) this.stopBreathing();
                },

                switchTab(tabName) {
                    document.querySelectorAll('.feature-tab').forEach(t => t.classList.remove('active'));
                    document.querySelector(`.feature-tab[data-tab="${tabName}"]`)?.classList.add('active');
                    document.querySelectorAll('.feature-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${tabName}`)?.classList.add('active');
                    if (tabName === 'progress') this.updateDashboard();
                },

                saveProfile() {
                    const name = this.elements.userNameInput.value.trim();
                    if (!name) {
                        ToastService.info('Injira izina ryawe');
                        return;
                    }
                    const userData = StateManager.get('userData') || {};
                    userData.name = name;
                    StateManager.set('userData', userData);
                    StateManager.saveSettings();
                    ToastService.success('Profile yabitswe!');
                },

                addGoal() {
                    const goalItem = document.createElement('div');
                    goalItem.className = 'profile-goal-item';
                    goalItem.innerHTML = `<input type="checkbox"><input type="text" class="profile-goal-input" placeholder="Goal nshya...">`;
                    this.elements.profileGoals.appendChild(goalItem);
                    goalItem.querySelector('input[type="text"]').focus();
                },

                selectedMood: null,

                selectMood(btn) {
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    this.selectedMood = parseInt(btn.dataset.mood);
                },

                saveMood() {
                    if (!this.selectedMood) {
                        ToastService.info('Hitamo imimerere yawe');
                        return;
                    }
                    const notes = this.elements.moodNotes.value.trim();
                    const moodData = StateManager.get('moodData') || [];
                    moodData.push({ mood: this.selectedMood, notes: notes, timestamp: Date.now() });
                    StateManager.set('moodData', moodData);
                    StateManager.saveSettings();
                    ToastService.success('Imimerere yabitswe!');
                    this.renderMoodCalendar();
                    this.elements.moodNotes.value = '';
                    document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
                    this.selectedMood = null;
                },

                renderMoodCalendar() {
                    const moodData = StateManager.get('moodData') || [];
                    const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                    let html = days.map(d => `<div class="mood-day-label">${d}</div>`).join('');

                    for (let i = 27; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dayStart = new Date(date.setHours(0, 0, 0, 0)).getTime();
                        const dayEnd = new Date(date.setHours(23, 59, 59, 999)).getTime();
                        const dayMoods = moodData.filter(m => m.timestamp >= dayStart && m.timestamp <= dayEnd);
                        const avgMood = dayMoods.length > 0 ? Math.round(dayMoods.reduce((a, b) => a + b.mood, 0) / dayMoods.length) : 0;
                        html += `<div class="mood-day mood-level-${avgMood}" title="${date.toLocaleDateString('rw-RW')}: ${avgMood || 'nta mimerere'}">${date.getDate()}</div>`;
                    }
                    this.elements.moodCalendar.innerHTML = html;
                },

                selectPattern(btn) {
                    document.querySelectorAll('.breathing-pattern-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    this.currentPattern = btn.dataset.pattern;
                },

                toggleBreathing() {
                    if (this.isBreathing) this.stopBreathing();
                    else this.startBreathing();
                },

                startBreathing() {
                    this.isBreathing = true;
                    this.elements.startBreathingBtn.innerHTML = '<i class="fas fa-stop"></i> Reya';
                    this.elements.startBreathingBtn.classList.add('btn-secondary');
                    this.elements.startBreathingBtn.classList.remove('btn-primary');

                    const pattern = this.patterns[this.currentPattern];
                    let phase = 'inhale';
                    let count = pattern.inhale;
                    let cycleCount = 0;

                    this.runBreathingPhase(pattern, phase, count);

                    this.breathingInterval = setInterval(() => {
                        count--;
                        this.elements.breathingTimer.textContent = count;
                        if (count <= 0) {
                            cycleCount++;
                            if (cycleCount >= 4) {
                                this.stopBreathing();
                                ToastService.success('Uracyumva neza! Murakoze.');
                                return;
                            }
                            if (phase === 'inhale') {
                                phase = pattern.hold ? 'hold' : 'exhale';
                                count = pattern.hold || pattern.exhale;
                            } else if (phase === 'hold') {
                                phase = 'exhale';
                                count = pattern.exhale;
                            } else if (phase === 'exhale') {
                                phase = 'inhale';
                                count = pattern.inhale;
                            }
                            this.runBreathingPhase(pattern, phase, count);
                        }
                    }, 1000);
                },

                runBreathingPhase(pattern, phase, count) {
                    this.elements.breathingCircle.className = 'breathing-circle';
                    if (phase === 'inhale') {
                        this.elements.breathingCircle.classList.add('inhale');
                        this.elements.breathingText.textContent = 'Fata umwuka';
                        this.elements.breathingInstruction.textContent = `Fata umwuka wo mu mfabiko (${count}s)`;
                    } else if (phase === 'hold') {
                        this.elements.breathingCircle.classList.add('hold');
                        this.elements.breathingText.textContent = 'Bika';
                        this.elements.breathingInstruction.textContent = `Bika umwuka (${count}s)`;
                    } else if (phase === 'exhale') {
                        this.elements.breathingCircle.classList.add('exhale');
                        this.elements.breathingText.textContent = 'Fungura';
                        this.elements.breathingInstruction.textContent = `Fungura umwuka (${count}s)`;
                    }
                    this.elements.breathingTimer.textContent = count;
                },

                stopBreathing() {
                    this.isBreathing = false;
                    if (this.breathingInterval) { clearInterval(this.breathingInterval); this.breathingInterval = null; }
                    this.elements.startBreathingBtn.innerHTML = '<i class="fas fa-play"></i> Banzerereze';
                    this.elements.startBreathingBtn.classList.remove('btn-secondary');
                    this.elements.startBreathingBtn.classList.add('btn-primary');
                    this.elements.breathingCircle.className = 'breathing-circle';
                    this.elements.breathingText.textContent = 'Bite';
                    this.elements.breathingInstruction.textContent = 'Kanda "Banzerereze" wishakiye gutangira';
                    this.elements.breathingTimer.textContent = '0';
                },

                prevAffirmation() {
                    this.currentAffirmationIndex = (this.currentAffirmationIndex - 1 + this.affirmations.length) % this.affirmations.length;
                    this.updateAffirmation();
                },

                nextAffirmation() {
                    this.currentAffirmationIndex = (this.currentAffirmationIndex + 1) % this.affirmations.length;
                    this.updateAffirmation();
                },

                updateAffirmation() {
                    this.elements.affirmationText.textContent = `"${this.affirmations[this.currentAffirmationIndex]}"`;
                    this.elements.affirmationIndex.textContent = `${this.currentAffirmationIndex + 1} / ${this.affirmations.length}`;
                },

                speakAffirmation() {
                    SpeechService.speak(this.affirmations[this.currentAffirmationIndex]);
                },

                shareAffirmation() {
                    const text = this.affirmations[this.currentAffirmationIndex];
                    if (navigator.share) { navigator.share({ text: text + ' â TYAZA' }); }
                    else { navigator.clipboard.writeText(text + ' â TYAZA'); ToastService.success('Ibyiringitungo byakiriwe!'); }
                },

                saveGratitude() {
                    const items = [this.elements.gratitude1.value.trim(), this.elements.gratitude2.value.trim(), this.elements.gratitude3.value.trim()].filter(i => i);
                    if (items.length === 0) { ToastService.info('Andika ibintu ushaka kugaragariza'); return; }
                    const gratitudeData = StateManager.get('gratitudeData') || [];
                    gratitudeData.push({ items: items, timestamp: Date.now() });
                    StateManager.set('gratitudeData', gratitudeData);
                    StateManager.saveSettings();
                    ToastService.success('Ibyishimo byabitswe!');
                    this.elements.gratitude1.value = ''; this.elements.gratitude2.value = ''; this.elements.gratitude3.value = '';
                    this.renderGratitudeList();
                    this.updateDashboard();
                },

                renderGratitudeList() {
                    const gratitudeData = StateManager.get('gratitudeData') || [];
                    if (gratitudeData.length === 0) { this.elements.gratitudeSavedList.innerHTML = '<p style="color: var(--color-text-muted); text-align: center;">Nta byishimo bitarahishwa</p>'; return; }
                    const recent = gratitudeData.slice(-5).reverse();
                    let html = '<div class="gratitude-saved-title">Ibyishimo biheruka</div>';
                    recent.forEach(g => {
                        const date = new Date(g.timestamp).toLocaleDateString('rw-RW', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
                        html += `<div class="gratitude-saved-item"><div><div class="gratitude-date">${date}</div>${g.items.map(i => `<div style="font-size: var(--text-sm); color: var(--color-text-secondary);">â¢ ${i}</div>`).join('')}</div></div>`;
                    });
                    this.elements.gratitudeSavedList.innerHTML = html;
                },

                updateDashboard() {
                    const moodData = StateManager.get('moodData') || [];
                    const gratitudeData = StateManager.get('gratitudeData') || [];

                    let streak = 0;
                    const today = new Date(); today.setHours(0, 0, 0, 0);
                    for (let i = 0; i < 30; i++) {
                        const checkDate = new Date(today); checkDate.setDate(checkDate.getDate() - i);
                        const dayStart = checkDate.getTime(); const dayEnd = dayStart + 86400000;
                        const hasActivity = moodData.some(m => m.timestamp >= dayStart && m.timestamp < dayEnd) || gratitudeData.some(g => g.timestamp >= dayStart && g.timestamp < dayEnd);
                        if (hasActivity) streak++;
                        else if (i > 0) break;
                    }

                    this.elements.streakCount.textContent = streak;
                    this.elements.totalMessages.textContent = moodData.length + gratitudeData.length;

                    if (moodData.length > 0) {
                        const avg = Math.round(moodData.reduce((a, b) => a + b.mood, 0) / moodData.length);
                        const moods = ['', 'ð¢', 'ð', 'ð', 'ð', 'ð'];
                        this.elements.avgMood.textContent = moods[avg] || '-';
                    }

                    this.elements.gratitudeCount.textContent = gratitudeData.length;
                    this.renderEmotionChart(moodData);
                },

                renderEmotionChart(moodData) {
                    const days = [];
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(); date.setDate(date.getDate() - i); date.setHours(0, 0, 0, 0);
                        const dayStart = date.getTime(); const dayEnd = dayStart + 86400000;
                        const dayMoods = moodData.filter(m => m.timestamp >= dayStart && m.timestamp < dayEnd);
                        const avg = dayMoods.length > 0 ? dayMoods.reduce((a, b) => a + b.mood, 0) / dayMoods.length : 0;
                        days.push(avg);
                    }
                    const maxMood = Math.max(...days, 5);
                    let html = '';
                    const dayNames = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
                    days.forEach((mood, i) => {
                        const height = mood ? (mood / maxMood) * 80 + 10 : 5;
                        html += `<div style="display: flex; flex-direction: column; align-items: center; gap: 4px;"><div class="emotion-bar" style="height: ${height}px;"></div><span style="font-size: 10px; color: var(--color-text-muted);">${dayNames[(new Date().getDay() - 6 + i + 7) % 7]}</span></div>`;
                    });
                    this.elements.emotionChart.innerHTML = html;
                },

                // Safety Check-in
                checkinInterval: null,

                startSafetyCheckins() {
                    // Check in every 15 minutes
                    this.checkinInterval = setInterval(() => {
                        this.showCheckinPrompt();
                    }, 15 * 60 * 1000);
                },

                showCheckinPrompt() {
                    if (document.getElementById('checkinPrompt')) return;

                    const prompt = document.createElement('div');
                    prompt.id = 'checkinPrompt';
                    prompt.className = 'checkin-prompt';
                    prompt.innerHTML = `
                        <span class="checkin-prompt-text">Wumva ute none?</span>
                        <button class="checkin-yes" id="checkinYes">Neza</button>
                        <button class="checkin-no" id="checkinNo">Ntabishoboye</button>
                    `;

                    document.body.appendChild(prompt);

                    prompt.querySelector('#checkinYes').onclick = () => {
                        prompt.remove();
                        ToastService.success('Murakoze! Kinyarwanda ukomeza.');
                    };

                    prompt.querySelector('#checkinNo').onclick = () => {
                        prompt.remove();
                        CrisisResources.showCrisisAlert();
                    };

                    // Auto-dismiss after 30 seconds
                    setTimeout(() => {
                        if (document.getElementById('checkinPrompt')) {
                            prompt.remove();
                        }
                    }, 30000);
                }
            };

            window.WellbeingFeatures = WellbeingFeatures;

            // ============================================================
            // CRISIS RESOURCES
            // ============================================================

            const CrisisResources = {
                resources: {
                    rwanda: [
                        { name: 'Imitari y\'inkunga', number: '116', description: 'Umugoroba w\'abana n\'urubyiruko - 24/7', icon: 'ð' },
                        { name: 'Isange One Stop Center', number: '3029', description: 'Ifasha mu gukumira ihohoterwa', icon: 'ð¥' },
                        { name: 'Police - Emergence', number: '112', description: 'Polisi y\'u Rwanda - ibyihutirwa', icon: 'ð' },
                        { name: 'Ambulance', number: '912', description: 'Serivisi y\'ambulance', icon: 'ð' },
                        { name: 'HB Consulting', number: '0788305876', description: 'Ubuvuzi bwo mu mutwe', icon: 'ð§ ' }
                    ],
                    keywords: ['kwiyahura', 'gutinya', 'nkibabaje', 'ntakizere', 'ndwaye', 'mpariye', 'ndashaka guhita', 'ntabwo mbona', 'ndi mu ngorane', 'mfite ibyago', 'ndashaka umutekano']
                },
                
                init() {
                    this.checkForCrisisKeywords();
                    this.addCrisisButton();
                },
                
                checkForCrisisKeywords() {
                    EventBus.on('message:sent', (message) => {
                        const lower = message.content.toLowerCase();
                        
                        if (this.resources.keywords.some(keyword => lower.includes(keyword))) {
                            this.showCrisisAlert();
                        }
                    });
                },
                
                showCrisisAlert() {
                    // Check if already showing
                    if (document.getElementById('crisisModal')) return;
                    
                    // Create crisis modal
                    const modal = document.createElement('div');
                    modal.className = 'modal-backdrop active';
                    modal.id = 'crisisModal';
                    modal.innerHTML = `
                        <div class="modal active" style="max-width: 500px; border-color: var(--color-error);">
                            <div class="modal-header" style="border-bottom-color: var(--color-error);">
                                <h3 class="modal-title" style="color: var(--color-error);">
                                    â ï¸ Ukeneye ubufasha bwihutirwa?
                                </h3>
                                <button class="modal-close" id="crisisClose">&times;</button>
                            </div>
                            
                            <div style="margin: var(--space-6) 0;">
                                <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                                    Nga ni byiza kuvugana n'umuntu w'umubiri. 
                                    Dore imitari y'inkunga:
                                </p>
                                
                                <div class="crisis-resources">
                                    ${this.resources.rwanda.map(r => `
                                        <div class="crisis-resource">
                                            <div class="crisis-icon">${r.icon}</div>
                                            <div class="crisis-info">
                                                <div class="crisis-name">${r.name}</div>
                                                <div class="crisis-number">${r.number}</div>
                                                <div class="crisis-desc">${r.description}</div>
                                            </div>
                                            <a href="tel:${r.number.replace(/\D/g, '')}" class="crisis-call">
                                                <i class="fas fa-phone-alt"></i>
                                            </a>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div style="margin-top: var(--space-4); padding: var(--space-4); background: rgba(239, 68, 68, 0.1); border-radius: var(--radius-lg);">
                                    <p style="color: var(--color-error); font-size: var(--text-sm);">
                                        <i class="fas fa-heart"></i>
                                        Ntugume wenyine. Hari abantu bashoboye kugufasha.
                                    </p>
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: var(--space-3);">
                                <button class="btn btn-secondary flex-1" id="crisisLater">
                                    Ndabibuka
                                </button>
                                <button class="btn btn-primary flex-1" id="crisisNow" style="background: var(--color-error);">
                                    Mpambe noneho
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Bind events
                    modal.querySelector('#crisisClose').onclick = () => modal.remove();
                    modal.querySelector('#crisisLater').onclick = () => modal.remove();
                    modal.querySelector('#crisisNow').onclick = () => {
                        window.location.href = 'tel:116';
                    };
                    
                    // Auto-hide after 30 seconds
                    setTimeout(() => {
                        if (document.getElementById('crisisModal')) {
                            modal.remove();
                        }
                    }, 30000);
                },
                
                addCrisisButton() {
                    const button = document.createElement('button');
                    button.className = 'crisis-floating-btn';
                    button.id = 'crisisFloatingBtn';
                    button.innerHTML = `
                        <span class="crisis-pulse"></span>
                        <i class="fas fa-phone-alt"></i>
                    `;
                    
                    button.onclick = () => this.showCrisisAlert();
                    
                    document.body.appendChild(button);
                }
            };

            // ============================================================
            // CLINICAL EVIDENCE - Evidence-Based Frameworks
            // ============================================================

            const ClinicalEvidence = {
                // Evidence-Based Response Templates
                frameworks: {
                    CBT: {
                        name: 'Cognitive Behavioral Therapy',
                        techniques: {
                            cognitiveRestructuring: {
                                pattern: /(always|never|everyone|nobody|terrible|horrible|can't stand|ntabwo|biragaragara)/i,
                                response: 'Nabonye ko ukoresha ijambo ry\'urugomo. Ese hari ikindi wabona uko wabisobanura?',
                                framework: 'Beck Institute CBT'
                            },
                            behavioralActivation: {
                                pattern: /(ntagifite imbaraga|sinashobora gukora|ntacyo nshobora|ntabwo mpashwa)/i,
                                response: 'Igihe tuba dufite ibintu byinshi, biduhenda. Ese hari igikorwa gito wakora uyu munsi?',
                                framework: 'Lewinsohn\'s Behavioral Activation'
                            }
                        }
                    },
                    DBT: {
                        name: 'Dialectical Behavior Therapy',
                        techniques: {
                            distressTolerance: {
                                pattern: /(ntakibazo|sinakimara|ndashaka guhita|ntacyo)/i,
                                response: 'Ibi bimeze nk\'umuyaga ukaze - uraza kandi uragenda. Reka turebe uko twakira iki gihe...',
                                framework: 'Marsha Linehan\'s DBT'
                            },
                            emotionRegulation: {
                                pattern: /(ndarakaye|ndababaye|ndatinya cyane|uburakari)/i,
                                response: 'Uyu murandasi ufite izina. Reka tumwereke umwanya...',
                                framework: 'Linehan\'s Emotion Regulation Model'
                            }
                        }
                    },
                    MI: {
                        name: 'Motivational Interviewing',
                        techniques: {
                            changeTalk: {
                                pattern: /(ndashaka guhindura|nkeneye ubufasha|nabikoze|ndashaka)/i,
                                response: 'Ni iki cyagufasha gutera intambwe? Mbese wabona uko...',
                                framework: 'Miller & Rollnick'
                            },
                            sustainTalk: {
                                pattern: /(ntabwo bishoboka|byananiranye|ntacyo bimaze|ntashobora)/i,
                                response: 'Ndumva ko ufite impungenge. Icyakora, hari ibyo wabona ukuntu byahinduka...',
                                framework: 'Miller & Rollnick'
                            }
                        }
                    },
                    ACT: {
                        name: 'Acceptance and Commitment Therapy',
                        techniques: {
                            acceptance: {
                                pattern: /(ntabwo mbishaka|ndwanya|ntabwo nemera|sinemera)/i,
                                response: 'Nta guhatana. Reka turebe uko dushobora kwakira iki kibazo...',
                                framework: 'Steven Hayes\' ACT'
                            },
                            values: {
                                pattern: /(icy\'ingenzi|icyiza|icyo nshaka|ibyiringiro)/i,
                                response: 'Ibyo uvuga bigaragaza icyo uha agaciro. Ni gute twakurikiza iryo teka?',
                                framework: 'Hayes\' Values Clarification'
                            }
                        }
                    }
                },

                // Crisis Protocol
                crisisProtocol: {
                    triggers: ['kwiyahura', 'gupfa', 'ntakibazo', 'birangiye', 'ndashaka guhita', 'ntacyo mbona', 'birashoboka', 'kwikomeretsa', 'kwiyica'],
                    response: {
                        immediate: 'Ndumva ko ufite ibibazo bikomeye. Nta wugomba kwiharira.',
                        resources: [
                            { name: 'Imitari y\'inkunga', number: '116' },
                            { name: 'Isange One Stop Center', number: '3029' }
                        ],
                        safetyPlan: [
                            'Niba ufite intege yo kwiyahura, hamagara 116',
                            'Ntugume wenyine',
                            'Jya aho hari abantu'
                        ]
                    },
                    evidence: 'Stanley & Brown Safety Planning Intervention (2012)'
                },

                // Clinical Disclaimer
                disclaimer: '',

                init() {
                    this.bindEvents();
                },

                bindEvents() {
                    EventBus.on('message:sent', (message) => {
                        this.processMessage(message.content);
                    });
                },

                processMessage(message) {
                    const lowerMessage = message.toLowerCase();
                    
                    // Check for crisis first
                    if (this.isCrisis(lowerMessage)) {
                        this.handleCrisis();
                        return null;
                    }
                    
                    // Check for evidence-based responses
                    return this.generateEvidenceBasedResponse(lowerMessage);
                },

                isCrisis(message) {
                    return this.crisisProtocol.triggers.some(trigger => message.includes(trigger));
                },

                handleCrisis() {
                    CrisisResources.showCrisisAlert();
                },

                generateEvidenceBasedResponse(message) {
                    // Check each framework
                    for (const [frameworkName, framework] of Object.entries(this.frameworks)) {
                        for (const [techniqueName, technique] of Object.entries(framework.techniques)) {
                            if (technique.pattern.test(message)) {
                                return {
                                    type: 'evidence-based',
                                    framework: frameworkName,
                                    technique: techniqueName,
                                    response: technique.response,
                                    evidence: technique.framework
                                };
                            }
                        }
                    }
                    return null;
                },

                getDisclaimer() {
                    return this.disclaimer;
                }
            };

            // Make ClinicalEvidence globally available
            window.ClinicalEvidence = ClinicalEvidence;

            // ============================================================
            // CLINICAL ASSESSMENTS - PHQ-9, GAD-7, CAGE
            // ============================================================

            const ClinicalAssessment = {
                assessments: {
                    PHQ9: {
                        name: 'Patient Health Questionnaire-9',
                        items: [
                            'Guhabwa agahinda, kwiheba, cyangwa kutagira ibyiringiro',
                            'Kutagira ishyaka mu bintu byakunezezaga',
                            'Guhangayika, kwiheba, cyangwa kumva uri mu matara',
                            'Kugorwa no gusinzira cyangwa kuryama cyane',
                            'Kumva ukoze nabi cyangwa ko wananirwa',
                            'Kugabanuka k\'ifunguro cyangwa kurya byinshi',
                            'Kwiyumva nabi kuri wowe - cyangwa ko wananirwa',
                            'Kugorwa no kwibanda ku bintu',
                            'Gutekereza cyangwa kwifuza gupfa'
                        ],
                        scoring: {
                            0: 'Nta na rimwe',
                            1: 'Iminsi mike',
                            2: 'Insg. zirenga kimwe mu cyumweru',
                            3: 'Buri munsi'
                        },
                        interpretation: (score) => {
                            if (score < 5) return { level: 'Normal', recommendation: 'Komeza gusobera' };
                            if (score < 10) return { level: 'Yoroheje', recommendation: 'Guma wiringiye, reba muganga niba byikomeza' };
                            if (score < 15) return { level: 'Hagati', recommendation: 'Reba umuvuzi w\'umutima' };
                            if (score < 20) return { level: 'Hagati-cyane', recommendation: 'Ukeneye ubufasha bwihutirwa' };
                            return { level: 'Ikabije', recommendation: 'Bona ubufasha bwihutirwa' };
                        }
                    },
                    GAD7: {
                        name: 'Generalized Anxiety Disorder-7',
                        items: [
                            'Kumva uhangayitse, utuje, cyangwa uri mu matara',
                            'Kutagomba guhagarara',
                            'Kurakara cyane',
                            'Kutagira umutekano',
                            'Kutagira ibyiringiro',
                            'Kutagira umutekano mu mutwe',
                            'Kutagira ibyiringiro by\'igihe kizaza'
                        ],
                        scoring: {
                            0: 'Nta na rimwe',
                            1: 'Iminsi mike',
                            2: 'Insg. zirenga kimwe mu cyumweru',
                            3: 'Buri munsi'
                        },
                        interpretation: (score) => {
                            if (score < 5) return { level: 'Normal', recommendation: 'Komeza gusobera' };
                            if (score < 10) return { level: 'Yoroheje', recommendation: 'Guma wiringiye' };
                            if (score < 15) return { level: 'Hagati', recommendation: 'Reba umuvuzi w\'umutima' };
                            return { level: 'Ikabije', recommendation: 'Ukeneye ubufasha bwihutirwa' };
                        }
                    },
                    CAGE: {
                        name: 'CAGE Questionnaire (Substance Use)',
                        items: [
                            'Wigeze utekereza ko ugomba kugabanya ibinyobwa?',
                            'Wigeze urakara iyo abantu bakugaya kubera ibinyobwa?',
                            'Wigeze wumva ubyoroshye kubera ibinyobwa?',
                            'Wigeze unywa ikinyobwa mu gitondo kugira ngo wiyumve neza?'
                        ],
                        interpretation: (score) => {
                            if (score >= 2) return { 
                                level: 'Ikibazo gishobora kubaho', 
                                recommendation: 'Reba umuvuzi w\'ubuvuzi bwo mu mutwe' 
                            };
                            return { level: 'Nta kibazo', recommendation: 'Komeza gusobera' };
                        }
                    }
                },

                currentSession: null,

                init() {
                    this.createAssessmentUI();
                },

                createAssessmentUI() {
                    // Create assessment button in sidebar
                    const sidebar = document.querySelector('.sidebar-content');
                    if (!sidebar || document.getElementById('assessmentBtn')) return;

                    const btn = document.createElement('button');
                    btn.id = 'assessmentBtn';
                    btn.className = 'sidebar-btn';
                    btn.innerHTML = '<i class="fas fa-clipboard-check"></i><span>Gusuzuma</span>';
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        this.showAssessmentModal();
                    };
                    sidebar.insertBefore(btn, document.getElementById('newChatBtn'));

                    // Dismiss Gusuzuma button when user taps/clicks anywhere on screen
                    document.addEventListener('click', (e) => {
                        const assessBtn = document.getElementById('assessmentBtn');
                        if (assessBtn && !assessBtn.contains(e.target)) {
                            assessBtn.style.display = 'none';
                        }
                    });
                    document.addEventListener('touchstart', (e) => {
                        const assessBtn = document.getElementById('assessmentBtn');
                        if (assessBtn && !assessBtn.contains(e.target)) {
                            assessBtn.style.display = 'none';
                        }
                    }, { passive: true });
                },

                showAssessmentModal() {
                    if (document.getElementById('assessmentModal')) return;

                    const modal = document.createElement('div');
                    modal.className = 'modal-backdrop active';
                    modal.id = 'assessmentModal';
                    modal.innerHTML = `
                        <div class="modal active" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3 class="modal-title">ð©º Gusuzuma</h3>
                                <button class="modal-close" id="assessmentClose">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                                    Hitamo uburyo bwo gusuzuma:
                                </p>
                                <div style="display: grid; gap: var(--space-3);">
                                    <button class="btn btn-secondary" onclick="ClinicalAssessment.startAssessment('PHQ9')">
                                        <i class="fas fa-frown"></i> PHQ-9 (Agahinda)
                                    </button>
                                    <button class="btn btn-secondary" onclick="ClinicalAssessment.startAssessment('GAD7')">
                                        <i class="fas fa-exclamation-triangle"></i> GAD-7 (Ubugome)
                                    </button>
                                    <button class="btn btn-secondary" onclick="ClinicalAssessment.startAssessment('CAGE')">
                                        <i class="fas fa-wine-glass"></i> CAGE (Ibinyobwa)
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                    modal.querySelector('#assessmentClose').onclick = () => modal.remove();
                    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
                },

                startAssessment(type) {
                    const assessment = this.assessments[type];
                    if (!assessment) return;

                    this.currentSession = {
                        type: type,
                        currentItem: 0,
                        responses: []
                    };

                    this.showAssessmentQuestion();
                    document.getElementById('assessmentModal')?.remove();
                },

                showAssessmentQuestion() {
                    const session = this.currentSession;
                    const assessment = this.assessments[session.type];
                    const item = assessment.items[session.currentItem];

                    if (document.getElementById('assessmentQuestionModal')) {
                        document.getElementById('assessmentQuestionModal').remove();
                    }

                    const modal = document.createElement('div');
                    modal.className = 'modal-backdrop active';
                    modal.id = 'assessmentQuestionModal';
                    modal.innerHTML = `
                        <div class="modal active" style="max-width: 600px;">
                            <div class="modal-header">
                                <h3 class="modal-title">${assessment.name}</h3>
                            </div>
                            <div class="modal-body">
                                <div style="margin-bottom: var(--space-4);">
                                    <span style="color: var(--color-text-muted);">Ikibazo ${session.currentItem + 1} / ${assessment.items.length}</span>
                                </div>
                                <p style="font-size: var(--text-lg); margin-bottom: var(--space-6);">${item}</p>
                                <div style="display: grid; gap: var(--space-2);">
                                    <button class="btn btn-secondary" onclick="ClinicalAssessment.answerQuestion(0)">
                                        0 - ${assessment.scoring[0]}
                                    </button>
                                    <button class="btn btn-secondary" onclick="ClinicalAssessment.answerQuestion(1)">
                                        1 - ${assessment.scoring[1]}
                                    </button>
                                    <button class="btn btn-secondary" onclick="ClinicalAssessment.answerQuestion(2)">
                                        2 - ${assessment.scoring[2]}
                                    </button>
                                    <button class="btn btn-secondary" onclick="ClinicalAssessment.answerQuestion(3)">
                                        3 - ${assessment.scoring[3]}
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                },

                answerQuestion(score) {
                    const session = this.currentSession;
                    session.responses.push(score);
                    session.currentItem++;

                    const assessment = this.assessments[session.type];

                    if (session.currentItem >= assessment.items.length) {
                        this.completeAssessment();
                    } else {
                        this.showAssessmentQuestion();
                    }
                },

                completeAssessment() {
                    const session = this.currentSession;
                    const assessment = this.assessments[session.type];
                    const totalScore = session.responses.reduce((a, b) => a + b, 0);
                    const result = assessment.interpretation(totalScore);

                    document.getElementById('assessmentQuestionModal')?.remove();

                    const modal = document.createElement('div');
                    modal.className = 'modal-backdrop active';
                    modal.innerHTML = `
                        <div class="modal active" style="max-width: 500px;">
                            <div class="modal-header">
                                <h3 class="modal-title">${assessment.name}</h3>
                                <button class="modal-close" onclick="this.closest('.modal-backdrop').remove()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div style="text-align: center; margin-bottom: var(--space-6);">
                                    <div style="font-size: 4rem; font-weight: bold; color: var(--color-primary-400);">${totalScore}</div>
                                    <div style="color: var(--color-text-muted);">Igiteranyo</div>
                                </div>
                                <div style="padding: var(--space-4); background: var(--color-surface-700); border-radius: var(--radius-lg); margin-bottom: var(--space-4);">
                                    <div style="font-weight: bold; margin-bottom: var(--space-2);">${result.level}</div>
                                    <div style="color: var(--color-text-secondary);">${result.recommendation}</div>
                                </div>
                                <p style="font-size: var(--text-sm); color: var(--color-text-muted); text-align: center;">
                                    âï¸ Ibi ni uburyo bwo gusuzuma. Ntabwo ari diagnosis. Reba umuvuzi w\'umutima.
                                </p>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(modal);
                    
                    // Save to history
                    this.saveAssessmentResult(session.type, totalScore, result);
                    this.currentSession = null;
                },

                saveAssessmentResult(type, score, result) {
                    const history = StateManager.get('assessmentHistory') || [];
                    history.push({
                        type: type,
                        score: score,
                        result: result,
                        timestamp: Date.now()
                    });
                    StateManager.set('assessmentHistory', history.slice(-50));
                    StateManager.saveSettings();
                }
            };

            // Make ClinicalAssessment globally available
            window.ClinicalAssessment = ClinicalAssessment;

            // ============================================================
            // RISK ASSESSMENT - Safety Monitoring
            // ============================================================

            const RiskAssessment = {
                riskFactors: {
                    suicidal: [
                        { keyword: 'kwiyahura', weight: 1.0 },
                        { keyword: 'gupfa', weight: 0.8 },
                        { keyword: 'ntakibazo', weight: 0.9 },
                        { keyword: 'birangiye', weight: 0.7 },
                        { keyword: 'kwikomeretsa', weight: 1.0 },
                        { keyword: 'kwiyica', weight: 1.0 }
                    ],
                    selfHarm: [
                        { keyword: 'kwiyaga', weight: 1.0 },
                        { keyword: 'kwikomeretsa', weight: 1.0 },
                        { keyword: 'kwiyica', weight: 1.0 }
                    ],
                    hopelessness: [
                        { keyword: 'ntacyo bizahindura', weight: 0.6 },
                        { keyword: 'ntabwo bishoboka', weight: 0.5 },
                        { keyword: 'byananiranye', weight: 0.5 },
                        { keyword: 'ntacyo nbona', weight: 0.6 }
                    ]
                },

                recentRiskScore: 0,

                init() {
                    EventBus.on('message:sent', (message) => {
                        this.assessRisk(message.content);
                    });
                },

                assessRisk(message) {
                    const lowerMessage = message.toLowerCase();
                    let riskScore = 0;
                    let riskFactors = [];

                    // Check risk factors
                    for (const [factor, keywords] of Object.entries(this.riskFactors)) {
                        for (const keyword of keywords) {
                            if (lowerMessage.includes(keyword.keyword)) {
                                riskScore += keyword.weight;
                                riskFactors.push({
                                    factor: factor,
                                    keyword: keyword.keyword,
                                    weight: keyword.weight
                                });
                            }
                        }
                    }

                    // Consider historical context
                    if (this.recentRiskScore > 0) {
                        riskScore = Math.max(riskScore, this.recentRiskScore * 0.8);
                    }

                    // Consider time of day (night = higher risk)
                    const hour = new Date().getHours();
                    if (hour < 6 || hour > 22) {
                        riskScore *= 1.2;
                    }

                    this.recentRiskScore = riskScore;

                    // Trigger crisis protocol if high risk
                    if (riskScore > 1.5) {
                        CrisisResources.showCrisisAlert();
                    }

                    return {
                        score: riskScore,
                        level: riskScore > 1.5 ? 'high' : riskScore > 0.8 ? 'moderate' : 'low',
                        factors: riskFactors
                    };
                },

                generateSafetyPlan() {
                    return {
                        warningSigns: [
                            'Iyo ntekereza cyane',
                            'Iyo numva nta mbaraga',
                            'Iyo ndakaye cyane'
                        ],
                        copingStrategies: [
                            'Kuvugana n\'umuntu nkunda',
                            'Guhumeka mu buryo burambye',
                            'Kugenda gato'
                        ],
                        professionalSupport: [
                            { name: 'Isange One Stop', number: '3029' },
                            { name: 'Crisis Line', number: '116' }
                        ],
                        emergency: {
                            hospital: 'CHUK Emergency',
                            number: '112',
                            address: 'Kigali'
                        }
                    };
                }
            };

            // Make RiskAssessment globally available
            window.RiskAssessment = RiskAssessment;

            // ============================================================
            // EMOTIONAL ANALYTICS
            // ============================================================

            const EmotionalAnalytics = {
                data: [],
                
                init() {
                    this.loadData();
                    this.createDashboard();
                },
                
                loadData() {
                    try {
                        this.data = JSON.parse(localStorage.getItem('tyaza_analytics_v3') || '[]');
                    } catch {
                        this.data = [];
                    }
                },
                
                saveData() {
                    localStorage.setItem('tyaza_analytics_v3', JSON.stringify(this.data.slice(-100)));
                },
                
                analyzeMessage(text, role) {
                    if (role !== 'user') return;
                    
                    const emotions = {
                        joy: 0,
                        sadness: 0,
                        anger: 0,
                        fear: 0,
                        love: 0,
                        hope: 0
                    };
                    
                    // Kinyarwanda emotional keywords
                    const keywords = {
                        joy: ['ishimwe', 'ibyishimo', 'kunezerwa', 'byiza', 'ndishimye', 'nezerewe'],
                        sadness: ['agahinda', 'umaraye', 'mbabaye', 'ntishimye', 'bibabaza', 'ndababaye'],
                        anger: ['uburakari', 'narakaye', 'mpatanye', 'sinshaka', 'urakari'],
                        fear: ['ubwoba', 'gutinya', 'ntekereze', 'wigitsa', 'ndatinya'],
                        love: ['urukundo', 'nkunda', 'ugukunda', 'umutima', 'ndagukunda'],
                        hope: ['ishinga', 'ibyiringiro', 'niringira', 'nzabona', 'niringiye']
                    };
                    
                    const lower = text.toLowerCase();
                    
                    Object.keys(keywords).forEach(emotion => {
                        keywords[emotion].forEach(word => {
                            if (lower.includes(word)) {
                                emotions[emotion] += 1;
                            }
                        });
                    });
                    
                    // Calculate total and normalize
                    const total = Object.values(emotions).reduce((a, b) => a + b, 0);
                    if (total > 0) {
                        Object.keys(emotions).forEach(key => {
                            emotions[key] = emotions[key] / total;
                        });
                    }
                    
                    // Store with timestamp
                    this.data.push({
                        timestamp: Date.now(),
                        emotions,
                        text: text.slice(0, 50)
                    });
                    
                    this.saveData();
                    this.updateDashboard();
                },
                
                createDashboard() {
                    // Check if already exists
                    if (document.getElementById('analyticsDashboard')) return;
                    
                    const dashboard = document.createElement('div');
                    dashboard.id = 'analyticsDashboard';
                    dashboard.className = 'analytics-dashboard';
                    dashboard.innerHTML = `
                        <div class="analytics-header">
                            <h3>ð Ihindagurika ry'amarangamutima</h3>
                            <button class="btn btn-sm btn-ghost" id="toggleAnalytics">
                                <i class="fas fa-chart-line"></i>
                            </button>
                        </div>
                        <div class="analytics-content" id="analyticsContent">
                            <canvas id="emotionChart" width="400" height="200"></canvas>
                            <div class="analytics-stats" id="analyticsStats"></div>
                        </div>
                    `;
                    
                    // Add to sidebar (after new chat button)
                    const sidebar = document.querySelector('.sidebar-content');
                    const newChatBtn = document.getElementById('newChatBtn');
                    if (sidebar && newChatBtn) {
                        sidebar.insertBefore(dashboard, newChatBtn.nextSibling);
                    }
                    
                    // Toggle functionality
                    document.getElementById('toggleAnalytics')?.addEventListener('click', () => {
                        const content = document.getElementById('analyticsContent');
                        content.classList.toggle('collapsed');
                    });
                    
                    this.updateDashboard();
                },
                
                updateDashboard() {
                    if (this.data.length === 0) return;
                    
                    const recent = this.data.slice(-20);
                    
                    // Calculate averages
                    const averages = {
                        joy: 0,
                        sadness: 0,
                        anger: 0,
                        fear: 0,
                        love: 0,
                        hope: 0
                    };
                    
                    recent.forEach(entry => {
                        Object.keys(averages).forEach(key => {
                            averages[key] += entry.emotions[key] || 0;
                        });
                    });
                    
                    Object.keys(averages).forEach(key => {
                        averages[key] = (averages[key] / recent.length * 100).toFixed(1);
                    });
                    
                    // Update stats
                    const stats = document.getElementById('analyticsStats');
                    if (stats) {
                        stats.innerHTML = Object.entries(averages).map(([emotion, value]) => `
                            <div class="stat-item">
                                <div class="stat-label">
                                    <span class="emotion-badge" style="background: ${this.getEmotionColor(emotion)}"></span>
                                    ${this.getEmotionName(emotion)}
                                </div>
                                <div class="stat-value">${value}%</div>
                            </div>
                        `).join('');
                    }
                    
                    // Draw chart
                    this.drawChart(recent);
                },
                
                drawChart(data) {
                    const canvas = document.getElementById('emotionChart');
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Clear
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw background
                    ctx.fillStyle = 'rgba(26, 20, 51, 0.5)';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw grid
                    ctx.strokeStyle = 'rgba(139, 92, 246, 0.2)';
                    ctx.lineWidth = 1;
                    
                    for (let i = 0; i <= 4; i++) {
                        const y = canvas.height - (i * canvas.height / 4);
                        ctx.beginPath();
                        ctx.moveTo(30, y);
                        ctx.lineTo(canvas.width - 10, y);
                        ctx.stroke();
                    }
                    
                    // Draw lines for each emotion
                    const emotions = ['joy', 'sadness', 'anger', 'fear', 'love', 'hope'];
                    const colors = ['#fbbf24', '#60a5fa', '#ef4444', '#a78bfa', '#ec4899', '#34d399'];
                    
                    emotions.forEach((emotion, idx) => {
                        if (data.length < 2) return;
                        
                        ctx.beginPath();
                        ctx.strokeStyle = colors[idx];
                        ctx.lineWidth = 2;
                        
                        data.forEach((entry, i) => {
                            const x = 30 + (i * ((canvas.width - 40) / (data.length - 1)));
                            const y = canvas.height - (entry.emotions[emotion] || 0) * canvas.height;
                            
                            if (i === 0) {
                                ctx.moveTo(x, y);
                            } else {
                                ctx.lineTo(x, y);
                            }
                        });
                        
                        ctx.stroke();
                    });
                },
                
                getEmotionColor(emotion) {
                    const colors = {
                        joy: '#fbbf24',
                        sadness: '#60a5fa',
                        anger: '#ef4444',
                        fear: '#a78bfa',
                        love: '#ec4899',
                        hope: '#34d399'
                    };
                    return colors[emotion] || '#94a3b8';
                },
                
                getEmotionName(emotion) {
                    const names = {
                        joy: 'Ibyishimo',
                        sadness: 'Agahinda',
                        anger: 'Uburakari',
                        fear: 'Ubwoba',
                        love: 'Urukundo',
                        hope: 'Ibyiringiro'
                    };
                    return names[emotion] || emotion;
                }
            };

            // ============================================================
            // MEDITATION LIBRARY
            // ============================================================

            const MeditationLibrary = {
                exercises: [
                    {
                        id: 'breath-1',
                        title: 'Guhumeka mu mahoro',
                        duration: 300,
                        level: 'beginner',
                        category: 'breathing',
                        icon: 'ð¬ï¸',
                        steps: [
                            { instruction: 'Fungura amaso, uhore.', duration: 10 },
                            { instruction: 'Humeka ukoresheje izuru - 1, 2, 3, 4', duration: 4 },
                            { instruction: 'Fata umwanya - 1, 2', duration: 2 },
                            { instruction: 'Hohora bworoshye - 1, 2, 3, 4, 5, 6', duration: 6 },
                            { instruction: 'Subiramo ibi inshuro 10', duration: 120 }
                        ]
                    },
                    {
                        id: 'body-1',
                        title: 'Kurekura umubiri',
                        duration: 600,
                        level: 'intermediate',
                        category: 'body-scan',
                        icon: 'ð§',
                        steps: [
                            { instruction: 'Ryama neza cyangwa wicare utuje.', duration: 20 },
                            { instruction: 'Tekereza ku birenge byawe...', duration: 30 },
                            { instruction: 'Tekereza ku maguru yawe...', duration: 30 },
                            { instruction: 'Tekereza ku kibuno...', duration: 30 },
                            { instruction: 'Tekereza mu igifu...', duration: 30 },
                            { instruction: 'Tekereza mu gituza...', duration: 30 },
                            { instruction: 'Tekereza ku amaboko yawe...', duration: 30 },
                            { instruction: 'Tekereza ku ijosi...', duration: 30 },
                            { instruction: 'Tekereza ku mutwe wawe...', duration: 30 },
                            { instruction: 'Ubu umubiri wawe wose uroroshye...', duration: 60 }
                        ]
                    },
                    {
                        id: 'gratitude-1',
                        title: 'Ishimwe ryo mu mutima',
                        duration: 420,
                        level: 'beginner',
                        category: 'gratitude',
                        icon: 'ð',
                        steps: [
                            { instruction: 'Tekereza ku kintu kimwe wishimira uyu munsi.', duration: 30 },
                            { instruction: 'Tekereza ku muntu umwe ushima.', duration: 30 },
                            { instruction: 'Tekereza ku mubiri wawe - icyo ukora.', duration: 30 },
                            { instruction: 'Tekereza ku isi ikugoye - uko ikomeza.', duration: 30 },
                            { instruction: 'Vuga mu mutima: "Ndabashimira"', duration: 60 }
                        ]
                    },
                    {
                        id: 'sleep-1',
                        title: 'Ijoro ryiza',
                        duration: 900,
                        level: 'all',
                        category: 'sleep',
                        icon: 'ð´',
                        steps: [
                            { instruction: 'Ryama mu buryo bworoshye.', duration: 30 },
                            { instruction: 'Humeka buhoro buhoro...', duration: 60 },
                            { instruction: 'Tekereza ko uri mu kirere...', duration: 120 },
                            { instruction: 'Umubiri wawe uroroshye...', duration: 180 },
                            { instruction: 'Umutwe wawe uroroshye...', duration: 180 },
                            { instruction: 'Ibyo wibaza byose biragenda...', duration: 180 },
                            { instruction: 'Ubu uri hafi yo gusinzira...', duration: 150 }
                        ]
                    },
                    {
                        id: 'anxiety-1',
                        title: 'Kurekura ubwoba',
                        duration: 480,
                        level: 'intermediate',
                        category: 'anxiety',
                        icon: 'ðï¸',
                        steps: [
                            { instruction: 'Emera ko ubwoba buhari.', duration: 30 },
                            { instruction: 'Humeka mu buryo burambye.', duration: 60 },
                            { instruction: 'Tekereza ubwoba nk\'igicu kiri mu kirere...', duration: 60 },
                            { instruction: 'Kireke kigende...', duration: 60 },
                            { instruction: 'Wowe uri umunsi uriho...', duration: 60 },
                            { instruction: 'Iki gihe, ubu, noneho...', duration: 60 },
                            { instruction: 'Umutekano uri muri wowe.', duration: 90 }
                        ]
                    }
                ],
                
                init() {
                    this.createLibraryUI();
                    this.addMeditationButton();
                },
                
                createLibraryUI() {
                    // Check if already exists
                    if (document.getElementById('meditationLibrary')) return;
                    
                    const container = document.createElement('div');
                    container.id = 'meditationLibrary';
                    container.className = 'meditation-library';
                    container.innerHTML = `
                        <div class="meditation-header">
                            <h3>ð§ Imyitozo ngororamutwe</h3>
                            <button class="btn btn-sm btn-ghost" id="toggleMeditation">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div class="meditation-content" id="meditationContent">
                            <div class="meditation-filters">
                                <select class="select" id="meditationFilter">
                                    <option value="all">Byose</option>
                                    <option value="beginner">Intangiriro</option>
                                    <option value="intermediate">Hagati</option>
                                </select>
                                <select class="select" id="categoryFilter">
                                    <option value="all">Ubwoko bwose</option>
                                    <option value="breathing">Guhumeka</option>
                                    <option value="body-scan">Kurekura umubiri</option>
                                    <option value="gratitude">Ishimwe</option>
                                    <option value="sleep">Ijoro</option>
                                    <option value="anxiety">Kurekura ubwoba</option>
                                </select>
                            </div>
                            <div class="meditation-grid" id="meditationGrid">
                                ${this.renderExercises()}
                            </div>
                        </div>
                    `;
                    
                    // Add to sidebar
                    const sidebar = document.querySelector('.sidebar-content');
                    const analytics = document.getElementById('analyticsDashboard');
                    if (sidebar) {
                        if (analytics) {
                            sidebar.insertBefore(container, analytics.nextSibling);
                        } else {
                            sidebar.appendChild(container);
                        }
                    }
                    
                    // Bind events
                    document.getElementById('toggleMeditation')?.addEventListener('click', () => {
                        const content = document.getElementById('meditationContent');
                        content.classList.toggle('collapsed');
                    });
                    
                    document.getElementById('meditationFilter')?.addEventListener('change', (e) => {
                        const grid = document.getElementById('meditationGrid');
                        const category = document.getElementById('categoryFilter').value;
                        grid.innerHTML = this.renderExercises(e.target.value, category);
                    });
                    
                    document.getElementById('categoryFilter')?.addEventListener('change', (e) => {
                        const grid = document.getElementById('meditationGrid');
                        const level = document.getElementById('meditationFilter').value;
                        grid.innerHTML = this.renderExercises(level, e.target.value);
                    });
                    
                    // Play buttons
                    document.addEventListener('click', (e) => {
                        if (e.target.closest('.meditation-play')) {
                            const btn = e.target.closest('.meditation-play');
                            const id = btn.dataset.id;
                            const exercise = this.exercises.find(ex => ex.id === id);
                            if (exercise) {
                                this.startMeditation(exercise);
                            }
                        }
                    });
                },
                
                renderExercises(filter = 'all', category = 'all') {
                    const filtered = this.exercises.filter(ex => {
                        if (filter !== 'all' && ex.level !== filter) return false;
                        if (category !== 'all' && ex.category !== category) return false;
                        return true;
                    });
                    
                    return filtered.map(ex => `
                        <div class="meditation-card" data-id="${ex.id}">
                            <div class="meditation-icon">${ex.icon}</div>
                            <div class="meditation-info">
                                <div class="meditation-title">${ex.title}</div>
                                <div class="meditation-meta">
                                    <span class="meditation-duration">${Math.floor(ex.duration / 60)} min</span>
                                    <span class="meditation-level ${ex.level}">${ex.level}</span>
                                </div>
                            </div>
                            <button class="meditation-play" data-id="${ex.id}">
                                <i class="fas fa-play"></i>
                            </button>
                        </div>
                    `).join('');
                },
                
                startMeditation(exercise) {
                    // Check if already playing
                    if (document.getElementById('meditationPlayer')) {
                        document.getElementById('meditationPlayer').remove();
                    }
                    
                    // Create player
                    const player = document.createElement('div');
                    player.className = 'meditation-player';
                    player.id = 'meditationPlayer';
                    player.innerHTML = `
                        <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-3);">
                            <div class="meditation-icon">${exercise.icon}</div>
                            <div>
                                <div style="font-weight: 600;">${exercise.title}</div>
                                <div style="font-size: var(--text-xs); color: var(--color-text-muted);">
                                    ${Math.floor(exercise.duration / 60)} min
                                </div>
                            </div>
                            <button class="meditation-close" style="margin-left: auto; background: none; border: none; color: var(--color-text-muted); cursor: pointer;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="meditation-instruction" id="meditationInstruction">
                            ${exercise.steps[0].instruction}
                        </div>
                        
                        <div class="meditation-timer" id="meditationTimer">
                            00:00
                        </div>
                        
                        <div class="meditation-progress">
                            <div class="meditation-progress-bar" id="meditationProgress" style="width: 0%"></div>
                        </div>
                        
                        <div class="meditation-controls">
                            <button class="meditation-control" id="meditationPrev">
                                <i class="fas fa-step-backward"></i>
                            </button>
                            <button class="meditation-control pause" id="meditationPlayPause">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button class="meditation-control" id="meditationNext">
                                <i class="fas fa-step-forward"></i>
                            </button>
                            <button class="meditation-control" id="meditationStop">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                        
                        <div style="text-align: center; margin-top: var(--space-3); font-size: var(--text-xs); color: var(--color-text-muted);">
                            <i class="fas fa-volume-up"></i> Jwi riracyafite
                        </div>
                    `;
                    
                    document.body.appendChild(player);
                    
                    // Meditation state
                    let currentStep = 0;
                    let timeInStep = 0;
                    let isPlaying = true;
                    let interval;
                    
                    const updateDisplay = () => {
                        const step = exercise.steps[currentStep];
                        const instruction = document.getElementById('meditationInstruction');
                        const timer = document.getElementById('meditationTimer');
                        const progress = document.getElementById('meditationProgress');
                        
                        if (instruction) {
                            instruction.textContent = step.instruction;
                        }
                        
                        // Calculate total elapsed time
                        let elapsed = 0;
                        for (let i = 0; i < currentStep; i++) {
                            elapsed += exercise.steps[i].duration;
                        }
                        elapsed += timeInStep;
                        
                        const total = exercise.duration;
                        const percent = (elapsed / total) * 100;
                        
                        if (progress) {
                            progress.style.width = `${percent}%`;
                        }
                        
                        // Format timer
                        const mins = Math.floor(elapsed / 60);
                        const secs = elapsed % 60;
                        if (timer) {
                            timer.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                        }
                    };
                    
                    const tick = () => {
                        if (!isPlaying) return;
                        
                        timeInStep++;
                        
                        const currentStepDuration = exercise.steps[currentStep].duration;
                        
                        if (timeInStep >= currentStepDuration) {
                            timeInStep = 0;
                            currentStep++;
                            
                            if (currentStep >= exercise.steps.length) {
                                // End of meditation
                                clearInterval(interval);
                                ToastService.success('Imyitozo yarangiye!', 'success');
                                
                                // Speak completion
                                SpeechService.speak("Imyitozo yarangiye. Urakaze!");
                                
                                setTimeout(() => {
                                    if (player.parentNode) {
                                        player.remove();
                                    }
                                }, 3000);
                                
                                return;
                            }
                            
                            // Speak new instruction
                            SpeechService.speak(exercise.steps[currentStep].instruction);
                        }
                        
                        updateDisplay();
                    };
                    
                    // Start timer
                    interval = setInterval(tick, 1000);
                    
                    // Speak first instruction
                    setTimeout(() => {
                        SpeechService.speak(exercise.steps[0].instruction);
                    }, 500);
                    
                    updateDisplay();
                    
                    // Bind controls
                    player.querySelector('#meditationPlayPause').onclick = (e) => {
                        isPlaying = !isPlaying;
                        e.target.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
                    };
                    
                    player.querySelector('#meditationStop').onclick = () => {
                        clearInterval(interval);
                        player.remove();
                    };
                    
                    player.querySelector('#meditationPrev').onclick = () => {
                        if (currentStep > 0) {
                            currentStep--;
                            timeInStep = 0;
                            updateDisplay();
                            SpeechService.speak(exercise.steps[currentStep].instruction);
                        }
                    };
                    
                    player.querySelector('#meditationNext').onclick = () => {
                        if (currentStep < exercise.steps.length - 1) {
                            currentStep++;
                            timeInStep = 0;
                            updateDisplay();
                            SpeechService.speak(exercise.steps[currentStep].instruction);
                        }
                    };
                    
                    player.querySelector('.meditation-close').onclick = () => {
                        clearInterval(interval);
                        player.remove();
                    };
                },
                
                addMeditationButton() {
                    const button = document.createElement('button');
                    button.className = 'meditation-quick-btn';
                    button.id = 'meditationQuickBtn';
                    button.innerHTML = '<i class="fas fa-brain"></i>';
                    button.title = 'Imyitozo ngororamutwe';
                    
                    button.onclick = () => {
                        const random = this.exercises[Math.floor(Math.random() * this.exercises.length)];
                        this.startMeditation(random);
                    };
                    
                    document.body.appendChild(button);
                }
            };

            // ============================================================
            // EXPORT/IMPORT MANAGER
            // ============================================================

            const ExportManager = {
                async exportChat(format = 'json') {
                    const chat = StateManager.get('currentChat');
                    if (chat.length === 0) {
                        ToastService.warning('Nta chat yohereza');
                        return;
                    }
                    
                    const metadata = {
                        app: 'TYAZA',
                        version: '3.0',
                        timestamp: Date.now(),
                        user: 'Anonymous',
                        conversationId: StateManager.get('currentChatId')
                    };
                    
                    switch(format) {
                        case 'json':
                            this.exportJSON(chat, metadata);
                            break;
                        case 'txt':
                            this.exportTXT(chat, metadata);
                            break;
                        case 'encrypted':
                            await this.exportEncrypted(chat, metadata);
                            break;
                        case 'html':
                            this.exportHTML(chat, metadata);
                            break;
                        case 'csv':
                            this.exportCSV(chat, metadata);
                            break;
                        default:
                            this.exportJSON(chat, metadata);
                    }
                },
                
                exportJSON(chat, metadata) {
                    const data = { metadata, messages: chat };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    this.download(blob, `tyaza-${Date.now()}.json`);
                    ToastService.success('Yakozwe mu JSON!');
                },
                
                exportTXT(chat, metadata) {
                    let text = `TYAZA CONVERSATION EXPORT\n`;
                    text += `Generated: ${new Date(metadata.timestamp).toLocaleString()}\n`;
                    text += `App: ${metadata.app} v${metadata.version}\n`;
                    text += `Conversation ID: ${metadata.conversationId}\n`;
                    text += `========================================\n\n`;
                    
                    chat.forEach(msg => {
                        const role = msg.role === 'user' ? 'ð¤ USER' : 'ð¤ TYAZA';
                        text += `${role} [${new Date().toLocaleTimeString()}]\n`;
                        text += `${msg.content}\n`;
                        text += `----------------------------------------\n\n`;
                    });
                    
                    const blob = new Blob([text], { type: 'text/plain' });
                    this.download(blob, `tyaza-${Date.now()}.txt`);
                    ToastService.success('Yakozwe mu nyandiko!');
                },
                
                exportHTML(chat, metadata) {
                    const html = `
<!DOCTYPE html>
<html>
<head>
    <title>TYAZA Chat Export</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #0a0612; color: #f8fafc; }
        .header { text-align: center; margin-bottom: 40px; }
        .message { margin-bottom: 20px; display: flex; gap: 15px; }
        .user { flex-direction: row-reverse; }
        .bubble { padding: 12px 16px; border-radius: 18px; max-width: 70%; }
        .user .bubble { background: #2d2352; }
        .assistant .bubble { background: #1a1433; border: 1px solid #a78bfa; }
        .meta { font-size: 0.8rem; color: #94a3b8; margin-top: 5px; }
        .timestamp { font-size: 0.7rem; color: #64748b; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ð¤ TYAZA</h1>
        <p>Umuvugizi w'Umutima</p>
        <p class="timestamp">${new Date().toLocaleString()}</p>
    </div>
    
    ${chat.map(msg => `
        <div class="message ${msg.role}">
            <div class="bubble">
                <div>${msg.content.replace(/\n/g, '<br>')}</div>
                <div class="meta">
                    <span class="timestamp">${new Date().toLocaleTimeString()}</span>
                </div>
            </div>
        </div>
    `).join('')}
    
    <div style="text-align: center; margin-top: 50px; font-size: 0.8rem; color: #64748b;">
        Exported from TYAZA Â· Kivura Labs
    </div>
</body>
</html>
                    `;
                    
                    const blob = new Blob([html], { type: 'text/html' });
                    this.download(blob, `tyaza-${Date.now()}.html`);
                    ToastService.success('Yakozwe mu HTML!');
                },
                
                exportCSV(chat, metadata) {
                    let csv = 'Role,Timestamp,Message\n';
                    
                    chat.forEach(msg => {
                        const timestamp = new Date().toISOString();
                        const content = msg.content.replace(/,/g, ';').replace(/\n/g, ' ');
                        csv += `${msg.role},${timestamp},"${content}"\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv' });
                    this.download(blob, `tyaza-${Date.now()}.csv`);
                    ToastService.success('Yakozwe mu CSV!');
                },
                
                async exportEncrypted(chat, metadata) {
                    const password = await this.promptPassword();
                    if (!password) return;
                    
                    const data = { metadata, messages: chat };
                    const json = JSON.stringify(data);
                    
                    // Encrypt with password
                    const encrypted = await EncryptionService.encryptWithPassword(json, password);
                    
                    const blob = new Blob([encrypted], { type: 'application/octet-stream' });
                    this.download(blob, `tyaza-encrypted-${Date.now()}.tyaza`);
                    ToastService.success('Yakozwe mu buryo bwiswe!');
                },
                
                async importChat(file) {
                    const reader = new FileReader();
                    
                    reader.onload = async (e) => {
                        const content = e.target.result;
                        
                        try {
                            // Try JSON first
                            const data = JSON.parse(content);
                            if (data.messages && Array.isArray(data.messages)) {
                                this.restoreChat(data.messages);
                                return;
                            }
                        } catch {}
                        
                        // Try encrypted
                        if (file.name.endsWith('.tyaza')) {
                            const password = await this.promptPassword('Injiza ijambo ryibanga...');                           if (!password) return;
                            
                            try {
                                // Manual decryption for imported file
                                ToastService.error('Kwakira dosive yanditswe ntabwo bishoboka ubu');
                            } catch {
                                ToastService.error('Ijambo ryibanga ntirikwiye!');
                            }
                            return;
                        }
                        
                        // Try plain text
                        ToastService.error('Dosive idakwiye!');
                    };
                    
                    if (file.name.endsWith('.tyaza')) {
                        reader.readAsText(file);
                    } else {
                        reader.readAsText(file);
                    }
                },
                
                restoreChat(messages) {
                    StateManager.set('currentChat', messages);
                    StateManager.set('chatStarted', true);
                    
                    // Clear and render
                    document.querySelectorAll('.message, .typing-indicator, .welcome-screen').forEach(el => {
                        if (el.id !== 'welcomeScreen') {
                            el.remove();
                        }
                    });
                    
                    // Hide welcome screen
                    const welcomeScreen = document.getElementById('welcomeScreen');
                    if (welcomeScreen) {
                        welcomeScreen.style.display = 'none';
                    }
                    
                    // Add messages
                    messages.forEach(msg => {
                        if (window.UI && UI.addMessage) {
                            UI.addMessage(msg.role, msg.content);
                        }
                    });
                    
                    ToastService.success('Yinjijwe neza!');
                },
                
                download(blob, filename) {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.click();
                    URL.revokeObjectURL(url);
                },
                
                promptPassword(message = 'Injiza ijambo ryibanga:') {
                    return new Promise(resolve => {
                        const modal = document.createElement('div');
                        modal.className = 'modal-backdrop active';
                        modal.id = 'passwordModal';
                        modal.innerHTML = `
                            <div class="modal active" style="max-width: 400px;">
                                <div class="modal-header">
                                    <h3 class="modal-title">ð ${message}</h3>
                                    <button class="modal-close" id="passwordClose">&times;</button>
                                </div>
                                <div style="margin: var(--space-6) 0;">
                                    <input type="password" class="input" id="passwordInput" placeholder="Ijambo ryibanga...">
                                </div>
                                <div style="display: flex; gap: var(--space-3);">
                                    <button class="btn btn-secondary flex-1" id="passwordCancel">Isubire</button>
                                    <button class="btn btn-primary flex-1" id="passwordConfirm">Emeza</button>
                                </div>
                            </div>
                        `;
                        
                        document.body.appendChild(modal);
                        
                        const input = modal.querySelector('#passwordInput');
                        input.focus();
                        
                        const cleanup = () => {
                            if (modal.parentNode) {
                                modal.remove();
                            }
                        };
                        
                        modal.querySelector('#passwordConfirm').onclick = () => {
                            const password = input.value;
                            cleanup();
                            resolve(password);
                        };
                        
                        modal.querySelector('#passwordCancel').onclick = () => {
                            cleanup();
                            resolve(null);
                        };
                        
                        modal.querySelector('#passwordClose').onclick = () => {
                            cleanup();
                            resolve(null);
                        };
                        
                        input.onkeydown = (e) => {
                            if (e.key === 'Enter') {
                                modal.querySelector('#passwordConfirm').click();
                            }
                        };
                    });
                }
            };

            // ============================================================
            // AI SERVICE
            // ============================================================

            const AIService = {
                systemContext: `Wowe uri Tyaza, umuvugizi w'umutima wahimbwe na Kivura Labs.

KIVURA LABS:
- Kivura Labs ni isosiyete ikora ubushakashatsi mu by'ubwenge bw'ikoranabuhanga (AI) ifite icyicaro i Rwanda
- Ikora ibijyanye na Mental Health, Voice Technology, na Local Language Computing
- Intego yayo: gufasha abantu babana n'ibibazo by'umutekano mu mutwe binyuze mu ikoranabuhanga
- CEO: Yves HIRWA TUYISHIME

TYAZA:
- Uri AI virtual therapy assistant
- Uvuga Kinyarwanda neza, kandi ushobora no kumva no kwishyura mu ndimi zindi
- Ufasha abantu mu by'umutekano mu mutwe, ubibutsa, ugatera inkunga
- Ntabwo usimbura umuvuzi w'umubiri, ariko uri umuvugizi w'umutima ufasha

UKO WITWARA:
- Shyashya mu ijwi ryuje impuhwe, ubumuntu n'ubugoro
- Komeza ibiganiro bigufi kandi byuje ubushyuhe
- Ibaza, umve, ugire inama
- Wibuke ko buri wese yakira impuhwe
- Koresha amagambo nk' "umva", "umutima", "mahoro", "impuhwe" kenshi
- Ntugire ubusobanuro burebure cyane, ariko ugaragaze ko umva

Intego yawe: Kugira ngo nta wusigara inyuma mu bijyanye n'ikoranabuhanga â haba mu rurimi, haba mu mibereho.`,

                async checkConnection() {
                    return new Promise((resolve) => {
                        let attempts = 0;
                        const maxAttempts = 25;
                        const interval = setInterval(() => {
                            attempts++;
                            
                            if (window.puter && window.puter.ai) {
                                clearInterval(interval);
                                StateManager.set('puterReady', true);
                                resolve(true);
                            } else if (attempts >= maxAttempts) {
                                clearInterval(interval);
                                StateManager.set('puterReady', false);
                                resolve(false);
                            }
                        }, 200);
                    });
                },

                async sendMessage(messages) {
                    const isReady = await this.checkConnection();
                    
                    // Get user's name for personalized context
                    const userData = StateManager.get('userData') || {};
                    const userName = userData.name || 'User';
                    
                    // Add user name to system context
                    const personalizedContext = this.systemContext.replace('Wowe uri Tyaza', `Umukiriya wawe ni ${userName}. Wowe uri Tyaza`);
                    
                    if (isReady && window.puter?.ai) {
                        try {
                            const model = StateManager.get('settings.model');
                            const response = await window.puter.ai.chat([
                                { role: 'system', content: personalizedContext },
                                ...messages.slice(-10)
                            ], {
                                model: model,
                                stream: true
                            });

                            let fullResponse = '';
                            for await (const part of response) {
                                fullResponse += part.text || part.message?.content || '';
                                EventBus.emit('ai:stream', fullResponse);
                            }
                            
                            return fullResponse;
                        } catch (error) {
                            console.error('AI Error:', error);
                            return this.getFallbackResponse(messages[messages.length - 1]?.content || '');
                        }
                    } else {
                        return this.getFallbackResponse(messages[messages.length - 1]?.content || '');
                    }
                },

                getFallbackResponse(userMessage) {
                    const responses = [
                        "Ndumva. Urakoze kunsangiza ibi. Nzavyumvira.",
                        "Ibyo ubwishaka byakomeye. Uri kumwe nawe.",
                        "Ndi kumwe nawe. Wumva ute ubu?",
                        "Urakoze kundekera. Ibyo birashishikara.",
                        "Ndakumva. Buri jambo rifite agaciro.",
                        "Mfite icyo mbashishaka. Nzavyikanyeye.",
                        "Ndi hano. Ngomba gutegereza kimwe cya munsi.",
                        "Umva neza. Ibyo ub Rwanda birakomeye.",
                        "Uri kumwe nawe muri iri jambo. Tujyane hamwe.",
                        "Ndagira nk'umuvugizi w'umutima. Ngira icyo mbajije."
                    ];
                    
                    const lowerMessage = userMessage.toLowerCase();
                    
                    if (lowerMessage.includes('mfite') || lowerMessage.includes('ibibazo')) {
                        return "Ndumva ko ufite ibibazo. Ndi hano kugira ngo nguteze. Ubwo utubwire ikibazo cyawe, tukanakoresheje iri jambo rikwege.";
                    }
                    
                    if (lowerMessage.includes('ngomba') || lowerMessage.includes('inkunga')) {
                        return "Nagira inkunga. Ndi hano kugira ngo nkugire. Tuganire kugira ngo nibonde.";
                    }
                    
                    if (lowerMessage.includes('maraye') || lowerMessage.includes('impuhwe')) {
                        return "Ndagira impuhwe. Ariko nibagiwe ko buri munsi hari igihe. Ngaho, tuganire kugira ngo nibonde.";
                    }
                    
                    return responses[Math.floor(Math.random() * responses.length)];
                }
            };

            // ============================================================
            // UI COMPONENTS
            // ============================================================

            const UI = {
                elements: {},

                cacheElements() {
                    this.elements = {
                        app: document.getElementById('app'),
                        sidebar: document.getElementById('sidebar'),
                        sidebarOverlay: document.getElementById('sidebarOverlay'),
                        sidebarClose: document.getElementById('sidebarClose'),
                        menuToggle: document.getElementById('menuToggle'),
                        
                        messagesWrapper: document.getElementById('messagesWrapper'),
                        welcomeScreen: document.getElementById('welcomeScreen'),
                        messageInput: document.getElementById('messageInput'),
                        sendBtn: document.getElementById('sendBtn'),
                        scrollBottom: document.getElementById('scrollBottom'),
                        
                        voiceInputBtn: document.getElementById('voiceInputBtn'),
                        voiceStatus: document.getElementById('voiceStatus'),
                        sttOverlay: document.getElementById('sttOverlay'),
                        sttText: document.getElementById('sttText'),
                        micTestBtn: document.getElementById('micTestBtn'),
                        previewBtn: document.getElementById('previewBtn'),
                        
                        modelSelect: document.getElementById('modelSelect'),
                        voiceSelect: document.getElementById('voiceSelect'),
                        rateSlider: document.getElementById('rateSlider'),
                        pitchSlider: document.getElementById('pitchSlider'),
                        rateValue: document.getElementById('rateValue'),
                        pitchValue: document.getElementById('pitchValue'),
                        autoTTS: document.getElementById('autoTTS'),
                        soundEffects: document.getElementById('soundEffects'),
                        animations: document.getElementById('animations'),
                        enableEncryption: document.getElementById('enableEncryption'),
                        
                        historyList: document.getElementById('historyList'),
                        clearHistory: document.getElementById('clearHistory'),
                        newChatBtn: document.getElementById('newChatBtn'),
                        
                        exportTrigger: document.getElementById('exportTrigger'),
                        importChat: document.getElementById('importChat'),
                        clearChat: document.getElementById('clearChat'),
                        
                        loadingScreen: document.getElementById('loadingScreen'),
                        
                        starsContainer: document.getElementById('starsContainer'),
                        
                        importFile: document.getElementById('importFile')
                    };
                },

                createStars() {
                    const container = this.elements.starsContainer;
                    if (!container) return;
                    
                    const starCount = 80;
                    
                    for (let i = 0; i < starCount; i++) {
                        const star = document.createElement('div');
                        const size = Math.random() > 0.8 ? 'large' : (Math.random() > 0.5 ? 'medium' : 'small');
                        star.className = `star ${size}`;
                        star.style.left = `${Math.random() * 100}%`;
                        star.style.top = `${Math.random() * 100}%`;
                        star.style.animationDelay = `${Math.random() * 3}s`;
                        star.style.opacity = Math.random() * 0.6 + 0.2;
                        container.appendChild(star);
                    }
                },

                toggleSidebar() {
                    const isOpen = StateManager.get('isSidebarOpen');
                    
                    this.elements.sidebar.classList.toggle('open', !isOpen);
                    this.elements.sidebarOverlay.classList.toggle('active', !isOpen);
                    
                    StateManager.set('isSidebarOpen', !isOpen);
                },

                closeSidebar() {
                    this.elements.sidebar.classList.remove('open');
                    this.elements.sidebarOverlay.classList.remove('active');
                    StateManager.set('isSidebarOpen', false);
                },

                addMessage(role, content, streaming = false) {
                    if (this.elements.welcomeScreen && 
                        this.elements.welcomeScreen.style.display !== 'none') {
                        this.elements.welcomeScreen.style.display = 'none';
                    }

                    const messageId = generateId();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${role}`;
                    messageDiv.id = messageDiv.id || `msg-${messageId}`;
                    
                    const time = formatMessageTime();
                    
                    messageDiv.innerHTML = `
                        <div class="message-avatar">${role === 'user' ? 'ð¤' : '<img src="tyaza-logo.png" alt="TYAZA">'}</div>%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'44\' height=\'44\' viewBox=\'0 0 44 44\'%3E%3Crect width=\'44\' height=\'44\' rx=\'12\' fill=\'url(%23gradient)\'/%3E%3Cdefs%3E%3ClinearGradient id=\'gradient\' x1=\'0%25\' y1=\'0%25\' x2=\'100%25\' y2=\'100%25\'%3E%3Cstop offset=\'0%25\' stop-color=\'%238b5cf6\'/%3E%3Cstop offset=\'100%25\' stop-color=\'%23ec4899\'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x=\'22\' y=\'30\' font-size=\'24\' text-anchor=\'middle\' fill=\'white\' font-family=\'Arial\'%3ET%3C/text%3E%3C/svg%3E" alt="TYAZA">'}</div>
                        <div class="message-content">
                            <div class="message-bubble" id="bubble-${messageId}">
                                ${formatMessageContent(content)}
                            </div>
                            <div class="message-meta">
                                <span class="message-time">${time}</span>
                                <div class="message-actions">
                                    ${role === 'assistant' ? `
                                        <button class="message-action tooltip" data-tooltip="Soma" 
                                            onclick="window.UI && UI.speakMessage('${escapeHtml(content).replace(/'/g, "\\'")}')">
                                            <i class="fas fa-volume-up"></i>
                                        </button>
                                        <button class="message-action tooltip" data-tooltip="Kopera" 
                                            onclick="window.UI && UI.copyMessage('${escapeHtml(content).replace(/'/g, "\\'")}')">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;

                    this.elements.messagesWrapper.appendChild(messageDiv);
                    this.scrollToBottom();
                    
                    return messageId;
                },

                updateMessage(messageId, content) {
                    const bubble = document.getElementById(`bubble-${messageId}`);
                    if (bubble) {
                        bubble.innerHTML = formatMessageContent(content) + ' <span style="animation: blink 1s infinite;">â</span>';
                    }
                },

                finishMessage(messageId, content) {
                    const bubble = document.getElementById(`bubble-${messageId}`);
                    if (bubble) {
                        bubble.innerHTML = formatMessageContent(content);
                    }
                },

                showTypingIndicator() {
                    const id = 'typing-' + generateId();
                    const typingDiv = document.createElement('div');
                    typingDiv.className = 'typing-indicator';
                    typingDiv.id = id;
                    typingDiv.innerHTML = `
                        <div class="typing-avatar"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='44' height='44' viewBox='0 0 44 44'%3E%3Crect width='44' height='44' rx='12' fill='url(%23gradient)'/%3E%3Cdefs%3E%3ClinearGradient id='gradient' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%238b5cf6'/%3E%3Cstop offset='100%25' stop-color='%23ec4899'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ctext x='22' y='30' font-size='24' text-anchor='middle' fill='white' font-family='Arial'%3ET%3C/text%3E%3C/svg%3E" alt="TYAZA"></div>
                        <div class="typing-bubble">
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                            <span class="typing-dot"></span>
                        </div>
                    `;
                    
                    this.elements.messagesWrapper.appendChild(typingDiv);
                    this.scrollToBottom();
                    
                    return id;
                },

                removeTypingIndicator(id) {
                    const el = document.getElementById(id);
                    if (el) el.remove();
                },

                async renderHistory() {
                    let history = await StorageService.getHistory();
                    
                    history = history.filter(chat => 
                        chat && 
                        chat.title && 
                        chat.title.length > 0 &&
                        chat.title.length < 50
                    );
                    
                    if (history.length === 0) {
                        this.elements.historyList.innerHTML = `
                            <div class="history-empty">
                                <i>ð­</i>
                                <span>Nta mateka</span>
                            </div>
                        `;
                        return;
                    }

                    this.elements.historyList.innerHTML = history.map(chat => `
                        <div class="history-item ${chat.id === StateManager.get('currentChatId') ? 'active' : ''}" 
                             data-id="${chat.id}">
                            <div class="history-title">${escapeHtml(chat.title)}</div>
                            <div class="history-meta">
                                <span>${formatRelativeTime(chat.timestamp)}</span>
                            </div>
                        </div>
                    `).join('');

                    this.elements.historyList.querySelectorAll('.history-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const id = item.dataset.id;
                            App.restoreChat(id);
                        });
                    });
                },

                startNewChat() {
                    StateManager.set('currentChat', []);
                    StateManager.set('currentChatId', generateId());
                    StateManager.set('chatStarted', false);
                    
                    const messages = this.elements.messagesWrapper.querySelectorAll('.message, .typing-indicator');
                    messages.forEach(msg => msg.remove());
                    
                    this.elements.welcomeScreen.style.display = 'flex';
                    
                    this.elements.messageInput.value = '';
                    this.elements.sendBtn.disabled = true;
                    
                    this.renderHistory();
                    this.closeSidebar();
                },

                scrollToBottom() {
                    this.elements.messagesWrapper.scrollTo({
                        top: this.elements.messagesWrapper.scrollHeight,
                        behavior: 'smooth'
                    });
                },

                handleScroll() {
                    const { scrollTop, scrollHeight, clientHeight } = this.elements.messagesWrapper;
                    const atBottom = scrollHeight - scrollTop - clientHeight < 150;
                    
                    this.elements.scrollBottom.classList.toggle('visible', !atBottom);
                },

                speakMessage(content) {
                    const settings = StateManager.get('settings');
                    
                    if (!settings.autoTTS) {
                        ToastService.info('Fungura TTS mububiko - Soma igisubizo mu ijwi');
                        return;
                    }
                    
                    SpeechService.speak(content.replace(/<[^>]*>/g, ''));
                },

                copyMessage(content) {
                    navigator.clipboard.writeText(content).then(() => {
                        ToastService.success('Ibyakiriwe!');
                    }).catch(() => {
                        ToastService.error('Ntabashije kubika!');
                    });
                },

                updateInputHeight() {
                    const input = this.elements.messageInput;
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 150) + 'px';
                },

                setLoading(loading) {
                    this.elements.loadingScreen.classList.toggle('hidden', !loading);
                }
            };

            window.UI = UI;

            // ============================================================
            // APPLICATION
            // ============================================================

            const App = {
                async init() {
                    StateManager.loadSettings();
                    
                    UI.cacheElements();
                    UI.createStars();
                    
                    await EncryptionService.init();
                    await OfflineDB.init();
                    
                    SpeechService.initRecognition();
                    SpeechService.initSynthesis();
                    
                    this.bindEvents();
                    
                    await UI.renderHistory();
                    
                    this.applySettings();
                    
                    this.checkPuterConnection();
                    
                    CrisisResources.init();
                    EmotionalAnalytics.init();
                    MeditationLibrary.init();
                    WellbeingFeatures.init();
                    
                    // Initialize Clinical Modules
                    ClinicalEvidence.init();
                    ClinicalAssessment.init();
                    RiskAssessment.init();
                    
                    VoiceVisualizer.init();
                    
                    setTimeout(() => {
                        UI.setLoading(false);
                    }, 2000);
                    
                    console.log('TYAZA v3.0 initialized successfully');
                },

                bindEvents() {
                    UI.elements.menuToggle?.addEventListener('click', () => UI.toggleSidebar());
                    UI.elements.sidebarOverlay?.addEventListener('click', () => UI.closeSidebar());
                    UI.elements.sidebarClose?.addEventListener('click', () => UI.closeSidebar());
                    UI.elements.newChatBtn?.addEventListener('click', () => UI.startNewChat());
                    
                    UI.elements.messageInput?.addEventListener('input', () => this.handleInputChange());
                    UI.elements.messageInput?.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            if (!UI.elements.sendBtn.disabled) {
                                this.sendMessage();
                            }
                        }
                    });
                    UI.elements.sendBtn?.addEventListener('click', () => this.sendMessage());
                    
                    UI.elements.voiceInputBtn?.addEventListener('click', () => this.toggleVoiceInput());
                    UI.elements.micTestBtn?.addEventListener('click', () => this.testMicrophone());
                    UI.elements.previewBtn?.addEventListener('click', () => this.previewVoice());
                    
                    UI.elements.modelSelect?.addEventListener('change', (e) => {
                        StateManager.set('settings.model', e.target.value);
                        StateManager.saveSettings();
                    });
                    
                    UI.elements.voiceSelect?.addEventListener('change', (e) => {
                        StateManager.set('settings.voice', e.target.value);
                        StateManager.saveSettings();
                    });
                    
                    UI.elements.rateSlider?.addEventListener('input', (e) => {
                        UI.elements.rateValue.textContent = e.target.value;
                        StateManager.set('settings.rate', e.target.value);
                    });
                    
                    UI.elements.rateSlider?.addEventListener('change', () => StateManager.saveSettings());
                    
                    UI.elements.pitchSlider?.addEventListener('input', (e) => {
                        UI.elements.pitchValue.textContent = e.target.value;
                        StateManager.set('settings.pitch', e.target.value);
                    });
                    
                    UI.elements.pitchSlider?.addEventListener('change', () => StateManager.saveSettings());
                    
                    UI.elements.autoTTS?.addEventListener('change', (e) => {
                        StateManager.set('settings.autoTTS', e.target.checked);
                        StateManager.saveSettings();
                    });
                    
                    UI.elements.soundEffects?.addEventListener('change', (e) => {
                        StateManager.set('settings.soundEffects', e.target.checked);
                        StateManager.saveSettings();
                    });
                    
                    UI.elements.animations?.addEventListener('change', (e) => {
                        StateManager.set('settings.animations', e.target.checked);
                        StateManager.saveSettings();
                    });
                    
                    UI.elements.enableEncryption?.addEventListener('change', (e) => {
                        StateManager.set('settings.enableEncryption', e.target.checked);
                        StateManager.saveSettings();
                        UI.renderHistory();
                    });
                    
                    UI.elements.clearHistory?.addEventListener('click', () => this.clearAllHistory());
                    
                    UI.elements.messagesWrapper?.addEventListener('scroll', () => UI.handleScroll());
                    UI.elements.scrollBottom?.addEventListener('click', () => UI.scrollToBottom());
                    
                    UI.elements.exportTrigger?.addEventListener('click', (e) => {
                        const dropdown = document.getElementById('exportDropdown');
                        dropdown.classList.toggle('open');
                    });
                    
                    document.querySelectorAll('.dropdown-item').forEach(item => {
                        item.addEventListener('click', async (e) => {
                            const format = e.currentTarget.dataset.format;
                            await ExportManager.exportChat(format);
                            document.getElementById('exportDropdown')?.classList.remove('open');
                        });
                    });
                    
                    UI.elements.importChat?.addEventListener('click', () => {
                        UI.elements.importFile.click();
                    });
                    
                    UI.elements.importFile?.addEventListener('change', (e) => {
                        if (e.target.files[0]) {
                            ExportManager.importChat(e.target.files[0]);
                        }
                        e.target.value = '';
                    });
                    
                    UI.elements.clearChat?.addEventListener('click', () => this.clearCurrentChat());
                    
                    document.querySelectorAll('.suggestion-btn').forEach(btn => {
                        btn.addEventListener('click', () => {
                            UI.elements.messageInput.value = btn.dataset.prompt;
                            this.handleInputChange();
                            UI.elements.messageInput.focus();
                        });
                    });

                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.dropdown')) {
                            document.getElementById('exportDropdown')?.classList.remove('open');
                        }
                    });

                    EventBus.on('recognition:start', () => {
                        StateManager.set('isListening', true);
                        UI.elements.voiceInputBtn.classList.add('listening');
                        UI.elements.sttOverlay.classList.add('active');
                        UI.elements.sttText.textContent = 'ndakumva...';
                        VoiceVisualizer.start();
                    });

                    EventBus.on('recognition:end', () => {
                        StateManager.set('isListening', false);
                        UI.elements.voiceInputBtn.classList.remove('listening');
                        UI.elements.sttOverlay.classList.remove('active');
                        VoiceVisualizer.stop();
                        
                        if (UI.elements.messageInput.value.trim()) {
                            this.sendMessage();
                        }
                    });

                    EventBus.on('recognition:result', (transcript) => {
                        UI.elements.messageInput.value = transcript;
                        UI.elements.sttText.textContent = transcript || 'ndakumva...';
                        UI.elements.sendBtn.disabled = !transcript.trim() || StateManager.get('isGenerating');
                        UI.updateInputHeight();
                    });

                    EventBus.on('recognition:error', (error) => {
                        UI.elements.voiceStatus.textContent = `Ikosa: ${error}`;
                        UI.elements.voiceStatus.classList.add('active');
                        VoiceVisualizer.stop();
                    });

                    EventBus.on('message:sent', (message) => {
                        EmotionalAnalytics.analyzeMessage(message.content, message.role);
                    });

                    window.addEventListener('online', () => {
                        StateManager.set('isOnline', true);
                        document.getElementById('connectionStatus').textContent = 'Irereye';
                    });
                    
                    window.addEventListener('offline', () => {
                        StateManager.set('isOnline', false);
                        document.getElementById('connectionStatus').textContent = 'Ntahuzi';
                    });
                },

                applySettings() {
                    const settings = StateManager.get('settings');
                    
                    if (UI.elements.modelSelect) {
                        UI.elements.modelSelect.value = settings.model;
                    }
                    
                    if (UI.elements.voiceSelect) {
                        UI.elements.voiceSelect.value = settings.voice;
                    }
                    
                    if (UI.elements.rateSlider) {
                        UI.elements.rateSlider.value = settings.rate;
                        UI.elements.rateValue.textContent = settings.rate;
                    }
                    
                    if (UI.elements.pitchSlider) {
                        UI.elements.pitchSlider.value = settings.pitch;
                        UI.elements.pitchValue.textContent = settings.pitch;
                    }
                    
                    if (UI.elements.autoTTS) {
                        UI.elements.autoTTS.checked = settings.autoTTS;
                    }
                    
                    if (UI.elements.soundEffects) {
                        UI.elements.soundEffects.checked = settings.soundEffects;
                    }
                    
                    if (UI.elements.animations) {
                        UI.elements.animations.checked = settings.animations;
                    }
                    
                    if (UI.elements.enableEncryption) {
                        UI.elements.enableEncryption.checked = settings.enableEncryption;
                    }
                },

                handleInputChange() {
                    const value = UI.elements.messageInput.value.trim();
                    UI.elements.sendBtn.disabled = !value || StateManager.get('isGenerating');
                    UI.updateInputHeight();
                },

                async toggleVoiceInput() {
                    if (!StateManager.get('micPermission')) {
                        await this.testMicrophone();
                        if (!StateManager.get('micPermission')) return;
                    }

                    if (StateManager.get('isListening')) {
                        SpeechService.stopRecognition();
                    } else {
                        SpeechService.startRecognition();
                    }
                },

                async testMicrophone() {
                    UI.elements.micTestBtn.innerHTML = '<span class="spinner spinner-sm"></span> ndategura...';
                    
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                        StateManager.set('micPermission', true);
                        
                        UI.elements.micTestBtn.innerHTML = 'â yiteguye';
                        UI.elements.voiceStatus.textContent = 'â Mikorofoni yiteguye';
                        UI.elements.voiceStatus.classList.add('active');
                        
                        if (!StateManager.get('speechRecognition')) {
                            SpeechService.initRecognition();
                        }
                    } catch (error) {
                        UI.elements.micTestBtn.innerHTML = 'â emerera';
                        UI.elements.voiceStatus.textContent = 'â Emera mikorofoni';
                        StateManager.set('micPermission', false);
                    }

                    setTimeout(() => {
                        UI.elements.micTestBtn.innerHTML = '<span>ð¤</span> Genzura Mikorofoni';
                        setTimeout(() => {
                            UI.elements.voiceStatus.classList.remove('active');
                        }, 2000);
                    }, 2000);
                },

                previewVoice() {
                    SpeechService.speak("Ndi kumwe nawe. Wumva ute ubu?");
                },

                async sendMessage() {
                    const text = UI.elements.messageInput.value.trim();
                    if (!text || StateManager.get('isGenerating')) return;

                    if (!StateManager.get('chatStarted')) {
                        StateManager.set('chatStarted', true);
                    }

                    UI.addMessage('user', text);
                    StateManager.get('currentChat').push({ role: 'user', content: text, timestamp: Date.now() });

                    EventBus.emit('message:sent', { role: 'user', content: text });

                    UI.elements.messageInput.value = '';
                    UI.elements.sendBtn.disabled = true;
                    UI.updateInputHeight();

                    const typingId = UI.showTypingIndicator();
                    StateManager.set('isGenerating', true);

                    try {
                        // Check for clinical evidence-based response first
                        const evidenceResponse = ClinicalEvidence.generateEvidenceBasedResponse(text.toLowerCase());
                        
                        let reply;
                        if (evidenceResponse && evidenceResponse.response) {
                            // Use evidence-based response
                            reply = evidenceResponse.response;
                        } else {
                            // Use AI response
                            reply = await AIService.sendMessage(StateManager.get('currentChat'));
                        }
                        
                        UI.removeTypingIndicator(typingId);
                        UI.addMessage('assistant', reply);
                        StateManager.get('currentChat').push({ role: 'assistant', content: reply, timestamp: Date.now() });

                        await this.saveToHistory(text);

                    } catch (error) {
                        console.error('Send message error:', error);
                        UI.removeTypingIndicator(typingId);
                        const fallback = 'Ndi kumwe nawe. Hari ikibazo, ngaho tuganire.';
                        UI.addMessage('assistant', fallback);
                        StateManager.get('currentChat').push({ role: 'assistant', content: fallback, timestamp: Date.now() });
                    } finally {
                        StateManager.set('isGenerating', false);
                    }
                },

                async saveToHistory(firstMessage) {
                    const chat = {
                        id: StateManager.get('currentChatId'),
                        title: firstMessage.slice(0, 40),
                        messages: StateManager.get('currentChat').slice(-15),
                        timestamp: Date.now()
                    };
                    
                    await StorageService.saveToHistory(chat);
                    UI.renderHistory();
                },

                async restoreChat(id) {
                    const history = await StorageService.getHistory();
                    const chat = history.find(c => c.id === id);
                    
                    if (!chat) return;
                    
                    StateManager.set('currentChatId', chat.id);
                    StateManager.set('currentChat', chat.messages);
                    StateManager.set('chatStarted', true);
                    
                    const messages = UI.elements.messagesWrapper.querySelectorAll('.message, .typing-indicator, .welcome-screen');
                    messages.forEach(msg => {
                        if (msg.id !== 'welcomeScreen') {
                            msg.remove();
                        }
                    });
                    
                    UI.elements.welcomeScreen.style.display = 'none';
                    
                    chat.messages.forEach(msg => {
                        UI.addMessage(msg.role, msg.content);
                    });
                    
                    UI.renderHistory();
                    UI.closeSidebar();
                },

                startNewChat() {
                    UI.startNewChat();
                },

                async clearAllHistory() {
                    if (confirm('Hanagura amateka yose?')) {
                        await StorageService.clearHistory();
                        this.startNewChat();
                        ToastService.success('Amateka yahanaguwe');
                    }
                },

                clearCurrentChat() {
                    if (StateManager.get('currentChat').length === 0) return;
                    
                    if (confirm('Hanagura chat hiye?')) {
                        this.startNewChat();
                        ToastService.success('Chat yahanaguwe');
                    }
                },

                async checkPuterConnection() {
                    const isReady = await AIService.checkConnection();
                    
                    if (!isReady) {
                        UI.elements.voiceStatus.textContent = 'â Kanda ku kimenyetso cya Puter wandikishe';
                        UI.elements.voiceStatus.classList.add('active');
                    }
                }
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => App.init());
            } else {
                App.init();
            }

            document.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                    e.preventDefault();
                    UI.elements.messageInput.focus();
                }
                
                if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                    e.preventDefault();
                    App.startNewChat();
                }
                
                if (e.key === 'Escape') {
                    if (StateManager.get('isSidebarOpen')) {
                        UI.closeSidebar();
                    }
                    
                    const dropdown = document.getElementById('exportDropdown');
                    if (dropdown?.classList.contains('open')) {
                        dropdown.classList.remove('open');
                    }
                }
            });

        })();
    </script>
</body>
</html>
