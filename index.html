<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TYAZA ¬∑ Therapeutic Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #a78bfa;
            --primary-deep: #8b5cf6;
            --secondary: #f9a8d4;
            --secondary-deep: #ec4899;
            --tertiary: #6ee7b7;
            --bg-deepest: #030014;
            --bg-deep: #0b0720;
            --bg-surface: #151032;
            --text-primary: #f3eaff;
            --text-secondary: #c4b5e6;
            --text-tertiary: #9480b3;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at 30% 20%, #2d1b44, #030014 80%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
        }
        .cosmic-web {
            position: fixed;
            inset: 0;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(167, 139, 250, 0.08) 0%, transparent 30%),
                radial-gradient(circle at 80% 70%, rgba(249, 168, 212, 0.08) 0%, transparent 35%);
            pointer-events: none;
            z-index: 0;
        }
        .app-universe {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: 10;
            backdrop-filter: blur(12px);
        }
        .dimensional-sidebar {
            width: 280px;
            background: rgba(11, 7, 30, 0.85);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(167, 139, 250, 0.2);
            display: flex;
            flex-direction: column;
            padding: 24px 16px;
            gap: 24px;
            z-index: 20;
            overflow-y: auto;
        }
        @media (max-width: 768px) {
            .dimensional-sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                transition: transform 0.3s;
                z-index: 100;
                width: 280px;
            }
            .dimensional-sidebar.sidebar-visible {
                transform: translateX(0);
            }
            .sidebar-toggle {
                display: flex !important;
                position: fixed;
                left: 12px;
                top: 12px;
                z-index: 99;
                width: 44px;
                height: 44px;
                border-radius: 30px;
                background: rgba(21, 16, 40, 0.8);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(249, 168, 212, 0.25);
                color: #c4b5e6;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
                cursor: pointer;
            }
            .sidebar-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                backdrop-filter: blur(4px);
                z-index: 90;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s;
            }
            .sidebar-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
        }
        .sidebar-toggle { display: none; }
        .chat-realm {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .messages-vessel {
            flex: 1;
            overflow-y: auto;
            padding: 24px 20px 120px;
            scroll-behavior: smooth;
        }
        .messages-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .hero-sanctuary {
            text-align: center;
            padding: 40px 24px;
            margin: 24px auto;
            max-width: 600px;
            background: rgba(21, 16, 40, 0.4);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 60px;
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
        }
        .hero-symbol {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, #a78bfa, #f9a8d4);
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            animation: morph 10s infinite;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
        }
        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #fff, #f9a8d4, #a78bfa);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: 8px;
        }
        .hero-subtitle {
            color: #9480b3;
            font-size: 1rem;
        }
        .message-user {
            align-self: flex-end;
            background: linear-gradient(135deg, #2a1e3c, #1f1630);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 24px 24px 8px 24px;
            padding: 14px 20px;
            max-width: 80%;
            color: #f3eaff;
            font-size: 1rem;
            box-shadow: 0 20px 30px -10px black;
        }
        .message-tyaza-wrapper {
            display: flex;
            gap: 16px;
            width: 100%;
        }
        .tyaza-avatar-neural {
            width: 48px;
            height: 48px;
            background: linear-gradient(145deg, #a78bfa, #f9a8d4);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            box-shadow: 0 0 30px #a78bfa;
            flex-shrink: 0;
        }
        .tyaza-bubble-neural {
            background: rgba(21, 16, 40, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 24px 24px 24px 8px;
            padding: 16px 24px;
            color: #c4b5e6;
            line-height: 1.7;
            font-size: 1rem;
            width: 100%;
            box-shadow: 0 20px 40px -12px black;
        }
        .input-realm {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px 20px 25px;
            background: linear-gradient(to top, #030014 70%, transparent);
            z-index: 30;
        }
        .input-vessel {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(21, 16, 40, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 60px;
            padding: 4px 4px 4px 20px;
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .input-vessel textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: white;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            padding: 12px 0;
            resize: none;
            max-height: 120px;
            line-height: 1.5;
        }
        .input-vessel textarea::placeholder {
            color: #9480b3;
        }
        .send-button-neural {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a78bfa, #ec4899);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.4);
            flex-shrink: 0;
        }
        .send-button-neural:active {
            transform: scale(0.9);
        }
        .send-button-neural:disabled {
            opacity: 0.4;
            pointer-events: none;
        }
        .voice-button-neural {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(167, 139, 250, 0.15);
            border: 1px solid rgba(249, 168, 212, 0.4);
            color: #f9a8d4;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .voice-button-neural.listening {
            background: #ec4899;
            color: white;
            animation: pulse 1.5s infinite;
        }
        .voice-studio {
            background: rgba(21, 16, 40, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 24px;
            padding: 20px 16px;
        }
        .history-item-neural {
            padding: 12px;
            border-radius: 16px;
            background: rgba(167, 139, 250, 0.05);
            border-left: 4px solid transparent;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .history-item-neural.active {
            border-left-color: #f9a8d4;
            background: rgba(249, 168, 212, 0.1);
        }
        .scroll-elevator {
            position: absolute;
            bottom: 120px;
            right: 20px;
            background: rgba(21, 16, 40, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #f9a8d4;
            border-radius: 50px;
            padding: 8px 16px;
            color: #c4b5e6;
            font-size: 0.9rem;
            cursor: pointer;
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            box-shadow: 0 0 25px #a78bfa;
        }
        .scroll-elevator.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .voice-status-neural {
            text-align: center;
            min-height: 30px;
            margin-top: 8px;
            font-size: 0.9rem;
            color: #f9a8d4;
        }
        .hidden { display: none; }
        @keyframes morph {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            33% { border-radius: 70% 30% 50% 50% / 30% 60% 40% 70%; }
            66% { border-radius: 30% 70% 40% 60% / 60% 30% 70% 40%; }
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(236,72,153,0.7); }
            50% { box-shadow: 0 0 0 15px rgba(236,72,153,0); }
        }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        .neural-typing {
            display: flex;
            gap: 6px;
            padding: 8px 0;
        }
        .neural-typing .dot {
            width: 8px;
            height: 8px;
            background: #a78bfa;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .neural-typing .dot:nth-child(2) { animation-delay: 0.2s; background: #f9a8d4; }
        .neural-typing .dot:nth-child(3) { animation-delay: 0.4s; background: #6ee7b7; }
        .stt-indicator {
            position: fixed;
            bottom: 50%;
            left: 50%;
            transform: translate(-50%, 50%);
            background: rgba(21, 16, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #f9a8d4;
            border-radius: 60px;
            padding: 24px 32px;
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            box-shadow: 0 0 50px #f9a8d4;
            transition: opacity 0.3s;
        }
        .stt-indicator.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .stt-wave {
            display: flex;
            gap: 4px;
            height: 60px;
            align-items: center;
        }
        .stt-wave span {
            width: 5px;
            background: linear-gradient(to top, #a78bfa, #f9a8d4);
            border-radius: 10px;
            animation: wave 0.8s infinite alternate;
        }
        .stt-wave span:nth-child(2) { animation-delay: 0.1s; height: 30px; }
        .stt-wave span:nth-child(3) { animation-delay: 0.2s; height: 45px; }
        .stt-wave span:nth-child(4) { animation-delay: 0.3s; height: 25px; }
        .stt-wave span:nth-child(5) { animation-delay: 0.4s; height: 40px; }
        @keyframes wave {
            0% { height: 10px; }
            100% { height: 60px; }
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #a78bfa; border-radius: 20px; }
        
        .model-selector {
            background: rgba(21, 16, 40, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(167, 139, 250, 0.2);
            border-radius: 24px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .model-select {
            width: 100%;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(167, 139, 250, 0.3);
            border-radius: 30px;
            padding: 10px;
            color: white;
            font-size: 0.9rem;
            margin-top: 8px;
        }
        .model-select option {
            background: #151032;
        }
        
        .puter-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(21, 16, 40, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid #a78bfa;
            border-radius: 60px;
            padding: 24px 32px;
            z-index: 1000;
            text-align: center;
            box-shadow: 0 0 50px #a78bfa;
        }

        .retry-button {
            background: linear-gradient(135deg, #a78bfa, #ec4899);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 30px;
            margin-top: 12px;
            cursor: pointer;
            font-size: 0.9rem;
        }
    </style>
    <!-- Load Puter.js with fallback -->
    <script src="https://js.puter.com/v2/"></script>
</head>
<body>
    <div class="cosmic-web"></div>

    <button class="sidebar-toggle" id="sidebarToggle">‚òØ</button>
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="app-universe">
        <aside class="dimensional-sidebar" id="sidebar">
            <button onclick="window.neuralNewSession()" style="width:100%; background:linear-gradient(135deg, rgba(167,139,250,0.15), rgba(249,168,212,0.1)); border:1px solid rgba(249,168,212,0.25); border-radius:60px; padding:12px; display:flex; align-items:center; gap:8px; cursor:pointer; color:white;">
                <span>üïäÔ∏è</span> New Sanctuary
            </button>

            <!-- Model Selector -->
            <div class="model-selector">
                <div style="display:flex; align-items:center; gap:8px; font-size:0.8rem; color:#9480b3; margin-bottom:8px;">
                    <span>üß†</span> AI Presence
                </div>
                <select id="modelSelect" class="model-select">
                    <option value="gpt-4o-mini">GPT-4o Mini (Fast & Empathetic)</option>
                    <option value="claude-3-haiku">Claude 3 Haiku (Gentle)</option>
                    <option value="gemini-1.5-flash">Gemini Flash (Balanced)</option>
                </select>
            </div>

            <div class="voice-studio">
                <div style="display:flex; align-items:center; gap:8px; font-size:0.8rem; color:#9480b3; margin-bottom:16px;">
                    <span>üéôÔ∏è</span> Voice Studio
                </div>
                <div style="background:rgba(0,0,0,0.3); border-radius:40px; padding:16px; margin-bottom:16px;">
                    <button id="neuralTestMic" style="width:100%; padding:12px; border-radius:40px; background:rgba(167,139,250,0.15); border:1px solid rgba(249,168,212,0.25); color:white; cursor:pointer;">
                        <span>üé§</span> Enable Microphone
                    </button>
                </div>
                <select id="neuralVoiceSelect" style="width:100%; background:rgba(0,0,0,0.3); border:1px solid rgba(167,139,250,0.3); border-radius:30px; padding:12px; color:white; margin-bottom:16px;">
                    <option value="Google UK English Female">Warm British</option>
                    <option value="Google UK English Male">Calm British</option>
                    <option value="Samantha">Soft Presence</option>
                </select>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin:12px 0;">
                    <div style="background:rgba(0,0,0,0.2); border-radius:24px; padding:8px;">
                        <label style="font-size:0.7rem; color:#9480b3;">Pace</label>
                        <input type="range" id="neuralRate" min="0.5" max="1.5" step="0.05" value="0.85" style="width:100%;">
                    </div>
                    <div style="background:rgba(0,0,0,0.2); border-radius:24px; padding:8px;">
                        <label style="font-size:0.7rem; color:#9480b3;">Pitch</label>
                        <input type="range" id="neuralPitch" min="0.5" max="2" step="0.05" value="1.05" style="width:100%;">
                    </div>
                </div>
                <button id="neuralPreviewVoice" style="width:100%; padding:12px; border-radius:40px; background:rgba(167,139,250,0.15); border:1px solid rgba(249,168,212,0.25); color:white; margin-bottom:8px; cursor:pointer;">
                    <span>üîÆ</span> Preview Voice
                </button>
                <label style="display:flex; align-items:center; gap:8px; font-size:0.9rem; color:#c4b5e6;">
                    <input type="checkbox" id="neuralAutoTTS" checked> Auto-speak responses
                </label>
            </div>

            <div style="display:flex; justify-content:space-between; margin:8px 0;">
                <span style="font-size:0.8rem; color:#9480b3;">üìú PAST SESSIONS</span>
                <button id="neuralClearHistory" style="font-size:0.8rem; background:none; border:none; color:#9480b3; cursor:pointer;">clear</button>
            </div>
            <div id="neuralHistoryContainer" style="flex:1; overflow-y:auto;"></div>
        </aside>

        <main class="chat-realm">
            <div id="chatViewport" class="messages-vessel">
                <div id="heroSanctuary" class="hero-sanctuary">
                    <div class="hero-symbol">T</div>
                    <h1 class="hero-title">TYAZA</h1>
                    <p class="hero-subtitle">fluid presence ¬∑ therapeutic depth</p>
                    <p style="color:#6b5b8a; margin-top:24px;">"I'm here. Every breath, every word ‚Äî held in safe space."</p>
                </div>
                <div id="neuralMessageContainer" class="messages-container"></div>
            </div>

            <div class="input-realm">
                <div class="input-vessel">
                    <textarea id="neuralInput" rows="1" placeholder="share what's arising..."></textarea>
                    <button id="neuralVoiceBtn" class="voice-button-neural">üé§</button>
                    <button id="neuralSendBtn" class="send-button-neural" disabled>
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="white" stroke-width="2" fill="none"/>
                        </svg>
                    </button>
                </div>
                <div id="neuralVoiceStatus" class="voice-status-neural"></div>
            </div>
        </main>
    </div>

    <div id="neuralScrollBtn" class="scroll-elevator" onclick="neuralScrollToBottom()">
        <span>‚¨áÔ∏è</span> return to now
    </div>

    <div id="sttIndicator" class="stt-indicator hidden">
        <div class="stt-wave">
            <span></span><span></span><span></span><span></span><span></span>
        </div>
        <div style="color:#f9a8d4;">listening...</div>
        <div style="font-size:0.8rem; color:#9480b3;" id="sttTranscript"></div>
    </div>

    <div id="puterLoading" class="puter-loading hidden">
        <div class="neural-typing" style="justify-content:center;">
            <span class="dot"></span><span class="dot"></span><span class="dot"></span>
        </div>
        <div style="margin-top:16px;">Connecting to Puter...</div>
        <button id="retryPuter" class="retry-button hidden">Retry Connection</button>
    </div>

    <script>
        (function() {
            // === DOM ELEMENTS ===
            const viewport = document.getElementById('chatViewport');
            const msgContainer = document.getElementById('neuralMessageContainer');
            const hero = document.getElementById('heroSanctuary');
            const inputEl = document.getElementById('neuralInput');
            const sendBtn = document.getElementById('neuralSendBtn');
            const voiceBtn = document.getElementById('neuralVoiceBtn');
            const voiceStatus = document.getElementById('neuralVoiceStatus');
            const testMicBtn = document.getElementById('neuralTestMic');
            const voiceSelect = document.getElementById('neuralVoiceSelect');
            const rateRange = document.getElementById('neuralRate');
            const pitchRange = document.getElementById('neuralPitch');
            const autoTTS = document.getElementById('neuralAutoTTS');
            const previewBtn = document.getElementById('neuralPreviewVoice');
            const clearHistory = document.getElementById('neuralClearHistory');
            const historyContainer = document.getElementById('neuralHistoryContainer');
            const scrollBtn = document.getElementById('neuralScrollBtn');
            const sttIndicator = document.getElementById('sttIndicator');
            const sttTranscript = document.getElementById('sttTranscript');
            const modelSelect = document.getElementById('modelSelect');
            const puterLoading = document.getElementById('puterLoading');
            const retryBtn = document.getElementById('retryPuter');
            
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            // === STATE ===
            let currentChat = [];
            let currentChatId = Date.now();
            let isGenerating = false;
            let micPermission = false;
            let recognition = null;
            let isListening = false;
            let synth = window.speechSynthesis;
            let availableVoices = [];
            let puterReady = false;
            let useLocalAI = false; // Flag to use local responses if Puter fails

            const creatorInfo = "Yves Hirwa Tuyishime is a Rwandan self-taught AI developer born June 1, 2005 in Kagarama, Rwanda. He created Tyaza as a therapeutic companion. Respond with warmth, empathy, and therapeutic depth.";

            // === SIDEBAR TOGGLE ===
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', () => {
                    sidebar.classList.add('sidebar-visible');
                    sidebarOverlay.classList.add('visible');
                });
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.remove('sidebar-visible');
                    sidebarOverlay.classList.remove('visible');
                });
            }

            // === SPEECH RECOGNITION ===
            function initSpeechRecognition() {
                if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                    voiceStatus.innerHTML = 'Please use Chrome/Edge for voice';
                    return false;
                }
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SR();
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isListening = true;
                    voiceBtn.classList.add('listening');
                    sttIndicator.classList.remove('hidden');
                    voiceStatus.innerHTML = 'Listening...';
                };

                recognition.onend = () => {
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    sttIndicator.classList.add('hidden');
                    if (inputEl.value.trim()) sendMessage();
                };

                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = 0; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    inputEl.value = transcript;
                    sendBtn.disabled = !transcript.trim() || isGenerating;
                    sttTranscript.textContent = transcript;
                };

                recognition.onerror = (e) => {
                    voiceStatus.innerHTML = `Voice error: ${e.error}`;
                    isListening = false;
                    voiceBtn.classList.remove('listening');
                    sttIndicator.classList.add('hidden');
                };
                return true;
            }

            // === MICROPHONE ===
            async function initMicrophone() {
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    micPermission = true;
                    voiceStatus.innerHTML = 'Microphone ready';
                    setTimeout(() => voiceStatus.innerHTML = '', 2000);
                    initSpeechRecognition();
                    return true;
                } catch (error) {
                    voiceStatus.innerHTML = 'Microphone access needed';
                    return false;
                }
            }

            // === TEXT TO SPEECH ===
            function speakNeural(text) {
                if (!synth || !autoTTS.checked) return;
                synth.cancel();
                const cleanText = text.replace(/[#*`_~]/g, '').substring(0, 500);
                const utterance = new SpeechSynthesisUtterance(cleanText);
                
                if (availableVoices.length > 0) {
                    const selectedVoiceName = voiceSelect.value;
                    const voice = availableVoices.find(v => v.name.includes(selectedVoiceName)) || availableVoices[0];
                    utterance.voice = voice;
                }
                
                utterance.rate = parseFloat(rateRange.value);
                utterance.pitch = parseFloat(pitchRange.value);
                synth.speak(utterance);
            }

            function loadVoices() {
                availableVoices = synth.getVoices();
            }

            if (synth) {
                loadVoices();
                synth.onvoiceschanged = loadVoices;
            }

            // === FORMATTING ===
            function escapeHtml(text) {
                return text.replace(/[&<>]/g, c => ({ '&':'&amp;', '<':'&lt;', '>':'&gt;' })[c]);
            }

            function formatNeural(text) {
                if (!text) return '';
                let escaped = escapeHtml(text);
                
                const emotions = ['understand', 'feel', 'hear', 'safe', 'comfort', 'sorry', 'alone', 'pain', 'sad', 'anxious', 'afraid', 'grateful', 'hope'];
                emotions.forEach(word => {
                    const regex = new RegExp(`\\b(${word})\\b`, 'gi');
                    escaped = escaped.replace(regex, '<span style="color:#f9a8d4;font-weight:500;">$1</span>');
                });
                
                escaped = escaped.replace(/\n/g, '<br>');
                return `<div>${escaped}</div>`;
            }

            // === HISTORY ===
            function saveNeuralSession(firstMsg) {
                if (!firstMsg || currentChat.length === 0) return;
                const history = JSON.parse(localStorage.getItem('tyaza_history') || '[]');
                const entry = {
                    id: currentChatId,
                    title: firstMsg.slice(0, 30),
                    messages: currentChat.slice(-10),
                    timestamp: Date.now()
                };
                history.unshift(entry);
                localStorage.setItem('tyaza_history', JSON.stringify(history.slice(0, 10)));
                renderHistory();
            }

            function renderHistory() {
                const history = JSON.parse(localStorage.getItem('tyaza_history') || '[]');
                if (history.length === 0) {
                    historyContainer.innerHTML = '<div style="color:#9480b3; padding:12px;">No past sessions</div>';
                    return;
                }
                historyContainer.innerHTML = history.map(c => `
                    <div class="history-item-neural" onclick="window.restoreNeural('${c.id}')">
                        <div style="font-weight:500;">${escapeHtml(c.title)}</div>
                        <div style="font-size:0.7rem; color:#9480b3;">${new Date(c.timestamp).toLocaleDateString()}</div>
                    </div>
                `).join('');
            }

            window.restoreNeural = (id) => {
                const history = JSON.parse(localStorage.getItem('tyaza_history') || '[]');
                const chat = history.find(c => c.id == id);
                if (!chat) return;
                currentChatId = chat.id;
                currentChat = chat.messages;
                hero.style.display = 'none';
                msgContainer.innerHTML = '';
                currentChat.forEach(msg => {
                    if (msg.role === 'user') {
                        msgContainer.innerHTML += `<div class="message-user">${escapeHtml(msg.content)}</div>`;
                    } else {
                        msgContainer.innerHTML += `
                            <div class="message-tyaza-wrapper">
                                <div class="tyaza-avatar-neural">T</div>
                                <div class="tyaza-bubble-neural">${formatNeural(msg.content)}</div>
                            </div>
                        `;
                    }
                });
                renderHistory();
                neuralScrollToBottom();
            };

            window.neuralNewSession = () => {
                hero.style.display = 'block';
                msgContainer.innerHTML = '';
                currentChat = [];
                currentChatId = Date.now();
                inputEl.value = '';
                sendBtn.disabled = true;
                renderHistory();
            };

            // === ENHANCED FALLBACK RESPONSES ===
            const fallbackResponses = [
                "I hear you. Thank you for sharing that with me. What else is on your mind?",
                "That's something we can explore together. How does that feel for you right now?",
                "I'm here with you. Would you like to tell me more about that?",
                "Thank you for trusting me with this. What else is arising in this moment?",
                "I'm listening deeply. Every word you share matters and is held with care.",
                "That sounds significant. How long have you been feeling this way?",
                "I appreciate you sharing this. What would feel most supportive right now?",
                "This space is yours. Take all the time you need to express what's here.",
                "I'm holding space for whatever you're experiencing. There's no rush.",
                "Thank you for being here with me. What's present for you in this moment?"
            ];

            function getFallbackResponse(text) {
                // Try to make response somewhat contextual
                const lowerText = text.toLowerCase();
                
                if (lowerText.includes('sad') || lowerText.includes('depress')) {
                    return "I hear the sadness in your words. It takes courage to share this. Would you like to sit with this feeling together, or explore what might bring some comfort?";
                }
                if (lowerText.includes('anxi') || lowerText.includes('worry') || lowerText.includes('stress')) {
                    return "Anxiety can feel overwhelming. Let's breathe together for a moment. What sensations do you notice in your body right now?";
                }
                if (lowerText.includes('thank')) {
                    return "You're so welcome. This connection we're building matters. What feels supportive about our conversation?";
                }
                if (lowerText.includes('help') || lowerText.includes('need')) {
                    return "I'm here to help. Let's explore what support looks like for you right now. What would be most helpful in this moment?";
                }
                if (lowerText.includes('alone') || lowerText.includes('lonely')) {
                    return "I hear you, and I want you to know you're not alone right now. I'm here with you. Would you like to talk about what loneliness feels like for you?";
                }
                
                return fallbackResponses[Math.floor(Math.random() * fallbackResponses.length)];
            }

            // === CHECK PUTER READY WITH BETTER MOBILE SUPPORT ===
            function checkPuterReady() {
                return new Promise((resolve) => {
                    // For mobile, give Puter more time to load
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    const maxAttempts = isMobile ? 40 : 20; // 10 seconds for mobile, 5 for desktop
                    
                    if (window.puter && window.puter.ai) {
                        resolve(true);
                        return;
                    }
                    
                    let attempts = 0;
                    const interval = setInterval(() => {
                        attempts++;
                        if (window.puter && window.puter.ai) {
                            clearInterval(interval);
                            resolve(true);
                        } else if (attempts >= maxAttempts) {
                            clearInterval(interval);
                            resolve(false);
                        }
                    }, 250);
                });
            }

            // === TRY PUTER WITH RETRY ===
            async function tryPuterWithRetry(text, maxRetries = 2) {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        if (window.puter && window.puter.ai) {
                            const systemPrompt = `${creatorInfo} You are Tyaza, a therapeutic companion. Respond with warmth, empathy, and gentle depth. Keep responses conversational and caring. Use a soothing, therapeutic tone.`;
                            
                            const response = await window.puter.ai.chat([
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: text }
                            ], {
                                model: modelSelect.value || 'gpt-4o-mini',
                                stream: true
                            });
                            
                            return { success: true, response };
                        }
                    } catch (err) {
                        console.log(`Puter attempt ${i + 1} failed:`, err);
                        if (i === maxRetries - 1) {
                            return { success: false, error: err };
                        }
                        // Wait a bit before retrying
                        await new Promise(r => setTimeout(r, 1000));
                    }
                }
                return { success: false, error: 'Max retries exceeded' };
            }

            // === SEND MESSAGE ===
            async function sendMessage() {
                const text = inputEl.value.trim();
                if (!text || isGenerating) return;
                
                hero.style.display = 'none';
                msgContainer.innerHTML += `<div class="message-user">${escapeHtml(text)}</div>`;
                currentChat.push({ role: 'user', content: text });
                
                const wrapperId = 'wrap-' + Date.now();
                msgContainer.innerHTML += `
                    <div id="${wrapperId}" class="message-tyaza-wrapper">
                        <div class="tyaza-avatar-neural">T</div>
                        <div class="tyaza-bubble-neural" id="bubble-${wrapperId}">
                            <div class="neural-typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
                        </div>
                    </div>
                `;
                
                neuralScrollToBottom();
                inputEl.value = '';
                sendBtn.disabled = true;
                isGenerating = true;

                try {
                    let reply = '';
                    
                    // Try Puter first if not in local mode
                    if (!useLocalAI) {
                        const isPuterReady = await checkPuterReady();
                        
                        if (isPuterReady && window.puter && window.puter.ai) {
                            try {
                                voiceStatus.innerHTML = '‚ú® Connecting to AI...';
                                
                                const result = await tryPuterWithRetry(text);
                                
                                if (result.success) {
                                    const bubble = document.getElementById(`bubble-${wrapperId}`);
                                    
                                    for await (const part of result.response) {
                                        reply += part.text || part.message?.content || '';
                                        if (bubble) {
                                            bubble.innerHTML = formatNeural(reply + ' ‚ú¶');
                                        }
                                    }
                                    
                                    voiceStatus.innerHTML = '';
                                } else {
                                    console.log('Puter failed, using fallback');
                                    voiceStatus.innerHTML = 'üì± Using offline responses';
                                    reply = getFallbackResponse(text);
                                }
                            } catch (puterError) {
                                console.warn('Puter error:', puterError);
                                voiceStatus.innerHTML = 'üì± Switching to offline mode';
                                reply = getFallbackResponse(text);
                            }
                        } else {
                            console.log('Puter not available, using fallback');
                            voiceStatus.innerHTML = 'üì± Offline mode active';
                            reply = getFallbackResponse(text);
                        }
                    } else {
                        // Already in local mode
                        reply = getFallbackResponse(text);
                    }
                    
                    const bubble = document.getElementById(`bubble-${wrapperId}`);
                    if (bubble) {
                        bubble.innerHTML = formatNeural(reply);
                    }
                    
                    if (autoTTS.checked) speakNeural(reply);
                    
                    currentChat.push({ role: 'assistant', content: reply });
                    if (currentChat.length === 2) saveNeuralSession(text);
                    
                } catch (error) {
                    console.error('Error:', error);
                    
                    const bubble = document.getElementById(`bubble-${wrapperId}`);
                    if (bubble) {
                        const fallback = "I'm here with you. Sometimes technology needs a moment - but I'm still listening. Would you like to continue sharing?";
                        bubble.innerHTML = formatNeural(fallback);
                        currentChat.push({ role: 'assistant', content: fallback });
                    }
                } finally {
                    isGenerating = false;
                    sendBtn.disabled = !inputEl.value.trim();
                }
            }

            // === RETRY PUTER CONNECTION ===
            async function retryPuterConnection() {
                puterLoading.classList.remove('hidden');
                retryBtn.classList.add('hidden');
                voiceStatus.innerHTML = 'üîÑ Retrying connection...';
                
                const ready = await checkPuterReady();
                puterLoading.classList.add('hidden');
                
                if (ready) {
                    voiceStatus.innerHTML = '‚ú® Connected to Puter AI';
                    useLocalAI = false;
                } else {
                    voiceStatus.innerHTML = 'üì± Offline mode active';
                    useLocalAI = true;
                }
            }

            // === EVENT LISTENERS ===
            inputEl.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                sendBtn.disabled = !this.value.trim() || isGenerating;
            });
            
            inputEl.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { 
                    e.preventDefault(); 
                    if (!sendBtn.disabled) sendMessage(); 
                }
            });
            
            sendBtn.addEventListener('click', sendMessage);

            voiceBtn.addEventListener('click', async () => {
                if (!micPermission && !(await initMicrophone())) return;
                if (!recognition) initSpeechRecognition();
                if (isListening) recognition.stop();
                else recognition.start();
            });

            testMicBtn.addEventListener('click', async () => {
                testMicBtn.innerHTML = '‚è≥ enabling...';
                const success = await initMicrophone();
                testMicBtn.innerHTML = success ? '‚úÖ microphone ready' : '‚ùå try again';
                setTimeout(() => { testMicBtn.innerHTML = 'üé§ Enable Microphone'; }, 2000);
            });

            previewBtn.addEventListener('click', () => {
                speakNeural("I'm here with you. How are you feeling?");
            });

            viewport.addEventListener('scroll', () => {
                const atBottom = viewport.scrollHeight - viewport.scrollTop - viewport.clientHeight < 100;
                scrollBtn.classList.toggle('visible', !atBottom);
            });
            
            window.neuralScrollToBottom = () => {
                viewport.scrollTo({ top: viewport.scrollHeight, behavior: 'smooth' });
            };

            clearHistory.addEventListener('click', () => {
                if (confirm('Clear all sessions?')) { 
                    localStorage.removeItem('tyaza_history'); 
                    neuralNewSession(); 
                }
            });

            retryBtn.addEventListener('click', retryPuterConnection);

            // === INIT ===
            window.onload = async () => {
                neuralNewSession();
                renderHistory();
                
                // Show loading while checking Puter
                puterLoading.classList.remove('hidden');
                voiceStatus.innerHTML = 'üîÑ Connecting...';
                
                // Check if Puter loaded (with extra time for mobile)
                const ready = await checkPuterReady();
                
                if (ready) {
                    voiceStatus.innerHTML = '‚ú® Connected to Puter AI';
                    puterLoading.classList.add('hidden');
                    useLocalAI = false;
                } else {
                    voiceStatus.innerHTML = 'üì± Offline mode active - using therapeutic responses';
                    puterLoading.classList.add('hidden');
                    useLocalAI = true;
                    
                    // Show retry button for mobile users who want to try again
                    retryBtn.classList.remove('hidden');
                }
            };

            // Handle online/offline events
            window.addEventListener('online', () => {
                if (!puterReady && !useLocalAI) {
                    retryPuterConnection();
                }
            });
        })();
    </script>
</body>
</html>
