<!DOCTYPE html>
<html lang="rw" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="TYAZA - Umuvugizi w'Umutima | Hybrid AI Virtual Therapy Assistant">
    <meta name="theme-color" content="#0a0612">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>TYAZA Â· Umuvugizi w'Umutima</title>
    
    <!-- Preconnect and Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://js.puter.com">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
    <!-- Import Maps for ES Modules -->
    <script type="importmap">
        {
            "imports": {
                "@xenova/transformers": "https://esm.sh/@xenova/transformers@2.17.1",
                "idb": "https://esm.sh/idb@8.0.0"
            }
        }
    </script>
    
    <style>
        /* ================================================================
           TYAZA v5.0 - FINAL PRODUCTION VERSION
           Hybrid AI: Puter API + On-device models
           ================================================================ */

        /* Design Tokens */
        :root {
            --color-primary-50: #f5f3ff;
            --color-primary-100: #ede9fe;
            --color-primary-200: #ddd6fe;
            --color-primary-300: #c4b5fd;
            --color-primary-400: #a78bfa;
            --color-primary-500: #8b5cf6;
            --color-primary-600: #7c3aed;
            --color-primary-700: #6d28d9;
            --color-primary-800: #5b21b6;
            --color-primary-900: #4c1d95;
            
            --color-secondary-50: #fdf2f8;
            --color-secondary-100: #fce7f3;
            --color-secondary-200: #fbcfe8;
            --color-secondary-300: #f9a8d4;
            --color-secondary-400: #f472b6;
            --color-secondary-500: #ec4899;
            --color-secondary-600: #db2777;
            --color-secondary-700: #be185d;
            --color-secondary-800: #9d174d;
            --color-secondary-900: #831843;
            
            --color-surface-950: #030014;
            --color-surface-900: #0a0612;
            --color-surface-800: #130d24;
            --color-surface-700: #1a1433;
            --color-surface-600: #231b42;
            --color-surface-500: #2d2352;
            
            --color-text-primary: #f8fafc;
            --color-text-secondary: #e2e8f0;
            --color-text-tertiary: #94a3b8;
            --color-text-muted: #64748b;
            
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            
            --gradient-primary: linear-gradient(135deg, #8b5cf6, #ec4899);
            --gradient-secondary: linear-gradient(135deg, #ec4899, #10b981);
            
            --shadow-glow-primary: 0 0 40px rgba(139, 92, 246, 0.3);
            --shadow-glow-secondary: 0 0 40px rgba(236, 72, 153, 0.3);
            
            --sidebar-width: 320px;
            --header-height: 64px;
            --content-max-width: 900px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;
            
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            
            --font-sans: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-display: 'Space Grotesk', var(--font-sans);
            --font-serif: 'Crimson Pro', Georgia, serif;
        }

        /* Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-surface-950);
            color: var(--color-text-primary);
            line-height: 1.5;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Utility Classes */
        .d-flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .flex-1 { flex: 1; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        
        .p-2 { padding: var(--space-2); }
        .p-3 { padding: var(--space-3); }
        .p-4 { padding: var(--space-4); }
        .p-5 { padding: var(--space-5); }
        .p-6 { padding: var(--space-6); }
        
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-3 { padding-top: var(--space-3); padding-bottom: var(--space-3); }
        
        .m-0 { margin: 0; }
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-muted { color: var(--color-text-muted); }
        .text-success { color: var(--color-success); }
        .text-error { color: var(--color-error); }
        
        .text-center { text-align: center; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .h-screen { height: 100vh; }
        
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .rounded-2xl { border-radius: var(--radius-2xl); }
        .rounded-full { border-radius: var(--radius-full); }
        
        .border { border: 1px solid var(--color-surface-600); }
        .border-0 { border: none; }
        .border-t { border-top: 1px solid var(--color-surface-600); }
        
        .shadow-lg { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), var(--shadow-glow-primary);
        }

        .btn-secondary {
            background: var(--color-surface-700);
            border-color: var(--color-surface-500);
            color: var(--color-text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-surface-600);
        }

        .btn-ghost {
            background: transparent;
            color: var(--color-text-secondary);
        }

        .btn-ghost:hover {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: 0.75rem;
        }

        .btn-block {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Input Styles */
        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: inherit;
            font-size: 1rem;
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            transition: all 0.15s;
        }

        .input:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .select {
            appearance: none;
            width: 100%;
            padding: var(--space-3) var(--space-4);
            padding-right: var(--space-10);
            font-family: inherit;
            font-size: 0.875rem;
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-3) center;
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            cursor: pointer;
        }

        .select:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-surface-800);
            border: 2px solid var(--color-surface-500);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .checkbox:checked {
            background: var(--color-primary-500);
            border-color: var(--color-primary-500);
        }

        .checkbox:checked::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 6px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .slider {
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: transform 0.15s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: var(--radius-full);
            background: var(--color-surface-700);
            color: var(--color-text-secondary);
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--color-warning);
        }

        .card {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
        }

        .card-glass {
            background: rgba(26, 20, 51, 0.8);
            backdrop-filter: blur(20px);
        }

        /* Cosmic Background */
        .app-background {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            background: var(--color-surface-950);
        }

        .app-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
            animation: cosmicDrift 40s ease-in-out infinite;
        }

        @keyframes cosmicDrift {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(2%, 1%); }
            50% { transform: translate(-1%, 2%); }
            75% { transform: translate(1%, -1%); }
        }

        .stars-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: var(--radius-full);
            animation: starTwinkle 3s ease-in-out infinite;
        }

        @keyframes starTwinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.9; }
        }

        /* Layout */
        .app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* Sidebar */
        .app-sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(10, 6, 18, 0.92);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(139, 92, 246, 0.15);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: var(--space-5);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-close {
            display: none;
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-surface-700);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .logo-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0 var(--space-2);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            width: 100%;
            padding: var(--space-4);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-xl);
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(236, 72, 153, 0.15));
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-primary);
        }

        .settings-card {
            background: var(--color-surface-800);
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
        }

        .voice-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        .voice-control-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .voice-control-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-text-tertiary);
        }

        .voice-control-value {
            color: var(--color-primary-300);
            font-weight: 500;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            min-height: 150px;
        }

        .history-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: var(--space-3);
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
        }

        .history-item:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .history-item.active {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            border-left: 3px solid var(--color-secondary-400);
        }

        .history-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .history-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            color: var(--color-text-muted);
            text-align: center;
            gap: var(--space-2);
        }

        .info-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            font-size: 0.75rem;
            color: var(--color-text-tertiary);
        }

        .info-card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-secondary-300);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .info-highlight {
            color: var(--color-primary-300);
            font-weight: 500;
        }

        .info-card-footer {
            font-size: 0.65rem;
            color: var(--color-text-muted);
            text-align: center;
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid rgba(139, 92, 246, 0.1);
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            overflow: hidden;
        }

        .chat-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            background: rgba(10, 6, 18, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            z-index: 15;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .menu-toggle {
            display: none;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .chat-info h1 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.75rem;
            color: var(--color-accent-400);
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            background: var(--color-accent-400);
            border-radius: var(--radius-full);
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--color-surface-500);
            border-radius: var(--radius-full);
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--color-surface-400);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-icon {
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary-400), var(--color-secondary-400), var(--color-accent-400));
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            font-size: 4rem;
            color: white;
            margin-bottom: var(--space-8);
            box-shadow: var(--shadow-glow-primary), var(--shadow-glow-secondary);
            animation: morphShape 10s ease-in-out infinite, iconFloat 6s ease-in-out infinite;
        }

        @keyframes morphShape {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            33% { border-radius: 70% 30% 50% 50% / 30% 60% 40% 70%; }
            66% { border-radius: 30% 70% 40% 60% / 60% 30% 70% 40%; }
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .welcome-title {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-primary-300), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
        }

        .welcome-subtitle {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-style: italic;
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-6);
        }

        .welcome-quote {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            color: var(--color-text-tertiary);
            max-width: 500px;
            line-height: 1.9;
            padding: var(--space-5) var(--space-8);
            background: rgba(26, 20, 51, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-8);
        }

        .welcome-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
            max-width: 600px;
            margin-bottom: var(--space-6);
        }

        .suggestion-btn {
            padding: var(--space-3) var(--space-5);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .suggestion-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--color-primary-500);
            color: var(--color-text-primary);
            transform: translateY(-2px);
        }

        .model-status {
            display: flex;
            gap: var(--space-4);
            justify-content: center;
            margin-top: var(--space-4);
        }

        /* Message Styles */
        .message {
            display: flex;
            gap: var(--space-4);
            max-width: 85%;
            margin-bottom: var(--space-4);
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            flex-shrink: 0;
            font-size: 1.2rem;
        }

        .message.user .message-avatar {
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
        }

        .message-bubble {
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-xl);
            line-height: 1.75;
            word-wrap: break-word;
            max-width: 100%;
        }

        .message.user .message-bubble {
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-xl) var(--radius-xl) var(--radius-sm) var(--radius-xl);
        }

        .message.assistant .message-bubble {
            background: rgba(26, 20, 51, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl) var(--radius-xl) var(--radius-xl) var(--radius-sm);
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: 0 var(--space-2);
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .message-actions {
            display: flex;
            gap: var(--space-1);
            opacity: 0;
            transition: opacity 0.15s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-surface-500);
            background: var(--color-surface-700);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.15s;
        }

        .message-action:hover {
            background: var(--color-surface-600);
            color: var(--color-text-primary);
            transform: scale(1.1);
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .typing-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            font-size: 1.2rem;
        }

        .typing-bubble {
            display: flex;
            gap: 6px;
            padding: var(--space-4) var(--space-5);
            background: rgba(26, 20, 51, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: var(--radius-full);
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { background: var(--color-primary-400); }
        .typing-dot:nth-child(2) { background: var(--color-secondary-400); animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { background: var(--color-accent-400); animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Input Area */
        .input-area {
            padding: var(--space-5) var(--space-6) var(--space-6);
            background: linear-gradient(to top, var(--color-surface-950) 50%, transparent);
            position: relative;
        }

        .input-container {
            max-width: var(--content-max-width);
            margin: 0 auto;
            background: rgba(26, 20, 51, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-2) var(--space-2) var(--space-2) var(--space-5);
            display: flex;
            align-items: flex-end;
            gap: var(--space-3);
            box-shadow: var(--shadow-lg);
            transition: all 0.15s;
        }

        .input-container:focus-within {
            border-color: var(--color-primary-500);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: 1rem;
            padding: var(--space-4) 0;
            resize: none;
            max-height: 150px;
            min-height: 24px;
            line-height: 1.6;
        }

        textarea::placeholder {
            color: var(--color-text-muted);
        }

        .input-actions {
            display: flex;
            gap: var(--space-2);
            padding-bottom: var(--space-2);
        }

        .input-btn {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            font-size: 1.1rem;
        }

        .voice-btn {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(236, 72, 153, 0.3);
            color: var(--color-secondary-400);
        }

        .voice-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: var(--color-secondary-500);
            color: white;
            animation: micPulse 1.5s infinite;
        }

        @keyframes micPulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.5); }
            70% { box-shadow: 0 0 0 20px rgba(236, 72, 153, 0); }
        }

        .send-btn {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg), var(--shadow-glow-primary);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .voice-status {
            text-align: center;
            font-size: 0.875rem;
            color: var(--color-text-tertiary);
            min-height: 24px;
            margin-top: var(--space-3);
        }

        /* Scroll to Bottom */
        .scroll-bottom {
            position: absolute;
            bottom: 100px;
            right: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(26, 20, 51, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s;
            z-index: 40;
        }

        .scroll-bottom.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* STT Overlay */
        .stt-overlay {
            position: fixed;
            inset: 0;
            background: rgba(3, 0, 20, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .stt-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .stt-modal {
            background: rgba(26, 20, 51, 0.98);
            border: 2px solid var(--color-secondary-500);
            border-radius: var(--radius-2xl);
            padding: var(--space-10);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-6);
            box-shadow: var(--shadow-glow-secondary), var(--shadow-xl);
            transform: scale(0.9);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90vw;
        }

        .stt-overlay.active .stt-modal {
            transform: scale(1);
        }

        .voice-visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
        }

        .stt-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 80px;
        }

        .stt-bar {
            width: 8px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            animation: sttWave 0.7s ease-in-out infinite alternate;
        }

        .stt-bar:nth-child(1) { height: 25px; animation-delay: 0s; }
        .stt-bar:nth-child(2) { height: 40px; animation-delay: 0.1s; }
        .stt-bar:nth-child(3) { height: 60px; animation-delay: 0.2s; }
        .stt-bar:nth-child(4) { height: 45px; animation-delay: 0.3s; }
        .stt-bar:nth-child(5) { height: 70px; animation-delay: 0.4s; }
        .stt-bar:nth-child(6) { height: 35px; animation-delay: 0.5s; }

        @keyframes sttWave {
            from { height: 15px; }
            to { height: 70px; }
        }

        .stt-text {
            font-size: 1.25rem;
            color: var(--color-text-secondary);
            text-align: center;
            max-width: 400px;
            min-height: 30px;
        }

        .stt-hint {
            font-size: 0.875rem;
            color: var(--color-text-muted);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--color-surface-950);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-6);
            z-index: 1000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            font-size: 3rem;
            color: white;
            animation: logoFloat 3s ease-in-out infinite;
            box-shadow: var(--shadow-glow-primary);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-surface-600);
            border-top-color: var(--color-primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 1rem;
            color: var(--color-text-tertiary);
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            animation: loadingProgress 2s ease-in-out infinite;
        }

        @keyframes loadingProgress {
            0% { width: 0%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 0%; margin-left: 100%; }
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            z-index: 800;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        /* Toast Component */
        tyaza-toast {
            display: block;
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-left: 4px solid;
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-5);
            margin-bottom: var(--space-3);
            box-shadow: var(--shadow-lg);
            animation: toastSlideIn 0.3s ease-out;
            max-width: 350px;
        }

        tyaza-toast[type="success"] { border-left-color: var(--color-success); }
        tyaza-toast[type="error"] { border-left-color: var(--color-error); }
        tyaza-toast[type="info"] { border-left-color: var(--color-info); }

        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 15;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Crisis Floating Button */
        .crisis-floating-btn {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-error);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
            z-index: 100;
            transition: all 0.15s;
            animation: crisisFloat 3s ease-in-out infinite;
        }

        .crisis-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6);
        }

        .crisis-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-full);
            background: var(--color-error);
            opacity: 0.6;
            animation: crisisPulse 2s ease-out infinite;
        }

        @keyframes crisisPulse {
            0% { transform: scale(1); opacity: 0.6; }
            70% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes crisisFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Meditation Quick Button */
        .meditation-quick-btn {
            position: fixed;
            bottom: 180px;
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-glow-primary);
            z-index: 99;
            transition: all 0.15s;
        }

        .meditation-quick-btn:hover {
            transform: scale(1.1) rotate(180deg);
        }

        /* AI Badge */
        .ai-badge {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-surface-800);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            border: 1px solid var(--color-primary-500);
            box-shadow: var(--shadow-glow-primary);
            z-index: 50;
            animation: fadeInUp 0.3s ease-out;
            white-space: nowrap;
        }

        /* Model Loader */
        .model-loader {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-surface-800);
            border-radius: var(--radius-full);
            padding: var(--space-3) var(--space-6);
            border: 1px solid var(--color-primary-500);
            box-shadow: var(--shadow-glow-primary);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: var(--space-3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateX(-50%) translateY(20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        .model-loader-progress {
            width: 100px;
            height: 4px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .model-loader-bar {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.3s ease;
        }

        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--color-warning);
            color: var(--color-surface-950);
            padding: var(--space-3);
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 85vw;
                --header-height: 56px;
            }

            .app-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                background: rgba(10, 6, 18, 0.98);
                z-index: 500;
            }

            .app-sidebar.open {
                transform: translateX(0);
            }

            .sidebar-close {
                display: flex !important;
            }

            .menu-toggle {
                display: flex !important;
            }

            .welcome-title {
                font-size: 2.25rem;
            }

            .welcome-icon {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }

            .message {
                max-width: 92%;
            }

            .messages-container {
                padding: var(--space-4);
            }

            .input-area {
                padding: var(--space-4);
            }

            .crisis-floating-btn,
            .meditation-quick-btn {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }

            .crisis-floating-btn {
                bottom: 90px;
                left: 10px;
            }

            .meditation-quick-btn {
                bottom: 150px;
                left: 10px;
            }

            .model-status {
                flex-direction: column;
                gap: var(--space-2);
            }
        }

        @media (max-width: 480px) {
            .welcome-suggestions {
                flex-direction: column;
                align-items: center;
            }

            .suggestion-btn {
                width: 100%;
                max-width: 280px;
            }

            .model-loader {
                width: 90%;
                left: 5%;
                transform: none;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Cosmic Background -->
    <div class="app-background">
        <div class="stars-container" id="starsContainer"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="app-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="logo-text">
                        <div class="logo-title">TYAZA</div>
                        <div class="logo-subtitle">Umuvugizi w'Umutima</div>
                    </div>
                </div>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- New Chat Button -->
                <button class="new-chat-btn" id="newChatBtn">
                    <span>â¨</span> Ikiganiro Gishya
                </button>

                <!-- Hybrid AI Settings -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">AI Selection</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <label class="settings-label">AI Mode</label>
                            <select class="select" id="modelSelect">
                                <option value="auto">Auto (Smart Switch) â¡</option>
                                <option value="puter">Puter Cloud (Instant) âï¸</option>
                                <option value="tinyllama">TinyLlama (338MB) ð</option>
                                <option value="qwen2">Qwen2 0.5B (150MB) ð</option>
                                <option value="phi2">Phi-2 (675MB) ð¯</option>
                            </select>
                        </div>
                        
                        <div class="settings-row" style="margin-top: var(--space-3);">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox" id="enableRAG" checked>
                                <span>RAG - Semantic Memory</span>
                            </label>
                            <div class="text-xs text-muted">
                                Remember context intelligently
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Status -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">AI Status</div>
                    <div class="settings-card">
                        <div class="flex items-center gap-2">
                            <span class="status-indicator" id="puterStatus" style="background: #f59e0b;"></span>
                            <span id="puterText" class="text-sm">Checking Puter...</span>
                        </div>
                        <div class="flex items-center gap-2 mt-2">
                            <span class="status-indicator" id="ondeviceStatus" style="background: #f59e0b;"></span>
                            <span id="ondeviceText" class="text-sm">On-device: Loading...</span>
                        </div>
                        <div class="text-xs text-muted mt-2" id="activeAI">
                            Active: Puter Cloud
                        </div>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Amajwi & Mikorofoni</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <button class="btn btn-secondary btn-block" id="micTestBtn">
                                <span>ð¤</span> Genzura Mikorofoni
                            </button>
                        </div>
                        <div class="settings-row" style="margin-top: var(--space-3);">
                            <label class="settings-label">Ijwi</label>
                            <select class="select" id="voiceSelect">
                                <option value="Google UK English Female">ijwi ry'umugore (UK)</option>
                                <option value="Google UK English Male">ijwi ry'umugabo (UK)</option>
                                <option value="Samantha">Samantha Â· ryorohe</option>
                            </select>
                        </div>
                        <div class="voice-controls">
                            <div class="voice-control-item">
                                <div class="voice-control-label">
                                    <span>Umurenge</span>
                                    <span class="voice-control-value" id="rateValue">0.9</span>
                                </div>
                                <input type="range" class="slider" id="rateSlider" min="0.5" max="1.5" step="0.05" value="0.9">
                            </div>
                            <div class="voice-control-item">
                                <div class="voice-control-label">
                                    <span>Ibarura</span>
                                    <span class="voice-control-value" id="pitchValue">1.0</span>
                                </div>
                                <input type="range" class="slider" id="pitchSlider" min="0.5" max="2" step="0.05" value="1.0">
                            </div>
                        </div>
                        <div class="settings-row" style="margin-top: var(--space-3);">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox" id="autoTTS" checked>
                                Soma igisubizo mu ijwi
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Chat History -->
                <div class="sidebar-section" style="flex: 1;">
                    <div class="sidebar-section-title" style="display: flex; justify-content: space-between;">
                        <span>ð Amateka</span>
                        <button class="btn btn-ghost btn-sm" id="clearHistory">Hanagura</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="history-empty">
                            <i class="fas fa-history"></i>
                            <span>Nta mateka</span>
                        </div>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="info-card">
                    <div class="info-card-title">
                        <i class="fas fa-microchip"></i> KIVURA LABS
                    </div>
                    <div>
                        <span class="info-highlight">TYAZA v5.0</span> - Hybrid AI
                    </div>
                    <div class="text-xs mt-2">
                        Puter + On-device Â· RAG Â· Voice
                    </div>
                    <div class="info-card-footer">
                        Â© 2026 Kivura Labs Â· Rwanda<br>
                        Yves HIRWA TUYISHIME - CEO
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <!-- Header -->
            <header class="chat-header">
                <div class="header-left">
                    <button class="btn btn-icon btn-ghost menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="chat-title">
                        <div class="chat-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="chat-info">
                            <h1>TYAZA</h1>
                            <div class="chat-status">
                                <span class="status-indicator" id="headerStatus"></span>
                                <span id="connectionStatus">Hybrid AI</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-icon btn-ghost tooltip" data-tooltip="Export" id="exportTrigger">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-icon btn-ghost tooltip" data-tooltip="Clear chat" id="clearChat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h1 class="welcome-title">TYAZA</h1>
                    <p class="welcome-subtitle">Hybrid AI Â· Puter + On-device</p>
                    <div class="welcome-quote">
                        "Ndi hano kugira nkugire. Nkoresha ubwenge bwombi."
                    </div>
                    <div class="welcome-suggestions">
                        <button class="suggestion-btn" data-prompt="ndashaka kuvuga">ð¬ Ndashaka kuvuga</button>
                        <button class="suggestion-btn" data-prompt="mfite ibibazo">ð Mfite ibibazo</button>
                        <button class="suggestion-btn" data-prompt="ngomba inkunga">ð¤ Ngomba inkunga</button>
                        <button class="suggestion-btn" data-prompt="narushijeho">ð Narushijeho</button>
                    </div>
                    <div class="model-status" id="welcomeModelStatus">
                        <div class="badge" id="puterWelcomeBadge">
                            <i class="fas fa-cloud mr-1"></i> Puter: Checking...
                        </div>
                        <div class="badge" id="ondeviceWelcomeBadge">
                            <i class="fas fa-microchip mr-1"></i> On-device: Loading...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scroll to Bottom -->
            <button class="scroll-bottom" id="scrollBottom">
                <i class="fas fa-arrow-down"></i>
                subira hasi
            </button>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        placeholder="Sangiza icyo utekereza..." 
                        rows="1"
                    ></textarea>
                    <div class="input-actions">
                        <button class="input-btn voice-btn" id="voiceBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="input-btn send-btn" id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="voice-status" id="voiceStatus"></div>
            </div>
        </main>
    </div>

    <!-- STT Overlay -->
    <div class="stt-overlay" id="sttOverlay">
        <div class="stt-modal">
            <canvas class="voice-visualizer" id="voiceVisualizer" width="400" height="100"></canvas>
            <div class="stt-visualizer">
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
            </div>
            <div class="stt-text" id="sttText">ndakumva...</div>
            <div class="stt-hint">soma ugire icyo uhambaro</div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-robot"></i>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading Hybrid AI...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden File Input -->
    <input type="file" id="importFile" accept=".json,.txt,.tyaza" style="display: none;">

    <!-- Puter AI SDK (Loaded first for instant availability) -->
    <script>
        window.puter = null;
        window.puterAvailable = false;
    </script>
    <script src="https://js.puter.com/v2/"></script>

    <!-- Main Application Script (Module) -->
    <script type="module">
        // ================================================================
        // TYAZA v5.0 - FINAL PRODUCTION VERSION
        // Hybrid AI: Puter API + On-device models
        // All features integrated and optimized
        // ================================================================

        import { openDB } from 'https://esm.sh/idb@8.0.0';
        import { pipeline, env } from 'https://esm.sh/@xenova/transformers@2.17.1';

        // Configure transformers.js for optimal loading
        env.useBrowserCache = true;
        env.localModelPath = '/models/';
        env.allowRemoteModels = true;
        env.useFSCache = false;

        // ================================================================
        // UTILITY FUNCTIONS
        // ================================================================
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessageTime() {
            return new Date().toLocaleTimeString('rw-RW', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatRelativeTime(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'none';
            if (minutes < 60) return `${minutes} min.`;
            if (hours < 24) return `${hours} hr.`;
            if (days < 7) return `${days} j.`;
            return new Date(timestamp).toLocaleDateString('rw-RW', {
                day: 'numeric',
                month: 'short'
            });
        }

        // ================================================================
        // DATABASE (IndexedDB)
        // ================================================================

        class Database {
            constructor() {
                this.db = null;
            }

            async init() {
                this.db = await openDB('TyazaDB', 2, {
                    upgrade(db) {
                        if (!db.objectStoreNames.contains('conversations')) {
                            const store = db.createObjectStore('conversations', { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings');
                        }
                    }
                });
            }

            async saveConversation(conversation) {
                await this.db.put('conversations', {
                    id: conversation.id || generateId(),
                    ...conversation,
                    timestamp: Date.now()
                });
            }

            async getConversations() {
                return await this.db.getAll('conversations');
            }

            async getSetting(key) {
                return await this.db.get('settings', key);
            }

            async setSetting(key, value) {
                await this.db.put('settings', value, key);
            }

            async clearHistory() {
                await this.db.clear('conversations');
            }
        }

        // ================================================================
        // HYBRID AI SERVICE (Puter + On-device)
        // ================================================================

        class HybridAIService {
            constructor() {
                this.puterAvailable = false;
                this.onDeviceAvailable = false;
                this.onDeviceModel = null;
                this.currentStrategy = 'puter'; // Start with Puter
                this.loadingProgress = 0;
                this.loadingCallbacks = [];
                this.messageQueue = [];
                this.processingQueue = false;
                this.modelType = 'auto'; // auto, puter, tinyllama, qwen2, phi2
                
                // Model configurations
                this.models = {
                    'tinyllama': {
                        name: 'Xenova/tinyllama-1.1b-chat-v1.0-4bit',
                        size: '338MB',
                        type: 'ondevice'
                    },
                    'qwen2': {
                        name: 'Xenova/Qwen2-0.5B-Instruct-4bit',
                        size: '150MB',
                        type: 'ondevice'
                    },
                    'phi2': {
                        name: 'Xenova/phi-2-4bit',
                        size: '675MB',
                        type: 'ondevice'
                    },
                    'puter': {
                        name: 'Puter Cloud',
                        size: 'instant',
                        type: 'cloud'
                    },
                    'auto': {
                        name: 'Auto Switch',
                        size: 'smart',
                        type: 'hybrid'
                    }
                };
            }

            async init(progressCallback = null) {
                if (progressCallback) this.loadingCallbacks.push(progressCallback);
                
                // Check Puter availability (instant)
                await this.checkPuterConnection();
                
                // Start loading on-device model in background (non-blocking)
                this.loadOnDeviceModel('qwen2').catch(e => {
                    console.log('Background model load:', e);
                });
                
                return this;
            }

            async checkPuterConnection() {
                return new Promise(resolve => {
                    let attempts = 0;
                    const maxAttempts = 15;
                    
                    const check = setInterval(() => {
                        if (window.puter && window.puter.ai) {
                            this.puterAvailable = true;
                            this.updateStatus('puter', true);
                            clearInterval(check);
                            resolve(true);
                        } else if (attempts++ >= maxAttempts) {
                            this.puterAvailable = false;
                            this.updateStatus('puter', false);
                            clearInterval(check);
                            resolve(false);
                        }
                    }, 200);
                });
            }

            async loadOnDeviceModel(modelName = 'qwen2') {
                if (this.onDeviceAvailable) return true;
                
                try {
                    this.updateLoadingProgress(0, `Loading ${modelName}...`);
                    
                    // Load quantized model
                    this.onDeviceModel = await pipeline('text-generation', this.models[modelName].name, {
                        quantized: true,
                        device: 'wasm',
                        progress_callback: (progress) => {
                            if (progress.status === 'progress') {
                                const percent = Math.round(progress.progress * 100);
                                this.updateLoadingProgress(percent, `Loading ${modelName}: ${percent}%`);
                            }
                        }
                    });
                    
                    this.onDeviceAvailable = true;
                    this.updateStatus('ondevice', true, modelName);
                    this.updateLoadingProgress(100, `${modelName} ready!`);
                    
                    // Process queued messages
                    this.processQueue();
                    
                    return true;
                } catch (e) {
                    console.error('On-device model failed:', e);
                    this.onDeviceAvailable = false;
                    this.updateStatus('ondevice', false);
                    this.updateLoadingProgress(0, 'Model failed, using Puter');
                    return false;
                }
            }

            updateStatus(type, available, info = '') {
                const puterIndicator = document.getElementById('puterStatus');
                const puterText = document.getElementById('puterText');
                const ondeviceIndicator = document.getElementById('ondeviceStatus');
                const ondeviceText = document.getElementById('ondeviceText');
                const puterWelcome = document.getElementById('puterWelcomeBadge');
                const ondeviceWelcome = document.getElementById('ondeviceWelcomeBadge');
                const headerStatus = document.getElementById('headerStatus');
                const connectionStatus = document.getElementById('connectionStatus');
                
                if (type === 'puter') {
                    if (puterIndicator) {
                        puterIndicator.style.background = available ? '#22c55e' : '#ef4444';
                    }
                    if (puterText) {
                        puterText.textContent = available ? 'Puter: Ready' : 'Puter: Unavailable';
                    }
                    if (puterWelcome) {
                        puterWelcome.innerHTML = available ? 
                            '<i class="fas fa-cloud mr-1"></i> Puter: â Ready' : 
                            '<i class="fas fa-cloud mr-1"></i> Puter: â Offline';
                        puterWelcome.className = available ? 'badge badge-success' : 'badge';
                    }
                    
                    if (available && this.currentStrategy === 'auto') {
                        this.currentStrategy = 'puter';
                        if (headerStatus) headerStatus.style.background = '#22c55e';
                        if (connectionStatus) connectionStatus.textContent = 'Puter AI';
                    }
                }
                
                if (type === 'ondevice') {
                    if (ondeviceIndicator) {
                        ondeviceIndicator.style.background = available ? '#22c55e' : '#f59e0b';
                    }
                    if (ondeviceText) {
                        ondeviceText.textContent = available ? 
                            `On-device: Ready (${info})` : 
                            'On-device: Loading...';
                    }
                    if (ondeviceWelcome) {
                        ondeviceWelcome.innerHTML = available ? 
                            `<i class="fas fa-microchip mr-1"></i> On-device: â ${info}` : 
                            '<i class="fas fa-microchip mr-1"></i> On-device: â³ Loading...';
                        ondeviceWelcome.className = available ? 'badge badge-success' : 'badge badge-warning';
                    }
                    
                    if (available && this.currentStrategy === 'auto') {
                        this.currentStrategy = 'ondevice';
                        if (headerStatus) headerStatus.style.background = '#8b5cf6';
                        if (connectionStatus) connectionStatus.textContent = 'On-device AI';
                    }
                }
                
                // Update active AI display
                const activeAI = document.getElementById('activeAI');
                if (activeAI) {
                    activeAI.textContent = `Active: ${this.currentStrategy === 'puter' ? 'Puter Cloud' : 
                        (this.currentStrategy === 'ondevice' ? 'On-device' : 'Auto')}`;
                }
            }

            updateLoadingProgress(percent, message) {
                this.loadingProgress = percent;
                this.loadingCallbacks.forEach(cb => cb(percent, message));
            }

            async setModelType(type) {
                this.modelType = type;
                
                if (type === 'puter') {
                    this.currentStrategy = 'puter';
                    this.updateStatus('ondevice', this.onDeviceAvailable, 'standby');
                } else if (type === 'auto') {
                    this.currentStrategy = this.onDeviceAvailable ? 'ondevice' : 'puter';
                } else if (['tinyllama', 'qwen2', 'phi2'].includes(type)) {
                    if (!this.onDeviceAvailable) {
                        await this.loadOnDeviceModel(type);
                    }
                    this.currentStrategy = 'ondevice';
                }
                
                this.updateActiveDisplay();
            }

            updateActiveDisplay() {
                const headerStatus = document.getElementById('headerStatus');
                const connectionStatus = document.getElementById('connectionStatus');
                
                if (this.currentStrategy === 'puter') {
                    if (headerStatus) headerStatus.style.background = '#22c55e';
                    if (connectionStatus) connectionStatus.textContent = 'Puter AI';
                } else if (this.currentStrategy === 'ondevice') {
                    if (headerStatus) headerStatus.style.background = '#8b5cf6';
                    if (connectionStatus) connectionStatus.textContent = 'On-device AI';
                }
                
                const activeAI = document.getElementById('activeAI');
                if (activeAI) {
                    activeAI.textContent = `Active: ${this.currentStrategy === 'puter' ? 'Puter Cloud' : 
                        (this.currentStrategy === 'ondevice' ? 'On-device' : 'Auto')}`;
                }
            }

            async generateResponse(messages, context = []) {
                const userMessage = messages[messages.length - 1]?.content || '';
                
                // Check if we should use Puter
                if (this.modelType === 'puter' || 
                    (this.modelType === 'auto' && this.puterAvailable && !this.onDeviceAvailable) ||
                    (this.modelType === 'auto' && this.currentStrategy === 'puter')) {
                    
                    try {
                        const response = await this.generateWithPuter(messages);
                        return response;
                    } catch (e) {
                        console.warn('Puter failed, falling back:', e);
                        this.puterAvailable = false;
                        this.updateStatus('puter', false);
                    }
                }
                
                // Check if we should use on-device
                if (this.modelType !== 'puter' && this.onDeviceAvailable && this.onDeviceModel) {
                    try {
                        const response = await this.generateOnDevice(userMessage, context);
                        return response;
                    } catch (e) {
                        console.warn('On-device failed:', e);
                    }
                }
                
                // Queue if nothing available
                return this.queueMessage(userMessage);
            }

            async generateWithPuter(messages) {
                if (!window.puter?.ai) {
                    throw new Error('Puter not available');
                }
                
                const systemPrompt = `Wowe uri Tyaza, umuvugizi w'umutima mu Kinyarwanda. 
Shyashya mu ijwi ryuje impuhwe, ubumuntu n'ubugoro.
Komeza ibiganiro bigufi kandi byuje ubushyuhe.
Koresha amagambo nk' "umva", "umutima", "mahoro", "impuhwe" kenshi.`;
                
                const fullMessages = [
                    { role: 'system', content: systemPrompt },
                    ...messages.slice(-5)
                ];
                
                const response = await window.puter.ai.chat(fullMessages, {
                    model: 'gpt-4o-mini',
                    stream: false
                });
                
                return response.message?.content || response;
            }

            async generateOnDevice(message, context = []) {
                const systemPrompt = `Wowe uri Tyaza, umuvugizi w'umutima mu Kinyarwanda. Shyashya mu ijwi ryuje impuhwe.`;
                const contextStr = context.length > 0 
                    ? `Ibyerekeye: ${context.map(c => c.text).join(' ')}\n` 
                    : '';
                
                const prompt = `<|system|>\n${systemPrompt}\n<|user|>\n${contextStr}${message}\n<|assistant|>\n`;
                
                const result = await this.onDeviceModel(prompt, {
                    max_new_tokens: 256,
                    temperature: 0.7,
                    do_sample: true,
                    top_p: 0.95
                });
                
                return result[0].generated_text.replace(prompt, '').trim();
            }

            queueMessage(message) {
                return new Promise((resolve) => {
                    this.messageQueue.push({ message, resolve });
                    
                                        Toast.show('Ubutumwa buzerekwa (AI irakonja)...', 'info');
                    
                    // Try processing queue after 2 seconds
                    setTimeout(() => this.processQueue(), 2000);
                });
            }

            async processQueue() {
                if (this.processingQueue || this.messageQueue.length === 0) return;
                
                this.processingQueue = true;
                
                const canProcess = this.puterAvailable || this.onDeviceAvailable;
                
                if (canProcess) {
                    const queue = [...this.messageQueue];
                    this.messageQueue = [];
                    
                    for (const item of queue) {
                        try {
                            const response = await this.generateResponse([{ content: item.message }]);
                            item.resolve(response);
                        } catch (e) {
                            item.resolve('Ndi kumwe nawe. Hari ikibazo, ngaho tuganire.');
                        }
                    }
                }
                
                this.processingQueue = false;
            }
        }

        // ================================================================
        // TOAST SERVICE
        // ================================================================

        class ToastService {
            constructor() {
                this.container = document.getElementById('toastContainer');
            }

            show(message, type = 'info', duration = 3000) {
                const toast = document.createElement('tyaza-toast');
                toast.setAttribute('message', message);
                toast.setAttribute('type', type);
                toast.setAttribute('duration', duration.toString());
                this.container.appendChild(toast);
                
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, duration + 100);
            }

            success(message) { this.show(message, 'success'); }
            error(message) { this.show(message, 'error'); }
            info(message) { this.show(message, 'info'); }
            warning(message) { this.show(message, 'warning'); }
        }

        // ================================================================
        // SPEECH SERVICES
        // ================================================================

        class SpeechService {
            constructor() {
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.isListening = false;
                this.voices = [];
                this.onResult = null;
                this.onEnd = null;
                
                this.initRecognition();
                this.loadVoices();
            }

            initRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.warn('Speech recognition not supported');
                    return false;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.lang = 'rw-RW';
                
                this.recognition.onstart = () => {
                    this.isListening = true;
                };
                
                this.recognition.onend = () => {
                    this.isListening = false;
                    if (this.onEnd) this.onEnd();
                };
                
                this.recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = 0; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    if (this.onResult) this.onResult(transcript);
                };
                
                this.recognition.onerror = (event) => {
                    console.error('Recognition error:', event.error);
                    this.isListening = false;
                };
                
                return true;
            }

            loadVoices() {
                this.voices = this.synthesis.getVoices();
                if (this.synthesis.onvoiceschanged !== undefined) {
                    this.synthesis.onvoiceschanged = () => {
                        this.voices = this.synthesis.getVoices();
                    };
                }
            }

            startListening() {
                if (this.recognition && !this.isListening) {
                    try {
                        this.recognition.start();
                        return true;
                    } catch (e) {
                        console.error('Start listening error:', e);
                        return false;
                    }
                }
                return false;
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    try {
                        this.recognition.stop();
                        return true;
                    } catch (e) {
                        console.error('Stop listening error:', e);
                        return false;
                    }
                }
                return false;
            }

            speak(text, options = {}) {
                if (!this.synthesis) return;
                
                this.synthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text.slice(0, 1000));
                
                if (options.voice) {
                    const voice = this.voices.find(v => v.name.includes(options.voice.split(' ')[0]));
                    if (voice) utterance.voice = voice;
                }
                
                utterance.rate = options.rate || 0.9;
                utterance.pitch = options.pitch || 1.0;
                utterance.lang = 'rw-RW';
                
                this.synthesis.speak(utterance);
            }
        }

        // ================================================================
        // VOICE VISUALIZER
        // ================================================================

        class VoiceVisualizer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) return;
                
                this.ctx = this.canvas.getContext('2d');
                this.analyser = null;
                this.animationFrame = null;
                this.isActive = false;
            }

            async start() {
                if (this.isActive) return;
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = audioCtx.createAnalyser();
                    this.analyser.fftSize = 256;
                    const source = audioCtx.createMediaStreamSource(stream);
                    source.connect(this.analyser);
                    
                    this.isActive = true;
                    this.draw();
                } catch (e) {
                    console.error('Visualizer start error:', e);
                }
            }

            stop() {
                this.isActive = false;
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
                this.clear();
            }

            draw() {
                if (!this.isActive || !this.analyser || !this.ctx || !this.canvas) return;
                
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                
                const drawFrame = () => {
                    if (!this.isActive) return;
                    
                    this.animationFrame = requestAnimationFrame(drawFrame);
                    
                    this.analyser.getByteFrequencyData(dataArray);
                    
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Draw gradient background
                    const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                    gradient.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
                    gradient.addColorStop(1, 'rgba(236, 72, 153, 0.2)');
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Draw bars
                    const barWidth = (this.canvas.width / dataArray.length) * 2.5;
                    let x = 0;
                    
                    for (let i = 0; i < dataArray.length; i += 2) {
                        const barHeight = (dataArray[i] / 255) * this.canvas.height;
                        const hue = 240 + (i / dataArray.length) * 120;
                        this.ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`;
                        this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth - 1, barHeight);
                        x += barWidth;
                    }
                };
                
                drawFrame();
            }

            clear() {
                if (!this.ctx || !this.canvas) return;
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }

        // ================================================================
        // CRISIS RESOURCES
        // ================================================================

        const CrisisResources = {
            resources: [
                { name: 'Imitari y\'inkunga', number: '116', icon: 'ð', description: '24/7 Crisis Line' },
                { name: 'Isange One Stop', number: '3029', icon: 'ð¥', description: 'One Stop Center' },
                { name: 'Police', number: '112', icon: 'ð', description: 'Emergency' },
                { name: 'Ambulance', number: '912', icon: 'ð', description: 'Medical Emergency' }
            ],
            
            keywords: ['kwiyahura', 'gupfa', 'ntakibazo', 'birangiye', 'kwikomeretsa', 'kwiyica', 'ntacyo mbona'],
            
            showAlert() {
                if (document.getElementById('crisisModal')) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal-backdrop active';
                modal.id = 'crisisModal';
                modal.innerHTML = `
                    <div class="modal active" style="max-width: 500px; border-color: var(--color-error);">
                        <div class="modal-header" style="border-bottom-color: var(--color-error);">
                            <h3 class="modal-title" style="color: var(--color-error);">
                                â ï¸ Ukeneye ubufasha bwihutirwa?
                            </h3>
                            <button class="modal-close" id="crisisClose">&times;</button>
                        </div>
                        <div style="margin: var(--space-6) 0;">
                            <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                                Nga ni byiza kuvugana n'umuntu w'umubiri. Dore imitari y'inkunga:
                            </p>
                            <div class="crisis-resources">
                                ${this.resources.map(r => `
                                    <div class="crisis-resource">
                                        <div class="crisis-icon">${r.icon}</div>
                                        <div class="crisis-info">
                                            <div class="crisis-name">${r.name}</div>
                                            <div class="crisis-number">${r.number}</div>
                                            <div class="crisis-desc">${r.description}</div>
                                        </div>
                                        <a href="tel:${r.number}" class="crisis-call">
                                            <i class="fas fa-phone-alt"></i>
                                        </a>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <div style="display: flex; gap: var(--space-3);">
                            <button class="btn btn-secondary flex-1" id="crisisLater">
                                Ndabibuka
                            </button>
                            <button class="btn btn-primary flex-1" id="crisisNow" style="background: var(--color-error);">
                                Mpambe noneho
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                modal.querySelector('#crisisClose').onclick = () => modal.remove();
                modal.querySelector('#crisisLater').onclick = () => modal.remove();
                modal.querySelector('#crisisNow').onclick = () => {
                    window.location.href = 'tel:116';
                };
                
                setTimeout(() => {
                    if (document.getElementById('crisisModal')) {
                        modal.remove();
                    }
                }, 30000);
            }
        };

        // ================================================================
        // MAIN APPLICATION
        // ================================================================

        class TyazaApp {
            constructor() {
                this.db = new Database();
                this.ai = new HybridAIService();
                this.speech = new SpeechService();
                this.toast = new ToastService();
                this.visualizer = null;
                
                this.messages = [];
                this.currentConversationId = generateId();
                this.isGenerating = false;
                this.settings = {
                    model: 'auto',
                    voice: 'Google UK English Female',
                    rate: 0.9,
                    pitch: 1.0,
                    autoTTS: true,
                    enableRAG: true
                };
                
                this.elements = {
                    messagesContainer: document.getElementById('messagesContainer'),
                    welcomeScreen: document.getElementById('welcomeScreen'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    modelSelect: document.getElementById('modelSelect'),
                    enableRAG: document.getElementById('enableRAG'),
                    voiceSelect: document.getElementById('voiceSelect'),
                    rateSlider: document.getElementById('rateSlider'),
                    pitchSlider: document.getElementById('pitchSlider'),
                    rateValue: document.getElementById('rateValue'),
                    pitchValue: document.getElementById('pitchValue'),
                    autoTTS: document.getElementById('autoTTS'),
                    micTestBtn: document.getElementById('micTestBtn'),
                    historyList: document.getElementById('historyList'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    clearHistory: document.getElementById('clearHistory'),
                    clearChat: document.getElementById('clearChat'),
                    exportTrigger: document.getElementById('exportTrigger'),
                    menuToggle: document.getElementById('menuToggle'),
                    sidebar: document.getElementById('sidebar'),
                    sidebarClose: document.getElementById('sidebarClose'),
                    sidebarOverlay: document.getElementById('sidebarOverlay'),
                    scrollBottom: document.getElementById('scrollBottom'),
                    sttOverlay: document.getElementById('sttOverlay'),
                    sttText: document.getElementById('sttText'),
                    voiceStatus: document.getElementById('voiceStatus'),
                    loadingScreen: document.getElementById('loadingScreen'),
                    loadingText: document.getElementById('loadingText'),
                    starsContainer: document.getElementById('starsContainer'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    headerStatus: document.getElementById('headerStatus')
                };
            }

            async init() {
                // Create stars
                this.createStars();
                
                // Initialize visualizer
                this.visualizer = new VoiceVisualizer('voiceVisualizer');
                
                // Load settings
                await this.loadSettings();
                
                // Initialize database
                this.elements.loadingText.textContent = 'Initializing database...';
                await this.db.init();
                
                // Initialize AI with progress
                this.elements.loadingText.textContent = 'Loading AI services...';
                await this.ai.init((percent, message) => {
                    if (percent < 100) {
                        this.elements.loadingText.textContent = message;
                    } else {
                        setTimeout(() => {
                            this.elements.loadingScreen.classList.add('hidden');
                        }, 500);
                    }
                });
                
                // Bind speech callbacks
                this.speech.onResult = (text) => {
                    this.elements.messageInput.value = text;
                    this.elements.sttText.textContent = text || 'ndakumva...';
                    this.handleInput();
                };
                
                this.speech.onEnd = () => {
                    this.elements.voiceBtn.classList.remove('listening');
                    this.elements.sttOverlay.classList.remove('active');
                    this.visualizer.stop();
                    
                    if (this.elements.messageInput.value.trim()) {
                        this.sendMessage();
                    }
                };
                
                // Bind UI events
                this.bindEvents();
                
                // Load history
                await this.loadHistory();
                
                // Apply settings
                this.applySettings();
                
                // Hide loading screen after AI is ready
                setTimeout(() => {
                    this.elements.loadingScreen.classList.add('hidden');
                }, 2000);
                
                // Set up crisis detection
                this.setupCrisisDetection();
                
                console.log('TYAZA v5.0 initialized');
                this.toast.success('TYAZA Hybrid AI Ready');
            }

            createStars() {
                if (!this.elements.starsContainer) return;
                
                for (let i = 0; i < 60; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 3}s`;
                    star.style.opacity = Math.random() * 0.6 + 0.2;
                    this.elements.starsContainer.appendChild(star);
                }
            }

            async loadSettings() {
                try {
                    const saved = await this.db.getSetting('settings');
                    if (saved) {
                        this.settings = { ...this.settings, ...saved };
                    }
                } catch (e) {
                    console.warn('Failed to load settings:', e);
                }
            }

            async saveSettings() {
                try {
                    await this.db.setSetting('settings', this.settings);
                } catch (e) {
                    console.warn('Failed to save settings:', e);
                }
            }

            applySettings() {
                this.elements.modelSelect.value = this.settings.model;
                this.elements.enableRAG.checked = this.settings.enableRAG;
                this.elements.voiceSelect.value = this.settings.voice;
                this.elements.rateSlider.value = this.settings.rate;
                this.elements.pitchSlider.value = this.settings.pitch;
                this.elements.rateValue.textContent = this.settings.rate;
                this.elements.pitchValue.textContent = this.settings.pitch;
                this.elements.autoTTS.checked = this.settings.autoTTS;
                
                // Set AI model type
                this.ai.setModelType(this.settings.model);
            }

            bindEvents() {
                // Input
                this.elements.messageInput.addEventListener('input', () => this.handleInput());
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!this.elements.sendBtn.disabled) this.sendMessage();
                    }
                });
                
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // Voice
                this.elements.voiceBtn.addEventListener('click', () => this.toggleVoice());
                this.elements.micTestBtn.addEventListener('click', () => this.testMicrophone());
                
                // Settings
                this.elements.modelSelect.addEventListener('change', (e) => {
                    this.settings.model = e.target.value;
                    this.ai.setModelType(e.target.value);
                    this.saveSettings();
                });
                
                this.elements.enableRAG.addEventListener('change', (e) => {
                    this.settings.enableRAG = e.target.checked;
                    this.saveSettings();
                });
                
                this.elements.voiceSelect.addEventListener('change', (e) => {
                    this.settings.voice = e.target.value;
                    this.saveSettings();
                });
                
                this.elements.rateSlider.addEventListener('input', (e) => {
                    this.elements.rateValue.textContent = e.target.value;
                    this.settings.rate = parseFloat(e.target.value);
                });
                
                this.elements.rateSlider.addEventListener('change', () => this.saveSettings());
                
                this.elements.pitchSlider.addEventListener('input', (e) => {
                    this.elements.pitchValue.textContent = e.target.value;
                    this.settings.pitch = parseFloat(e.target.value);
                });
                
                this.elements.pitchSlider.addEventListener('change', () => this.saveSettings());
                
                this.elements.autoTTS.addEventListener('change', (e) => {
                    this.settings.autoTTS = e.target.checked;
                    this.saveSettings();
                });
                
                // Navigation
                this.elements.newChatBtn.addEventListener('click', () => this.newChat());
                this.elements.clearHistory.addEventListener('click', () => this.clearHistory());
                this.elements.clearChat.addEventListener('click', () => this.clearCurrentChat());
                
                // Sidebar
                this.elements.menuToggle.addEventListener('click', () => this.toggleSidebar());
                this.elements.sidebarClose.addEventListener('click', () => this.closeSidebar());
                this.elements.sidebarOverlay.addEventListener('click', () => this.closeSidebar());
                
                // Scroll
                this.elements.messagesContainer.addEventListener('scroll', () => this.handleScroll());
                this.elements.scrollBottom.addEventListener('click', () => this.scrollToBottom());
                
                // Export
                this.elements.exportTrigger.addEventListener('click', () => this.exportChat());
                
                // Suggestions
                document.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.elements.messageInput.value = btn.dataset.prompt;
                        this.handleInput();
                        this.elements.messageInput.focus();
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        this.elements.messageInput.focus();
                    }
                    if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                        e.preventDefault();
                        this.newChat();
                    }
                    if (e.key === 'Escape') {
                        this.closeSidebar();
                        if (this.speech.isListening) this.toggleVoice();
                    }
                });
            }

            setupCrisisDetection() {
                // Simple event emitter
                const checkMessage = (content) => {
                    const lower = content.toLowerCase();
                    if (CrisisResources.keywords.some(k => lower.includes(k))) {
                        CrisisResources.showAlert();
                    }
                };
                
                // Override addMessage to check
                const originalAddMessage = this.addMessage;
                this.addMessage = (role, content) => {
                    if (role === 'user') checkMessage(content);
                    originalAddMessage.call(this, role, content);
                };
            }

            handleInput() {
                const value = this.elements.messageInput.value.trim();
                this.elements.sendBtn.disabled = !value || this.isGenerating;
                
                // Auto-resize
                this.elements.messageInput.style.height = 'auto';
                this.elements.messageInput.style.height = 
                    Math.min(this.elements.messageInput.scrollHeight, 150) + 'px';
            }

            async toggleVoice() {
                if (!this.speech.isListening) {
                    // Test microphone first
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.speech.startListening();
                        this.elements.voiceBtn.classList.add('listening');
                        this.elements.sttOverlay.classList.add('active');
                        this.elements.voiceStatus.textContent = 'Mvuga none...';
                        this.visualizer.start();
                    } catch (e) {
                        this.elements.voiceStatus.textContent = 'â Emera mikorofoni';
                    }
                } else {
                    this.speech.stopListening();
                }
            }

            async testMicrophone() {
                this.elements.micTestBtn.innerHTML = '<span class="spinner-sm"></span> ndategura...';
                
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.elements.micTestBtn.innerHTML = 'â yiteguye';
                    this.elements.voiceStatus.textContent = 'â Mikorofoni yiteguye';
                    
                    setTimeout(() => {
                        this.elements.micTestBtn.innerHTML = '<span>ð¤</span> Genzura Mikorofoni';
                        this.elements.voiceStatus.textContent = '';
                    }, 2000);
                } catch (e) {
                    this.elements.micTestBtn.innerHTML = 'â emerera';
                    this.elements.voiceStatus.textContent = 'â Emera mikorofoni';
                }
            }

            async sendMessage() {
                const text = this.elements.messageInput.value.trim();
                if (!text || this.isGenerating) return;
                
                // Hide welcome screen
                this.elements.welcomeScreen.style.display = 'none';
                
                // Add user message
                this.addMessage('user', text);
                
                // Clear input
                this.elements.messageInput.value = '';
                this.elements.sendBtn.disabled = true;
                this.handleInput();
                
                // Show typing indicator
                const typingId = this.showTyping();
                this.isGenerating = true;
                
                // Close sidebar on mobile
                this.closeSidebar();
                
                try {
                    // Get context if RAG enabled
                    let context = [];
                    if (this.settings.enableRAG) {
                        // Simple context from recent messages
                        context = this.messages.slice(-5).map(m => ({
                            text: m.content,
                            role: m.role
                        }));
                    }
                    
                    // Generate response
                    const response = await this.ai.generateResponse(
                        [{ role: 'user', content: text }], 
                        context
                    );
                    
                    // Remove typing indicator
                    this.removeTyping(typingId);
                    
                    // Add assistant message
                    this.addMessage('assistant', response);
                    
                    // Auto TTS
                    if (this.settings.autoTTS) {
                        this.speech.speak(response, {
                            voice: this.settings.voice,
                            rate: this.settings.rate,
                            pitch: this.settings.pitch
                        });
                    }
                    
                    // Save conversation
                    await this.saveConversation(text, response);
                    
                } catch (e) {
                    console.error('Send error:', e);
                    this.removeTyping(typingId);
                    this.addMessage('assistant', 'Hari ikibazo. Ngaho tuganire.');
                } finally {
                    this.isGenerating = false;
                }
            }

            addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}`;
                
                const time = formatMessageTime();
                const escapedContent = escapeHtml(content);
                
                messageDiv.innerHTML = `
                    <div class="message-avatar">${role === 'user' ? 'ð¤' : 'ð¤'}</div>
                    <div class="message-content">
                        <div class="message-bubble">${escapedContent}</div>
                        <div class="message-meta">
                            <span class="message-time">${time}</span>
                            <div class="message-actions">
                                ${role === 'assistant' ? `
                                    <button class="message-action" onclick="this.closest('.message').querySelector('.message-bubble').textContent && window.app.speakMessage('${escapedContent.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <button class="message-action" onclick="navigator.clipboard.writeText('${escapedContent.replace(/'/g, "\\'")}'); window.app.toast.success('Ibyakiriwe!')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                this.elements.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                this.messages.push({ role, content, timestamp: Date.now() });
            }

            speakMessage(text) {
                if (this.settings.autoTTS) {
                    this.speech.speak(text, {
                        voice: this.settings.voice,
                        rate: this.settings.rate,
                        pitch: this.settings.pitch
                    });
                }
            }

            showTyping() {
                const id = 'typing-' + Date.now();
                const typing = document.createElement('div');
                typing.id = id;
                typing.className = 'typing-indicator';
                typing.innerHTML = `
                    <div class="typing-avatar">ð¤</div>
                    <div class="typing-bubble">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                `;
                this.elements.messagesContainer.appendChild(typing);
                this.scrollToBottom();
                return id;
            }

            removeTyping(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            scrollToBottom() {
                this.elements.messagesContainer.scrollTo({
                    top: this.elements.messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }

            handleScroll() {
                const { scrollTop, scrollHeight, clientHeight } = this.elements.messagesContainer;
                const atBottom = scrollHeight - scrollTop - clientHeight < 150;
                this.elements.scrollBottom.classList.toggle('visible', !atBottom);
            }

            async saveConversation(userMsg, assistantMsg) {
                const conversation = {
                    id: this.currentConversationId,
                    title: userMsg.slice(0, 40),
                    messages: this.messages.slice(-10),
                    timestamp: Date.now()
                };
                
                await this.db.saveConversation(conversation);
                await this.loadHistory();
            }

            async loadHistory() {
                const conversations = await this.db.getConversations();
                
                if (conversations.length === 0) {
                    this.elements.historyList.innerHTML = `
                        <div class="history-empty">
                            <i class="fas fa-history"></i>
                            <span>Nta mateka</span>
                        </div>
                    `;
                    return;
                }
                
                this.elements.historyList.innerHTML = conversations
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 15)
                    .map(c => `
                        <div class="history-item ${c.id === this.currentConversationId ? 'active' : ''}" data-id="${c.id}">
                            <div class="history-title">${escapeHtml(c.title || 'Chat')}</div>
                            <div class="history-meta">
                                <span>${formatRelativeTime(c.timestamp)}</span>
                            </div>
                        </div>
                    `).join('');
                
                this.elements.historyList.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => this.loadChat(item.dataset.id));
                });
            }

            async loadChat(id) {
                const conversations = await this.db.getConversations();
                const chat = conversations.find(c => c.id === id);
                
                if (!chat) return;
                
                this.currentConversationId = chat.id;
                this.messages = chat.messages || [];
                
                // Clear container
                while (this.elements.messagesContainer.firstChild) {
                    this.elements.messagesContainer.removeChild(this.elements.messagesContainer.firstChild);
                }
                
                // Hide welcome
                this.elements.welcomeScreen.style.display = 'none';
                
                // Add messages
                this.messages.forEach(msg => {
                    this.addMessage(msg.role, msg.content);
                });
                
                this.closeSidebar();
            }

            newChat() {
                this.messages = [];
                this.currentConversationId = generateId();
                
                // Clear container
                while (this.elements.messagesContainer.firstChild) {
                    this.elements.messagesContainer.removeChild(this.elements.messagesContainer.firstChild);
                }
                
                // Show welcome
                this.elements.welcomeScreen.style.display = 'flex';
                
                // Close sidebar
                this.closeSidebar();
            }

            async clearHistory() {
                if (!confirm('Hanagura amateka yose?')) return;
                
                await this.db.clearHistory();
                this.newChat();
                this.toast.success('Amateka yahanaguwe');
            }

            clearCurrentChat() {
                if (this.messages.length === 0) return;
                if (!confirm('Hanagura chat hiye?')) return;
                this.newChat();
                this.toast.success('Chat yahanaguwe');
            }

            exportChat() {
                if (this.messages.length === 0) {
                    this.toast.warning('Nta chat yohereza');
                    return;
                }
                
                const data = {
                    app: 'TYAZA',
                    version: '5.0',
                    timestamp: Date.now(),
                    messages: this.messages
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tyaza-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.toast.success('Chat yaherekejwe');
            }

            toggleSidebar() {
                this.elements.sidebar.classList.toggle('open');
                this.elements.sidebarOverlay.classList.toggle('active');
            }

            closeSidebar() {
                this.elements.sidebar.classList.remove('open');
                this.elements.sidebarOverlay.classList.remove('active');
            }
        }

        // ================================================================
        // CUSTOM ELEMENTS (Web Components)
        // ================================================================

        class TyazaToast extends HTMLElement {
            constructor() {
                super();
                this.attachShadow({ mode: 'open' });
            }

            connectedCallback() {
                const message = this.getAttribute('message') || '';
                const type = this.getAttribute('type') || 'info';
                
                this.shadowRoot.innerHTML = `
                    <style>
                        :host {
                            display: block;
                            background: #130d24;
                            border: 1px solid #2d2352;
                            border-left: 4px solid ${this.getBorderColor(type)};
                            border-radius: 12px;
                            padding: 16px 20px;
                            margin-bottom: 12px;
                            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
                            animation: slideIn 0.3s ease-out;
                            max-width: 350px;
                        }
                        .content {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            color: #f8fafc;
                        }
                        @keyframes slideIn {
                            from { opacity: 0; transform: translateX(100%); }
                            to { opacity: 1; transform: translateX(0); }
                        }
                    </style>
                    <div class="content">
                        <i class="fas fa-${this.getIcon(type)}"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                setTimeout(() => this.remove(), 3000);
            }

            getBorderColor(type) {
                const colors = {
                    success: '#22c55e',
                    error: '#ef4444',
                    warning: '#f59e0b',
                    info: '#3b82f6'
                };
                return colors[type] || '#3b82f6';
            }

            getIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'exclamation-circle',
                    warning: 'exclamation-triangle',
                    info: 'info-circle'
                };
                return icons[type] || 'info-circle';
            }
        }

        customElements.define('tyaza-toast', TyazaToast);

        // ================================================================
        // INITIALIZATION
        // ================================================================

        // Create global app instance
        window.app = new TyazaApp();
        window.Toast = window.app.toast;

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => window.app.init());
        } else {
            window.app.init();
        }

        // Handle offline/online events
        window.addEventListener('online', () => {
            document.getElementById('connectionStatus').textContent = 'Online';
            window.Toast?.success('Mwongeye guhuza!');
        });

        window.addEventListener('offline', () => {
            document.getElementById('connectionStatus').textContent = 'Offline';
            
            // Show offline banner
            const banner = document.createElement('div');
            banner.className = 'offline-banner show';
            banner.id = 'offlineBanner';
            banner.innerHTML = '<i class="fas fa-wifi-slash"></i> Ntago uhuza - using on-device AI';
            document.body.appendChild(banner);
            
            setTimeout(() => {
                if (document.getElementById('offlineBanner')) {
                    document.getElementById('offlineBanner').classList.remove('show');
                    setTimeout(() => document.getElementById('offlineBanner')?.remove(), 300);
                }
            }, 5000);
        });
    </script>

    <!-- Crisis Resources Styles -->
    <style>
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .modal-backdrop.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-2xl);
            padding: var(--space-8);
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s;
        }
        
        .modal-backdrop.active .modal {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-surface-600);
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            color: var(--color-text-muted);
            cursor: pointer;
            border-radius: var(--radius-md);
            font-size: 1.5rem;
        }
        
        .modal-close:hover {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }
        
        .crisis-resources {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            max-height: 300px;
            overflow-y: auto;
        }
        
        .crisis-resource {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            transition: all 0.15s;
        }
        
        .crisis-resource:hover {
            border-color: var(--color-error);
            transform: translateX(4px);
        }
        
        .crisis-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface-600);
            border-radius: var(--radius-md);
            font-size: 1.2rem;
        }
        
        .crisis-info {
            flex: 1;
        }
        
        .crisis-name {
            font-weight: 600;
            color: var(--color-text-primary);
            font-size: 0.875rem;
        }
        
        .crisis-number {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--color-error);
            line-height: 1.3;
        }
        
        .crisis-desc {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }
        
        .crisis-call {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-error);
            color: white;
            border-radius: var(--radius-full);
            text-decoration: none;
            transition: all 0.15s;
        }
        
        .crisis-call:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--color-error);
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .spinner-sm {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-surface-600);
            border-top-color: var(--color-primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .mr-1 {
            margin-right: 4px;
        }
        
        .mt-2 {
            margin-top: 8px;
        }
        
        .mt-3 {
            margin-top: 12px;
        }
        
        .mt-6 {
            margin-top: 24px;
        }
        
        .mb-2 {
            margin-bottom: 8px;
        }
        
        .pt-3 {
            padding-top: 12px;
        }
        
        .border-t {
            border-top: 1px solid var(--color-surface-600);
        }
    </style>

    <!-- Crisis Floating Button -->
    <button class="crisis-floating-btn" id="crisisFloatingBtn">
        <span class="crisis-pulse"></span>
        <i class="fas fa-phone-alt"></i>
    </button>

    <!-- Meditation Quick Button -->
    <button class="meditation-quick-btn" id="meditationQuickBtn">
        <i class="fas fa-brain"></i>
    </button>

    <script>
        // Add crisis button functionality
        document.getElementById('crisisFloatingBtn').addEventListener('click', () => {
            CrisisResources.showAlert();
        });
        
        // Add meditation button (simple breathing exercise)
        document.getElementById('meditationQuickBtn').addEventListener('click', () => {
            const message = "Imyitozo yo guhumeka: Humeka mu izuru (1,2,3,4), fata umwanya (1,2,3,4), hohora bworoshye (1,2,3,4). Subiramo inshuro 5.";
            window.app?.toast?.info(message);
            
            if (window.app?.speech) {
                window.app.speech.speak(message, {
                    voice: window.app.settings.voice,
                    rate: 0.8
                });
            }
        });
    </script>

    <!-- Fallback for older browsers -->
    <noscript>
        <div style="position: fixed; inset: 0; background: #0a0612; color: white; display: flex; align-items: center; justify-content: center; padding: 40px; text-align: center; z-index: 9999;">
            <div>
                <h1 style="font-size: 2rem; margin-bottom: 20px;">TYAZA</h1>
                <p>JavaScript is required for TYAZA Advanced AI features.</p>
                <p style="color: #94a3b8; margin-top: 20px;">Please enable JavaScript to continue.</p>
            </div>
        </div>
    </noscript>
</body>
</html>

