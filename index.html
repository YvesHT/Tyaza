<!DOCTYPE html>
<html lang="rw" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="TYAZA - Umuvugizi w'Umutima | AI Virtual Therapy Assistant">
    <meta name="theme-color" content="#0a0612">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>TYAZA Â· Umuvugizi w'Umutima</title>
    
    <!-- Preconnect and Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://js.puter.com">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
    <!-- Import Maps for ES Modules (hidden from user) -->
    <script type="importmap" style="display: none;">
        {
            "imports": {
                "@xenova/transformers": "https://esm.sh/@xenova/transformers@2.17.1",
                "idb": "https://esm.sh/idb@8.0.0"
            }
        }
    </script>
    
    <style>
        /* ================================================================
           TYAZA v5.0 - PRODUCTION VERSION
           ================================================================ */

        /* Design Tokens */
        :root {
            --color-primary-50: #f5f3ff;
            --color-primary-100: #ede9fe;
            --color-primary-200: #ddd6fe;
            --color-primary-300: #c4b5fd;
            --color-primary-400: #a78bfa;
            --color-primary-500: #8b5cf6;
            --color-primary-600: #7c3aed;
            --color-primary-700: #6d28d9;
            --color-primary-800: #5b21b6;
            --color-primary-900: #4c1d95;
            
            --color-secondary-50: #fdf2f8;
            --color-secondary-100: #fce7f3;
            --color-secondary-200: #fbcfe8;
            --color-secondary-300: #f9a8d4;
            --color-secondary-400: #f472b6;
            --color-secondary-500: #ec4899;
            --color-secondary-600: #db2777;
            --color-secondary-700: #be185d;
            --color-secondary-800: #9d174d;
            --color-secondary-900: #831843;
            
            --color-surface-950: #030014;
            --color-surface-900: #0a0612;
            --color-surface-800: #130d24;
            --color-surface-700: #1a1433;
            --color-surface-600: #231b42;
            --color-surface-500: #2d2352;
            
            --color-text-primary: #f8fafc;
            --color-text-secondary: #e2e8f0;
            --color-text-tertiary: #94a3b8;
            --color-text-muted: #64748b;
            
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            
            --gradient-primary: linear-gradient(135deg, #8b5cf6, #ec4899);
            --gradient-secondary: linear-gradient(135deg, #ec4899, #10b981);
            
            --shadow-glow-primary: 0 0 40px rgba(139, 92, 246, 0.3);
            --shadow-glow-secondary: 0 0 40px rgba(236, 72, 153, 0.3);
            
            --sidebar-width: 320px;
            --header-height: 64px;
            --content-max-width: 900px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;
            
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            
            --font-sans: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-display: 'Space Grotesk', var(--font-sans);
            --font-serif: 'Crimson Pro', Georgia, serif;
        }

        /* Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-surface-950);
            color: var(--color-text-primary);
            line-height: 1.5;
            min-height: 100vh;
            overflow: hidden;
        }

        /* Utility Classes */
        .d-flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .flex-1 { flex: 1; }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        
        .p-2 { padding: var(--space-2); }
        .p-3 { padding: var(--space-3); }
        .p-4 { padding: var(--space-4); }
        .p-5 { padding: var(--space-5); }
        .p-6 { padding: var(--space-6); }
        
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-3 { padding-top: var(--space-3); padding-bottom: var(--space-3); }
        
        .m-0 { margin: 0; }
        .mt-2 { margin-top: var(--space-2); }
        .mt-3 { margin-top: var(--space-3); }
        .mt-4 { margin-top: var(--space-4); }
        .mb-2 { margin-bottom: var(--space-2); }
        .mb-3 { margin-bottom: var(--space-3); }
        .mb-4 { margin-bottom: var(--space-4); }
        
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-base { font-size: 1rem; }
        .text-lg { font-size: 1.125rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-muted { color: var(--color-text-muted); }
        .text-success { color: var(--color-success); }
        .text-error { color: var(--color-error); }
        
        .text-center { text-align: center; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .h-screen { height: 100vh; }
        
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .rounded-2xl { border-radius: var(--radius-2xl); }
        .rounded-full { border-radius: var(--radius-full); }
        
        .border { border: 1px solid var(--color-surface-600); }
        .border-0 { border: none; }
        .border-t { border-top: 1px solid var(--color-surface-600); }
        
        .shadow-lg { box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5); }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-y-auto { overflow-y: auto; }
        
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.5), var(--shadow-glow-primary);
        }

        .btn-secondary {
            background: var(--color-surface-700);
            border-color: var(--color-surface-500);
            color: var(--color-text-primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--color-surface-600);
        }

        .btn-ghost {
            background: transparent;
            color: var(--color-text-secondary);
        }

        .btn-ghost:hover {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: 0.75rem;
        }

        .btn-block {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Input Styles */
        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: inherit;
            font-size: 1rem;
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            transition: all 0.15s;
        }

        .input:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .select {
            appearance: none;
            width: 100%;
            padding: var(--space-3) var(--space-4);
            padding-right: var(--space-10);
            font-family: inherit;
            font-size: 0.875rem;
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-3) center;
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            cursor: pointer;
        }

        .select:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.875rem;
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-surface-800);
            border: 2px solid var(--color-surface-500);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .checkbox:checked {
            background: var(--color-primary-500);
            border-color: var(--color-primary-500);
        }

        .checkbox:checked::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 6px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .slider {
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            transition: transform 0.15s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: var(--radius-full);
            background: var(--color-surface-700);
            color: var(--color-text-secondary);
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--color-warning);
        }

        .card {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
        }

        .card-glass {
            background: rgba(26, 20, 51, 0.8);
            backdrop-filter: blur(20px);
        }

        /* Cosmic Background */
        .app-background {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            background: var(--color-surface-950);
        }

        .app-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
            animation: cosmicDrift 40s ease-in-out infinite;
        }

        @keyframes cosmicDrift {
            0%, 100% { transform: translate(0, 0); }
            25% { transform: translate(2%, 1%); }
            50% { transform: translate(-1%, 2%); }
            75% { transform: translate(1%, -1%); }
        }

        .stars-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: var(--radius-full);
            animation: starTwinkle 3s ease-in-out infinite;
        }

        @keyframes starTwinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.9; }
        }

        /* Layout */
        .app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* Sidebar */
        .app-sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(10, 6, 18, 0.92);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(139, 92, 246, 0.15);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: var(--space-5);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-close {
            display: none;
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-surface-700);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow-glow-primary);
            overflow: hidden;
        }

        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .logo-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .sidebar-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0 var(--space-2);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            width: 100%;
            padding: var(--space-4);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-xl);
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(236, 72, 153, 0.15));
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-primary);
        }

        .settings-card {
            background: var(--color-surface-800);
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
        }

        .voice-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        .voice-control-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .voice-control-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-text-tertiary);
        }

        .voice-control-value {
            color: var(--color-primary-300);
            font-weight: 500;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            min-height: 150px;
        }

        .history-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: var(--space-3);
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
        }

        .history-item:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .history-item.active {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            border-left: 3px solid var(--color-secondary-400);
        }

        .history-title {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .history-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            color: var(--color-text-muted);
            text-align: center;
            gap: var(--space-2);
        }

        .info-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            font-size: 0.75rem;
            color: var(--color-text-tertiary);
        }

        .info-card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-secondary-300);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .info-highlight {
            color: var(--color-primary-300);
            font-weight: 500;
        }

        .info-card-footer {
            font-size: 0.65rem;
            color: var(--color-text-muted);
            text-align: center;
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid rgba(139, 92, 246, 0.1);
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            overflow: hidden;
        }

        .chat-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            background: rgba(10, 6, 18, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            z-index: 15;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .menu-toggle {
            display: none;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
            overflow: hidden;
        }

        .chat-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .chat-info h1 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: 0.75rem;
            color: var(--color-accent-400);
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            background: var(--color-accent-400);
            border-radius: var(--radius-full);
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .ndahari-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            box-shadow: var(--shadow-glow-primary);
            border: none;
            cursor: pointer;
            transition: all 0.15s;
        }

        .ndahari-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-primary), var(--shadow-lg);
        }

        .ndahari-btn i {
            font-size: 1rem;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--color-surface-500);
            border-radius: var(--radius-full);
        }

        .messages-container::-webkit-scrollbar-thumb:hover {
            background: var(--color-surface-400);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-icon {
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary-400), var(--color-secondary-400), var(--color-accent-400));
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            font-size: 4rem;
            color: white;
            margin-bottom: var(--space-8);
            box-shadow: var(--shadow-glow-primary), var(--shadow-glow-secondary);
            animation: morphShape 10s ease-in-out infinite, iconFloat 6s ease-in-out infinite;
            overflow: hidden;
        }

        .welcome-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes morphShape {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            33% { border-radius: 70% 30% 50% 50% / 30% 60% 40% 70%; }
            66% { border-radius: 30% 70% 40% 60% / 60% 30% 70% 40%; }
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .welcome-title {
            font-family: var(--font-display);
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-primary-300), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
        }

        .welcome-subtitle {
            font-family: var(--font-serif);
            font-size: 1.25rem;
            font-style: italic;
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-6);
        }

        .welcome-quote {
            font-family: var(--font-serif);
            font-size: 1.125rem;
            color: var(--color-text-tertiary);
            max-width: 500px;
            line-height: 1.9;
            padding: var(--space-5) var(--space-8);
            background: rgba(26, 20, 51, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-8);
        }

        .welcome-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
            max-width: 600px;
            margin-bottom: var(--space-6);
        }

        .suggestion-btn {
            padding: var(--space-3) var(--space-5);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-family: inherit;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .suggestion-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--color-primary-500);
            color: var(--color-text-primary);
            transform: translateY(-2px);
        }

        /* Message Styles */
        .message {
            display: flex;
            gap: var(--space-4);
            max-width: 85%;
            margin-bottom: var(--space-4);
            animation: messageSlide 0.3s ease-out;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            flex-shrink: 0;
            font-size: 1.2rem;
            overflow: hidden;
        }

        .message-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .message.user .message-avatar {
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
        }

        .message-bubble {
            padding: var(--space-4) var(--space-5);
            border-radius: var(--radius-xl);
            line-height: 1.75;
            word-wrap: break-word;
            max-width: 100%;
        }

        .message.user .message-bubble {
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-xl) var(--radius-xl) var(--radius-sm) var(--radius-xl);
        }

        .message.assistant .message-bubble {
            background: rgba(26, 20, 51, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl) var(--radius-xl) var(--radius-xl) var(--radius-sm);
        }

        .message-meta {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: 0 var(--space-2);
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .message-actions {
            display: flex;
            gap: var(--space-1);
            opacity: 0;
            transition: opacity 0.15s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-action {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-md);
            border: 1px solid var(--color-surface-500);
            background: var(--color-surface-700);
            color: var(--color-text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            transition: all 0.15s;
        }

        .message-action:hover {
            background: var(--color-surface-600);
            color: var(--color-text-primary);
            transform: scale(1.1);
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .typing-avatar {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            font-size: 1.2rem;
            overflow: hidden;
        }

        .typing-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .typing-bubble {
            display: flex;
            gap: 6px;
            padding: var(--space-4) var(--space-5);
            background: rgba(26, 20, 51, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
        }

        .typing-dot {
            width: 10px;
            height: 10px;
            border-radius: var(--radius-full);
            animation: typingBounce 1.4s ease-in-out infinite;
        }

        .typing-dot:nth-child(1) { background: var(--color-primary-400); }
        .typing-dot:nth-child(2) { background: var(--color-secondary-400); animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { background: var(--color-accent-400); animation-delay: 0.4s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Input Area */
        .input-area {
            padding: var(--space-5) var(--space-6) var(--space-6);
            background: linear-gradient(to top, var(--color-surface-950) 50%, transparent);
            position: relative;
        }

        .input-container {
            max-width: var(--content-max-width);
            margin: 0 auto;
            background: rgba(26, 20, 51, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-2) var(--space-2) var(--space-2) var(--space-5);
            display: flex;
            align-items: flex-end;
            gap: var(--space-3);
            box-shadow: var(--shadow-lg);
            transition: all 0.15s;
        }

        .input-container:focus-within {
            border-color: var(--color-primary-500);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: 1rem;
            padding: var(--space-4) 0;
            resize: none;
            max-height: 150px;
            min-height: 24px;
            line-height: 1.6;
        }

        textarea::placeholder {
            color: var(--color-text-muted);
        }

        .input-actions {
            display: flex;
            gap: var(--space-2);
            padding-bottom: var(--space-2);
        }

        .input-btn {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            font-size: 1.1rem;
        }

        .voice-btn {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(236, 72, 153, 0.3);
            color: var(--color-secondary-400);
        }

        .voice-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: var(--color-secondary-500);
            color: white;
            animation: micPulse 1.5s infinite;
        }

        @keyframes micPulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.5); }
            70% { box-shadow: 0 0 0 20px rgba(236, 72, 153, 0); }
        }

        .send-btn {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg), var(--shadow-glow-primary);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .voice-status {
            text-align: center;
            font-size: 0.875rem;
            color: var(--color-text-tertiary);
            min-height: 24px;
            margin-top: var(--space-3);
        }

        /* Scroll to Bottom */
        .scroll-bottom {
            position: absolute;
            bottom: 100px;
            right: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(26, 20, 51, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s;
            z-index: 40;
        }

        .scroll-bottom.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* STT Overlay */
        .stt-overlay {
            position: fixed;
            inset: 0;
            background: rgba(3, 0, 20, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .stt-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .stt-modal {
            background: rgba(26, 20, 51, 0.98);
            border: 2px solid var(--color-secondary-500);
            border-radius: var(--radius-2xl);
            padding: var(--space-10);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-6);
            box-shadow: var(--shadow-glow-secondary), var(--shadow-xl);
            transform: scale(0.9);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90vw;
        }

        .stt-overlay.active .stt-modal {
            transform: scale(1);
        }

        .voice-visualizer {
            width: 100%;
            height: 100px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
        }

        .stt-visualizer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            height: 80px;
        }

        .stt-bar {
            width: 8px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            animation: sttWave 0.7s ease-in-out infinite alternate;
        }

        .stt-bar:nth-child(1) { height: 25px; animation-delay: 0s; }
        .stt-bar:nth-child(2) { height: 40px; animation-delay: 0.1s; }
        .stt-bar:nth-child(3) { height: 60px; animation-delay: 0.2s; }
        .stt-bar:nth-child(4) { height: 45px; animation-delay: 0.3s; }
        .stt-bar:nth-child(5) { height: 70px; animation-delay: 0.4s; }
        .stt-bar:nth-child(6) { height: 35px; animation-delay: 0.5s; }

        @keyframes sttWave {
            from { height: 15px; }
            to { height: 70px; }
        }

        .stt-text {
            font-size: 1.25rem;
            color: var(--color-text-secondary);
            text-align: center;
            max-width: 400px;
            min-height: 30px;
        }

        .stt-hint {
            font-size: 0.875rem;
            color: var(--color-text-muted);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--color-surface-950);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-6);
            z-index: 1000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            font-size: 3rem;
            color: white;
            animation: logoFloat 3s ease-in-out infinite;
            box-shadow: var(--shadow-glow-primary);
            overflow: hidden;
        }

        .loading-logo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-surface-600);
            border-top-color: var(--color-primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: 1rem;
            color: var(--color-text-tertiary);
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            animation: loadingProgress 2s ease-in-out infinite;
        }

        @keyframes loadingProgress {
            0% { width: 0%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 0%; margin-left: 100%; }
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            z-index: 800;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        /* Toast Component */
        tyaza-toast {
            display: block;
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-left: 4px solid;
            border-radius: var(--radius-lg);
            padding: var(--space-4) var(--space-5);
            margin-bottom: var(--space-3);
            box-shadow: var(--shadow-lg);
            animation: toastSlideIn 0.3s ease-out;
            max-width: 350px;
        }

        tyaza-toast[type="success"] { border-left-color: var(--color-success); }
        tyaza-toast[type="error"] { border-left-color: var(--color-error); }
        tyaza-toast[type="info"] { border-left-color: var(--color-info); }

        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 15;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Crisis Floating Button */
        .crisis-floating-btn {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-error);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
            z-index: 100;
            transition: all 0.15s;
            animation: crisisFloat 3s ease-in-out infinite;
        }

        .crisis-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6);
        }

        .crisis-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-full);
            background: var(--color-error);
            opacity: 0.6;
            animation: crisisPulse 2s ease-out infinite;
        }

        @keyframes crisisPulse {
            0% { transform: scale(1); opacity: 0.6; }
            70% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes crisisFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Mood Tracking Modal */
        .mood-modal {
            max-width: 500px;
        }

        .mood-scale {
            display: flex;
            justify-content: space-between;
            gap: var(--space-2);
            margin: var(--space-6) 0;
        }

        .mood-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 2px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
        }

        .mood-btn:hover {
            border-color: var(--color-primary-400);
            transform: translateY(-2px);
        }

        .mood-btn.selected {
            border-color: var(--color-primary-500);
            background: rgba(139, 92, 246, 0.2);
        }

        .mood-emoji {
            font-size: 1.5rem;
        }

        .mood-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        .mood-notes {
            width: 100%;
            padding: var(--space-3);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            border-radius: var(--radius-lg);
            color: var(--color-text-primary);
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            margin-bottom: var(--space-4);
        }

        .mood-history {
            margin-top: var(--space-4);
        }

        .mood-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: var(--space-1);
            margin-top: var(--space-2);
        }

        .mood-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .mood-day:hover {
            transform: scale(1.1);
        }

        .mood-level-1 { background: rgba(239, 68, 68, 0.3); }
        .mood-level-2 { background: rgba(245, 158, 11, 0.3); }
        .mood-level-3 { background: rgba(234, 179, 8, 0.3); }
        .mood-level-4 { background: rgba(34, 197, 94, 0.3); }
        .mood-level-5 { background: rgba(16, 185, 129, 0.3); }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 85vw;
                --header-height: 56px;
            }

            .app-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                background: rgba(10, 6, 18, 0.98);
                z-index: 500;
            }

            .app-sidebar.open {
                transform: translateX(0);
            }

            .sidebar-close {
                display: flex !important;
            }

            .menu-toggle {
                display: flex !important;
            }

            .welcome-title {
                font-size: 2.25rem;
            }

            .welcome-icon {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }

            .message {
                max-width: 92%;
            }

            .messages-container {
                padding: var(--space-4);
            }

            .input-area {
                padding: var(--space-4);
            }

            .crisis-floating-btn {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
                bottom: 90px;
                left: 10px;
            }

            .ndahari-btn span {
                display: none;
            }
            
            .ndahari-btn {
                padding: var(--space-2);
            }
        }

        @media (max-width: 480px) {
            .welcome-suggestions {
                flex-direction: column;
                align-items: center;
            }

            .suggestion-btn {
                width: 100%;
                max-width: 280px;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Cosmic Background -->
    <div class="app-background">
        <div class="stars-container" id="starsContainer"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="app-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <img src="tyaza-logo.png" alt="TYAZA" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <i class="fas fa-robot" style="display: none;"></i>
                    </div>
                    <div class="logo-text">
                        <div class="logo-title">TYAZA</div>
                        <div class="logo-subtitle">Umuvugizi w'Umutima</div>
                    </div>
                </div>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- New Chat Button (User sees this) -->
                <button class="new-chat-btn" id="newChatBtn">
                    <span>â¨</span> Ikiganiro Gishya
                </button>

                <!-- AI Settings - Hidden from user (technical data) -->
                <div style="display: none;">
                    <select id="modelSelect">
                        <option value="auto">Auto</option>
                        <option value="puter">Ndahari</option>
                        <option value="tinyllama">TinyLlama</option>
                    </select>
                    <input type="checkbox" id="enableRAG" checked>
                </div>

                <!-- User Profile Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Umwirondoro</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <label class="settings-label">Izina ryawe</label>
                            <input type="text" class="input" id="userNameInput" placeholder="Injira izina ryawe..." value="Mugisha">
                        </div>
                        <div class="settings-row mt-2">
                            <button class="btn btn-secondary btn-sm" id="saveNameBtn">
                                <i class="fas fa-save"></i> Bika izina
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mood Tracking -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Uko wumva</div>
                    <div class="settings-card">
                        <div class="mood-scale-compact" id="moodQuickSelect">
                            <button class="mood-btn-small" data-mood="1" title="Byacye">ð¢</button>
                            <button class="mood-btn-small" data-mood="2" title="Ntacyo">ð</button>
                            <button class="mood-btn-small" data-mood="3" title="Harinkomeye">ð</button>
                            <button class="mood-btn-small" data-mood="4" title="Ni meza">ð</button>
                            <button class="mood-btn-small" data-mood="5" title="Neza cyane">ð</button>
                        </div>
                        <button class="btn btn-secondary btn-block btn-sm mt-2" id="openMoodModal">
                            <i class="fas fa-chart-line"></i> Reba imimerere
                        </button>
                    </div>
                </div>

                <!-- Voice Settings -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Amajwi</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <button class="btn btn-secondary btn-block" id="micTestBtn">
                                <span>ð¤</span> Gerageza mikorofoni
                            </button>
                        </div>
                        <div class="settings-row mt-2">
                            <label class="settings-label">Ijwi</label>
                            <select class="select" id="voiceSelect">
                                <option value="Google UK English Female">Umugore (UK)</option>
                                <option value="Google UK English Male">Umugabo (UK)</option>
                                <option value="Samantha">Samantha</option>
                            </select>
                        </div>
                        <div class="voice-controls">
                            <div class="voice-control-item">
                                <div class="voice-control-label">
                                    <span>Umuvuduko</span>
                                    <span class="voice-control-value" id="rateValue">0.9</span>
                                </div>
                                <input type="range" class="slider" id="rateSlider" min="0.5" max="1.5" step="0.05" value="0.9">
                            </div>
                            <div class="voice-control-item">
                                <div class="voice-control-label">
                                    <span>Ibarura</span>
                                    <span class="voice-control-value" id="pitchValue">1.0</span>
                                </div>
                                <input type="range" class="slider" id="pitchSlider" min="0.5" max="2" step="0.05" value="1.0">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat History -->
                <div class="sidebar-section" style="flex: 1;">
                    <div class="sidebar-section-title" style="display: flex; justify-content: space-between;">
                        <span>ð Amateka</span>
                        <button class="btn btn-ghost btn-sm" id="clearHistory">Hanagura</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="history-empty">
                            <i class="fas fa-history"></i>
                            <span>Nta mateka</span>
                        </div>
                    </div>
                </div>

                <!-- Kivura Labs Info Card -->
                <div class="info-card">
                    <div class="info-card-title">
                        <img src="kivura-logo.png" alt="KIVURA LABS" style="width: 24px; height: 24px; border-radius: 4px; margin-right: 8px;" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';">
                        <i class="fas fa-microchip" style="display: none;"></i> KIVURA LABS
                    </div>
                    <div>
                        <span class="info-highlight">"Healthy citizens, wealthy nation"</span>
                    </div>
                    <div class="text-xs mt-2">
                        Yves HIRWA TUYISHIME - CEO
                    </div>
                    <div class="text-xs mt-1">
                        Â© 2026 Kivura Labs Â· Rwanda
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <!-- Header -->
            <header class="chat-header">
                <div class="header-left">
                    <button class="btn btn-icon btn-ghost menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="chat-title">
                        <div class="chat-avatar">
                            <img src="tyaza-logo.png" alt="TYAZA" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <i class="fas fa-robot" style="display: none;"></i>
                        </div>
                        <div class="chat-info">
                            <h1>TYAZA</h1>
                            <div class="chat-status">
                                <span class="status-indicator" id="headerStatus"></span>
                                <span id="connectionStatus">Igisubizo kindimo</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="ndahari-btn" id="ndahariBtn">
                        <i class="fas fa-cloud"></i>
                        <span>Ndahari AI</span>
                    </button>
                    <button class="btn btn-icon btn-ghost" id="exportTrigger">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-icon btn-ghost" id="clearChat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <img src="tyaza-logo.png" alt="TYAZA" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <i class="fas fa-robot" style="display: none;"></i>
                    </div>
                    <h1 class="welcome-title">TYAZA</h1>
                    <p class="welcome-subtitle">Igisubizo kindimo</p>
                    <div class="welcome-quote">
                        "Ndi hano kugira nkugire. Buri mwanya, buri jambo â byakiriwe mu mahoro n'igondero."
                    </div>
                    <div class="welcome-suggestions">
                        <button class="suggestion-btn" data-prompt="Ndashaka kuvuga">ð¬ Ndashaka kuvuga</button>
                        <button class="suggestion-btn" data-prompt="Mfite ibibazo">ð Mfite ibibazo</button>
                        <button class="suggestion-btn" data-prompt="Ngomba inkunga">ð¤ Ngomba inkunga</button>
                        <button class="suggestion-btn" data-prompt="Narushijeho">ð Narushijeho</button>
                    </div>
                    <div class="greeting" id="welcomeGreeting">
                        â¨ Murakaza neza, Mugisha
                    </div>
                </div>
            </div>

            <!-- Scroll to Bottom -->
            <button class="scroll-bottom" id="scrollBottom">
                <i class="fas fa-arrow-down"></i>
                subira hasi
            </button>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        placeholder="Sangiza icyo utekereza..." 
                        rows="1"
                    ></textarea>
                    <div class="input-actions">
                        <button class="input-btn voice-btn" id="voiceBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="input-btn send-btn" id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="voice-status" id="voiceStatus"></div>
            </div>
        </main>
    </div>

    <!-- STT Overlay -->
    <div class="stt-overlay" id="sttOverlay">
        <div class="stt-modal">
            <canvas class="voice-visualizer" id="voiceVisualizer" width="400" height="100"></canvas>
            <div class="stt-visualizer">
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
                <span class="stt-bar"></span>
            </div>
            <div class="stt-text" id="sttText">ndakumva...</div>
            <div class="stt-hint">vuga ugire icyo uhambara</div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <img src="tyaza-logo.png" alt="TYAZA" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <i class="fas fa-robot" style="display: none;"></i>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Itegura...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden File Input -->
    <input type="file" id="importFile" accept=".json,.txt,.tyaza" style="display: none;">

    <!-- Mood Modal -->
    <div class="modal-backdrop" id="moodModal">
        <div class="modal mood-modal">
            <div class="modal-header">
                <h3 class="modal-title">ð Uko wumva</h3>
                <button class="modal-close" id="moodModalClose">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: var(--color-text-secondary); margin-bottom: var(--space-4);">
                    Ubu umerera gute?
                </p>
                <div class="mood-scale" id="moodScale">
                    <button class="mood-btn" data-mood="1">
                        <span class="mood-emoji">ð¢</span>
                        <span class="mood-label">Byacye</span>
                    </button>
                    <button class="mood-btn" data-mood="2">
                        <span class="mood-emoji">ð</span>
                        <span class="mood-label">Ntacyo</span>
                    </button>
                    <button class="mood-btn" data-mood="3">
                        <span class="mood-emoji">ð</span>
                        <span class="mood-label">Harinkomeye</span>
                    </button>
                    <button class="mood-btn" data-mood="4">
                        <span class="mood-emoji">ð</span>
                        <span class="mood-label">Ni meza</span>
                    </button>
                    <button class="mood-btn" data-mood="5">
                        <span class="mood-emoji">ð</span>
                        <span class="mood-label">Neza cyane</span>
                    </button>
                </div>
                <textarea class="mood-notes" id="moodNotes" placeholder="Andika icyo uhererwa... (ikinyarwanda)"></textarea>
                <button class="btn btn-primary btn-block" id="saveMoodBtn">
                    <i class="fas fa-save"></i> Bika uko numva
                </button>
                <div class="mood-history">
                    <div class="mood-history-title">Imimerere y'icyumweru</div>
                    <div class="mood-calendar" id="moodCalendar"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Crisis Modal -->
    <div class="modal-backdrop" id="crisisModal">
        <div class="modal" style="max-width: 500px; border-color: var(--color-error);">
            <div class="modal-header" style="border-bottom-color: var(--color-error);">
                <h3 class="modal-title" style="color: var(--color-error);">
                    â ï¸ Ukeneye ubufasha bwihutirwa?
                </h3>
                <button class="modal-close" id="crisisClose">&times;</button>
            </div>
            <div style="margin: var(--space-6) 0;">
                <p style="margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                    Nga ni byiza kuvugana n'umuntu w'umubiri. Dore imitari y'inkunga:
                </p>
                <div class="crisis-resources">
                    <div class="crisis-resource">
                        <div class="crisis-icon">ð</div>
                        <div class="crisis-info">
                            <div class="crisis-name">Imitari y'inkunga</div>
                            <div class="crisis-number">116</div>
                            <div class="crisis-desc">24/7 Crisis Line</div>
                        </div>
                        <a href="tel:116" class="crisis-call">
                            <i class="fas fa-phone-alt"></i>
                        </a>
                    </div>
                    <div class="crisis-resource">
                        <div class="crisis-icon">ð¥</div>
                        <div class="crisis-info">
                            <div class="crisis-name">Isange One Stop</div>
                            <div class="crisis-number">3029</div>
                            <div class="crisis-desc">One Stop Center</div>
                        </div>
                        <a href="tel:3029" class="crisis-call">
                            <i class="fas fa-phone-alt"></i>
                        </a>
                    </div>
                    <div class="crisis-resource">
                        <div class="crisis-icon">ð</div>
                        <div class="crisis-info">
                            <div class="crisis-name">Police</div>
                            <div class="crisis-number">112</div>
                            <div class="crisis-desc">Emergency</div>
                        </div>
                        <a href="tel:112" class="crisis-call">
                            <i class="fas fa-phone-alt"></i>
                        </a>
                    </div>
                    <div class="crisis-resource">
                        <div class="crisis-icon">ð</div>
                        <div class="crisis-info">
                            <div class="crisis-name">Ambulance</div>
                            <div class="crisis-number">912</div>
                            <div class="crisis-desc">Medical Emergency</div>
                        </div>
                        <a href="tel:912" class="crisis-call">
                            <i class="fas fa-phone-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: var(--space-3);">
                <button class="btn btn-secondary flex-1" id="crisisLater">
                    Ndabibuka
                </button>
                <button class="btn btn-primary flex-1" id="crisisNow" style="background: var(--color-error);">
                    Mpambe noneho
                </button>
            </div>
        </div>
    </div>

    <!-- Puter AI SDK (hidden from user) -->
    <script style="display: none;">
        window.puter = null;
        window.puterAvailable = false;
    </script>
    <script src="https://js.puter.com/v2/" style="display: none;"></script>

    <!-- Main Application Script -->
    <script type="module" style="display: none;">
        // ================================================================
        // TYAZA v5.0 - COMPLETE PRODUCTION VERSION
        // Technical implementation hidden from user
        // ================================================================

        import { openDB } from 'https://esm.sh/idb@8.0.0';
        import { pipeline, env } from 'https://esm.sh/@xenova/transformers@2.17.1';

        env.useBrowserCache = true;
        env.allowRemoteModels = true;

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessageTime() {
            return new Date().toLocaleTimeString('rw-RW', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatRelativeTime(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'none';
            if (minutes < 60) return `${minutes} min`;
            if (hours < 24) return `${hours} hr`;
            if (days < 7) return `${days} d`;
            return new Date(timestamp).toLocaleDateString('rw-RW');
        }

        // Database
        class Database {
            constructor() {
                this.db = null;
            }

            async init() {
                this.db = await openDB('TyazaDB', 3, {
                    upgrade(db) {
                        if (!db.objectStoreNames.contains('conversations')) {
                            db.createObjectStore('conversations', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings');
                        }
                        if (!db.objectStoreNames.contains('moodData')) {
                            db.createObjectStore('moodData', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!db.objectStoreNames.contains('userData')) {
                            db.createObjectStore('userData');
                        }
                    }
                });
            }

            async saveConversation(conversation) {
                await this.db.put('conversations', {
                    id: conversation.id || generateId(),
                    ...conversation,
                    timestamp: Date.now()
                });
            }

            async getConversations() {
                return await this.db.getAll('conversations');
            }

            async getSetting(key) {
                return await this.db.get('settings', key);
            }

            async setSetting(key, value) {
                await this.db.put('settings', value, key);
            }

            async saveMood(mood) {
                await this.db.add('moodData', {
                    ...mood,
                    timestamp: Date.now()
                });
            }

            async getMoodHistory(days = 7) {
                const all = await this.db.getAll('moodData');
                const cutoff = Date.now() - (days * 86400000);
                return all.filter(m => m.timestamp >= cutoff).sort((a, b) => a.timestamp - b.timestamp);
            }

            async getUserData() {
                return await this.db.get('userData', 'user') || { name: 'Mugisha' };
            }

            async saveUserData(data) {
                await this.db.put('userData', data, 'user');
            }

            async clearHistory() {
                await this.db.clear('conversations');
            }
        }

        // Clinical Evidence Framework (Highest Quality)
        const ClinicalEvidence = {
            frameworks: {
                CBT: {
                    name: 'Cognitive Behavioral Therapy',
                    techniques: {
                        cognitiveRestructuring: {
                            patterns: ['ntabwo', 'ntashobora', 'buri gihe', 'nta na rimwe', 'ntacyo'],
                            response: 'Nabonye ko utekereza mu buryo butemewe. Reka turebe hamwe uko twahindura ibyo tekerezo.',
                            evidence: 'Beck, A.T. (1979). Cognitive Therapy of Depression.'
                        },
                        behavioralActivation: {
                            patterns: ['ntagifite imbaraga', 'sinashobora gukora', 'ntacyo nshobora'],
                            response: 'Igihe tuba dufite ibintu byinshi, biduhenda. Hari igikorwa gito wakora uyu munsi?',
                            evidence: 'Lewinsohn, P.M. (1974). A behavioral approach to depression.'
                        }
                    }
                },
                DBT: {
                    name: 'Dialectical Behavior Therapy',
                    techniques: {
                        distressTolerance: {
                            patterns: ['ntakibazo', 'sinakimara', 'ndashaka guhita'],
                            response: 'Ibi bimeze nk\'umuyaga ukaze - uraza kandi uragenda. Reka turebe uko twakira iki gihe.',
                            evidence: 'Linehan, M.M. (1993). Cognitive-Behavioral Treatment of Borderline Personality Disorder.'
                        },
                        emotionRegulation: {
                            patterns: ['ndarakaye', 'ndababaye', 'ndatinya'],
                            response: 'Uyu murandasi ufite izina. Reka tumwereke umwanya.',
                            evidence: 'Linehan, M.M. (2015). DBT Skills Training Manual.'
                        }
                    }
                },
                MI: {
                    name: 'Motivational Interviewing',
                    techniques: {
                        changeTalk: {
                            patterns: ['ndashaka guhinduka', 'nkeneye ubufasha', 'nabikoze'],
                            response: 'Ni iki cyagufasha gutera intambwe? Mbese wabona uko...',
                            evidence: 'Miller, W.R. & Rollnick, S. (2012). Motivational Interviewing.'
                        }
                    }
                },
                ACT: {
                    name: 'Acceptance and Commitment Therapy',
                    techniques: {
                        acceptance: {
                            patterns: ['ntabwo mbishaka', 'ndwanya', 'ntemera'],
                            response: 'Nta guhatana. Reka turebe uko dushobora kwakira iki kibazo.',
                            evidence: 'Hayes, S.C. (2004). Acceptance and Commitment Therapy.'
                        }
                    }
                }
            },
            
            crisisProtocol: {
                triggers: ['kwiyahura', 'gupfa', 'ntakibazo', 'birangiye', 'kwikomeretsa', 'kwiyica'],
                evidence: 'Stanley, B. & Brown, G.K. (2012). Safety Planning Intervention.'
            },

            getResponse(message) {
                const lower = message.toLowerCase();
                
                // Check crisis first
                if (this.crisisProtocol.triggers.some(t => lower.includes(t))) {
                    return { type: 'crisis', response: null };
                }
                
                // Check each framework
                for (const framework of Object.values(this.frameworks)) {
                    for (const technique of Object.values(framework.techniques)) {
                        if (technique.patterns.some(p => lower.includes(p))) {
                            return {
                                type: 'evidence-based',
                                response: technique.response,
                                evidence: technique.evidence
                            };
                        }
                    }
                }
                
                return null;
            }
        };

        // AI Service (hidden implementation)
        class AIService {
            constructor() {
                this.puterAvailable = false;
                this.onDeviceAvailable = false;
                this.onDeviceModel = null;
                this.currentSource = 'puter';
                this.userName = 'Mugisha';
            }

            async init() {
                await this.checkPuter();
                this.loadOnDevice().catch(() => {});
            }

            async checkPuter() {
                return new Promise(resolve => {
                    let attempts = 0;
                    const check = setInterval(() => {
                        if (window.puter?.ai) {
                            this.puterAvailable = true;
                            this.currentSource = 'puter';
                            clearInterval(check);
                            resolve(true);
                        } else if (attempts++ >= 15) {
                            this.puterAvailable = false;
                            clearInterval(check);
                            resolve(false);
                        }
                    }, 200);
                });
            }

            async loadOnDevice() {
                try {
                    this.onDeviceModel = await pipeline('text-generation', 
                        'Xenova/tinyllama-1.1b-chat-v1.0-4bit', {
                        quantized: true,
                        device: 'wasm'
                    });
                    this.onDeviceAvailable = true;
                } catch (e) {
                    console.log('On-device unavailable');
                }
            }

            async generateResponse(messages) {
                const userMessage = messages[messages.length - 1]?.content || '';
                
                // Check clinical evidence first
                const clinical = ClinicalEvidence.getResponse(userMessage);
                if (clinical?.type === 'crisis') {
                    return { type: 'crisis', content: null };
                }
                if (clinical) {
                    return { type: 'normal', content: clinical.response };
                }
                
                // Use Puter (Ndahari)
                if (this.puterAvailable) {
                    try {
                        const systemPrompt = `Wowe uri Tyaza, umuvugizi w'umutima mu Kinyarwanda. 
Ushyashya mu ijwi ryuje impuhwe. Koresha amagambo nk' "umva", "umutima", "mahoro".
Umukiriya wawe witwa ${this.userName}.`;
                        
                        const response = await window.puter.ai.chat([
                            { role: 'system', content: systemPrompt },
                            ...messages.slice(-5)
                        ], { model: 'gpt-4o-mini' });
                        
                        return { type: 'normal', content: response.message?.content || response };
                    } catch (e) {
                        return this.getFallback();
                    }
                }
                
                // Use on-device if available
                if (this.onDeviceAvailable && this.onDeviceModel) {
                    try {
                        const prompt = `<|system|>\nWowe uri Tyaza mu Kinyarwanda.\n<|user|>\n${userMessage}\n<|assistant|>\n`;
                        const result = await this.onDeviceModel(prompt, {
                            max_new_tokens: 150,
                            temperature: 0.7
                        });
                        return { type: 'normal', content: result[0].generated_text.replace(prompt, '').trim() };
                    } catch (e) {
                        return this.getFallback();
                    }
                }
                
                return this.getFallback();
            }

            getFallback() {
                const responses = [
                    "Ndumva. Urakoze kunsangiza ibi.",
                    "Ndi kumwe nawe. Wumva ute ubu?",
                    "Urakoze kundekera."
                ];
                return { type: 'normal', content: responses[Math.floor(Math.random() * responses.length)] };
            }

            setUserName(name) {
                this.userName = name;
            }
        }

        // Speech Service
        class SpeechService {
            constructor() {
                this.recognition = null;
                this.synthesis = window.speechSynthesis;
                this.isListening = false;
                this.voices = [];
                this.onResult = null;
                this.onEnd = null;
                this.initRecognition();
                this.loadVoices();
            }

            initRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
                const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SR();
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.lang = 'rw-RW';
                
                this.recognition.onstart = () => { this.isListening = true; };
                this.recognition.onend = () => { 
                    this.isListening = false; 
                    if (this.onEnd) this.onEnd();
                };
                this.recognition.onresult = (e) => {
                    let transcript = '';
                    for (let i = 0; i < e.results.length; i++) {
                        transcript += e.results[i][0].transcript;
                    }
                    if (this.onResult) this.onResult(transcript);
                };
            }

            loadVoices() {
                this.voices = this.synthesis.getVoices();
                if (this.synthesis.onvoiceschanged) {
                    this.synthesis.onvoiceschanged = () => {
                        this.voices = this.synthesis.getVoices();
                    };
                }
            }

            startListening() {
                if (this.recognition && !this.isListening) {
                    try { this.recognition.start(); } catch (e) {}
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    try { this.recognition.stop(); } catch (e) {}
                }
            }

            speak(text, options = {}) {
                if (!this.synthesis) return;
                this.synthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text.slice(0, 500));
                if (options.voice) {
                    const voice = this.voices.find(v => v.name.includes(options.voice.split(' ')[0]));
                    if (voice) utterance.voice = voice;
                }
                utterance.rate = options.rate || 0.9;
                utterance.pitch = options.pitch || 1.0;
                utterance.lang = 'rw-RW';
                this.synthesis.speak(utterance);
            }
        }

        // Voice Visualizer
        class VoiceVisualizer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) return;
                this.ctx = this.canvas.getContext('2d');
                this.analyser = null;
                this.animationFrame = null;
                this.isActive = false;
            }

            async start() {
                if (this.isActive) return;
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const audioCtx = new AudioContext();
                    this.analyser = audioCtx.createAnalyser();
                    this.analyser.fftSize = 256;
                    const source = audioCtx.createMediaStreamSource(stream);
                    source.connect(this.analyser);
                    this.isActive = true;
                    this.draw();
                } catch (e) {}
            }

            stop() {
                this.isActive = false;
                if (this.animationFrame) cancelAnimationFrame(this.animationFrame);
                this.clear();
            }

            draw() {
                if (!this.isActive || !this.analyser || !this.ctx) return;
                const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                const drawFrame = () => {
                    if (!this.isActive) return;
                    this.animationFrame = requestAnimationFrame(drawFrame);
                    this.analyser.getByteFrequencyData(dataArray);
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Gradient
                    const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                    gradient.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
                    gradient.addColorStop(1, 'rgba(236, 72, 153, 0.2)');
                    this.ctx.fillStyle = gradient;
                    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                    
                    // Bars
                    const barWidth = (this.canvas.width / dataArray.length) * 2.5;
                    let x = 0;
                    for (let i = 0; i < dataArray.length; i += 2) {
                        const barHeight = (dataArray[i] / 255) * this.canvas.height;
                        const hue = 240 + (i / dataArray.length) * 120;
                        this.ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`;
                        this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth - 1, barHeight);
                        x += barWidth;
                    }
                };
                drawFrame();
            }

            clear() {
                if (this.ctx) this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }

        // Toast Web Component
        class TyazaToast extends HTMLElement {
            connectedCallback() {
                const message = this.getAttribute('message') || '';
                const type = this.getAttribute('type') || 'info';
                const colors = { success: '#22c55e', error: '#ef4444', info: '#3b82f6' };
                const icons = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle' };
                
                this.attachShadow({ mode: 'open' }).innerHTML = `
                    <style>
                        :host {
                            display: block;
                            background: #130d24;
                            border: 1px solid #2d2352;
                            border-left: 4px solid ${colors[type]};
                            border-radius: 12px;
                            padding: 16px 20px;
                            margin-bottom: 12px;
                            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
                            animation: slideIn 0.3s ease-out;
                            max-width: 350px;
                        }
                        .content {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            color: #f8fafc;
                        }
                        @keyframes slideIn {
                            from { opacity: 0; transform: translateX(100%); }
                            to { opacity: 1; transform: translateX(0); }
                        }
                    </style>
                    <div class="content">
                        <i class="fas fa-${icons[type]}"></i>
                        <span>${message}</span>
                    </div>
                `;
                setTimeout(() => this.remove(), 3000);
            }
        }
        customElements.define('tyaza-toast', TyazaToast);

        // Main App
        class TyazaApp {
            constructor() {
                this.db = new Database();
                this.ai = new AIService();
                this.speech = new SpeechService();
                this.visualizer = new VoiceVisualizer('voiceVisualizer');
                
                this.messages = [];
                this.currentId = generateId();
                this.isGenerating = false;
                this.userName = 'Mugisha';
                this.settings = {
                    voice: 'Google UK English Female',
                    rate: 0.9,
                    pitch: 1.0
                };
                
                this.elements = {
                    messagesContainer: document.getElementById('messagesContainer'),
                    welcomeScreen: document.getElementById('welcomeScreen'),
                    welcomeGreeting: document.getElementById('welcomeGreeting'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    userNameInput: document.getElementById('userNameInput'),
                    saveNameBtn: document.getElementById('saveNameBtn'),
                    voiceSelect: document.getElementById('voiceSelect'),
                    rateSlider: document.getElementById('rateSlider'),
                    pitchSlider: document.getElementById('pitchSlider'),
                    rateValue: document.getElementById('rateValue'),
                    pitchValue: document.getElementById('pitchValue'),
                    micTestBtn: document.getElementById('micTestBtn'),
                    historyList: document.getElementById('historyList'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    clearHistory: document.getElementById('clearHistory'),
                    clearChat: document.getElementById('clearChat'),
                    exportTrigger: document.getElementById('exportTrigger'),
                    menuToggle: document.getElementById('menuToggle'),
                    sidebar: document.getElementById('sidebar'),
                    sidebarClose: document.getElementById('sidebarClose'),
                    sidebarOverlay: document.getElementById('sidebarOverlay'),
                    scrollBottom: document.getElementById('scrollBottom'),
                    sttOverlay: document.getElementById('sttOverlay'),
                    sttText: document.getElementById('sttText'),
                    voiceStatus: document.getElementById('voiceStatus'),
                    loadingScreen: document.getElementById('loadingScreen'),
                    loadingText: document.getElementById('loadingText'),
                    starsContainer: document.getElementById('starsContainer'),
                    headerStatus: document.getElementById('headerStatus'),
                    ndahariBtn: document.getElementById('ndahariBtn'),
                    moodModal: document.getElementById('moodModal'),
                    moodModalClose: document.getElementById('moodModalClose'),
                    moodScale: document.getElementById('moodScale'),
                    moodNotes: document.getElementById('moodNotes'),
                    saveMoodBtn: document.getElementById('saveMoodBtn'),
                    moodCalendar: document.getElementById('moodCalendar'),
                    openMoodModal: document.getElementById('openMoodModal'),
                    crisisFloatingBtn: document.getElementById('crisisFloatingBtn'),
                    crisisModal: document.getElementById('crisisModal'),
                    crisisClose: document.getElementById('crisisClose'),
                    crisisLater: document.getElementById('crisisLater'),
                    crisisNow: document.getElementById('crisisNow')
                };
            }

            async init() {
                this.createStars();
                await this.db.init();
                
                const userData = await this.db.getUserData();
                this.userName = userData.name || 'Mugisha';
                this.ai.setUserName(this.userName);
                this.elements.userNameInput.value = this.userName;
                if (this.elements.welcomeGreeting) {
                    this.elements.welcomeGreeting.textContent = `â¨ Murakaza neza, ${this.userName}`;
                }
                
                const settings = await this.db.getSetting('settings');
                if (settings) this.settings = { ...this.settings, ...settings };
                this.applySettings();
                
                await this.ai.init();
                
                this.bindEvents();
                await this.loadHistory();
                
                setTimeout(() => this.elements.loadingScreen.classList.add('hidden'), 1500);
                
                // Auto-show welcome greeting
                setTimeout(() => {
                    if (this.elements.welcomeGreeting) {
                        this.elements.welcomeGreeting.style.opacity = '1';
                    }
                }, 500);
            }

            createStars() {
                if (!this.elements.starsContainer) return;
                for (let i = 0; i < 50; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 3}s`;
                    star.style.opacity = Math.random() * 0.6 + 0.2;
                    this.elements.starsContainer.appendChild(star);
                }
            }

            applySettings() {
                this.elements.voiceSelect.value = this.settings.voice;
                this.elements.rateSlider.value = this.settings.rate;
                this.elements.pitchSlider.value = this.settings.pitch;
                this.elements.rateValue.textContent = this.settings.rate;
                this.elements.pitchValue.textContent = this.settings.pitch;
            }

            bindEvents() {
                // Input
                this.elements.messageInput.addEventListener('input', () => this.handleInput());
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!this.elements.sendBtn.disabled) this.sendMessage();
                    }
                });
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // Voice
                this.elements.voiceBtn.addEventListener('click', () => this.toggleVoice());
                this.elements.micTestBtn.addEventListener('click', () => this.testMic());
                
                // Settings
                this.elements.voiceSelect.addEventListener('change', (e) => {
                    this.settings.voice = e.target.value;
                    this.db.setSetting('settings', this.settings);
                });
                this.elements.rateSlider.addEventListener('input', (e) => {
                    this.elements.rateValue.textContent = e.target.value;
                    this.settings.rate = parseFloat(e.target.value);
                });
                this.elements.rateSlider.addEventListener('change', () => this.db.setSetting('settings', this.settings));
                this.elements.pitchSlider.addEventListener('input', (e) => {
                    this.elements.pitchValue.textContent = e.target.value;
                    this.settings.pitch = parseFloat(e.target.value);
                });
                this.elements.pitchSlider.addEventListener('change', () => this.db.setSetting('settings', this.settings));
                
                // User name
                this.elements.saveNameBtn.addEventListener('click', async () => {
                    const name = this.elements.userNameInput.value.trim();
                    if (name) {
                        this.userName = name;
                        this.ai.setUserName(name);
                        await this.db.saveUserData({ name });
                        if (this.elements.welcomeGreeting) {
                            this.elements.welcomeGreeting.textContent = `â¨ Murakaza neza, ${name}`;
                        }
                        this.showToast('Izina ryabitswe!', 'success');
                    }
                });
                
                // Navigation
                this.elements.newChatBtn.addEventListener('click', () => this.newChat());
                this.elements.clearHistory.addEventListener('click', () => this.clearHistory());
                this.elements.clearChat.addEventListener('click', () => this.clearCurrent());
                this.elements.exportTrigger.addEventListener('click', () => this.exportChat());
                
                // Sidebar
                this.elements.menuToggle.addEventListener('click', () => this.toggleSidebar());
                this.elements.sidebarClose.addEventListener('click', () => this.closeSidebar());
                this.elements.sidebarOverlay.addEventListener('click', () => this.closeSidebar());
                
                // Scroll
                this.elements.messagesContainer.addEventListener('scroll', () => this.handleScroll());
                this.elements.scrollBottom.addEventListener('click', () => this.scrollToBottom());
                
                // Suggestions
                document.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.elements.messageInput.value = btn.dataset.prompt;
                        this.handleInput();
                        this.elements.messageInput.focus();
                    });
                });
                
                // Mood tracking
                this.elements.openMoodModal.addEventListener('click', () => this.openMoodModal());
                this.elements.moodModalClose.addEventListener('click', () => this.closeMoodModal());
                this.elements.moodModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.moodModal) this.closeMoodModal();
                });
                
                document.querySelectorAll('.mood-btn-small').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mood = btn.dataset.mood;
                        this.quickMood(mood);
                    });
                });
                
                this.elements.moodScale.querySelectorAll('.mood-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.elements.moodScale.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
                        btn.classList.add('selected');
                    });
                });
                
                this.elements.saveMoodBtn.addEventListener('click', () => this.saveMood());
                
                // Crisis
                this.elements.crisisFloatingBtn.addEventListener('click', () => this.showCrisis());
                this.elements.crisisClose.addEventListener('click', () => this.closeCrisis());
                this.elements.crisisLater.addEventListener('click', () => this.closeCrisis());
                this.elements.crisisNow.addEventListener('click', () => {
                    window.location.href = 'tel:116';
                });
                
                // Speech callbacks
                this.speech.onResult = (text) => {
                    this.elements.messageInput.value = text;
                    this.elements.sttText.textContent = text || 'ndakumva...';
                    this.handleInput();
                };
                
                this.speech.onEnd = () => {
                    this.elements.voiceBtn.classList.remove('listening');
                    this.elements.sttOverlay.classList.remove('active');
                    this.visualizer.stop();
                    if (this.elements.messageInput.value.trim()) {
                        this.sendMessage();
                    }
                };
                
                // Keyboard
                document.addEventListener('keydown', (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        this.elements.messageInput.focus();
                    }
                    if (e.key === 'Escape') {
                        this.closeSidebar();
                        this.closeMoodModal();
                        this.closeCrisis();
                        if (this.speech.isListening) this.toggleVoice();
                    }
                });
            }

            handleInput() {
                const val = this.elements.messageInput.value.trim();
                this.elements.sendBtn.disabled = !val || this.isGenerating;
                this.elements.messageInput.style.height = 'auto';
                this.elements.messageInput.style.height = Math.min(this.elements.messageInput.scrollHeight, 150) + 'px';
            }

            async toggleVoice() {
                if (!this.speech.isListening) {
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.speech.startListening();
                        this.elements.voiceBtn.classList.add('listening');
                        this.elements.sttOverlay.classList.add('active');
                        this.elements.voiceStatus.textContent = 'Mvuga none...';
                        this.visualizer.start();
                    } catch {
                        this.elements.voiceStatus.textContent = 'â Emera mikorofoni';
                    }
                } else {
                    this.speech.stopListening();
                }
            }

            async testMic() {
                this.elements.micTestBtn.innerHTML = '<span class="spinner-sm"></span> ndategura...';
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.elements.micTestBtn.innerHTML = 'â yiteguye';
                    this.elements.voiceStatus.textContent = 'â Mikorofoni yiteguye';
                    setTimeout(() => {
                        this.elements.micTestBtn.innerHTML = '<span>ð¤</span> Gerageza mikorofoni';
                        this.elements.voiceStatus.textContent = '';
                    }, 2000);
                } catch {
                    this.elements.micTestBtn.innerHTML = 'â emerera';
                    this.elements.voiceStatus.textContent = 'â Emera mikorofoni';
                }
            }

            async sendMessage() {
                const text = this.elements.messageInput.value.trim();
                if (!text || this.isGenerating) return;
                
                this.elements.welcomeScreen.style.display = 'none';
                this.addMessage('user', text);
                
                this.elements.messageInput.value = '';
                this.elements.sendBtn.disabled = true;
                this.handleInput();
                
                const typingId = this.showTyping();
                this.isGenerating = true;
                this.closeSidebar();
                
                try {
                    const response = await this.ai.generateResponse([{ role: 'user', content: text }]);
                    
                    if (response.type === 'crisis') {
                        this.showCrisis();
                    }
                    
                    this.removeTyping(typingId);
                    this.addMessage('assistant', response.content);
                    
                    await this.saveConversation(text, response.content);
                } catch {
                    this.removeTyping(typingId);
                    this.addMessage('assistant', 'Hari ikibazo. Ngaho tuganire.');
                } finally {
                    this.isGenerating = false;
                }
            }

            addMessage(role, content) {
                const msg = document.createElement('div');
                msg.className = `message ${role}`;
                const time = formatMessageTime();
                const escaped = escapeHtml(content);
                
                msg.innerHTML = `
                    <div class="message-avatar">
                        ${role === 'user' ? 'ð¤' : '<img src="tyaza-logo.png" alt="TYAZA" onerror="this.style.display=\'none\'; this.nextElementSibling.style.display=\'flex\';"><i class="fas fa-robot" style="display: none;"></i>'}
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">${escaped}</div>
                        <div class="message-meta">
                            <span>${time}</span>
                            <div class="message-actions">
                                ${role === 'assistant' ? `
                                    <button class="message-action" onclick="app.speakMessage('${escaped.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                ` : ''}
                                <button class="message-action" onclick="navigator.clipboard.writeText('${escaped.replace(/'/g, "\\'")}'); app.showToast('Ibyakiriwe!', 'success')">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                this.elements.messagesContainer.appendChild(msg);
                this.scrollToBottom();
                this.messages.push({ role, content, timestamp: Date.now() });
            }

            speakMessage(text) {
                this.speech.speak(text, {
                    voice: this.settings.voice,
                    rate: this.settings.rate,
                    pitch: this.settings.pitch
                });
            }

            showTyping() {
                const id = 'typing-' + Date.now();
                const typing = document.createElement('div');
                typing.id = id;
                typing.className = 'typing-indicator';
                typing.innerHTML = `
                    <div class="typing-avatar">
                        <img src="tyaza-logo.png" alt="TYAZA" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <i class="fas fa-robot" style="display: none;"></i>
                    </div>
                    <div class="typing-bubble">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                `;
                this.elements.messagesContainer.appendChild(typing);
                this.scrollToBottom();
                return id;
            }

            removeTyping(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            scrollToBottom() {
                this.elements.messagesContainer.scrollTo({
                    top: this.elements.messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }

            handleScroll() {
                const { scrollTop, scrollHeight, clientHeight } = this.elements.messagesContainer;
                const atBottom = scrollHeight - scrollTop - clientHeight < 150;
                this.elements.scrollBottom.classList.toggle('visible', !atBottom);
            }

            async saveConversation(userMsg, assistantMsg) {
                const conv = {
                    id: this.currentId,
                    title: userMsg.slice(0, 40),
                    messages: this.messages.slice(-10),
                    timestamp: Date.now()
                };
                await this.db.saveConversation(conv);
                await this.loadHistory();
            }

            async loadHistory() {
                const convs = await this.db.getConversations();
                if (convs.length === 0) {
                    this.elements.historyList.innerHTML = '<div class="history-empty"><i class="fas fa-history"></i><span>Nta mateka</span></div>';
                    return;
                }
                
                this.elements.historyList.innerHTML = convs
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 15)
                    .map(c => `
                        <div class="history-item ${c.id === this.currentId ? 'active' : ''}" data-id="${c.id}">
                            <div class="history-title">${escapeHtml(c.title || 'Chat')}</div>
                            <div class="history-meta">${formatRelativeTime(c.timestamp)}</div>
                        </div>
                    `).join('');
                
                this.elements.historyList.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => this.loadChat(item.dataset.id));
                });
            }

            async loadChat(id) {
                const convs = await this.db.getConversations();
                const chat = convs.find(c => c.id === id);
                if (!chat) return;
                
                this.currentId = chat.id;
                this.messages = chat.messages || [];
                
                while (this.elements.messagesContainer.firstChild) {
                    this.elements.messagesContainer.removeChild(this.elements.messagesContainer.firstChild);
                }
                this.elements.welcomeScreen.style.display = 'none';
                this.messages.forEach(msg => this.addMessage(msg.role, msg.content));
                this.closeSidebar();
            }

            newChat() {
                this.messages = [];
                this.currentId = generateId();
                while (this.elements.messagesContainer.firstChild) {
                    this.elements.messagesContainer.removeChild(this.elements.messagesContainer.firstChild);
                }
                this.elements.welcomeScreen.style.display = 'flex';
                this.closeSidebar();
            }

            async clearHistory() {
                if (!confirm('Hanagura amateka yose?')) return;
                await this.db.clearHistory();
                this.newChat();
                this.showToast('Amateka yahanaguwe', 'success');
            }

            clearCurrent() {
                if (this.messages.length === 0) return;
                if (!confirm('Hanagura chat hiye?')) return;
                this.newChat();
                this.showToast('Chat yahanaguwe', 'success');
            }

            exportChat() {
                if (this.messages.length === 0) {
                    this.showToast('Nta chat yohereza', 'warning');
                    return;
                }
                const data = { app: 'TYAZA', version: '5.0', timestamp: Date.now(), messages: this.messages };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tyaza-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                this.showToast('Chat yaherekejwe', 'success');
            }

            toggleSidebar() {
                this.elements.sidebar.classList.toggle('open');
                this.elements.sidebarOverlay.classList.toggle('active');
            }

            closeSidebar() {
                this.elements.sidebar.classList.remove('open');
                this.elements.sidebarOverlay.classList.remove('active');
            }

            showToast(message, type) {
                const toast = document.createElement('tyaza-toast');
                toast.setAttribute('message', message);
                toast.setAttribute('type', type);
                document.getElementById('toastContainer').appendChild(toast);
            }

            openMoodModal() {
                this.elements.moodModal.classList.add('active');
                this.loadMoodCalendar();
            }

            closeMoodModal() {
                this.elements.moodModal.classList.remove('active');
            }

            async quickMood(mood) {
                await this.db.saveMood({ mood: parseInt(mood), notes: '', quick: true });
                this.showToast('Uko wumva byabitswe!', 'success');
            }

            async saveMood() {
                const selected = this.elements.moodScale.querySelector('.mood-btn.selected');
                if (!selected) {
                    this.showToast('Hitamo uko wumva', 'warning');
                    return;
                }
                const mood = parseInt(selected.dataset.mood);
                const notes = this.elements.moodNotes.value.trim();
                await this.db.saveMood({ mood, notes });
                this.showToast('Byabitswe!', 'success');
                this.closeMoodModal();
            }

            async loadMoodCalendar() {
                const moods = await this.db.getMoodHistory(7);
                const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];
                let html = days.map(d => `<div class="mood-day-label">${d}</div>`).join('');
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dayStart = new Date(date.setHours(0,0,0,0)).getTime();
                    const dayEnd = dayStart + 86400000;
                    const dayMoods = moods.filter(m => m.timestamp >= dayStart && m.timestamp < dayEnd);
                    const avg = dayMoods.length ? Math.round(dayMoods.reduce((a,b) => a + b.mood, 0) / dayMoods.length) : 0;
                    html += `<div class="mood-day mood-level-${avg}" title="${date.toLocaleDateString()}">${date.getDate()}</div>`;
                }
                this.elements.moodCalendar.innerHTML = html;
            }

            showCrisis() {
                this.elements.crisisModal.classList.add('active');
            }

            closeCrisis() {
                this.elements.crisisModal.classList.remove('active');
            }
        }

        // Initialize
        window.app = new TyazaApp();
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }
    </script>

    <!-- Crisis Floating Button -->
    <button class="crisis-floating-btn" id="crisisFloatingBtn">
        <span class="crisis-pulse"></span>
        <i class="fas fa-phone-alt"></i>
    </button>

    <!-- Fallback -->
    <noscript>
        <div style="position: fixed; inset: 0; background: #0a0612; color: white; display: flex; align-items: center; justify-content: center; padding: 40px; text-align: center;">
            JavaScript is required for TYAZA.
        </div>
    </noscript>

    <style>
        /* Additional styles for mood quick select */
        .mood-btn-small {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            background: var(--color-surface-700);
            border: 1px solid var(--color-surface-500);
            color: var(--color-text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.15s;
        }
        
        .mood-btn-small:hover {
            transform: scale(1.1);
            border-color: var(--color-primary-500);
        }
        
        #moodQuickSelect {
            display: flex;
            justify-content: space-between;
            gap: var(--space-1);
        }
        
        .greeting {
            margin-top: var(--space-4);
            font-size: 1.1rem;
            color: var(--color-secondary-400);
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        
        .mood-day-label {
            text-align: center;
            font-size: 0.75rem;
            color: var(--color-text-muted);
            padding: var(--space-1);
        }
        
        .modal-body {
            max-height: 70vh;
            overflow-y: auto;
            padding-right: var(--space-2);
        }
        
        .mood-history-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin: var(--space-4) 0 var(--space-2) 0;
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .spinner-sm {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-surface-600);
            border-top-color: var(--color-primary-500);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        .mr-1 {
            margin-right: 4px;
        }
        
        .mt-1 {
            margin-top: 4px;
        }
        
        .mt-2 {
            margin-top: 8px;
        }
        
        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: 0.75rem;
        }
    </style>
</body>
</html>
