<!DOCTYPE html>
<html lang="rw" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <meta name="description" content="TYAZA - Umuvugizi w'Umutima | Advanced AI Virtual Therapy Assistant with On-device Intelligence">
    <meta name="theme-color" content="#0a0612">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <title>TYAZA · Umuvugizi w'Umutima · Advanced AI</title>
    
    <!-- Preconnect and Resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400;1,500&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    
    <!-- Import Maps for ES Modules -->
    <script type="importmap">
        {
            "imports": {
                "lit": "https://esm.sh/lit@3.1.0",
                "lit/decorators.js": "https://esm.sh/lit@3.1.0/decorators.js",
                "@xenova/transformers": "https://esm.sh/@xenova/transformers@2.17.1",
                "idb": "https://esm.sh/idb@8.0.0",
                "hnswlib": "https://esm.sh/hnswlib-node@1.0.0?target=es2020",
                "simple-peer": "https://esm.sh/simple-peer@9.11.1"
            }
        }
    </script>
    
    <style>
        /* ================================================================
           TYAZA v5.0 - ULTIMATE EDITION
           Complete Integration: Original Features + Advanced AI
           Web Components, Vector DB, On-device AI, RAG, WebRTC, Realtime ASR
           ================================================================ */

        /* ================================================================
           DESIGN TOKENS (Preserved from original)
           ================================================================ */
        :root {
            /* Color Tokens - Dark Theme */
            --color-primary-50: #f5f3ff;
            --color-primary-100: #ede9fe;
            --color-primary-200: #ddd6fe;
            --color-primary-300: #c4b5fd;
            --color-primary-400: #a78bfa;
            --color-primary-500: #8b5cf6;
            --color-primary-600: #7c3aed;
            --color-primary-700: #6d28d9;
            --color-primary-800: #5b21b6;
            --color-primary-900: #4c1d95;
            
            --color-secondary-50: #fdf2f8;
            --color-secondary-100: #fce7f3;
            --color-secondary-200: #fbcfe8;
            --color-secondary-300: #f9a8d4;
            --color-secondary-400: #f472b6;
            --color-secondary-500: #ec4899;
            --color-secondary-600: #db2777;
            --color-secondary-700: #be185d;
            --color-secondary-800: #9d174d;
            --color-secondary-900: #831843;
            
            --color-accent-50: #ecfdf5;
            --color-accent-100: #d1fae5;
            --color-accent-200: #a7f3d0;
            --color-accent-300: #6ee7b7;
            --color-accent-400: #34d399;
            --color-accent-500: #10b981;
            --color-accent-600: #059669;
            --color-accent-700: #047857;
            --color-accent-800: #065f46;
            --color-accent-900: #064e3b;
            
            --color-surface-950: #030014;
            --color-surface-900: #0a0612;
            --color-surface-800: #130d24;
            --color-surface-700: #1a1433;
            --color-surface-600: #231b42;
            --color-surface-500: #2d2352;
            --color-surface-400: #3d2f6d;
            --color-surface-300: #504185;
            --color-surface-200: #6b5a9e;
            --color-surface-100: #8b7ab8;
            --color-surface-50: #b8b0d0;
            
            --color-text-primary: #f8fafc;
            --color-text-secondary: #e2e8f0;
            --color-text-tertiary: #94a3b8;
            --color-text-muted: #64748b;
            --color-text-inverted: #0f172a;
            
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            --color-info: #3b82f6;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--color-primary-400), var(--color-secondary-400));
            --gradient-secondary: linear-gradient(135deg, var(--color-secondary-400), var(--color-accent-400));
            --gradient-cosmic: linear-gradient(135deg, var(--color-surface-900), var(--color-surface-800), var(--color-primary-900));
            
            /* Shadows */
            --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.6);
            --shadow-glow-primary: 0 0 40px rgba(139, 92, 246, 0.3);
            --shadow-glow-secondary: 0 0 40px rgba(236, 72, 153, 0.3);
            
            /* Border Radius */
            --radius-none: 0;
            --radius-xs: 4px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
            --radius-2xl: 32px;
            --radius-full: 9999px;
            
            /* Spacing */
            --space-0: 0;
            --space-1: 4px;
            --space-2: 8px;
            --space-3: 12px;
            --space-4: 16px;
            --space-5: 20px;
            --space-6: 24px;
            --space-8: 32px;
            --space-10: 40px;
            --space-12: 48px;
            --space-16: 64px;
            
            /* Typography */
            --font-sans: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-display: 'Space Grotesk', var(--font-sans);
            --font-serif: 'Crimson Pro', Georgia, serif;
            
            --text-xs: 0.75rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --text-3xl: 1.875rem;
            --text-4xl: 2.25rem;
            --text-5xl: 3rem;
            
            /* Layout */
            --sidebar-width: 320px;
            --header-height: 64px;
            --content-max-width: 900px;
        }

        /* ================================================================
           RESET & BASE STYLES
           ================================================================ */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-surface-950);
            color: var(--color-text-primary);
            line-height: 1.5;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* ================================================================
           UTILITY CLASSES (Preserved from original)
           ================================================================ */
        .d-none { display: none !important; }
        .d-flex { display: flex !important; }
        .d-grid { display: grid !important; }
        
        .flex-row { flex-direction: row; }
        .flex-col { flex-direction: column; }
        .flex-1 { flex: 1 1 0%; }
        .flex-auto { flex: 1 1 auto; }
        .flex-none { flex: none; }
        
        .items-center { align-items: center; }
        .items-start { align-items: flex-start; }
        .items-end { align-items: flex-end; }
        
        .justify-center { justify-content: center; }
        .justify-between { justify-content: space-between; }
        .justify-start { justify-content: flex-start; }
        .justify-end { justify-content: flex-end; }
        
        .gap-1 { gap: var(--space-1); }
        .gap-2 { gap: var(--space-2); }
        .gap-3 { gap: var(--space-3); }
        .gap-4 { gap: var(--space-4); }
        .gap-5 { gap: var(--space-5); }
        .gap-6 { gap: var(--space-6); }
        
        .p-0 { padding: 0; }
        .p-1 { padding: var(--space-1); }
        .p-2 { padding: var(--space-2); }
        .p-3 { padding: var(--space-3); }
        .p-4 { padding: var(--space-4); }
        .p-5 { padding: var(--space-5); }
        .p-6 { padding: var(--space-6); }
        
        .px-2 { padding-left: var(--space-2); padding-right: var(--space-2); }
        .px-3 { padding-left: var(--space-3); padding-right: var(--space-3); }
        .px-4 { padding-left: var(--space-4); padding-right: var(--space-4); }
        .px-6 { padding-left: var(--space-6); padding-right: var(--space-6); }
        
        .py-1 { padding-top: var(--space-1); padding-bottom: var(--space-1); }
        .py-2 { padding-top: var(--space-2); padding-bottom: var(--space-2); }
        .py-3 { padding-top: var(--space-3); padding-bottom: var(--space-3); }
        .py-4 { padding-top: var(--space-4); padding-bottom: var(--space-4); }
        
        .text-xs { font-size: var(--text-xs); }
        .text-sm { font-size: var(--text-sm); }
        .text-base { font-size: var(--text-base); }
        .text-lg { font-size: var(--text-lg); }
        .text-xl { font-size: var(--text-xl); }
        .text-2xl { font-size: var(--text-2xl); }
        
        .font-normal { font-weight: 400; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .text-primary { color: var(--color-text-primary); }
        .text-secondary { color: var(--color-text-secondary); }
        .text-muted { color: var(--color-text-muted); }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .h-screen { height: 100vh; }
        
        .rounded-sm { border-radius: var(--radius-sm); }
        .rounded-md { border-radius: var(--radius-md); }
        .rounded-lg { border-radius: var(--radius-lg); }
        .rounded-xl { border-radius: var(--radius-xl); }
        .rounded-2xl { border-radius: var(--radius-2xl); }
        .rounded-full { border-radius: var(--radius-full); }
        
        .border { border: 1px solid var(--color-surface-600); }
        .border-0 { border: none; }
        
        .shadow-sm { box-shadow: var(--shadow-sm); }
        .shadow-md { box-shadow: var(--shadow-md); }
        .shadow-lg { box-shadow: var(--shadow-lg); }
        
        .overflow-hidden { overflow: hidden; }
        .overflow-auto { overflow: auto; }
        .overflow-y-auto { overflow-y: auto; }
        
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        
        .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
        
        /* ================================================================
           COMPONENT STYLES (Preserved from original)
           ================================================================ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 500;
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg), var(--shadow-glow-primary);
        }

        .btn-secondary {
            background: var(--color-surface-700);
            border-color: var(--color-surface-500);
            color: var(--color-text-primary);
        }

        .btn-secondary:hover {
            background: var(--color-surface-600);
            border-color: var(--color-primary-500);
        }

        .btn-ghost {
            background: transparent;
            color: var(--color-text-secondary);
        }

        .btn-ghost:hover {
            background: var(--color-surface-700);
            color: var(--color-text-primary);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-md);
        }

        .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-xs);
        }

        .btn-block {
            width: 100%;
        }

        .input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: inherit;
            font-size: var(--text-base);
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            transition: all 0.15s;
        }

        .input:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .select {
            appearance: none;
            width: 100%;
            padding: var(--space-3) var(--space-4);
            padding-right: var(--space-10);
            font-family: inherit;
            font-size: var(--text-sm);
            color: var(--color-text-primary);
            background: var(--color-surface-800);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right var(--space-3) center;
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-lg);
            outline: none;
            cursor: pointer;
        }

        .select:focus {
            border-color: var(--color-primary-500);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .checkbox {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--color-surface-800);
            border: 2px solid var(--color-surface-500);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .checkbox:checked {
            background: var(--color-primary-500);
            border-color: var(--color-primary-500);
        }

        .checkbox:checked::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 6px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .slider {
            appearance: none;
            width: 100%;
            height: 6px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: transform 0.15s;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            font-size: var(--text-xs);
            font-weight: 500;
            border-radius: var(--radius-full);
            background: var(--color-surface-700);
            color: var(--color-text-secondary);
        }

        .badge-primary {
            background: rgba(139, 92, 246, 0.2);
            color: var(--color-primary-300);
        }

        .badge-success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--color-success);
        }

        .card {
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
        }

        .card-glass {
            background: rgba(26, 20, 51, 0.8);
            backdrop-filter: blur(20px);
        }

        /* ================================================================
           COSMIC BACKGROUND (Preserved)
           ================================================================ */
        .app-background {
            position: fixed;
            inset: 0;
            z-index: -1;
            overflow: hidden;
            background: var(--color-surface-950);
        }

        .app-background::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(139, 92, 246, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 60% 10%, rgba(110, 231, 183, 0.05) 0%, transparent 40%);
            animation: cosmicDrift 40s ease-in-out infinite;
        }

        @keyframes cosmicDrift {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(2%, 1%) rotate(0.5deg); }
            50% { transform: translate(-1%, 2%) rotate(-0.5deg); }
            75% { transform: translate(1%, -1%) rotate(0.3deg); }
        }

        .stars-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            border-radius: var(--radius-full);
            animation: starTwinkle 3s ease-in-out infinite;
        }

        @keyframes starTwinkle {
            0%, 100% { opacity: 0.2; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.3); }
        }

        /* ================================================================
           LAYOUT STYLES
           ================================================================ */
        .app-layout {
            display: flex;
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* Sidebar */
        .app-sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: rgba(10, 6, 18, 0.92);
            backdrop-filter: blur(40px);
            border-right: 1px solid rgba(139, 92, 246, 0.15);
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 20;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: var(--space-5);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-close {
            display: none;
            width: 36px;
            height: 36px;
            border: none;
            background: var(--color-surface-700);
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            cursor: pointer;
            align-items: center;
            justify-content: center;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-lg);
            font-size: 1.5rem;
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .logo-title {
            font-family: var(--font-display);
            font-size: var(--text-xl);
            font-weight: 700;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-subtitle {
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .sidebar-section-title {
            font-size: var(--text-xs);
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            padding: 0 var(--space-2);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            width: 100%;
            padding: var(--space-4);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(236, 72, 153, 0.1));
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-xl);
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
        }

        .new-chat-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.25), rgba(236, 72, 153, 0.15));
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow-primary);
        }

        .settings-card {
            background: var(--color-surface-800);
            border: 1px solid rgba(139, 92, 246, 0.1);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
        }

        .settings-row {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .settings-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 500;
        }

        .voice-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        .voice-control-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .voice-control-label {
            display: flex;
            justify-content: space-between;
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
        }

        .voice-control-value {
            color: var(--color-primary-300);
            font-weight: 500;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            min-height: 150px;
        }

        .history-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: var(--space-3);
            background: rgba(139, 92, 246, 0.05);
            border: 1px solid transparent;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.15s;
        }

        .history-item:hover {
            background: rgba(139, 92, 246, 0.1);
            border-color: rgba(139, 92, 246, 0.2);
        }

        .history-item.active {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            border-left: 3px solid var(--color-secondary-400);
        }

        .history-title {
            font-size: var(--text-sm);
            font-weight: 500;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: var(--text-xs);
            color: var(--color-text-muted);
        }

        .history-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            color: var(--color-text-muted);
            text-align: center;
            gap: var(--space-2);
        }

        .info-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(236, 72, 153, 0.05));
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            font-size: var(--text-xs);
            color: var(--color-text-tertiary);
        }

        .info-card-title {
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--color-secondary-300);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        /* Main Chat Area */
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            position: relative;
            overflow: hidden;
        }

        .chat-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-6);
            background: rgba(10, 6, 18, 0.85);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(139, 92, 246, 0.1);
            z-index: 15;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .menu-toggle {
            display: none;
        }

        .chat-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .chat-info h1 {
            font-size: var(--text-base);
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .chat-status {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-xs);
            color: var(--color-accent-400);
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            background: var(--color-accent-400);
            border-radius: var(--radius-full);
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.3); }
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-6);
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: var(--color-surface-500);
            border-radius: var(--radius-full);
        }

        /* Welcome Screen */
        .welcome-screen {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-8);
            text-align: center;
            animation: fadeInUp 0.6s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .welcome-icon {
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--color-primary-400), var(--color-secondary-400), var(--color-accent-400));
            border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%;
            font-size: 4rem;
            color: white;
            margin-bottom: var(--space-8);
            box-shadow: var(--shadow-glow-primary), var(--shadow-glow-secondary);
            animation: morphShape 10s ease-in-out infinite, iconFloat 6s ease-in-out infinite;
        }

        @keyframes morphShape {
            0%, 100% { border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; }
            33% { border-radius: 70% 30% 50% 50% / 30% 60% 40% 70%; }
            66% { border-radius: 30% 70% 40% 60% / 60% 30% 70% 40%; }
        }

        @keyframes iconFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .welcome-title {
            font-family: var(--font-display);
            font-size: var(--text-5xl);
            font-weight: 800;
            background: linear-gradient(135deg, var(--color-text-primary), var(--color-primary-300), var(--color-secondary-300));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-2);
        }

        .welcome-subtitle {
            font-family: var(--font-serif);
            font-size: var(--text-xl);
            font-style: italic;
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-6);
        }

        .welcome-quote {
            font-family: var(--font-serif);
            font-size: var(--text-lg);
            color: var(--color-text-tertiary);
            max-width: 500px;
            line-height: 1.9;
            padding: var(--space-5) var(--space-8);
            background: rgba(26, 20, 51, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(139, 92, 246, 0.15);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-8);
        }

        .welcome-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            justify-content: center;
            max-width: 600px;
        }

        .suggestion-btn {
            padding: var(--space-3) var(--space-5);
            background: var(--color-surface-800);
            border: 1px solid var(--color-surface-600);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-family: inherit;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all 0.15s;
        }

        .suggestion-btn:hover {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--color-primary-500);
            color: var(--color-text-primary);
            transform: translateY(-2px);
        }

        /* Input Area */
        .input-area {
            padding: var(--space-5) var(--space-6) var(--space-6);
            background: linear-gradient(to top, var(--color-surface-950) 50%, transparent);
            position: relative;
        }

        .input-container {
            max-width: var(--content-max-width);
            margin: 0 auto;
            background: rgba(26, 20, 51, 0.9);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: var(--radius-2xl);
            padding: var(--space-2) var(--space-2) var(--space-2) var(--space-5);
            display: flex;
            align-items: flex-end;
            gap: var(--space-3);
            box-shadow: var(--shadow-lg);
            transition: all 0.15s;
        }

        .input-container:focus-within {
            border-color: var(--color-primary-500);
            box-shadow: var(--shadow-lg), 0 0 0 3px rgba(139, 92, 246, 0.15);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: var(--color-text-primary);
            font-family: inherit;
            font-size: var(--text-base);
            padding: var(--space-4) 0;
            resize: none;
            max-height: 150px;
            min-height: 24px;
            line-height: 1.6;
        }

        textarea::placeholder {
            color: var(--color-text-muted);
        }

        .input-actions {
            display: flex;
            gap: var(--space-2);
            padding-bottom: var(--space-2);
        }

        .input-btn {
            width: 52px;
            height: 52px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s;
            border: none;
            font-size: 1.1rem;
        }

        .voice-btn {
            background: rgba(139, 92, 246, 0.15);
            border: 1px solid rgba(236, 72, 153, 0.3);
            color: var(--color-secondary-400);
        }

        .voice-btn:hover {
            background: rgba(139, 92, 246, 0.25);
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: var(--color-secondary-500);
            color: white;
            animation: micPulse 1.5s infinite;
        }

        @keyframes micPulse {
            0% { box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.5); }
            70% { box-shadow: 0 0 0 20px rgba(236, 72, 153, 0); }
        }

        .send-btn {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-glow-primary);
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg), var(--shadow-glow-primary);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .voice-status {
            text-align: center;
            font-size: var(--text-sm);
            color: var(--color-text-tertiary);
            min-height: 24px;
            margin-top: var(--space-3);
        }

        /* Scroll to Bottom */
        .scroll-bottom {
            position: absolute;
            bottom: 100px;
            right: var(--space-6);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: rgba(26, 20, 51, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: var(--radius-full);
            color: var(--color-text-secondary);
            font-size: var(--text-sm);
            cursor: pointer;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s;
            z-index: 40;
        }

        .scroll-bottom.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        /* STT Overlay */
        .stt-overlay {
            position: fixed;
            inset: 0;
            background: rgba(3, 0, 20, 0.9);
            backdrop-filter: blur(15px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 500;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .stt-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .stt-modal {
            background: rgba(26, 20, 51, 0.98);
            border: 2px solid var(--color-secondary-500);
            border-radius: var(--radius-2xl);
            padding: var(--space-10);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-6);
            box-shadow: var(--shadow-glow-secondary), var(--shadow-xl);
            transform: scale(0.9);
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-width: 90vw;
        }

        .stt-overlay.active .stt-modal {
            transform: scale(1);
        }

        .stt-text {
            font-size: var(--text-xl);
            color: var(--color-text-secondary);
            text-align: center;
            max-width: 400px;
            min-height: 30px;
        }

        .stt-hint {
            font-size: var(--text-sm);
            color: var(--color-text-muted);
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            inset: 0;
            background: var(--color-surface-950);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-6);
            z-index: 1000;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-logo {
            width: 100px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gradient-primary);
            border-radius: var(--radius-xl);
            font-size: 3rem;
            color: white;
            animation: logoFloat 3s ease-in-out infinite;
            box-shadow: var(--shadow-glow-primary);
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--color-surface-600);
            border-top-color: var(--color-primary-500);
            border-radius: var(--radius-full);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text {
            font-size: var(--text-base);
            color: var(--color-text-tertiary);
        }

        .loading-progress {
            width: 200px;
            height: 4px;
            background: var(--color-surface-700);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .loading-progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            animation: loadingProgress 2s ease-in-out infinite;
        }

        @keyframes loadingProgress {
            0% { width: 0%; margin-left: 0; }
            50% { width: 60%; margin-left: 20%; }
            100% { width: 0%; margin-left: 100%; }
        }

        /* Toast Container */
        .toast-container {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            z-index: 800;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 15;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Crisis Floating Button */
        .crisis-floating-btn {
            position: fixed;
            bottom: 100px;
            left: 20px;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-error);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
            z-index: 100;
            transition: all 0.15s;
            animation: crisisFloat 3s ease-in-out infinite;
        }

        .crisis-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 30px rgba(239, 68, 68, 0.6);
        }

        .crisis-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: var(--radius-full);
            background: var(--color-error);
            opacity: 0.6;
            animation: crisisPulse 2s ease-out infinite;
        }

        @keyframes crisisPulse {
            0% { transform: scale(1); opacity: 0.6; }
            70% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        @keyframes crisisFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Meditation Quick Button */
        .meditation-quick-btn {
            position: fixed;
            bottom: 180px;
            left: 20px;
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            background: var(--gradient-primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: var(--shadow-glow-primary);
            z-index: 99;
            transition: all 0.15s;
        }

        .meditation-quick-btn:hover {
            transform: scale(1.1) rotate(180deg);
        }

        /* Offline Banner */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--color-warning);
            color: var(--color-surface-950);
            padding: var(--space-3);
            text-align: center;
            font-size: var(--text-sm);
            font-weight: 500;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 85vw;
                --header-height: 56px;
            }

            .app-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                background: rgba(10, 6, 18, 0.98);
                z-index: 500;
            }

            .app-sidebar.open {
                transform: translateX(0);
            }

            .sidebar-close {
                display: flex !important;
            }

            .menu-toggle {
                display: flex !important;
            }

            .welcome-title {
                font-size: var(--text-4xl);
            }

            .welcome-icon {
                width: 100px;
                height: 100px;
                font-size: 3rem;
            }

            .messages-container {
                padding: var(--space-4);
            }

            .input-area {
                padding: var(--space-4);
            }

            .crisis-floating-btn,
            .meditation-quick-btn {
                width: 48px;
                height: 48px;
                font-size: 1.2rem;
            }

            .crisis-floating-btn {
                bottom: 90px;
                left: 10px;
            }

            .meditation-quick-btn {
                bottom: 150px;
                left: 10px;
            }
        }

        @media (max-width: 480px) {
            .welcome-suggestions {
                flex-direction: column;
                align-items: center;
            }

            .suggestion-btn {
                width: 100%;
                max-width: 280px;
            }
        }

        /* Reduced Motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <!-- Cosmic Background -->
    <div class="app-background">
        <div class="stars-container" id="starsContainer"></div>
    </div>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="app-sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="logo-text">
                        <div class="logo-title">TYAZA</div>
                        <div class="logo-subtitle">Umuvugizi w'Umutima</div>
                    </div>
                </div>
                <button class="sidebar-close" id="sidebarClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- New Chat Button -->
                <button class="new-chat-btn" id="newChatBtn">
                    <span>✨</span> Ikiganiro Gishya
                </button>

                <!-- Advanced AI Settings Section -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Advanced AI</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <label class="settings-label">On-device Model</label>
                            <select class="select" id="modelSelect">
                                <option value="tinyllama">TinyLlama (Fast, 0.5B)</option>
                                <option value="phi2">Phi-2 (Balanced, 2.7B)</option>
                                <option value="qwen2">Qwen2 0.5B (Efficient)</option>
                                <option value="cloud">Cloud Fallback (API)</option>
                            </select>
                        </div>
                        
                        <div class="settings-row" style="margin-top: var(--space-3);">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox" id="enableRAG" checked>
                                <span>RAG - Semantic Memory</span>
                            </label>
                            <div class="text-xs text-muted" style="margin-top: 4px;">
                                Uses embeddings to remember context
                            </div>
                        </div>
                        
                        <div class="settings-row" style="margin-top: var(--space-3);">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox" id="enableWebGPU" checked>
                                <span>WebGPU Acceleration</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- WebRTC Status -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Realtime Peer</div>
                    <div class="settings-card">
                        <div class="flex items-center gap-2">
                            <span class="status-indicator" id="webrtcStatus" style="background: var(--color-warning);"></span>
                            <span id="webrtcText" class="text-sm">Initializing...</span>
                        </div>
                        <div class="text-xs text-muted mt-2">
                            Peer-to-peer for realtime chat
                        </div>
                    </div>
                </div>

                <!-- Voice Settings (Preserved) -->
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Amajwi & Mikorofoni</div>
                    <div class="settings-card">
                        <div class="settings-row">
                            <button class="btn btn-secondary btn-block" id="micTestBtn">
                                <span>🎤</span> Genzura Mikorofoni
                            </button>
                        </div>
                        <div class="settings-row" style="margin-top: var(--space-3);">
                            <label class="settings-label">Ijwi</label>
                            <select class="select" id="voiceSelect">
                                <option value="Google UK English Female">ijwi ry'umugore (UK)</option>
                                <option value="Google UK English Male">ijwi ry'umugabo (UK)</option>
                                <option value="Samantha">Samantha · ryorohe</option>
                            </select>
                        </div>
                        <div class="voice-controls">
                            <div class="voice-control-item">
                                <div class="voice-control-label">
                                    <span>Umurenge</span>
                                    <span class="voice-control-value" id="rateValue">0.9</span>
                                </div>
                                <input type="range" class="slider" id="rateSlider" min="0.5" max="1.5" step="0.05" value="0.9">
                            </div>
                            <div class="voice-control-item">
                                <div class="voice-control-label">
                                    <span>Ibarura</span>
                                    <span class="voice-control-value" id="pitchValue">1.0</span>
                                </div>
                                <input type="range" class="slider" id="pitchSlider" min="0.5" max="2" step="0.05" value="1.0">
                            </div>
                        </div>
                        <div class="settings-row" style="margin-top: var(--space-3);">
                            <label class="checkbox-label">
                                <input type="checkbox" class="checkbox" id="autoTTS" checked>
                                Soma igisubizo mu ijwi
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Chat History -->
                <div class="sidebar-section" style="flex: 1;">
                    <div class="sidebar-section-title" style="display: flex; justify-content: space-between;">
                        <span>📜 Amateka</span>
                        <button class="btn btn-ghost btn-sm" id="clearHistory">Hanagura</button>
                    </div>
                    <div class="history-list" id="historyList">
                        <div class="history-empty">
                            <i class="fas fa-history"></i>
                            <span>Nta mateka</span>
                        </div>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="info-card">
                    <div class="info-card-title">
                        <i class="fas fa-microchip"></i> KIVURA LABS
                    </div>
                    <div>
                        <span class="info-highlight">TYAZA v5.0</span> - Advanced AI
                    </div>
                    <div class="text-xs mt-2">
                        WebGPU · RAG · WebRTC · On-device
                    </div>
                    <div class="info-card-footer mt-3 pt-3 border-t border-surface-600">
                        © 2026 Kivura Labs · Rwanda
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <!-- Header -->
            <header class="chat-header">
                <div class="header-left">
                    <button class="btn btn-icon btn-ghost menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="chat-title">
                        <div class="chat-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="chat-info">
                            <h1>TYAZA</h1>
                            <div class="chat-status">
                                <span class="status-indicator"></span>
                                <span id="connectionStatus">Advanced AI</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-icon btn-ghost tooltip" data-tooltip="Export" id="exportTrigger">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="btn btn-icon btn-ghost tooltip" data-tooltip="Clear chat" id="clearChat">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Screen (will be hidden once chat starts) -->
                <div class="welcome-screen" id="welcomeScreen">
                    <div class="welcome-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <h1 class="welcome-title">TYAZA</h1>
                    <p class="welcome-subtitle">Advanced AI · On-device · Realtime</p>
                    <div class="welcome-quote">
                        "Ndi hano kugira nkugire. Nkoresha ubwenge bw'ikoranabuhanga bwa none."
                    </div>
                    <div class="welcome-suggestions">
                        <button class="suggestion-btn" data-prompt="ndashaka kuvuga">💬 Ndashaka kuvuga</button>
                        <button class="suggestion-btn" data-prompt="mfite ibibazo">😔 Mfite ibibazo</button>
                        <button class="suggestion-btn" data-prompt="ngomba inkunga">🤝 Ngomba inkunga</button>
                    </div>
                </div>
            </div>

            <!-- Scroll to Bottom -->
            <button class="scroll-bottom" id="scrollBottom">
                <i class="fas fa-arrow-down"></i>
                subira hasi
            </button>

            <!-- Input Area -->
            <div class="input-area">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        placeholder="Sangiza icyo utekereza..." 
                        rows="1"
                    ></textarea>
                    <div class="input-actions">
                        <button class="input-btn voice-btn" id="voiceBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <button class="input-btn send-btn" id="sendBtn" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="voice-status" id="voiceStatus"></div>
            </div>
        </main>
    </div>

    <!-- STT Overlay -->
    <div class="stt-overlay" id="sttOverlay">
        <div class="stt-modal">
            <tyaza-voice-visualizer id="voiceVisualizer"></tyaza-voice-visualizer>
            <div class="stt-visualizer">
                <span class="stt-bar"></span><span class="stt-bar"></span><span class="stt-bar"></span>
                <span class="stt-bar"></span><span class="stt-bar"></span><span class="stt-bar"></span>
            </div>
            <div class="stt-text" id="sttText">ndakumva...</div>
            <div class="stt-hint">soma ugire icyo uhambaro</div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">
            <i class="fas fa-robot"></i>
        </div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Loading Advanced AI...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Hidden File Input -->
    <input type="file" id="importFile" accept=".json,.txt,.tyaza" style="display: none;">

    <!-- Main Application Script (Module) -->
    <script type="module">
        // ================================================================
        // TYAZA v5.0 - ULTIMATE INTEGRATED EDITION
        // Combines original features with advanced AI capabilities
        // ================================================================

        import { LitElement, html, css } from 'lit';
        import { openDB } from 'idb';
        import { pipeline, env } from '@xenova/transformers';
        import Hnswlib from 'hnswlib';
        import Peer from 'simple-peer';

        // Configure transformers.js
        env.localModelPath = '/models/';
        env.allowRemoteModels = true;
        env.useBrowserCache = true;
        env.useFSCache = false;

        // ================================================================
        // UTILITY FUNCTIONS (Preserved from original)
        // ================================================================
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessageTime() {
            return new Date().toLocaleTimeString('rw-RW', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function formatRelativeTime(timestamp) {
            const diff = Date.now() - timestamp;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'none';
            if (minutes < 60) return `${minutes} min.`;
            if (hours < 24) return `${hours} hr.`;
            if (days < 7) return `${days} j.`;
            return new Date(timestamp).toLocaleDateString('rw-RW');
        }

        // ================================================================
        // WEB COMPONENTS
        // ================================================================

        /**
         * TyazaMessage - Chat message component
         */
        class TyazaMessage extends LitElement {
            static properties = {
                role: { type: String },
                content: { type: String },
                timestamp: { type: Number }
            };

            static styles = css`
                :host {
                    display: flex;
                    gap: 16px;
                    max-width: 85%;
                    margin-bottom: 20px;
                    animation: slideIn 0.3s ease-out;
                }
                :host([role="user"]) {
                    align-self: flex-end;
                    flex-direction: row-reverse;
                }
                .avatar {
                    width: 44px;
                    height: 44px;
                    border-radius: 12px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    background: linear-gradient(135deg, #8b5cf6, #ec4899);
                    flex-shrink: 0;
                    font-size: 1.2rem;
                }
                .bubble {
                    padding: 16px 20px;
                    border-radius: 24px;
                    line-height: 1.75;
                    word-wrap: break-word;
                    max-width: 100%;
                }
                :host([role="user"]) .bubble {
                    background: #1a1433;
                    border: 1px solid #2d2352;
                    border-radius: 24px 24px 8px 24px;
                }
                :host([role="assistant"]) .bubble {
                    background: rgba(26, 20, 51, 0.7);
                    backdrop-filter: blur(20px);
                    border: 1px solid rgba(139, 92, 246, 0.15);
                    border-radius: 24px 24px 24px 8px;
                }
                .meta {
                    display: flex;
                    gap: 8px;
                    padding: 0 8px;
                    font-size: 12px;
                    color: #64748b;
                }
                .actions {
                    display: flex;
                    gap: 4px;
                    opacity: 0;
                    transition: opacity 0.15s;
                }
                :host(:hover) .actions {
                    opacity: 1;
                }
                .action-btn {
                    width: 28px;
                    height: 28px;
                    border-radius: 6px;
                    border: 1px solid #2d2352;
                    background: #1a1433;
                    color: #94a3b8;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 12px;
                }
                .action-btn:hover {
                    background: #2d2352;
                    color: #f8fafc;
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateY(10px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;

            render() {
                return html`
                    <div class="avatar">${this.role === 'user' ? '👤' : '🤖'}</div>
                    <div class="content">
                        <div class="bubble">${this.content}</div>
                        <div class="meta">
                            <span>${new Date(this.timestamp).toLocaleTimeString()}</span>
                            <div class="actions">
                                ${this.role === 'assistant' ? html`
                                    <button class="action-btn" @click=${this.speak} title="Soma">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                    <button class="action-btn" @click=${this.copy} title="Kopera">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            speak() {
                const event = new CustomEvent('speak', { detail: this.content });
                this.dispatchEvent(event);
            }

            copy() {
                navigator.clipboard.writeText(this.content);
                const event = new CustomEvent('toast', { detail: { message: 'Ibyakiriwe!', type: 'success' } });
                this.dispatchEvent(event);
            }
        }

        /**
         * TyazaVoiceVisualizer - Realtime voice visualization
         */
        class TyazaVoiceVisualizer extends LitElement {
            static properties = {
                active: { type: Boolean }
            };

            static styles = css`
                :host {
                    display: block;
                    width: 100%;
                    height: 100px;
                    background: rgba(0, 0, 0, 0.2);
                    border-radius: 12px;
                    contain: strict;
                }
                canvas {
                    width: 100%;
                    height: 100%;
                    border-radius: 12px;
                }
            `;

            firstUpdated() {
                this.canvas = this.shadowRoot.querySelector('canvas');
                this.ctx = this.canvas.getContext('2d');
                this.analyser = null;
                this.animationFrame = null;
            }

            updated(changed) {
                if (changed.has('active')) {
                    if (this.active) this.start();
                    else this.stop();
                }
            }

            async start() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    this.analyser = audioCtx.createAnalyser();
                    this.analyser.fftSize = 256;
                    const source = audioCtx.createMediaStreamSource(stream);
                    source.connect(this.analyser);
                    
                    const draw = () => {
                        if (!this.analyser || !this.active) return;
                        
                        const dataArray = new Uint8Array(this.analyser.frequencyBinCount);
                        this.analyser.getByteFrequencyData(dataArray);
                        
                        this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        // Draw gradient background
                        const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                        gradient.addColorStop(0, 'rgba(139, 92, 246, 0.2)');
                        gradient.addColorStop(1, 'rgba(236, 72, 153, 0.2)');
                        this.ctx.fillStyle = gradient;
                        this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                        
                        // Draw bars
                        const barWidth = (this.canvas.width / dataArray.length) * 2.5;
                        let x = 0;
                        
                        for (let i = 0; i < dataArray.length; i++) {
                            const barHeight = (dataArray[i] / 255) * this.canvas.height;
                            const hue = 240 + (i / dataArray.length) * 120;
                            this.ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`;
                            this.ctx.fillRect(x, this.canvas.height - barHeight, barWidth - 1, barHeight);
                            x += barWidth;
                        }
                        
                        this.animationFrame = requestAnimationFrame(draw);
                    };
                    
                    draw();
                } catch (e) {
                    console.error('Visualizer error:', e);
                }
            }

            stop() {
                if (this.animationFrame) {
                    cancelAnimationFrame(this.animationFrame);
                }
                if (this.ctx) {
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
            }

            render() {
                return html`<canvas width="400" height="100"></canvas>`;
            }
        }

        /**
         * TyazaSpinner - Loading indicator
         */
        class TyazaSpinner extends LitElement {
            static styles = css`
                :host {
                    display: inline-block;
                    width: 24px;
                    height: 24px;
                    border: 3px solid #2d2352;
                    border-top-color: #8b5cf6;
                    border-radius: 50%;
                    animation: spin 0.8s linear infinite;
                }
                @keyframes spin { to { transform: rotate(360deg); } }
            `;
            render() { return html``; }
        }

        /**
         * TyazaToast - Notification component
         */
        class TyazaToast extends LitElement {
            static properties = {
                message: { type: String },
                type: { type: String },
                duration: { type: Number }
            };

            static styles = css`
                :host {
                    display: block;
                    background: #1a1433;
                    border: 1px solid #2d2352;
                    border-left: 4px solid;
                    border-radius: 12px;
                    padding: 16px 20px;
                    margin-bottom: 12px;
                    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
                    animation: slideIn 0.3s ease-out;
                    max-width: 350px;
                }
                :host([type="success"]) { border-left-color: #22c55e; }
                :host([type="error"]) { border-left-color: #ef4444; }
                :host([type="info"]) { border-left-color: #3b82f6; }
                .content {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }
                @keyframes slideIn {
                    from { opacity: 0; transform: translateX(100%); }
                    to { opacity: 1; transform: translateX(0); }
                }
            `;

            render() {
                return html`
                    <div class="content">
                        <i class="fas fa-${this.getIcon()}"></i>
                        <span>${this.message}</span>
                    </div>
                `;
            }

            getIcon() {
                const icons = { success: 'check-circle', error: 'exclamation-circle', info: 'info-circle' };
                return icons[this.type] || 'info-circle';
            }

            firstUpdated() {
                setTimeout(() => this.remove(), this.duration || 3000);
            }
        }

        // Register Web Components
        customElements.define('tyaza-message', TyazaMessage);
        customElements.define('tyaza-voice-visualizer', TyazaVoiceVisualizer);
        customElements.define('tyaza-spinner', TyazaSpinner);
        customElements.define('tyaza-toast', TyazaToast);

        // ================================================================
        // VECTOR DATABASE (IndexedDB + HNSW)
        // ================================================================

        class VectorDatabase {
            constructor() {
                this.db = null;
                this.hnsw = null;
                this.initialized = false;
                this.dimension = 384; // all-MiniLM-L6-v2 dimension
            }

            async init() {
                // Initialize IndexedDB
                this.db = await openDB('TyazaVectorDB', 3, {
                    upgrade(db) {
                        if (!db.objectStoreNames.contains('embeddings')) {
                            const store = db.createObjectStore('embeddings', { keyPath: 'id' });
                            store.createIndex('text', 'text', { unique: false });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('conversations')) {
                            const store = db.createObjectStore('conversations', { keyPath: 'id' });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings');
                        }
                    }
                });

                // Initialize HNSW index
                try {
                    this.hnsw = new Hnswlib.HierarchicalNSW('cosine', this.dimension);
                    this.hnsw.initIndex(10000); // Max 10k vectors
                    
                    // Load existing embeddings
                    await this.loadEmbeddings();
                    this.initialized = true;
                    console.log('Vector DB initialized');
                } catch (e) {
                    console.error('HNSW init error:', e);
                    this.initialized = false;
                }
            }

            async loadEmbeddings() {
                if (!this.db) return;
                const embeddings = await this.db.getAll('embeddings');
                embeddings.forEach(e => {
                    if (e.vector && e.vector.length === this.dimension) {
                        try {
                            this.hnsw.addPoint(Float32Array.from(e.vector), e.id);
                        } catch (e) {
                            console.warn('Failed to add point:', e);
                        }
                    }
                });
            }

            async addEmbedding(text, vector, metadata = {}) {
                if (!this.initialized || !this.db) return null;
                
                const id = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                const embedding = {
                    id,
                    text: text.slice(0, 500),
                    vector: Array.from(vector),
                    timestamp: Date.now(),
                    ...metadata
                };
                
                await this.db.put('embeddings', embedding);
                try {
                    this.hnsw.addPoint(Float32Array.from(vector), id);
                } catch (e) {
                    console.warn('HNSW add error:', e);
                }
                return id;
            }

            async searchSimilar(queryVector, k = 5) {
                if (!this.initialized || !this.hnsw) return [];
                
                try {
                    const results = this.hnsw.searchKnn(Float32Array.from(queryVector), k);
                    const ids = results.neighbors;
                    const distances = results.distances;
                    
                    const embeddings = [];
                    for (let i = 0; i < ids.length; i++) {
                        const emb = await this.db.get('embeddings', ids[i]);
                        if (emb) {
                            embeddings.push({
                                ...emb,
                                distance: distances[i]
                            });
                        }
                    }
                    return embeddings;
                } catch (e) {
                    console.error('Search error:', e);
                    return [];
                }
            }

            async saveConversation(conversation) {
                if (!this.db) return;
                await this.db.put('conversations', {
                    id: conversation.id || Date.now().toString(),
                    ...conversation,
                    timestamp: Date.now()
                });
            }

            async getConversations() {
                if (!this.db) return [];
                return await this.db.getAll('conversations');
            }

            async getSetting(key) {
                if (!this.db) return null;
                return await this.db.get('settings', key);
            }

            async setSetting(key, value) {
                if (!this.db) return;
                await this.db.put('settings', value, key);
            }
        }

        // ================================================================
        // ON-DEVICE INFERENCE ENGINE
        // ================================================================

        class OnDeviceInference {
            constructor() {
                this.model = null;
                this.embeddingModel = null;
                this.currentModel = 'tinyllama';
                this.isWebGPUSupported = 'gpu' in navigator;
                this.models = {
                    tinyllama: 'Xenova/tiny-random-LlamaForCausalLM',
                    phi2: 'Xenova/phi-2',
                    qwen2: 'Xenova/Qwen2-0.5B-Instruct'
                };
                this.loadingCallbacks = [];
            }

            async init(progressCallback = null) {
                if (progressCallback) this.loadingCallbacks.push(progressCallback);
                
                try {
                    // Load embedding model first (smaller)
                    this.updateProgress('Loading embedding model...', 10);
                    this.embeddingModel = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', {
                        quantized: true,
                        device: this.isWebGPUSupported ? 'webgpu' : 'wasm'
                    });
                    
                    this.updateProgress('Embedding model ready', 30);
                    
                    // Load default model
                    await this.loadModel(this.currentModel);
                    
                    return true;
                } catch (e) {
                    console.error('Inference init error:', e);
                    return false;
                }
            }

            updateProgress(message, percent) {
                this.loadingCallbacks.forEach(cb => cb(message, percent));
            }

            async loadModel(modelName) {
                this.currentModel = modelName;
                
                if (modelName === 'cloud') {
                    this.updateProgress('Using cloud fallback', 100);
                    return;
                }
                
                try {
                    this.updateProgress(`Loading ${modelName}...`, 50);
                    
                    this.model = await pipeline('text-generation', this.models[modelName], {
                        quantized: true,
                        device: this.isWebGPUSupported ? 'webgpu' : 'wasm'
                    });
                    
                    this.updateProgress('Model ready', 100);
                    Toast.show(`${modelName} loaded successfully`, 'success');
                } catch (e) {
                    console.error('Model load error:', e);
                    this.model = null;
                    Toast.show('Model load failed, using cloud', 'error');
                    this.currentModel = 'cloud';
                }
            }

            async generate(prompt, context = [], systemPrompt = null) {
                if (this.currentModel === 'cloud' || !this.model) {
                    return this.cloudFallback(prompt);
                }
                
                try {
                    const defaultSystem = "Wowe uri Tyaza, umuvugizi w'umutima mu Kinyarwanda. Shyashya mu ijwi ryuje impuhwe.";
                    const system = systemPrompt || defaultSystem;
                    
                    const contextStr = context.length > 0 
                        ? `Ibyerekeye: ${context.map(c => c.text).join(' ')}\n` 
                        : '';
                    
                    const fullPrompt = `<|system|>\n${system}\n<|user|>\n${contextStr}${prompt}\n<|assistant|>\n`;
                    
                    const result = await this.model(fullPrompt, {
                        max_new_tokens: 256,
                        temperature: 0.7,
                        do_sample: true,
                        top_p: 0.95
                    });
                    
                    return result[0].generated_text.replace(fullPrompt, '').trim();
                } catch (e) {
                    console.error('Generation error:', e);
                    return this.cloudFallback(prompt);
                }
            }

            async createEmbedding(text) {
                if (!this.embeddingModel) return null;
                
                try {
                    const result = await this.embeddingModel(text, {
                        pooling: 'mean',
                        normalize: true
                    });
                    return result.data;
                } catch (e) {
                    console.error('Embedding error:', e);
                    return null;
                }
            }

            cloudFallback(prompt) {
                const responses = [
                    "Ndumva. Urakoze kunsangiza ibi.",
                    "Ndi kumwe nawe. Wumva ute ubu?",
                    "Urakoze kundekera. Ibyo birashishikara.",
                    "Ndi hano. Ngomba kutegereza kimwe."
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }
        }

        // ================================================================
        // WEBRTC DATACHANNELS
        // ================================================================

        class RealtimePeer {
            constructor() {
                this.peer = null;
                this.dataChannel = null;
                this.onMessage = null;
                this.connected = false;
                this.initiator = true;
            }

            init(initiator = true) {
                this.initiator = initiator;
                
                try {
                    this.peer = new Peer({
                        initiator,
                        trickle: false,
                        config: {
                            iceServers: [
                                { urls: 'stun:stun.l.google.com:19302' },
                                { urls: 'stun:global.stun.twilio.com:3478' }
                            ]
                        }
                    });
                    
                    this.peer.on('signal', data => {
                        console.log('Signal data (copy to other peer):', JSON.stringify(data));
                        // In production, this would go through a signaling server
                        if (this.onSignal) this.onSignal(data);
                    });
                    
                    this.peer.on('connect', () => {
                        this.connected = true;
                        this.updateStatus('connected');
                    });
                    
                    this.peer.on('data', data => {
                        if (this.onMessage) {
                            this.onMessage(data.toString());
                        }
                    });
                    
                    this.peer.on('error', err => {
                        console.error('WebRTC error:', err);
                        this.connected = false;
                        this.updateStatus('error');
                    });
                    
                    this.peer.on('close', () => {
                        this.connected = false;
                        this.updateStatus('closed');
                    });
                } catch (e) {
                    console.error('Peer init error:', e);
                }
            }

            updateStatus(status) {
                const indicator = document.getElementById('webrtcStatus');
                const text = document.getElementById('webrtcText');
                if (!indicator || !text) return;
                
                switch(status) {
                    case 'connected':
                        indicator.style.background = '#22c55e';
                        text.textContent = 'Connected';
                        break;
                    case 'error':
                        indicator.style.background = '#ef4444';
                        text.textContent = 'Error';
                        break;
                    case 'closed':
                        indicator.style.background = '#94a3b8';
                        text.textContent = 'Disconnected';
                        break;
                    default:
                        indicator.style.background = '#f59e0b';
                        text.textContent = 'Initializing';
                }
            }

            send(message) {
                if (this.connected && this.peer) {
                    this.peer.send(message);
                    return true;
                }
                return false;
            }

            signal(data) {
                if (this.peer) {
                    try {
                        this.peer.signal(data);
                    } catch (e) {
                        console.error('Signal error:', e);
                    }
                }
            }

            destroy() {
                if (this.peer) {
                    this.peer.destroy();
                }
            }
        }

        // ================================================================
        // REALTIME ASR (Speech Recognition)
        // ================================================================

        class RealtimeASR {
            constructor() {
                this.recognition = null;
                this.isListening = false;
                this.onResult = null;
                this.onEnd = null;
                this.onError = null;
            }

            init() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.warn('Speech recognition not supported');
                    return false;
                }
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = false;
                this.recognition.interimResults = true;
                this.recognition.lang = 'rw-RW';
                
                this.recognition.onstart = () => {
                    this.isListening = true;
                };
                
                this.recognition.onend = () => {
                    this.isListening = false;
                    if (this.onEnd) this.onEnd();
                };
                
                this.recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = 0; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    if (this.onResult) this.onResult(transcript);
                };
                
                this.recognition.onerror = (event) => {
                    if (this.onError) this.onError(event.error);
                };
                
                return true;
            }

            start() {
                if (this.recognition && !this.isListening) {
                    try {
                        this.recognition.start();
                    } catch (e) {
                        console.error('Recognition start error:', e);
                    }
                }
            }

            stop() {
                if (this.recognition && this.isListening) {
                    try {
                        this.recognition.stop();
                    } catch (e) {
                        console.error('Recognition stop error:', e);
                    }
                }
            }
        }

        // ================================================================
        // SPEECH SYNTHESIS (Preserved from original)
        // ================================================================

        class SpeechSynthesisService {
            constructor() {
                this.synth = window.speechSynthesis;
                this.voices = [];
                this.loadVoices();
            }

            loadVoices() {
                this.voices = this.synth.getVoices();
                if (this.synth.onvoiceschanged !== undefined) {
                    this.synth.onvoiceschanged = () => {
                        this.voices = this.synth.getVoices();
                    };
                }
            }

            speak(text, options = {}) {
                if (!this.synth) return;
                
                this.synth.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text.slice(0, 1000));
                
                if (options.voice) {
                    const voice = this.voices.find(v => v.name.includes(options.voice.split(' ')[0]));
                    if (voice) utterance.voice = voice;
                }
                
                utterance.rate = options.rate || 0.9;
                utterance.pitch = options.pitch || 1.0;
                utterance.lang = 'rw-RW';
                
                this.synth.speak(utterance);
            }
        }

        // ================================================================
        // TOAST SERVICE
        // ================================================================

        const Toast = {
            container: document.getElementById('toastContainer'),
            
            show(message, type = 'info', duration = 3000) {
                const toast = document.createElement('tyaza-toast');
                toast.setAttribute('message', message);
                toast.setAttribute('type', type);
                toast.setAttribute('duration', duration.toString());
                this.container.appendChild(toast);
            },
            
            success(message) { this.show(message, 'success'); },
            error(message) { this.show(message, 'error'); },
            info(message) { this.show(message, 'info'); }
        };

        // ================================================================
        // CRISIS RESOURCES (Preserved)
        // ================================================================

        const CrisisResources = {
            resources: [
                { name: 'Imitari y\'inkunga', number: '116', icon: '📞' },
                { name: 'Isange One Stop', number: '3029', icon: '🏥' },
                { name: 'Police', number: '112', icon: '🚔' },
                { name: 'Ambulance', number: '912', icon: '🚑' }
            ],
            
            keywords: ['kwiyahura', 'gupfa', 'ntakibazo', 'birangiye', 'kwikomeretsa'],
            
            showAlert() {
                if (document.getElementById('crisisModal')) return;
                
                const modal = document.createElement('div');
                modal.className = 'modal-backdrop active';
                modal.id = 'crisisModal';
                modal.innerHTML = `
                    <div class="modal active" style="max-width: 500px; border-color: var(--color-error);">
                        <div class="modal-header">
                            <h3 class="modal-title" style="color: var(--color-error);">⚠️ Ukeneye ubufasha?</h3>
                            <button class="modal-close" id="crisisClose">&times;</button>
                        </div>
                        <div class="p-6">
                            ${this.resources.map(r => `
                                <div class="flex items-center gap-3 p-3 bg-surface-700 rounded-lg mb-2">
                                    <div class="w-10 h-10 bg-surface-600 rounded-md flex items-center justify-center">${r.icon}</div>
                                    <div class="flex-1">
                                        <div class="font-medium">${r.name}</div>
                                        <div class="text-lg font-bold text-error">${r.number}</div>
                                    </div>
                                    <a href="tel:${r.number}" class="w-11 h-11 bg-error rounded-full flex items-center justify-center">
                                        <i class="fas fa-phone-alt"></i>
                                    </a>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.querySelector('#crisisClose').onclick = () => modal.remove();
            }
        };

        // ================================================================
        // MAIN APPLICATION
        // ================================================================

        class TyazaApp {
            constructor() {
                this.db = new VectorDatabase();
                this.inference = new OnDeviceInference();
                this.asr = new RealtimeASR();
                this.webrtc = new RealtimePeer();
                this.tts = new SpeechSynthesisService();
                
                this.messages = [];
                this.currentConversationId = generateId();
                this.isGenerating = false;
                this.settings = {
                    model: 'tinyllama',
                    voice: 'Google UK English Female',
                    rate: 0.9,
                    pitch: 1.0,
                    autoTTS: true,
                    enableRAG: true,
                    enableWebGPU: true
                };
                
                this.elements = {
                    messagesContainer: document.getElementById('messagesContainer'),
                    welcomeScreen: document.getElementById('welcomeScreen'),
                    messageInput: document.getElementById('messageInput'),
                    sendBtn: document.getElementById('sendBtn'),
                    voiceBtn: document.getElementById('voiceBtn'),
                    modelSelect: document.getElementById('modelSelect'),
                    enableRAG: document.getElementById('enableRAG'),
                    enableWebGPU: document.getElementById('enableWebGPU'),
                    voiceSelect: document.getElementById('voiceSelect'),
                    rateSlider: document.getElementById('rateSlider'),
                    pitchSlider: document.getElementById('pitchSlider'),
                    rateValue: document.getElementById('rateValue'),
                    pitchValue: document.getElementById('pitchValue'),
                    autoTTS: document.getElementById('autoTTS'),
                    micTestBtn: document.getElementById('micTestBtn'),
                    historyList: document.getElementById('historyList'),
                    newChatBtn: document.getElementById('newChatBtn'),
                    clearHistory: document.getElementById('clearHistory'),
                    clearChat: document.getElementById('clearChat'),
                    exportTrigger: document.getElementById('exportTrigger'),
                    menuToggle: document.getElementById('menuToggle'),
                    sidebar: document.getElementById('sidebar'),
                    sidebarClose: document.getElementById('sidebarClose'),
                    sidebarOverlay: document.getElementById('sidebarOverlay'),
                    scrollBottom: document.getElementById('scrollBottom'),
                    sttOverlay: document.getElementById('sttOverlay'),
                    sttText: document.getElementById('sttText'),
                    voiceStatus: document.getElementById('voiceStatus'),
                    loadingScreen: document.getElementById('loadingScreen'),
                    loadingText: document.getElementById('loadingText'),
                    starsContainer: document.getElementById('starsContainer'),
                    connectionStatus: document.getElementById('connectionStatus'),
                    webrtcStatus: document.getElementById('webrtcStatus'),
                    webrtcText: document.getElementById('webrtcText')
                };
            }

            async init() {
                // Create stars
                this.createStars();
                
                // Load settings
                await this.loadSettings();
                
                // Initialize database
                this.elements.loadingText.textContent = 'Initializing database...';
                await this.db.init();
                
                // Initialize inference with progress
                this.elements.loadingText.textContent = 'Loading AI models...';
                await this.inference.init((msg, percent) => {
                    this.elements.loadingText.textContent = msg;
                });
                
                // Initialize ASR
                this.asr.init();
                this.setupASRCallbacks();
                
                // Initialize WebRTC
                this.webrtc.init(true);
                this.setupWebRTCCallbacks();
                
                // Bind UI events
                this.bindEvents();
                
                // Load history
                await this.loadHistory();
                
                // Apply settings
                this.applySettings();
                
                // Hide loading screen
                setTimeout(() => {
                    this.elements.loadingScreen.classList.add('hidden');
                }, 1500);
                
                // Check for crisis keywords in messages
                this.setupCrisisDetection();
                
                console.log('TYAZA v5.0 initialized');
                Toast.success('TYAZA Advanced AI Ready');
            }

            createStars() {
                if (!this.elements.starsContainer) return;
                
                for (let i = 0; i < 80; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 3}s`;
                    star.style.opacity = Math.random() * 0.6 + 0.2;
                    this.elements.starsContainer.appendChild(star);
                }
            }

            async loadSettings() {
                try {
                    const saved = await this.db.getSetting('settings');
                    if (saved) {
                        this.settings = { ...this.settings, ...saved };
                    }
                } catch (e) {
                    console.warn('Failed to load settings:', e);
                }
            }

            async saveSettings() {
                try {
                    await this.db.setSetting('settings', this.settings);
                } catch (e) {
                    console.warn('Failed to save settings:', e);
                }
            }

            applySettings() {
                this.elements.modelSelect.value = this.settings.model;
                this.elements.enableRAG.checked = this.settings.enableRAG;
                this.elements.enableWebGPU.checked = this.settings.enableWebGPU;
                this.elements.voiceSelect.value = this.settings.voice;
                this.elements.rateSlider.value = this.settings.rate;
                this.elements.pitchSlider.value = this.settings.pitch;
                this.elements.rateValue.textContent = this.settings.rate;
                this.elements.pitchValue.textContent = this.settings.pitch;
                this.elements.autoTTS.checked = this.settings.autoTTS;
            }

            bindEvents() {
                // Input
                this.elements.messageInput.addEventListener('input', () => this.handleInput());
                this.elements.messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (!this.elements.sendBtn.disabled) this.sendMessage();
                    }
                });
                
                this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
                
                // Voice
                this.elements.voiceBtn.addEventListener('click', () => this.toggleVoice());
                this.elements.micTestBtn.addEventListener('click', () => this.testMicrophone());
                
                // Settings
                this.elements.modelSelect.addEventListener('change', (e) => {
                    this.settings.model = e.target.value;
                    this.inference.loadModel(e.target.value);
                    this.saveSettings();
                });
                
                this.elements.enableRAG.addEventListener('change', (e) => {
                    this.settings.enableRAG = e.target.checked;
                    this.saveSettings();
                });
                
                this.elements.voiceSelect.addEventListener('change', (e) => {
                    this.settings.voice = e.target.value;
                    this.saveSettings();
                });
                
                this.elements.rateSlider.addEventListener('input', (e) => {
                    this.elements.rateValue.textContent = e.target.value;
                    this.settings.rate = parseFloat(e.target.value);
                });
                
                this.elements.rateSlider.addEventListener('change', () => this.saveSettings());
                
                this.elements.pitchSlider.addEventListener('input', (e) => {
                    this.elements.pitchValue.textContent = e.target.value;
                    this.settings.pitch = parseFloat(e.target.value);
                });
                
                this.elements.pitchSlider.addEventListener('change', () => this.saveSettings());
                
                this.elements.autoTTS.addEventListener('change', (e) => {
                    this.settings.autoTTS = e.target.checked;
                    this.saveSettings();
                });
                
                // Navigation
                this.elements.newChatBtn.addEventListener('click', () => this.newChat());
                this.elements.clearHistory.addEventListener('click', () => this.clearHistory());
                this.elements.clearChat.addEventListener('click', () => this.clearCurrentChat());
                
                // Sidebar
                this.elements.menuToggle.addEventListener('click', () => this.toggleSidebar());
                this.elements.sidebarClose.addEventListener('click', () => this.closeSidebar());
                this.elements.sidebarOverlay.addEventListener('click', () => this.closeSidebar());
                
                // Scroll
                this.elements.messagesContainer.addEventListener('scroll', () => this.handleScroll());
                this.elements.scrollBottom.addEventListener('click', () => this.scrollToBottom());
                
                // Export
                this.elements.exportTrigger.addEventListener('click', () => this.exportChat());
                
                // Suggestions
                document.querySelectorAll('.suggestion-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.elements.messageInput.value = btn.dataset.prompt;
                        this.handleInput();
                        this.elements.messageInput.focus();
                    });
                });
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
                        e.preventDefault();
                        this.elements.messageInput.focus();
                    }
                    if ((e.metaKey || e.ctrlKey) && e.key === 'n') {
                        e.preventDefault();
                        this.newChat();
                    }
                    if (e.key === 'Escape') {
                        this.closeSidebar();
                        if (this.asr.isListening) this.toggleVoice();
                    }
                });
            }

            setupASRCallbacks() {
                this.asr.onResult = (text) => {
                    this.elements.messageInput.value = text;
                    this.elements.sttText.textContent = text || 'ndakumva...';
                    this.handleInput();
                };
                
                this.asr.onEnd = () => {
                    this.elements.voiceBtn.classList.remove('listening');
                    this.elements.sttOverlay.classList.remove('active');
                    
                    if (this.elements.messageInput.value.trim()) {
                        this.sendMessage();
                    }
                };
                
                this.asr.onError = (error) => {
                    this.elements.voiceStatus.textContent = `Ikosa: ${error}`;
                    this.elements.voiceBtn.classList.remove('listening');
                    this.elements.sttOverlay.classList.remove('active');
                };
            }

            setupWebRTCCallbacks() {
                this.webrtc.onMessage = (msg) => {
                    this.addMessage('assistant', msg);
                };
                
                this.webrtc.onSignal = (data) => {
                    console.log('WebRTC signal:', data);
                };
            }

            setupCrisisDetection() {
                EventBus.on('message:sent', (msg) => {
                    if (msg.role === 'user') {
                        const lower = msg.content.toLowerCase();
                        if (CrisisResources.keywords.some(k => lower.includes(k))) {
                            CrisisResources.showAlert();
                        }
                    }
                });
            }

            handleInput() {
                const value = this.elements.messageInput.value.trim();
                this.elements.sendBtn.disabled = !value || this.isGenerating;
                
                // Auto-resize
                this.elements.messageInput.style.height = 'auto';
                this.elements.messageInput.style.height = 
                    Math.min(this.elements.messageInput.scrollHeight, 150) + 'px';
            }

            async toggleVoice() {
                if (!this.asr.isListening) {
                    // Test microphone first
                    try {
                        await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.asr.start();
                        this.elements.voiceBtn.classList.add('listening');
                        this.elements.sttOverlay.classList.add('active');
                        this.elements.voiceStatus.textContent = 'Mvuga none...';
                    } catch (e) {
                        this.elements.voiceStatus.textContent = '❌ Emera mikorofoni';
                    }
                } else {
                    this.asr.stop();
                }
            }

            async testMicrophone() {
                this.elements.micTestBtn.innerHTML = '<span class="spinner-sm"></span> ndategura...';
                
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.elements.micTestBtn.innerHTML = '✅ yiteguye';
                    this.elements.voiceStatus.textContent = '✅ Mikorofoni yiteguye';
                    
                    setTimeout(() => {
                        this.elements.micTestBtn.innerHTML = '<span>🎤</span> Genzura Mikorofoni';
                    }, 2000);
                } catch (e) {
                    this.elements.micTestBtn.innerHTML = '❌ emerera';
                    this.elements.voiceStatus.textContent = '❌ Emera mikorofoni';
                }
            }

            async sendMessage() {
                const text = this.elements.messageInput.value.trim();
                if (!text || this.isGenerating) return;
                
                // Hide welcome screen
                this.elements.welcomeScreen.style.display = 'none';
                
                // Add user message
                this.addMessage('user', text);
                
                // Clear input
                this.elements.messageInput.value = '';
                this.elements.sendBtn.disabled = true;
                this.handleInput();
                
                // Show typing indicator
                const typingId = this.showTyping();
                this.isGenerating = true;
                
                // Close sidebar on mobile
                this.closeSidebar();
                
                try {
                    // RAG: Get relevant context
                    let context = [];
                    if (this.settings.enableRAG) {
                        const embedding = await this.inference.createEmbedding(text);
                        if (embedding) {
                            context = await this.db.searchSimilar(embedding, 3);
                        }
                    }
                    
                    // Generate response
                    const response = await this.inference.generate(text, context);
                    
                    // Remove typing indicator
                    this.removeTyping(typingId);
                    
                    // Add assistant message
                    this.addMessage('assistant', response);
                    
                    // Save to vector DB for future RAG
                    if (this.settings.enableRAG) {
                        const respEmbedding = await this.inference.createEmbedding(response);
                        if (respEmbedding) {
                            await this.db.addEmbedding(response, respEmbedding, {
                                role: 'assistant',
                                conversationId: this.currentConversationId
                            });
                        }
                    }
                    
                    // Auto TTS
                    if (this.settings.autoTTS) {
                        this.tts.speak(response, {
                            voice: this.settings.voice,
                            rate: this.settings.rate,
                            pitch: this.settings.pitch
                        });
                    }
                    
                    // Save conversation
                    await this.saveConversation(text, response);
                    
                    // Emit event for crisis detection
                    EventBus.emit('message:sent', { role: 'user', content: text });
                    
                } catch (e) {
                    console.error('Send error:', e);
                    this.removeTyping(typingId);
                    this.addMessage('assistant', 'Hari ikibazo. Ngaho tuganire.');
                } finally {
                    this.isGenerating = false;
                }
            }

            addMessage(role, content) {
                const msg = document.createElement('tyaza-message');
                msg.setAttribute('role', role);
                msg.setAttribute('content', content);
                msg.setAttribute('timestamp', Date.now().toString());
                
                // Add event listeners
                msg.addEventListener('speak', (e) => {
                    this.tts.speak(e.detail, {
                        voice: this.settings.voice,
                        rate: this.settings.rate,
                        pitch: this.settings.pitch
                    });
                });
                
                msg.addEventListener('toast', (e) => {
                    Toast[e.detail.type](e.detail.message);
                });
                
                this.elements.messagesContainer.appendChild(msg);
                this.scrollToBottom();
                
                this.messages.push({ role, content, timestamp: Date.now() });
            }

            showTyping() {
                const id = 'typing-' + Date.now();
                const typing = document.createElement('div');
                typing.id = id;
                typing.className = 'flex items-center gap-4 p-4';
                typing.innerHTML = `
                    <div class="w-11 h-11 rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center">🤖</div>
                    <div class="flex gap-2 p-4 bg-surface-700/70 rounded-2xl">
                        <span class="w-2 h-2 bg-primary-400 rounded-full animate-bounce"></span>
                        <span class="w-2 h-2 bg-secondary-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-2 h-2 bg-accent-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                    </div>
                `;
                this.elements.messagesContainer.appendChild(typing);
                this.scrollToBottom();
                return id;
            }

            removeTyping(id) {
                const el = document.getElementById(id);
                if (el) el.remove();
            }

            scrollToBottom() {
                this.elements.messagesContainer.scrollTo({
                    top: this.elements.messagesContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }

            handleScroll() {
                const { scrollTop, scrollHeight, clientHeight } = this.elements.messagesContainer;
                const atBottom = scrollHeight - scrollTop - clientHeight < 150;
                this.elements.scrollBottom.classList.toggle('visible', !atBottom);
            }

            async saveConversation(userMsg, assistantMsg) {
                const conversation = {
                    id: this.currentConversationId,
                    title: userMsg.slice(0, 40),
                    messages: this.messages.slice(-10),
                    timestamp: Date.now()
                };
                
                await this.db.saveConversation(conversation);
                await this.loadHistory();
            }

            async loadHistory() {
                const conversations = await this.db.getConversations();
                
                if (conversations.length === 0) {
                    this.elements.historyList.innerHTML = `
                        <div class="history-empty">
                            <i class="fas fa-history"></i>
                            <span>Nta mateka</span>
                        </div>
                    `;
                    return;
                }
                
                this.elements.historyList.innerHTML = conversations
                    .sort((a, b) => b.timestamp - a.timestamp)
                    .slice(0, 15)
                    .map(c => `
                        <div class="history-item" data-id="${c.id}">
                            <div class="history-title">${escapeHtml(c.title || 'Chat')}</div>
                            <div class="history-meta">
                                <span>${formatRelativeTime(c.timestamp)}</span>
                            </div>
                        </div>
                    `).join('');
                
                this.elements.historyList.querySelectorAll('.history-item').forEach(item => {
                    item.addEventListener('click', () => this.loadChat(item.dataset.id));
                });
            }

            async loadChat(id) {
                const conversations = await this.db.getConversations();
                const chat = conversations.find(c => c.id === id);
                
                if (!chat) return;
                
                this.currentConversationId = chat.id;
                this.messages = chat.messages || [];
                
                // Clear container
                while (this.elements.messagesContainer.firstChild) {
                    this.elements.messagesContainer.removeChild(this.elements.messagesContainer.firstChild);
                }
                
                // Hide welcome
                this.elements.welcomeScreen.style.display = 'none';
                
                // Add messages
                this.messages.forEach(msg => {
                    this.addMessage(msg.role, msg.content);
                });
                
                this.closeSidebar();
            }

            newChat() {
                this.messages = [];
                this.currentConversationId = generateId();
                
                // Clear container
                while (this.elements.messagesContainer.firstChild) {
                    this.elements.messagesContainer.removeChild(this.elements.messagesContainer.firstChild);
                }
                
                // Show welcome
                this.elements.welcomeScreen.style.display = 'flex';
                
                // Close sidebar
                this.closeSidebar();
            }

            async clearHistory() {
                if (!confirm('Hanagura amateka yose?')) return;
                
                // Clear IndexedDB stores
                const tx = this.db.db.transaction(['conversations', 'embeddings'], 'readwrite');
                await tx.objectStore('conversations').clear();
                await tx.objectStore('embeddings').clear();
                
                this.newChat();
                Toast.success('Amateka yahanaguwe');
            }

            clearCurrentChat() {
                if (this.messages.length === 0) return;
                if (!confirm('Hanagura chat hiye?')) return;
                this.newChat();
                Toast.success('Chat yahanaguwe');
            }

            exportChat() {
                if (this.messages.length === 0) {
                    Toast.warning('Nta chat yohereza');
                    return;
                }
                
                const data = {
                    app: 'TYAZA',
                    version: '5.0',
                    timestamp: Date.now(),
                    messages: this.messages
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tyaza-${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                Toast.success('Chat yaherekejwe');
            }

            toggleSidebar() {
                this.elements.sidebar.classList.toggle('open');
                this.elements.sidebarOverlay.classList.toggle('active');
            }

            closeSidebar() {
                this.elements.sidebar.classList.remove('open');
                this.elements.sidebarOverlay.classList.remove('active');
            }
        }

        // Simple event bus
        const EventBus = {
            events: {},
            on(event, callback) {
                if (!this.events[event]) this.events[event] = [];
                this.events[event].push(callback);
            },
            emit(event, data) {
                if (this.events[event]) {
                    this.events[event].forEach(cb => cb(data));
                }
            }
        };

        // Initialize app
        const app = new TyazaApp();
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => app.init());
        } else {
            app.init();
        }

        // Make available globally
        window.TyazaApp = app;
        window.Toast = Toast;
    </script>

    <!-- Fallback for older browsers -->
    <noscript>
        <div style="position: fixed; inset: 0; background: #0a0612; color: white; display: flex; align-items: center; justify-content: center; padding: 40px; text-align: center;">
            JavaScript is required for TYAZA Advanced AI features.
        </div>
    </noscript>
</body>
</html>
